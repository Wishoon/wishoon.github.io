{"componentChunkName":"component---src-templates-post-jsx","path":"/Transactional과-Lock-1/","result":{"data":{"site":{"siteMetadata":{"title":"rookie"}},"markdownRemark":{"id":"d0b1bfd4-e5bc-5544-8671-7428d41327c9","excerpt":"들어가기에 앞서.. 해당 학습은 “쿠폰의 재고 시스템은 어떻게 구현해야 할까?”에서 시작되었습니다. 여러명이 쿠폰을 발급받게 될 경우 어떻게 동시성 처리를 해야하는지 다양한 방법을 한번 눈으로 확인해보고 싶어서 실험을 진행하게 되었습니다. 이번 글에서는 동시성 처리에 필요한 스프링에서의 @Transactional과 DB Lock의 개념과 코드를 통한 동시…","html":"<h2>들어가기에 앞서..</h2>\n<p>해당 학습은 “쿠폰의 재고 시스템은 어떻게 구현해야 할까?”에서 시작되었습니다. 여러명이 쿠폰을 발급받게 될 경우 어떻게 동시성 처리를 해야하는지 다양한 방법을 한번 눈으로 확인해보고 싶어서 실험을 진행하게 되었습니다.</p>\n<p>이번 글에서는 동시성 처리에 필요한 스프링에서의 @Transactional과 DB Lock의 개념과 코드를 통한 동시성 처리 방법에 대해서 한번 살펴보고자 합니다.</p>\n<h2>Transactional의 개념과 격리레벨</h2>\n<h3>트랜잭션이란?</h3>\n<p><strong>트랜잭션은 데이터베이스 상태를 변화시키는 하나의 논리적인 작업기능을 구성하는 단위</strong>를 말합니다. 어떤 작업들이 성공적으로 완료되어야 구성된 작업의 결과를 반영하고, 오류가 발생했을 때는 이전에 있었던 모든 작업들이 성공적이라고 해도 없었던일 처럼 완전히 되돌리는 것이 트랜잭션의 개념이라고 할 수 있습니다.</p>\n<h3>Lock과 Consistent Read</h3>\n<p>트랜잭션의 격리 레벨에 대해서 알아보기 전에 먼저 2가지의 개념을 먼저 알아보도록 하겠습니다.</p>\n<p><strong>첫번째로 알아볼 내용은 <code class=\"language-text\">Lock</code>입니다</strong>. Lock은 트랜잭션 처리의 순차성을 보장하기 위한 방법입니다. 이러한 <code class=\"language-text\">Lock</code>의 종류로는 대표적으로 <strong>공유 락(Shared Lock)</strong>과 <strong>베타 락(Exclusive Lock)</strong>이 있습니다.</p>\n<p>공유 락은 데이터를 읽을 때 사용되어지는 <code class=\"language-text\">Lock</code> 입니다. 이런 공유 락은 공유 락의 범위에서는 동시에 접근이 가능합니다. <strong>즉, 하나의 데이터를 읽는 것은 여러 사용자가 동시에 할 수 있다</strong>라는 것입니다. 하지만 공유 락이 설정된 데이터에 베타 락을 설정할 수는 없습니다.</p>\n<p>베타 락은 데이터를 변경하고자 할 때 사용되며, 트랜잭션이 완료될 때까지 유지됩니다. 배타 락은 <code class=\"language-text\">Lock</code>이 해제될 때까지 다른 트랜잭션은 해당 리스스에 접근할 수 없습니다.</p>\n<p>이렇게 <code class=\"language-text\">Lock</code>에 대해서 살펴본 이유는 <code class=\"language-text\">InnoDB</code>에서 각각의 격리 레벨을 적용하기 위해서 <code class=\"language-text\">Lock</code>을 적용하기 때문입니다.</p>\n<p><strong>두번째로 알아볼 내용은 <code class=\"language-text\">Consistent Read</code> 입니다.</strong> <code class=\"language-text\">Consistent Read</code>는 SELECT문을 실행할 때, 동시에 다른 트랜잭션에서 데이터를 변경하더라도 <code class=\"language-text\">Undo Log</code>에 존재하는 특정 시점의 <code class=\"language-text\">Snapshot</code>을 사용하여 동일한 결과를 반환하기 위한 방법입니다. 이를 통해서, <strong>Lock이 필요한 부분에서 이를 사용하지 않고도 동시성 제어를 할 수 있게 됩니다.</strong></p>\n<h3>트랜잭션의 격리 레벨이란 무엇인가?</h3>\n<p>트랜잭션 격리 레벨이란 <strong>동시에 여러 트랜잭션이 처리될 때, 트랜잭션끼리 얼마나 서로 고립되어 있는지를 나타내는 것</strong>입니다. 즉, 특정 트랜잭션이 다른 트랜잭션에 변경할 데이터를 볼 수 있도록 허용할지 말지를 결정합니다.</p>\n<p>이를 수행하기 위해서, 트랜잭션이 독립적인 수행을 하도록 <code class=\"language-text\">Locking</code>을 통해, 트랜잭션이 DB를 다루는 동안 다른 트랜잭션이 관여하지 못하도록 막는 작업이 필요합니다.</p>\n<p>하지만 무조건적인 <code class=\"language-text\">Locking</code>으로 동시에 수행되는 수많은 트랜잭션을 순서대로 처리하도록 설계하게 되면 데이터베이스의 동시성 성능이 떨어지게 됩니다. 이러한 성능저하를 줄이기 위해서 <code class=\"language-text\">Locking</code>의 범위를 줄인다면, 데이터 일관성이 깨지는 문제가 발생할 수도 있습니다. 따라서 최대한 효율적으로 <code class=\"language-text\">Locking</code>을 설정하는 것이 좋습니다.</p>\n<h2>트랜잭션 격리 레벨에 대해서 자세히 알아보자</h2>\n<p>트랜잭션 격리 레벨은 다음과 같이 4단계로 구분을 할 수 있습니다.</p>\n<ul>\n<li>READ UNCOMMITTED</li>\n<li>READ COMMITTED</li>\n<li>REPEATABLE READ</li>\n<li>SERIALIZABLE</li>\n</ul>\n<p>이러한 격리 레벨에 대해서 하나씩 알아보도록 합시다.</p>\n<h3>READ UNCOMMITTED</h3>\n<p><code class=\"language-text\">Read Uncommitted</code>는 커밋 전의 트랜잭션의 데이터 변경 내용을 다른 트랜잭션이 읽는 것을 허용하는 격리 레벨을 말합니다. <code class=\"language-text\">Read Uncommitted</code> 에서는 <code class=\"language-text\">Dirty Read</code>현상이 발생할 수 있습니다.</p>\n<p><code class=\"language-text\">Transaction 1</code>에서 INSERT로 추가된 <code class=\"language-text\">Coupon</code>이 <code class=\"language-text\">COMMIT</code> 되기 이전에 새로운 <code class=\"language-text\">Transaction 2</code>에서 <code class=\"language-text\">Coupon</code>을 조회한다고 가정해보겠습니다. 하지만 <code class=\"language-text\">Transaction 1</code>에서 오류가 발생해서 <code class=\"language-text\">ROLLeBACK</code>이 되게 되었습니다. 이 경우 <code class=\"language-text\">Transaction 2</code>는 <code class=\"language-text\">ROLLBACK</code> 여부를 확인하지 못하고 <code class=\"language-text\">ROLLBACK</code> 된 <code class=\"language-text\">Coupon</code>를 정상적인 데이터라 생각하고 작업을 계속 진행하게 됩니다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/6b0810a36bd91f5de527948990655f02/e596b/img.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 69.41176470588235%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAABbklEQVQ4y42Ui46CQAxF/f8PNBoj4gNQgiuCIA+x9kxSAuK6O0kzY6dze3tbnD2fT2E9Hg9n/132znY7z8wRx7Gcz2dpmkaqqpL7/S51XUtZlm43H3vXdSMw7s03s4s0TeV2uzlAjMd5nst2u5Xr9SpZlsl8Ppfj8dhXYoDEjgBZp9NJkiTp2RRFIW3but8YZ4C5A3BYKlWMAAng0SedCLT9XbNMKyARZqwdIMFksQdmvy0k2e124vu+BIeD03/EkB/oMGSAj/LQjGRYEAROa84HBYrCUGKk0mb+CUgZNInsaEeDPM9zOsNwuErVe1LyJ4Y2m2YAscMclpW+STRJuFhI9w3wm36TxqG/MpyUTNb3psCGRMaQGBul5XIpm/Va/M1GwiiaAqLX8NPDh277/b4f7NVq5eaVcokv1GqVIdd9Mth0kwbACOOBfX7mA8jO+NH0RzsfKdORhkPNYEk2G+hPfwLWMCeVjlF1ufT3L4QoR+X2/ArvAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='img' title='img' src='/static/6b0810a36bd91f5de527948990655f02/ca1dc/img.png' srcset='/static/6b0810a36bd91f5de527948990655f02/e7570/img.png 170w,\n/static/6b0810a36bd91f5de527948990655f02/f46e7/img.png 340w,\n/static/6b0810a36bd91f5de527948990655f02/ca1dc/img.png 680w,\n/static/6b0810a36bd91f5de527948990655f02/02d09/img.png 1020w,\n/static/6b0810a36bd91f5de527948990655f02/9d567/img.png 1360w,\n/static/6b0810a36bd91f5de527948990655f02/e596b/img.png 1862w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>이처럼 트랜잭션에서 처리한 작업이 완료되지 않아도 볼 수 있는 현상을 <code class=\"language-text\">Dirty Read</code>라고 합니다.</p>\n<h3>READ COMMITTED</h3>\n<p><code class=\"language-text\">Read Committed</code>는 <code class=\"language-text\">COMMIT</code>이 완료된 트랜잭션의 변경사항만 다른 트랜잭션에서 조회가 가능합니다. 이로 인해서, <code class=\"language-text\">Read Uncommitted</code>에서 발생하는 <code class=\"language-text\">Dirty Read</code>가 발생하지 않습니다. 이렇게 되는 이유는 <code class=\"language-text\">Read Committed</code> 부터는 <code class=\"language-text\">MVCC</code>인 <code class=\"language-text\">Consistent Read</code>로 문제를 해결하기 때문인데요.</p>\n<p><code class=\"language-text\">Read Committed</code>에서 데이터의 변경이 일어나게 되면 변경 전 데이터는 <strong>언두 영역으로 복사가 됩니다</strong>. 그리고 <strong>다른 트랜잭션에서 해당 테이블의 데이터를 조회할 경우, 변경된 테이블 데이터를 조회하는 것이 아니라 언두 영역에 복사된(Snapshot) 레코드를 조회</strong>하게 됩니다.</p>\n<p><img src=\"img_1.png\"></p>\n<p><code class=\"language-text\">Read Committed</code>는 <code class=\"language-text\">COMMIT</code> 된 데이터에 대해서는 정합성을 유지한다는 판단을 하기 때문에 <code class=\"language-text\">Snapshot</code>을 해당 <code class=\"language-text\">COMMIT</code>된 데이터로 다시 덮어쓰게 됩니다.</p>\n<p><code class=\"language-text\">Read Committed</code>에서는 <code class=\"language-text\">None Repetable Read</code>현상이 발생할 수 있습니다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/0ec407a762ae78a87b89661dfcebc3b9/e596b/img_2.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 69.41176470588235%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAABi0lEQVQ4y42T646CQAyFff/38xdGxcuKiCB3UbDbr9kawGxik2aGdub0nHZYvF4vwfq+N//W/J6vvl94II5juV6v8ng85H6/S9u20nWdNE1jq8dYh2GYgJH32MITt9tNqqoyQJzLZVlKGIaWK4pClsulnE6ntxIH5OwEEDufz3K5XIwBXte1PJ9PcwoAAihs2I+lomICyAEuzo044J539g5GUXJecCKZ/iVJYocwKiJ5v98bMzwIAus14KihHbSAu2+GXo3Eer2WKIrsMsCwQyK95TvPc5PHut1u5ajFop8fK/IhmcvOliQsiKVpagxgxMqAagUdW6eSJ4B8MKnx5HwIDAvp7FEQK3CirLLDQbLjUXJVFm020x7OAd3/s05bUKnMQovVWiDTAl8Bcoi4/0W0wJ9SsFpJqH3c7XYSKfCHZJruwfmUGYJNWUFoAUWaP7/r0Apl/PGwaTrPxn8xJsueqeLssywzkJInpk8m1T7isTId5u9wLJNq+LyfzqJX0FZBW30BeKcK/Mwvu0dCOQ4wnHoAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='img 2' title='img 2' src='/static/0ec407a762ae78a87b89661dfcebc3b9/ca1dc/img_2.png' srcset='/static/0ec407a762ae78a87b89661dfcebc3b9/e7570/img_2.png 170w,\n/static/0ec407a762ae78a87b89661dfcebc3b9/f46e7/img_2.png 340w,\n/static/0ec407a762ae78a87b89661dfcebc3b9/ca1dc/img_2.png 680w,\n/static/0ec407a762ae78a87b89661dfcebc3b9/02d09/img_2.png 1020w,\n/static/0ec407a762ae78a87b89661dfcebc3b9/9d567/img_2.png 1360w,\n/static/0ec407a762ae78a87b89661dfcebc3b9/e596b/img_2.png 1862w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>DB에는 <code class=\"language-text\">Coupon</code>이 2개가 있다고 가정해보겠습니다. <code class=\"language-text\">Transaction 1</code>에서 쿼리가 먼저 시작되고 나서 <code class=\"language-text\">Transaction 2</code>에서 <code class=\"language-text\">Coupon</code> 의 2번 ID를 조회하면 <strong>커피가 조회가 되게 됩니다</strong>. 하지만 <code class=\"language-text\">Transcation 1</code>에서 <strong>UPDATE</strong> 쿼리가 <code class=\"language-text\">COMMIT</code> 된 이후 <code class=\"language-text\">Transaction 2</code> 에서 다시 똑같은 <strong>SELECT</strong> 쿼리를 사용하여 다시 <code class=\"language-text\">Coupon</code>를 조회하게 될 경우 <strong>UPDATE</strong> 쿼리의 경우 <strong>술이 조회가 되게 됩니다.</strong></p>\n<p>이처럼 <strong>하나의 트랜잭션 내에서 똑같은 SELECT 쿼리를 실행했을 때 항상 같은 결과를 가져오지 못하는 <code class=\"language-text\">None-Repetable Read</code>가 발생하게 됩니다.</strong></p>\n<p>또한 앞서서 설명드렸듯이 Lock 방법에서 <code class=\"language-text\">Record Lock</code>만을 사용하기 때문에 <strong>데이터가 중간에 삽입, 삭제 될 경우 SELECT의 결과가 다르게 나타나는 <code class=\"language-text\">Phantom Read</code> 현상도 발생</strong>하게 됩니다.</p>\n<h3>REPEATABLE READ</h3>\n<p><code class=\"language-text\">Repeatable Read</code>는 트랜잭션 범위 내에서 조회한 내용이 항상 동일함을 보장합니다. 여기서 <code class=\"language-text\">Read Committed</code>와 다른 점은 <strong>언두 영역에 백업된 레코드의 여러 버전 가운데 몇 번째 이전 버전까지 찾는지</strong>에 있습니다. 모든 <code class=\"language-text\">InnoDB</code>의 트랜잭션은 고유한 트랜잭션 번호를 가지며, <strong>언두 영역에 백업된 모든 레코드에는 변경을 발생시킨 트랜잭션의 번호가 포함</strong>되어 있습니다.</p>\n<p>밑의 그림과 같이 <strong>자신의 트랜잭션 번호보다 작은 트랜잭션 번호만 보게 되는 것을 확인</strong>할 수 있습니다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/94b90d52c3e858057c8e868eef0f7cb5/e596b/img_3.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 74.70588235294117%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAABrklEQVQ4y42TCY+CQAyF/f9/UI0HHqiAoIDKoWC338QS0HWzkzTMDNPX93qMns+n2LJ9/+6/Cx9sxKFtW6nr+gO0LEupqsp9i6JwX9tfLhfZ+r4cDgcJw9BhsDpAHvUBuYvjWJIkcQ673U62262Mx2OJ9W4yncpiNhNvuZQwijo/B9g0TcfQlrHG7ve7M/Zpmsr5dJL0fJZc91dlyrlVjA4QdNic9RFSkAkgII/HowO7qz3UMQsCOSq7eLGQRBkGum8M0Kju93vxPE8ipW/5siDH49HlCtnz+dwBOyKvvBmBAWCgUVerlcsXLAHke71e5Xa7uS+BkIzzs5dv3g6KAl2imHzOGM6AEoSCcKZIpEAfdiClBvqoMizs0oBPmmwkI51UoIK0vBeQ8wAQZ/KEo/Ud9teCdaLv45d9MDQAk4tlWeZyZ4XB0ddmRvp6vRZ/s5FAi8W/r4D9PkQyBrBJp3B5ng/eFr/l0ABtJjHkkx9jyN46oL+q9xy+A9odIFSV/tuoPHp1TjMrU3qR6tYalIkZTMo3QJsQpgXDudB3uRYkmkwk0glJNECgc22T8gPZSozfdZ9JQwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='img 3' title='img 3' src='/static/94b90d52c3e858057c8e868eef0f7cb5/ca1dc/img_3.png' srcset='/static/94b90d52c3e858057c8e868eef0f7cb5/e7570/img_3.png 170w,\n/static/94b90d52c3e858057c8e868eef0f7cb5/f46e7/img_3.png 340w,\n/static/94b90d52c3e858057c8e868eef0f7cb5/ca1dc/img_3.png 680w,\n/static/94b90d52c3e858057c8e868eef0f7cb5/02d09/img_3.png 1020w,\n/static/94b90d52c3e858057c8e868eef0f7cb5/9d567/img_3.png 1360w,\n/static/94b90d52c3e858057c8e868eef0f7cb5/e596b/img_3.png 1862w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>추가적으로 일반적인 SQL 표준에서는 <code class=\"language-text\">Repetable Read</code> 조건일 때 <code class=\"language-text\">Phantom Read</code>가 발생한다라고 흔히 알고 있는데, 저희가 주로 사용하는 MySQL의 <code class=\"language-text\">InnoDB</code> 기준으로는 <code class=\"language-text\">Repetable Read</code> 조건에서 <code class=\"language-text\">Phantom Read</code>가 발생하지 않습니다. 그 이유는 <code class=\"language-text\">Record Lock</code>이 아닌 <code class=\"language-text\">Next-key Lock</code>을 사용하기 때문입니다.</p>\n<p>특정 레코드에 대해서만 <code class=\"language-text\">Lock</code>을 걸지 않고 검색하고자 하는 범위 내에서 <code class=\"language-text\">Gap Lock</code>까지 걸어버리기 때문에 중간에 특정 데이터가 <strong>추가 혹은 삭제되어 발생하는 <code class=\"language-text\">Phantom Read</code> 현상은 발생</strong>하지 않습니다.</p>\n<h3>Serializable</h3>\n<p>가장 단순한 격리 수준이면서, 가장 엄걱한 격리 수준입니다. 읽기 작업에 대해서도 공유 잠금을 획득해야 하며, 동시에 다른 트랜잭션은 해당 레코드의 변경이 불가능 합니다. 즉, 한 트랜잭션에서 읽고 쓰는 레코드를 다른 트랜잭션에서는 절대 접근할 수 없습니다.</p>\n<p>MySQL <code class=\"language-text\">InnoDB</code>에서의 격리수준에서 가장 아리송할 수 있는 부분은 <code class=\"language-text\">Repetable Read</code>와 <code class=\"language-text\">Serializable</code> 둘다 <code class=\"language-text\">Phantom Read</code>가 발생하지 않도록 보장한다는 점입니다. <strong>여기서 주의깊게 봐야 할 점은 그 보장의 방법이 다르다는 점입니다.</strong></p>\n<p><code class=\"language-text\">Repetable Read</code>는 Write 상황에서는 <code class=\"language-text\">x-lock</code>이 걸리고 Read 상황에서는 <code class=\"language-text\">Consistent Read</code>를 통해서 비 잠금 Read로 <code class=\"language-text\">Phantom Read</code> 가 발생하지 않도록 보장합니다.</p>\n<p>반면 <code class=\"language-text\">Serializable</code>은 <code class=\"language-text\">Consistent Read</code>를 사용하지 않고, Read에 대해서만 <code class=\"language-text\">s-lock</code>을 걸어서 <code class=\"language-text\">Phantom Read</code>가 발생하지 않도록 보장하게 된다는 점이 차이가 있다고 할 수 있습니다.</p>\n<h2>스프링에서의 트랜잭션</h2>\n<h3>스프링에서의 트랜잭션 작동 원리</h3>\n<p>각각의 데이터 접근 기술들(JDBC, JPA)은 트랜잭션을 처리하는 방식에 차이가 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">jdbcTemplate</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">SQLException</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">Connection</span> conn <span class=\"token operator\">=</span> dataSource<span class=\"token punctuation\">.</span><span class=\"token function\">getConnection</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        conn<span class=\"token punctuation\">.</span><span class=\"token function\">setAutoCommit</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// (1) - 트랜잭션 시작</span>\n        <span class=\"token function\">bizLogic</span><span class=\"token punctuation\">(</span>conn<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        conn<span class=\"token punctuation\">.</span><span class=\"token function\">commit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// (2) - 로직 성공시 트랜잭션 커밋</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        conn<span class=\"token punctuation\">.</span><span class=\"token function\">rollback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalStateException</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">(</span>\n        <span class=\"token function\">close</span><span class=\"token punctuation\">(</span>conn<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">jpa</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">EntityManagerFactory</span> emf <span class=\"token operator\">=</span> <span class=\"token class-name\">Persistence</span><span class=\"token punctuation\">.</span><span class=\"token function\">createEntityFactory</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"transaction\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">EntityManager</span> em <span class=\"token operator\">=</span> emf<span class=\"token punctuation\">.</span><span class=\"token function\">createEntityManager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">EntityTransaction</span> tx <span class=\"token operator\">=</span> em<span class=\"token punctuation\">.</span><span class=\"token function\">getTransaction</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    \n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        tx<span class=\"token punctuation\">.</span><span class=\"token function\">begin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">bizLogic</span><span class=\"token punctuation\">(</span>em<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        tx<span class=\"token punctuation\">.</span><span class=\"token function\">commit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        tx<span class=\"token punctuation\">.</span><span class=\"token function\">rollabck</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n        em<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    emf<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>스프링은 이러한 문제를 해결하기 위해 트랜잭션 추상화를 제공합니다. <code class=\"language-text\">PlatformTransactionManager</code> 라는 인터페이스를 통해 트랜잭션을 추상화 할 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">PlatformTransactionManager</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">TransactionManager</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">TransactionStatus</span> <span class=\"token function\">getTransaction</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@Nullable</span> <span class=\"token class-name\">TransactionDefinition</span> definition<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">TransactionException</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">commit</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">TransactionStatus</span> status<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">TransactionException</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">rollback</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">TransactionStatus</span> status<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">TransactionException</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>또한 스프링은 <strong>데이터 접근 기술에 대한 트랜잭션 매니저의 구현체도 제공</strong>을 합니다. 우리는 필요한 구현체를 스프링 빈으로 등록하고 주입받아 사용하기만 하면 됩니다. 추가적으로 스프링 부트를 사용한다면 <code class=\"language-text\">AutoConfiguration</code>에 의하여 <strong>개발자가 의존성으로 등록한 데이터 접근기술을 자동으로 인식해, 적절한 트랜잭션 메니저를 스프링 빈으로 등록</strong>해 줍니다.</p>\n<h3>@Transactional 등장</h3>\n<p>앞에서 설명한 스프링에서 제공하는 트랜잭션 추상화인 <code class=\"language-text\">PlatformTransactionManger</code>를 사용하는 방식은 <strong>선언적 트랜잭션</strong> <strong>관리</strong>와 <strong>프로그래밍 방식 트랜잭션 관리</strong>가 있습니다. 프로그래밍 방식의 트랜잭션 관리를 사용하게 되면, <strong>애플리케이션 코드가 트랜잭션이라는 기술 코드와 강하게 결합</strong>하게 됩니다. 이는 다음 코드를 통해서도 확인할 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Service</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">UserSerivce</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">TransactionStatus</span> status <span class=\"token operator\">=</span> transactionManager<span class=\"token punctuation\">.</span><span class=\"token function\">getTransaction</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">DefaultTransactionDefinition</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">bizLogic</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        transactionManager<span class=\"token punctuation\">.</span><span class=\"token function\">commit</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 성공시 커밋</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        transactionManger<span class=\"token punctuation\">.</span><span class=\"token function\">rollback</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 실패시 롤백</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalStateException</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이러한 문제를 해결하기 위해, 프록시 방식을 이용한 트랜잭션 관리 방식의 트랜잭션을 사용하게 되었습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Component</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">TransactionUserSerivceProxy</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">UserService</span> target<span class=\"token punctuation\">;</span>\n\t\t\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">logic</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">TransactionStatus</span> status <span class=\"token operator\">=</span> transactionManger<span class=\"token punctuation\">.</span><span class=\"token function\">getTransaction</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            target<span class=\"token punctuation\">.</span><span class=\"token function\">logic</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            transactionManager<span class=\"token punctuation\">.</span><span class=\"token function\">commit</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 성공시 커밋</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            transactionManger<span class=\"token punctuation\">.</span><span class=\"token function\">rollback</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 실패시 롤백</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalStateException</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MemberService</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">logic</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">bizLogic</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>여기서 조금 더 발전해 스프링에서는 <code class=\"language-text\">@Transactional</code> 애노테이션을 이용해서 <strong><code class=\"language-text\">@Transactional</code>이 선언된 곳에 트랜잭션을 처리하는 프록시를 적용해 선언적 트랜잭션 관리 방식으로 사용을 할 수 있게 기능을 제공</strong>합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Transactional</span>\n<span class=\"token annotation punctuation\">@Service</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MemberService</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">logic</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">bizLogic</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>다음글에서..</h2>\n<p>이번 글에서는 Transactional과 Lock 그리고 스프링에서는 어떻게 각 데이터 접근 기술에 대해서 트랜잭션을 지원하는지를 알아보았습니다. 다음 글에서는 이제 실제 코드를 통해서 문제 상황과 해결방법을 한번 살펴보도록 하겠습니다.</p>","frontmatter":{"title":"Transactional과 Lock 1","date":"October 25, 2022","update":"October 25, 2022","tags":["Transactional & Lock"],"series":"Transactional과 Lock 알아보기"},"fields":{"slug":"/Transactional과-Lock-1/","readingTime":{"minutes":16.395}}},"seriesList":{"edges":[{"node":{"id":"d0b1bfd4-e5bc-5544-8671-7428d41327c9","fields":{"slug":"/Transactional과-Lock-1/"},"frontmatter":{"title":"Transactional과 Lock 1"}}}]},"previous":{"fields":{"slug":"/Replication과-SpringBoot/"},"frontmatter":{"title":"Replication과 Spring Boot"}},"next":null},"pageContext":{"id":"d0b1bfd4-e5bc-5544-8671-7428d41327c9","series":"Transactional과 Lock 알아보기","previousPostId":"4c21b76a-ad6b-5e0b-b0e7-a0c0e94b12a9","nextPostId":null}},"staticQueryHashes":[]}