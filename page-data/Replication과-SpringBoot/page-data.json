{"componentChunkName":"component---src-templates-post-jsx","path":"/Replication과-SpringBoot/","result":{"data":{"site":{"siteMetadata":{"title":"rookie"}},"markdownRemark":{"id":"4c21b76a-ad6b-5e0b-b0e7-a0c0e94b12a9","excerpt":"사용배경 현재 진행하고 있는 프로젝트에서 쿠폰 시스템을 만들고 있습니다. 현재 시스템상 내부 인원들만 사용을 하고 있기 때문에 부하에 대한 문제를 걱정하지 않아도 되지만, 해당 시스템이 실제 상용서비스가 되어 많은 사용자들이 사용한다고 가정한다면 분명 서버와 DB에 많은 부하가 오게 될 것입니다. 이번 글에서는 부하 분산 중 DB에서의 처리 방법을 한번 …","html":"<h2>사용배경</h2>\n<p>현재 진행하고 있는 프로젝트에서 쿠폰 시스템을 만들고 있습니다. 현재 시스템상 내부 인원들만 사용을 하고 있기 때문에 부하에 대한 문제를 걱정하지 않아도 되지만, 해당 시스템이 실제 상용서비스가 되어 많은 사용자들이 사용한다고 가정한다면 분명 서버와 DB에 많은 부하가 오게 될 것입니다.</p>\n<p>이번 글에서는 <strong>부하 분산 중 DB에서의 처리 방법을 한번 고민</strong>해보고자 합니다. 그리고 고민의 결과와 적용한 과정에 대해서도 함께 작성해보려고 합니다.</p>\n<h2>DB 성능 확장 방법</h2>\n<p>DB의 성능을 높이기 위해서는 <code class=\"language-text\">Scale up</code> 또는 <code class=\"language-text\">Scale out</code> 하여 성능을 높여야 합니다. 현재 진행하는 프로젝트에서는 <code class=\"language-text\">Scale up</code>을 하기 위한 자원을 제공받을 수 없는 상황이기 때문에, <code class=\"language-text\">Scale up</code>은 고려하지 않고 <code class=\"language-text\">Scale out</code>을 적용하기로 결정했습니다.</p>\n<p>DB를 <code class=\"language-text\">Scale out</code>하는 방법은 <code class=\"language-text\">Clusterning</code>과 <code class=\"language-text\">Replication</code>으로 구분할 수 있습니다. 한번 각각의 방법에 대해서 알아보도록 합시다.</p>\n<h3>Clustering</h3>\n<p><code class=\"language-text\">Clusterning</code>은 DB 서버를 2대 이상, DB 스토지리를 1대로 구성하는 형태입니다. <strong>DB 서버 2대를 모두 <code class=\"language-text\">Active</code> 상태로 운영한다면, DB 서버 1대가 죽더라도 다른 DB 서버 1대는 살아있어 서비스를 정상적</strong>으로 할 수 있습니다. 또한 DB 서버를 여러대로 두게되면, 트래픽을 분산하여 감당하게 되어 CPU와 Memory 부하가 적어지는 장점이 존재합니다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 664px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/053f7d357d3fa0ee06a86522a4b3771d/5bd9c/img.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 112.3529411764706%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAAAsTAAALEwEAmpwYAAACkklEQVQ4y41Uy27TQBT1P7BDLPkDlv0HJL4AiR2rCrEBpK6QQGKB2CMWhWWlgtghJELSNFFebuLYVZNGJHHIy0FNiBzH8SMH3/EjduzQjjIaz8y5Z86ceyfcer3GGk6j0TZh06fXbdsC7cObOwDnZ8UwbriL49hIRO4cWHUB/gkwFbwF2wV7h7G2kIDKPqDJLpkd7IALTocGU3qH/Nu7yB1wUNOPUBUvYRr6RiGusORfIvXqDuqvOVydPIXUlAOF1B2FDvvvLxA+7OFon8PnZ7cwzjwH9D5OT3OYTCYswLg8hPj+Hj495vD14DbUszfQZzJ+pH5uEdLs5AEyjir+433nOkIg//xcgqJMmD7r2x6+v+BwcfwQsH4FmFKpuPGZCJlLUxHoH4E/q4IsNo0VAwhCHRNl5EZOS/grHeKi2WZTwpB3hUIhSsiuzKwHcrkcwq1er2M8Hgfz0R8VtVotgsnn83GFfpaKxSLK5TIqlQoLTKfTUFXVC11DW6js0Gq1yjCEzWazUQ/DNWQ7xARst9uONyXMZrMImFXMYsGu2el0wPM8lstltA7DExoHgwH6/T67qq7rMULTNNk+4QhD8xhheIGaoigIr4f7Lky0sENgy7IwHA5jwO1gwhB2ez2mkHwcjUbB2mq1Yp2ubxjGJuMOxvaSGVO4TUj+UCPTU6kUyyZ1+u52u2yPMDcm9GtPEASW1bCqRqMRXPlGhDS2Wi32hqkO5/N5sEfZzWQyrJxkWY7EJBL6G+QXdapFv878zJINpIx83Y6LECaVAPkmiiJ6vR7zjMhIfRLRToVhIHlJ77nZbLJRkiRomhaz6FqFPoCeIJGQX6SO1JKnu2r0WkL/2w79xScl4r+ESV4mHbSr/QOYJ4wptSQmTgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='img' title='img' src='/static/053f7d357d3fa0ee06a86522a4b3771d/5bd9c/img.png' srcset='/static/053f7d357d3fa0ee06a86522a4b3771d/e7570/img.png 170w,\n/static/053f7d357d3fa0ee06a86522a4b3771d/f46e7/img.png 340w,\n/static/053f7d357d3fa0ee06a86522a4b3771d/5bd9c/img.png 664w' sizes='(max-width: 664px) 100vw, 664px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>하지만, <strong>DB 서버들이 하나의 DB 스토리지를 공유하기 때문에 DB 스토리지에 병목이 생기는 단점</strong>이 존재합니다.</p>\n<p>이를 해결하기 위해서 DB 서대 2대 중 1대를 <code class=\"language-text\">Stand-by</code> 즉, 사용대기 상태로 두어 단점을 보안할 수 있습니다. <strong><code class=\"language-text\">Stand-by</code> 상태의 서버는 <code class=\"language-text\">Active</code> 상태의 서버에 문제가 생겼을 때, <code class=\"language-text\">Fail Over</code>를 하여 상호 전환을 하여 장애에 대응</strong>을 할 수 있습니다. 이를 통해서, DB 스토리지에 대한 병목 현상도 해결할 수 있습니다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 664px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/613ac30f3b12d16c2c95f7104950094a/5bd9c/img_1.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 112.3529411764706%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAAAsTAAALEwEAmpwYAAACmUlEQVQ4y41UO48SURjlP9hamW2stLKx1c6YaGXtD9iNlauJf2ALY6LtxkejyRZa2QkBYQivEQbYCEuWl8AwEwQJw2sex/tdZoYZYLJ8yc19nXvm3PN9d0KWZcECC+pNHSYN7WaaBmgf9pwtMIzJMU4Y5mrm4EK8JyLLRiyagPgMGEr2gsnBlmHAcFh+F6G8PMRMEldkhruDkPt1TKGX3yD5+gDCqxAm0afIly6gL+drOaoM7d0Jovfu4OPN6xCOj3BRb7gKqTGFTPKfb5BO7+LsKISvx9fQj70A5h0kEgIUVeEHBl8+IPn4Pj7fuoH4kwewfnyH9neAcDi8QUizn48QY6rETw8BTXIFnZfLkPt9Ps4+P8T72wdovD1hl5nAcSiTyax9JkLu0rAEdM4g/spzn/TlggMkqQhVWRFiOMC/VALnl5erZCwWLEcmUqmUn5BfmVsPCIIAbxSLRfRthRTycAQpn/dhksnktkLLTn06nUY2m0Uul0OhUEA0GsVkMnEPTzWNfzTPSAlD2Hg87vfQW0N0BQLW63XuzWg08oEpNEZK12w0GhBFEbPZzF+H3gn13W4XnU6HX3U+n28R6rrO9wlHGJpvEXoXKBRFgXfd24Iw/sL2gA1W9b1ebwu4eZgwhueFBCokH2VZdtcWrDyo0fWXy+U64wxjbrzjQELyh4JMj0QiPJvUaNxsNvkeYfYmdGpPkiSeVa+qSqXiXnkvQuprtRpUVeV1OB6P3T3KbiwW4+XUarV8Z3YSOhvkFzWqRafOnMySDaSMfN085yPcVQLkW6lUQrvd5p4RGanfRRSo0AskL+k9V6tV3pfZ32c6nW5ZdKVCB0BPkEjIL1JHasnToBq9ktAZO9ncVLYX4S4vd30oKP4Dk+KJkeTx6LAAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='img 1' title='img 1' src='/static/613ac30f3b12d16c2c95f7104950094a/5bd9c/img_1.png' srcset='/static/613ac30f3b12d16c2c95f7104950094a/e7570/img_1.png 170w,\n/static/613ac30f3b12d16c2c95f7104950094a/f46e7/img_1.png 340w,\n/static/613ac30f3b12d16c2c95f7104950094a/5bd9c/img_1.png 664w' sizes='(max-width: 664px) 100vw, 664px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>하지만, <strong><code class=\"language-text\">Fail Over</code>가 발생하는 시간 동안은 손실이 존재하며, DB 서버 비용은 그대로인데 가용률이 1/2가 된다는 단점이 존재</strong>합니다.</p>\n<p>또한, <code class=\"language-text\">Clustering</code>이 가지는 본질적인 <strong>문제로 DB 스토리지에 문제가 발생하면, 데이터를 복구할 수 없다는 치명적인 문제</strong>가 존재합니다.</p>\n<h3>Replication</h3>\n<p><code class=\"language-text\">Replication</code>은 각 DB 서버가 각자 DB 스토리지를 가지고 있는 형태입니다. 그리고 이를 실시간으로 동기화하면서 트래픽을 여러 MySQL 서버로 분산시켜주기 때문에 데이터베이스로 인한 병목 현상을 개선할 수 있습니다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/7320063af3fcb5938a76de7b86383716/fe486/img_2.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 92.94117647058823%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAACaklEQVQ4y41Uu5ISQRSdXKuMTAz0G/wNQ3/A1NTAyI1MTNUNjCytDdbEzdcyWXkIVUDxWt64gC7vx8DIm5k5zumhmxlYq/YWXcx0H849997TaDacsC3nY8KCG7Zti+V93r3vY+HDara9O8Q4Cqt4LN98QPfBhC0P9TDMxEtnb6YSMTRXYR+T6CucH91F6+N9tArf0R9N90gtl2zRRO/iBb4d3cHo8z38TpxiMF7sFJrVE5y/foST5xoSn54AozjKpSIymYwAWZYlyET+6y9IvX2A42casqdPgUkGleovpFIphdXM7Buk3j3EVfC9KnU4HKJSKXsIt6X+OYP+9TFqPz8o7Hg8RrFY3BECG6yNa+RKDR+oXPYS2qp3y6mOTP5KYQ3jLwqFgpfQacvSRCj4A/V6zVkNxONx5PN5P+G2l6u1iWDgArUasXUkk0lcXl7uCCWQZabTaSGfGVerFQ7Dxfb7fdHjUqnkw25t44JM0xRZO50Oer2e2NtsnHas1yIzz/nN4B7VdbtdhZU82r7fZrOZ0qPrOqLRqJgiV7Va9emVWJlIKZSEzMzSZRDId6rg8p5R8WAwOLgESmGr1XKsUkEulxOlG4aBm4LYZrMp1BLL0iVWKOTDfD5HKBQSKpiVDSdYKvFWsVwuEQgERP84HOKy2azfNtPpVBEwRqORz4fekhaLhSJgTCaTfWO7hNJLchi0xG0IWe6BsVlyJBIRfaRt+ANvVi8hPRcOhwW23W6LC+C9BJrMxCw8IFksFlMT3f9flFi2iFURyxb5hsLgZNloTo0TZG/+R0gs1TUajQOsz9g3WeQ2e979f1/Bn4aYLjfFAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='img 2' title='img 2' src='/static/7320063af3fcb5938a76de7b86383716/ca1dc/img_2.png' srcset='/static/7320063af3fcb5938a76de7b86383716/e7570/img_2.png 170w,\n/static/7320063af3fcb5938a76de7b86383716/f46e7/img_2.png 340w,\n/static/7320063af3fcb5938a76de7b86383716/ca1dc/img_2.png 680w,\n/static/7320063af3fcb5938a76de7b86383716/fe486/img_2.png 768w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p><code class=\"language-text\">Master</code>와 <code class=\"language-text\">Slave</code>로 구성된 구조는 <code class=\"language-text\">Master</code> 서버에는 INSERT, UPDATE, DELETE 작업이 전달되고 <code class=\"language-text\">Slave</code> 서버에는 SELECT 작업을 전달합니다. <code class=\"language-text\">Slave</code>는 결국 <code class=\"language-text\">Master</code> 서버에서 복제된 데이터이기 때문에 데이터의 조작이 발생할 수 있는 INSERT, UPDATE, DELETE 작업은 <code class=\"language-text\">Master</code>로 전달이 되고 조회만을 하는 SELECT 작업은 <code class=\"language-text\">Slave</code> 서버를 통하여 진행하게 됩니다.</p>\n<p>위의 그림에서는 <code class=\"language-text\">Slave</code> 서버가 하나뿐이지만 서비스에 맞게 <code class=\"language-text\">Slave</code> 서버를 여러 개로 설정할 수도 있습니다. <strong>데이터베이스에서 발생하는 대부분의 쿼리는 조회인 SELECT인데 이러한 것을 <code class=\"language-text\">Slave</code> 서버를 통해 분산하여 처리할 수 있으니 좀 더 성능 향상을 가져갈 수 있습니다</strong>.</p>\n<p>MySQL에서의 <code class=\"language-text\">Replication</code> 동작과정을 조금 더 자세히 살펴보면 다음과 같습니다.</p>\n<ol>\n<li>사용자가 INSERT, UPDATE, DELETE 쿼리를 <code class=\"language-text\">Master</code> 서버로 요청하면, <code class=\"language-text\">Master</code> 서버는 이를 처리하고 <code class=\"language-text\">Master</code> 서버에서 일어나는 모든 변경 이력들을 <strong>바이너리 로그 스레드</strong>를 사용해서 <strong>바이너리 로그</strong>에 저장한다.</li>\n<li><code class=\"language-text\">Slave</code> 서버에서 변경 내역을 요청하면 <code class=\"language-text\">Master</code> 서버의 바이너리 <strong>로그 덤프 스레드</strong>가 바이너리 로그들을 읽어서 <code class=\"language-text\">Slave</code> 서버로 데이터를 전달한다.</li>\n<li><code class=\"language-text\">Slave</code> 서버의 <strong>Slave I/O 스레드</strong>가 요청한 변경 내역들을 <code class=\"language-text\">Slave</code> 서버의 <strong>릴레이 로그</strong>에 저장합니다.</li>\n<li>최종적으로 <code class=\"language-text\">Slave</code> 서버의 <strong>Slave SQL 스레드</strong>가 <strong>릴레이 로그</strong>에 기록된 데이터들을 읽어서 <code class=\"language-text\">Slave</code> 서버에 적용합니다.</li>\n</ol>\n<blockquote>\n<p>바이너리 로그란?</p>\n</blockquote>\n<p><code class=\"language-text\">Master</code> 노드에서의 <code class=\"language-text\">DDL</code> or <code class=\"language-text\">DML</code> 가운데 데이터의 구조나 내용을 변경하는 모든 쿼리 문장과 이력을 기록하는 논리적인 로그를 말합니다.</p>\n<p>전체적인 흐름은 다음 도식과 같습니다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/a4f3d97f875cefc753561d7f7f54ece0/8a72f/img_3.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABTUlEQVQoz2VSCXKDMAzk/w9r31AoOUgyEzfEAWIbsA2qV4koSTUjMDp21xLZfrejPM/JOUfeexrHcXmvHTGlFH2XJQ3D8K8G333fU6avmpqmoWmaCObjTB9loNbN/P14EufbtmWfZ4m+WgiBMjzEUBjiRPm+psHHZ+yRizGysrWhfg0OlRmKIFkUotGajpNMkAjhox8ZEHXIISZg9/ud+1ghZrfZbKgoCjqfzzwHXMtZy43X+pryW7rpG+mfhpzpSaW6uq6ZoO8f/QLKCq11PMfL5cIsSCIOBcYY6kCQiK2xKR/5DOL4vNXxeOS6BfDdUCyLwDjkLHGxaTSkvj6pUTteXgj+D1DmAZbD4cAq1nPCWQAlNoWBOrWlU1Wm3PCqEA2yyaqqlisIKM5rwPV287zgfxSxBZBn1XXsGgvQmmeHBWE574DLO7n8JSD/BSBsC0lpYgg8AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='img 3' title='img 3' src='/static/a4f3d97f875cefc753561d7f7f54ece0/ca1dc/img_3.png' srcset='/static/a4f3d97f875cefc753561d7f7f54ece0/e7570/img_3.png 170w,\n/static/a4f3d97f875cefc753561d7f7f54ece0/f46e7/img_3.png 340w,\n/static/a4f3d97f875cefc753561d7f7f54ece0/ca1dc/img_3.png 680w,\n/static/a4f3d97f875cefc753561d7f7f54ece0/8a72f/img_3.png 780w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<h3>그래서.. 어떤 선택을?</h3>\n<p>결론적으로 <code class=\"language-text\">DB Scale out</code>을 하는 방법으로 <code class=\"language-text\">Replication</code>을 선택하기로 했습니다. 이렇게 구성하게 될 경우 DB 스토리지를 여러개로 두기 때문에, 데이터 복구를 못하는 상황을 어느정도 방지할 수 있으며, <code class=\"language-text\">Clustering</code>과 다르게 DB 가용률을 최대로 가져갈 수 있다는 장점을 가져갈 수 있다고 생각했기 때문입니다.</p>\n<p>여기서 고민인 점은 <code class=\"language-text\">Slave DB</code>를 몇대로 설정하는가 입니다. 현재로써는 서비스 사용자가 많지 않기 때문에 <code class=\"language-text\">Master 1</code>, <code class=\"language-text\">Slave 1</code> 구조로 선택해도 문제가 없습니다. 하지만 현재 진행하는 설계는 다수의 사용자를 고려하여 진행하고 있기 때문에 추후 확장에 용이하도록 <strong>N개의 Slave DB를 기준으로 설계</strong>를 하기로 하였습니다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 612px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/b810527eb7cb2dabde817a27d66ac7ca/dbf98/img_4.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 105.29411764705883%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAAAsTAAALEwEAmpwYAAADR0lEQVQ4y42VXWhbZRjH48WuBAW98GJ6IQhOGDiYgswxpQPFMmQgKAwdiJMKDjcYw6Js0zG0Vvy4EZHNXkyH4oqwCfODuTl6s1HbtCRdTdqkycnX+Uqa5CRNzzk55+d7zslHS9JuD7wcyPt/f+f/Js//Sch1XfouwHWauLYploXbtIKn6wR7G5wLbQgTBzeqzaD9gcKZV/Wpy+jfHqT4/RDLF45RPHsIU4oEUM/93QCDCtxVfjpOYiBE7vAj5I9tI30gxGr4t7bPlttNgF7Ztk2pqKHVTKSz76IMP4n88R7k088J6OPkr1+gVLcoL5dwHKcH2gOsVCqkl5IYNuTG3kP+YCfyZ/sonB5AEg5TV3+garpkpBSGYdwZ6IlKuhbAx08gvXkvpeHtaEP3k3s1RPLmHxSE1NNUq9U7Az2RpgVAS0tjxye4duUXbvx1CX1iDGP6R5T0DKlcgXrNuDugruudFjEsmFdrXF3UWFJkUGeFKIUuXlrd/MpOC1gRYrUDXIjHiISniIb/RZGVzuc+UHzfGwPbjlZM9LKxpjGCp7umoX1guYrRsLr7a4F+5zUMHD0lbhOlGJvEURZo1svrxH5blRVfV4xPUU3O0FQTfjzbTkNu0w5ScWsc6eAW0cRbkU88TXboQYy/vwuEQtNOj5cW6fV7KBzfRuH97WSF3srNd9LTAdYmzpN+LYR8chfq6Mvkjj5G9feveoDal/uR3tiC8ulLKGf2kjvyKGZ6thdo/DMmnD2DfOpZCh8+JVLxRF+g/s0BkZrnyQ/vCICHH8bORPoAr58j89Z9qKd2URC5XXohRPriJxQdn9h1+PUrZN95CPWj3WTffoDkPqGbm6QREAWwJWzMXUP9fBDpC3FgZJDSmd0oN86zWKpTWVn1xX56Lo+gjA6SGt2PMvIixZEBsvFpkkJnN5vdtmlPv5uZEhfnFCKJGNb8OCsLf9JYXe3MQa+83/RKTObX2zK6FMa+/TOGNIkltn2g02qJxOIC4elpov/FiSWSuKYhVi24cktjmSYzM2Ei0SizQpfJpEUv1XGtuvfGrsP2pMlmsxRF8C3hal1jt/tVjCxNVcnnc1SWl2k0Gms09GZ5/ajvncj9/xK6+/8DFbYAQ5kwZ6sAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='img 4' title='img 4' src='/static/b810527eb7cb2dabde817a27d66ac7ca/dbf98/img_4.png' srcset='/static/b810527eb7cb2dabde817a27d66ac7ca/e7570/img_4.png 170w,\n/static/b810527eb7cb2dabde817a27d66ac7ca/f46e7/img_4.png 340w,\n/static/b810527eb7cb2dabde817a27d66ac7ca/dbf98/img_4.png 612w' sizes='(max-width: 612px) 100vw, 612px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>실제 프로젝트에는 <code class=\"language-text\">Master 1</code>, <code class=\"language-text\">Slave 2</code> 로 구성하여 작업을 진행하였습니다.</p>\n<h2>MySQL 설정</h2>\n<h3>Master, Slave DB Server 사전 작업</h3>\n<p>MySQL은 기본적으로 <code class=\"language-text\">127.0.0.1</code> 즉, 로컬 호스트에서만 접속할 수 있는데 아래와 같이 MySQL 설정을 변경하여 외부에서 접속이 가능하도록 변경을 해야합니다. 다음과 같이 변경을 하면 됩니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">vim</span> /etc/mysql/mysql.conf.d/mysqld.cnf\n\nbind-address           <span class=\"token operator\">=</span> <span class=\"token number\">0.0</span>.0.0\nmysqlx-bind-address    <span class=\"token operator\">=</span> <span class=\"token number\">0.0</span>.0.0</code></pre></div>\n<h3>Master DB Server 작업</h3>\n<p>기본적인 데이터베이스 부터 한번 생성해보도록 하겠습니다. 먼저 <code class=\"language-text\">Master DB</code>에 대한 데이터베이스를 생성합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token constant\">CREATE</span> <span class=\"token class-name\">DATABASE</span> test<span class=\"token punctuation\">;</span></code></pre></div>\n<p>테스트할 테이블이 있어야 하기 때문에 테이블도 생성해 줍니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token constant\">CREATE</span> <span class=\"token class-name\">TABLE</span> <span class=\"token function\">user</span><span class=\"token punctuation\">(</span>\n\tid <span class=\"token constant\">BIGINT</span> <span class=\"token constant\">NOT</span> <span class=\"token class-name\">NULL</span> <span class=\"token constant\">AUTO_INCREMENT</span><span class=\"token punctuation\">,</span>\n\tname <span class=\"token function\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token class-name\">PRIMARY</span> <span class=\"token function\">KEY</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">Replication</code> 에 필요한 전용 계정을 생성해주고, <code class=\"language-text\">Replication</code>을 위한 권한을 부여해 줍니다. <code class=\"language-text\">root</code>를 사용할 경우 보안상 문제가 될 수 있기 때문에, 다음과 같이 <code class=\"language-text\">Slave</code> 권한을 부여해 줍니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token constant\">CREATE</span> <span class=\"token constant\">USER</span> <span class=\"token char\">'master'</span>@<span class=\"token char\">'%'</span> <span class=\"token constant\">IDENTIFIED</span> <span class=\"token constant\">BY</span> 'password'<span class=\"token punctuation\">;</span>\n<span class=\"token constant\">GRANT</span> <span class=\"token constant\">REPLICATION</span> <span class=\"token constant\">SLAVE</span> <span class=\"token constant\">ON</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">.</span>* <span class=\"token constant\">TO</span> <span class=\"token char\">'master'</span>@<span class=\"token char\">'%'</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>그리고 MySQL 설정 변경을 위해 <code class=\"language-text\">my.cnf</code> 파일로 이동하여 값을 수정해줍니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">vim</span> /etc/mysql/my.cnf</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token punctuation\">[</span>mysqld<span class=\"token punctuation\">]</span>\nmax_allowed_packet<span class=\"token operator\">=</span><span class=\"token number\">1000</span>M\nserver<span class=\"token operator\">-</span>id <span class=\"token operator\">=</span> <span class=\"token number\">1</span>\nlog<span class=\"token operator\">-</span>bin <span class=\"token operator\">=</span> mysql<span class=\"token operator\">-</span>bin\nbinlog_format <span class=\"token operator\">=</span> <span class=\"token class-name\">ROW</span>\nmax_binlog_size <span class=\"token operator\">=</span> <span class=\"token number\">500</span>M\nsync_binlog <span class=\"token operator\">=</span> <span class=\"token number\">1</span>\nexpire<span class=\"token operator\">-</span>logs<span class=\"token operator\">-</span>days <span class=\"token operator\">=</span> <span class=\"token number\">7</span>\nbinlog_do_db <span class=\"token operator\">=</span> test</code></pre></div>\n<p>설정들의 세부 값들은 다음과 같습니다.</p>\n<ul>\n<li>max<em>allowed</em>packet : 서버로 질의하거나 받게되는 패킷의 최대 길이를 설정</li>\n<li>server-id : 서버의 ID, 레플리케이션 토플리지(연결된 망)에서는 고유한 각각의 서버 ID를 가져야 함</li>\n<li>log-bin : 바이너리 로그 파일 경로 → (/var/lib/mysql/mysql-bin.XXXXXX<strong>)</strong> 형식으로 저장</li>\n<li>\n<p>binlog_format : 바이너리 로그의 저장 형식을 지정. STATEMENT, ROW, MIXED 3가지 중 하나를 선택이 가능</p>\n<ul>\n<li>해당 설정중 <code class=\"language-text\">ROW</code>를 선택. 그 이유는 현재 <code class=\"language-text\">InnoDB</code>를 사용 중이며, 트랜잭션 격리 수준이 <code class=\"language-text\">READ COMMITTED</code>일 경우 <code class=\"language-text\">ROW</code> 기반 로깅만 사용이 가능.</li>\n</ul>\n</li>\n<li>max<em>binlog</em>size : 바이너리 로그의 최대 크기</li>\n<li>sync_binlog : N개의 트랜잭션 마다 바이너리 로그를 디스크에 동기화 시킬지 결정. 설정한 1은 안정적이지만, 가장 느린 설정임</li>\n<li>expire-logs-days: 바이너리 로그가 만료되는 기간 설정</li>\n<li>binlog<em>do</em>db : 레플리케이션을 적용할 데이터베이스 이름 설정</li>\n</ul>\n<p>설정이 끝났으면 MySQL을 재시작 해줍니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> systemctl restart mysql</code></pre></div>\n<p>그리고 <code class=\"language-text\">Master</code>의 상태를 확인해 잘 반영되었는지 확인합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token constant\">SHOW</span> <span class=\"token constant\">MASTER</span> <span class=\"token constant\">STATUS</span><span class=\"token operator\">:</span></code></pre></div>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/7bd6abe92817db22e1b03707e8f909f2/fcbeb/img_9.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 18.23529411764706%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAnklEQVQY022Q2w6CMBBE+xd4QWOkQLEoBYl4S/z/r1p7ViA8+DCZ3dmd7aQmawZx/VvK60uK7qlASzIv6/wsia1lBWINoyfW/3TmmZ93YGPDXVIXZFs2ykX70Ac4ynE3PRT1aVbGvoqcL7QpjMFgx5TUHN2fOl0mtR8+aj5ebjrbVa2CnUPdSzr2zIDBBDBhpibthsRVmBfR+IIl/mlfa113jWb0AlcAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='img 9' title='img 9' src='/static/7bd6abe92817db22e1b03707e8f909f2/ca1dc/img_9.png' srcset='/static/7bd6abe92817db22e1b03707e8f909f2/e7570/img_9.png 170w,\n/static/7bd6abe92817db22e1b03707e8f909f2/f46e7/img_9.png 340w,\n/static/7bd6abe92817db22e1b03707e8f909f2/ca1dc/img_9.png 680w,\n/static/7bd6abe92817db22e1b03707e8f909f2/02d09/img_9.png 1020w,\n/static/7bd6abe92817db22e1b03707e8f909f2/fcbeb/img_9.png 1206w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<blockquote>\n<p>중요!</p>\n</blockquote>\n<p>레플리케이션에서는 이 <code class=\"language-text\">File</code>과 <code class=\"language-text\">Position</code> 값으로 <code class=\"language-text\">Master - Slave</code> 서버 동기화가 진행이 됩니다. 또한<code class=\"language-text\">File</code>과 <code class=\"language-text\">Position</code>은 데이터베이스에서 어떤 작업을 할 때마다 변경이 됩니다. <code class=\"language-text\">Master DB</code>의 해당 정보들을 <code class=\"language-text\">Slave DB</code>에서 기입해서 사용하기 때문에, 항상 확인 후 <code class=\"language-text\">Master - Slave</code> 연동을 진행해야 합니다.</p>\n<h3>Slave DB Server 작업</h3>\n<p>이어서 위에서 설명했던 내용을 바탕으로 <code class=\"language-text\">Slave DB</code>를 설정해 줍니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token constant\">CREATE</span> <span class=\"token class-name\">DATABASE</span> test<span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token constant\">CREATE</span> <span class=\"token constant\">USER</span> <span class=\"token char\">'slave'</span>@<span class=\"token char\">'%'</span> <span class=\"token constant\">IDENTIFIED</span> <span class=\"token constant\">BY</span> 'password'<span class=\"token punctuation\">;</span>\n<span class=\"token constant\">GRANT</span> <span class=\"token constant\">ALL</span> <span class=\"token constant\">PRIVILEGES</span> <span class=\"token constant\">ON</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">.</span>* <span class=\"token constant\">TO</span> <span class=\"token char\">'slave'</span>@<span class=\"token char\">'%'</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">$ vim <span class=\"token operator\">/</span>etc<span class=\"token operator\">/</span>mysql<span class=\"token operator\">/</span>my<span class=\"token punctuation\">.</span>cnf\n\n<span class=\"token punctuation\">[</span>mysqld<span class=\"token punctuation\">]</span>\n\nmax_allowed_packet<span class=\"token operator\">=</span><span class=\"token number\">1000</span>M\nserver<span class=\"token operator\">-</span>id <span class=\"token operator\">=</span> <span class=\"token number\">2</span>\nlog<span class=\"token operator\">-</span>bin  <span class=\"token operator\">=</span> mysql<span class=\"token operator\">-</span>bin\nbinlog_format   <span class=\"token operator\">=</span> <span class=\"token class-name\">ROW</span>\nmax_binlog_size <span class=\"token operator\">=</span> <span class=\"token number\">500</span>M\nsync_binlog     <span class=\"token operator\">=</span> <span class=\"token number\">1</span>\nexpire<span class=\"token operator\">-</span>logs<span class=\"token operator\">-</span>days<span class=\"token operator\">=</span> <span class=\"token number\">7</span>\nslow_query_log <span class=\"token operator\">=</span> <span class=\"token number\">1</span>\nread_only <span class=\"token operator\">=</span> <span class=\"token number\">1</span></code></pre></div>\n<p>설정을 변경했기 때문에 역시 MySQL을 재시작 해줍니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> systemctl restart mysql</code></pre></div>\n<p>그리고 최종적으로 <code class=\"language-text\">MySQL</code>에서 아래 쿼리를 실행해주면 됩니다. 여기서 <code class=\"language-text\">MASTER_LOG_FILE</code>과  <code class=\"language-text\">MASTER_LOG_POS</code> 값은 아까 <code class=\"language-text\">Master DB STATUS</code>에서 나온 값으로 설정을 하면 됩니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">RESET</span> <span class=\"token constant\">SLAVE</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token constant\">CHANGE</span> <span class=\"token constant\">MASTER</span> <span class=\"token class-name\">TO</span> <span class=\"token constant\">MASTER_HOST</span><span class=\"token operator\">=</span>'xxx<span class=\"token punctuation\">.</span>xxx<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">.</span>xxx'<span class=\"token punctuation\">,</span> <span class=\"token comment\">// private IP</span>\n        <span class=\"token constant\">MASTER_USER</span><span class=\"token operator\">=</span><span class=\"token char\">'master'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token constant\">MASTER_PORT</span><span class=\"token operator\">=</span><span class=\"token number\">8080</span><span class=\"token punctuation\">,</span>                     <span class=\"token comment\">// 내부적인 이슈로 8080 포트로 연결</span>\n        <span class=\"token constant\">MASTER_PASSWORD</span><span class=\"token operator\">=</span>'password'<span class=\"token punctuation\">,</span>\n        <span class=\"token constant\">MASTER_LOG_FILE</span><span class=\"token operator\">=</span>'mysql<span class=\"token operator\">-</span>bin<span class=\"token punctuation\">.</span><span class=\"token number\">00000</span>x'<span class=\"token punctuation\">,</span>\n        <span class=\"token constant\">MASTER_LOG_POS</span><span class=\"token operator\">=</span><span class=\"token number\">157</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\">START</span> <span class=\"token constant\">REPLICA</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>지금까지 잘 설정이 되었다면, 다음 명령어를 입력했을 때 문제가 없다는 것을 확인할 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">show slave status\\<span class=\"token class-name\">G</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 629px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/1b3a1fee510412f41c8f794d99d32f26/7e5f2/img_12.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 114.11764705882352%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAXCAYAAAALHW+jAAAACXBIWXMAAAsTAAALEwEAmpwYAAACpElEQVQ4y52VWXPaUAyFeWs77bSJMZiAAS8YbxgwZt+X7P///6g68lLaCUzog+bahHxXOjoSpWC6I2+8Jn+6pd78wLGX04gmZA3mZA8X1IkXfM7J7E/J4WdrMCOt06Oq3UvPsygVH9ohGb0JDVYnijdPcknTCahhe6S1HTLChNq9MdkMsxhcc6ILwE76oWoGVHcHAhuuHyngjMPZjjS+SDV9qvApYQUSH8EEmKfe9EcCG6weKdm9SulusqRWEJPD5erekFTDowrglv8hLCs5pFq3L5oBiJgc3iiYbKhueVTWTapyyUrDpF+1FkeT7urGdeADAyE6YMnuRYD95YlCzrLF2nXiJTWDJCszugjLSo5EP3QQoGSbAqPFUS7KdcPFuTwSl4Aqf7nhDrkRT4WGk/0budzlsuEXGV3L6i+g7sdZI14Eig4jS9gGmX0WVADrnB0CvkLA1LjATdYXzXsVCI2gD8TH1CBDlAwN0flKrt1ngbk+yC63zfT4LsAOj11ufO0WIDLEWMHMGL3UNkeRovo/GUJ8lDvmCUFmmBSPjZ3DbtPQCos5hn7R4iAdR7ll07+9y81gVJSb+vBEo+2zLAcY++aSAQMUXXZGy7Qx7EcAG16qYTod4VlclqGE7j50B/Iln3VDufHmmY29IU282ZfQskifo4srrITMsDChWW6bESYlWdG9bpHStEnRz8MilbdPi5cFktHObKXl20Y105kFFE2BDwH8+lPhuC/iG79/+XFH35Vqtn3+LFzsBAyBAKEhfIeVhU6P96/SHIxhm38WoDOmBhAje29lz6gwrXJG2AvFPnR458GLmGOUjfUPHfGPMLjuxWKtBp9oFk4AsKnwjqTQCwF2uTwY2uUznO1lUmBspe2mZUlpYVbiP3H2W4O//wZozaCgOuMgWwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='img 12' title='img 12' src='/static/1b3a1fee510412f41c8f794d99d32f26/7e5f2/img_12.png' srcset='/static/1b3a1fee510412f41c8f794d99d32f26/e7570/img_12.png 170w,\n/static/1b3a1fee510412f41c8f794d99d32f26/f46e7/img_12.png 340w,\n/static/1b3a1fee510412f41c8f794d99d32f26/7e5f2/img_12.png 629w' sizes='(max-width: 629px) 100vw, 629px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>추가적으로 <code class=\"language-text\">Master DB</code> 서버에서 테이블 생성과 데이터 생성을 해보면 바로 <code class=\"language-text\">Slave DB</code> 서버에 잘 반영되는 것을 확인할 수 있습니다.</p>\n<p>[Master DB]</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/88e3c52e23d1c8c35efab4512e0ad0b2/9d567/img_10.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 5.294117647058823%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAAAsTAAALEwEAmpwYAAAATElEQVQI1y3JaRJAIACAUTdBtrEklCJjyf3v9DHG3/ci6QO13WncgVwD7XLSrRdqu6nMRtrPCGXJx4Vi8sSdJhscpfafp/+J1xJpeADycB9o9AYL7QAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='img 10' title='img 10' src='/static/88e3c52e23d1c8c35efab4512e0ad0b2/ca1dc/img_10.png' srcset='/static/88e3c52e23d1c8c35efab4512e0ad0b2/e7570/img_10.png 170w,\n/static/88e3c52e23d1c8c35efab4512e0ad0b2/f46e7/img_10.png 340w,\n/static/88e3c52e23d1c8c35efab4512e0ad0b2/ca1dc/img_10.png 680w,\n/static/88e3c52e23d1c8c35efab4512e0ad0b2/02d09/img_10.png 1020w,\n/static/88e3c52e23d1c8c35efab4512e0ad0b2/9d567/img_10.png 1360w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>[Slave DB]</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/3c5f60d8c700d5daa09b5d2a36d78a36/9d567/img_11.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 15.294117647058824%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAATklEQVQI12PQNLP9r2Zs9R9Eg7CsttF/STXd/2Iq2v/FVXVIxgwgw5QNzP/LaRv/l9c1+a+oZ/pfWtOAfANBhikADQEZpKRvBmZLUOBCAO5pVjAd8mCvAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='img 11' title='img 11' src='/static/3c5f60d8c700d5daa09b5d2a36d78a36/ca1dc/img_11.png' srcset='/static/3c5f60d8c700d5daa09b5d2a36d78a36/e7570/img_11.png 170w,\n/static/3c5f60d8c700d5daa09b5d2a36d78a36/f46e7/img_11.png 340w,\n/static/3c5f60d8c700d5daa09b5d2a36d78a36/ca1dc/img_11.png 680w,\n/static/3c5f60d8c700d5daa09b5d2a36d78a36/02d09/img_11.png 1020w,\n/static/3c5f60d8c700d5daa09b5d2a36d78a36/9d567/img_11.png 1360w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<h2>SpringBoot 설정</h2>\n<p>DB 서버를 <code class=\"language-text\">Master - Slave</code> 로 이중화 하였으므로, <code class=\"language-text\">SpringBoot</code>에서 사용하는 <code class=\"language-text\">DataSource</code>도 <code class=\"language-text\">Master - Slave</code>를 각각 사용해야 합니다. 이를 구현하기 위한 방법으로 <code class=\"language-text\">@Transactional</code> 애노테이션의 속성을 이용하여 <code class=\"language-text\">readOnly = false</code>인 트랜잭션은 <code class=\"language-text\">Master DataSource</code>를, <code class=\"language-text\">readOnly = true</code>인 트랜잭션은 <code class=\"language-text\">Slave DataSource</code>를 사용하도록 설정해 주겠습니다.</p>\n<h3>application.yml 설정</h3>\n<p>저는 <code class=\"language-text\">Master 1</code>, <code class=\"language-text\">Slave 2</code> 를 바탕으로 <code class=\"language-text\">Replication</code>을 구성했기 때문에 3개의 <code class=\"language-text\">DataSource</code>에 대한 설정을 작성해주어야 합니다. 여기서 하나 유의해야 할 점은 일반적인 <code class=\"language-text\">DataSource</code> 등록 방법과는 과정이 조금 달라진다는 점입니다.</p>\n<p>하나의 <code class=\"language-text\">DataSource</code>만 사용하는 경우에는 <code class=\"language-text\">SpringBoot AutoConfiguration</code>을 통해서 자동으로 빈으로 만들어져 관리되었지만, 2개 이상의 <code class=\"language-text\">DataSource</code>를 사용하는 경우에는 개발자가 직접 빈을 만들어서 사용해야 합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">datasource</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">master</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">username</span><span class=\"token punctuation\">:</span> master\n      <span class=\"token key atrule\">password</span><span class=\"token punctuation\">:</span> password\n      <span class=\"token key atrule\">driver-class-name</span><span class=\"token punctuation\">:</span> com.mysql.cj.jdbc.Driver\n      <span class=\"token key atrule\">jdbc-url</span><span class=\"token punctuation\">:</span> jdbc<span class=\"token punctuation\">:</span>mysql<span class=\"token punctuation\">:</span>//XXX.XXX.XXX.XXX<span class=\"token punctuation\">:</span>3306/test\n    <span class=\"token key atrule\">slave1</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">username</span><span class=\"token punctuation\">:</span> slave1\n      <span class=\"token key atrule\">password</span><span class=\"token punctuation\">:</span> password\n      <span class=\"token key atrule\">driver-class-name</span><span class=\"token punctuation\">:</span> com.mysql.cj.jdbc.Driver\n      <span class=\"token key atrule\">jdbc-url</span><span class=\"token punctuation\">:</span> jdbc<span class=\"token punctuation\">:</span>mysql<span class=\"token punctuation\">:</span>//XXX.XXX.XXX.XXX<span class=\"token punctuation\">:</span>3306/test\n\t<span class=\"token key atrule\">slave2</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">username</span><span class=\"token punctuation\">:</span> slave2\n      <span class=\"token key atrule\">password</span><span class=\"token punctuation\">:</span> password\n      <span class=\"token key atrule\">driver-class-name</span><span class=\"token punctuation\">:</span> com.mysql.cj.jdbc.Driver\n      <span class=\"token key atrule\">jdbc-url</span><span class=\"token punctuation\">:</span> jdbc<span class=\"token punctuation\">:</span>mysql<span class=\"token punctuation\">:</span>//XXX.XXX.XXX.XXX<span class=\"token punctuation\">:</span>3306/test</code></pre></div>\n<h3>DataSource 빈 등록</h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Configuration</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">DataSourceConfig</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> <span class=\"token constant\">MASTER_SERVER</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"MASTER\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> <span class=\"token constant\">SLAVE1_SERVER</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"SLAVE1\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> <span class=\"token constant\">SLAVE1_SERVER</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"SLAVE2\"</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Bean</span>\n    <span class=\"token annotation punctuation\">@Qualifier</span><span class=\"token punctuation\">(</span><span class=\"token constant\">MASTER_SERVER</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@ConfigurationProperties</span><span class=\"token punctuation\">(</span>prefix <span class=\"token operator\">=</span> <span class=\"token string\">\"spring.datasource.master\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">DataSource</span> <span class=\"token function\">masterDataSource</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">DataSourceBuilder</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Bean</span>\n    <span class=\"token annotation punctuation\">@Qualifier</span><span class=\"token punctuation\">(</span><span class=\"token constant\">SLAVE1_SERVER</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@ConfigurationProperties</span><span class=\"token punctuation\">(</span>prefix <span class=\"token operator\">=</span> <span class=\"token string\">\"spring.datasource.slave1\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">DataSource</span> <span class=\"token function\">slave1DataSource</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">DataSourceBuilder</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Bean</span>\n    <span class=\"token annotation punctuation\">@Qualifier</span><span class=\"token punctuation\">(</span><span class=\"token constant\">SLAVE2_SERVER</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@ConfigurationProperties</span><span class=\"token punctuation\">(</span>prefix <span class=\"token operator\">=</span> <span class=\"token string\">\"spring.datasource.slave2\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">DataSource</span> <span class=\"token function\">slave2DataSource</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">DataSourceBuilder</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>다음과 같이 각 DB 서버에 대응되는 <code class=\"language-text\">DataSource</code> 타입의 빈을 등록하면 됩니다.</p>\n<p>위의 코드를 보면, <code class=\"language-text\">@Qualifier</code> 애노테이션을 사용한 것을 확인할 수 있습니다. 일반적으로 같은 타입 (여기서는 DataSource)의 빈이 2개 이상 등록된 경우 스프링은 어떤 빈을 주입해야 하는지 모릅니다. 이를 해결하기 위해서 <code class=\"language-text\">@Qualifier</code> 애노테이션을 사용하여 <strong>이름을 기반으로 한정자를 명시하여서, 주입받을 빈을 지정</strong>할 수 있도록 만들면 됩니다.</p>\n<p>추가적으로 <code class=\"language-text\">@ConfigurationProperties</code> ****애노테이션을 사용한 것을 확인할 수 있습니다. 해당 애노테이션을 사용하면 <code class=\"language-text\">application.yml</code>에 명시한 여러 설정 중, 특정 <code class=\"language-text\">prefix</code>에 해당하는 설정 값을 자바 빈에 매핑할 수가 있습니다.</p>\n<h3>AbstractRoutingDataSource</h3>\n<p>스프링은 <code class=\"language-text\">Multi DataSource</code> 환경에서 여러 <code class=\"language-text\">DataSource</code>를 묶고 분기해주기 위해서 <code class=\"language-text\">AbstractRoutingDataSource</code>라는 추상 클래스를 지원합니다.</p>\n<p><code class=\"language-text\">AbstractRoutingDataSource</code> 를 살펴보면 다음과 같이 구성되어 있는 것을 확인할 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AbstractRoutingDataSource</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">AbstractDataSource</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">InitializingBean</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token annotation punctuation\">@Nullable</span>\n\t<span class=\"token keyword\">private</span> <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> targetDataSources<span class=\"token punctuation\">;</span>\n\n\t<span class=\"token annotation punctuation\">@Nullable</span>\n\t<span class=\"token keyword\">private</span> <span class=\"token class-name\">Object</span> defaultTargetDataSource<span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">boolean</span> lenientFallback <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">private</span> <span class=\"token class-name\">DataSourceLookup</span> dataSourceLookup <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">JndiDataSourceLookup</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token annotation punctuation\">@Nullable</span>\n\t<span class=\"token keyword\">private</span> <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">DataSource</span><span class=\"token punctuation\">></span></span> resolvedDataSources<span class=\"token punctuation\">;</span>\n\n\t<span class=\"token annotation punctuation\">@Nullable</span>\n\t<span class=\"token keyword\">private</span> <span class=\"token class-name\">DataSource</span> resolvedDefaultDataSource<span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">setTargetDataSources</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> targetDataSources<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>targetDataSources <span class=\"token operator\">=</span> targetDataSources<span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n\t<span class=\"token keyword\">protected</span> <span class=\"token class-name\">DataSource</span> <span class=\"token function\">determineTargetDataSource</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token class-name\">Assert</span><span class=\"token punctuation\">.</span><span class=\"token function\">notNull</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>resolvedDataSources<span class=\"token punctuation\">,</span> <span class=\"token string\">\"DataSource router not initialized\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token class-name\">Object</span> lookupKey <span class=\"token operator\">=</span> <span class=\"token function\">determineCurrentLookupKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token class-name\">DataSource</span> dataSource <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>resolvedDataSources<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>lookupKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>dataSource <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>lenientFallback <span class=\"token operator\">||</span> lookupKey <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\tdataSource <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>resolvedDefaultDataSource<span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>dataSource <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalStateException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Cannot determine target DataSource for lookup key [\"</span> <span class=\"token operator\">+</span> lookupKey <span class=\"token operator\">+</span> <span class=\"token string\">\"]\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t\t<span class=\"token keyword\">return</span> dataSource<span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위의 코드를 보면 <code class=\"language-text\">setTargetDataSources()</code>라는 메서드를 통해 <code class=\"language-text\">Map</code>을 전달합니다. 이때 <code class=\"language-text\">Map</code>의 <code class=\"language-text\">Value</code>로는 <code class=\"language-text\">DataSource</code>를 전달합니다. 전달된 <code class=\"language-text\">DataSource</code>는 <code class=\"language-text\">Map</code>의 <code class=\"language-text\">Key</code>를 통해서 찾을 수 있습니다.</p>\n<p>또한 <code class=\"language-text\">determineTargetDataSource()</code>메서드를 보면 실제로 사용된 <code class=\"language-text\">DataSource</code>를 결정합니다. 내부 코드를 확인해보면 <code class=\"language-text\">determineCurrentLookupKey()</code> 라는 메서드를 사용해서 가져올 <code class=\"language-text\">DataSource</code>의 <code class=\"language-text\">Key</code>를 결정합니다.</p>\n<p>실제 저희가 이를 활용하기 위해서 <code class=\"language-text\">AbstractRoutingDataSource</code> 를 상속받는 구체 클래스를 만들어서 위에서 언급한 <code class=\"language-text\">determineCurrentLookupKey()</code>메서드를 오버라이드하여 트랜잭션의 <code class=\"language-text\">readOnly</code> 값에 따라 다른 <code class=\"language-text\">DataSource</code> 의 <code class=\"language-text\">Key</code>를 반환하도록 구현하겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">RoutingDataSource</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">AbstractRoutingDataSource</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">RoutingCircular</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> routingCircular<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">setTargetDataSources</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> targetDataSources<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">setTargetDataSources</span><span class=\"token punctuation\">(</span>targetDataSources<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        routingCircular <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RoutingCircular</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span>\n                targetDataSources<span class=\"token punctuation\">.</span><span class=\"token function\">keySet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                        <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span><span class=\"token operator\">::</span><span class=\"token function\">toString</span><span class=\"token punctuation\">)</span>\n                        <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>key <span class=\"token operator\">-></span> key<span class=\"token punctuation\">.</span><span class=\"token function\">contains</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"slave\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                        <span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collectors</span><span class=\"token punctuation\">.</span><span class=\"token function\">toList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\t\t\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">protected</span> <span class=\"token class-name\">Object</span> <span class=\"token function\">determineCurrentLookupKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">boolean</span> isReadOnly <span class=\"token operator\">=</span> <span class=\"token class-name\">TransactionSynchronizationManager</span><span class=\"token punctuation\">.</span><span class=\"token function\">isCurrentTransactionReadOnly</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isReadOnly<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> routingCircular<span class=\"token punctuation\">.</span><span class=\"token function\">getOne</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> <span class=\"token string\">\"master\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span> </code></pre></div>\n<p>해당 코드를 보면, <code class=\"language-text\">TransactionSynchronizationManager</code>의 <code class=\"language-text\">isCurrentTransactionReadOnly()</code>라는 메서드를 사용하였는데, 이를 통해서 현재 트랜잭션의 <code class=\"language-text\">read-only</code> 여부를 확인할 수 있습니다.</p>\n<h3>Slave DB의 다중화 처리</h3>\n<p>위의 코드에서는 한가지 설명하지 않은 부분이 있습니다. 바로 <code class=\"language-text\">setTargetDataSources()</code>과 관련된 설명인데요. 저는 <strong><code class=\"language-text\">Slave DB</code>를 2개 이상 사용하려고 하기 때문에 <code class=\"language-text\">readOnly</code> 속성만으로는 이를 해결할 수 없습니다</strong>. 이를 해결하기 위해서 <code class=\"language-text\">Slave DB</code>를 번갈아서 사용하도록 기능을 추가해주도록 하겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">RoutingCircular</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> dataSources<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Integer</span> counter <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n        \n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">RoutingCircular</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> dataSources<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>dataSources <span class=\"token operator\">=</span> dataSources<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\t\t\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">T</span> <span class=\"token function\">getOne</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">int</span> circularSize <span class=\"token operator\">=</span> dataSources<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>counter <span class=\"token operator\">+</span> <span class=\"token number\">1</span> <span class=\"token operator\">></span> circularSize<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            counter <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> dataSources<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>counter<span class=\"token operator\">++</span> <span class=\"token operator\">%</span> circularSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>다음과 같이 <code class=\"language-text\">RoutingCircular</code> 클래스를 만들어 통해서 <strong>여러개의 <code class=\"language-text\">Slave DB</code>의 <code class=\"language-text\">DataSource</code>를 순서대로 로드밸런싱</strong> 할 수 있게 됩니다.</p>\n<h3>라우팅할 DataSource 등록하기</h3>\n<p>지금까지 위에서 만든 <code class=\"language-text\">RoutingDataSource</code>에 우리가 사용할 3가지의 <code class=\"language-text\">DataSource</code> 정보를 등록하고, 이를 빈으로 만들어서 최종적으로 스프링에서 관리되도록 작업을 처리해주겠습니다. <code class=\"language-text\">@Qualifier</code>를 이용해서 어떤 빈을 주입받을 것인지 명확히 지시해서 작업을 진행합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Bean</span>\n<span class=\"token keyword\">public</span> <span class=\"token class-name\">DataSource</span> <span class=\"token function\">routingDataSource</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@Qualifier</span><span class=\"token punctuation\">(</span><span class=\"token constant\">MASTER_SERVER</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">DataSource</span> masterDataSource<span class=\"token punctuation\">,</span>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<span class=\"token annotation punctuation\">@Qualifier</span><span class=\"token punctuation\">(</span><span class=\"token constant\">SLAVE1_SERVER</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">DataSource</span> slave1DataSource<span class=\"token punctuation\">,</span>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<span class=\"token annotation punctuation\">@Qualifier</span><span class=\"token punctuation\">(</span><span class=\"token constant\">SLAVE2_SERVER</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">DataSource</span> slave2DataSoucre<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">RoutingDataSource</span> routingDataSource <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RoutingDataSource</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">HashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> dataSources <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    dataSources<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"master\"</span><span class=\"token punctuation\">,</span> masterDataSource<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    dataSources<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"slave1\"</span><span class=\"token punctuation\">,</span> slave1DataSource<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    dataSources<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"slave2\"</span><span class=\"token punctuation\">,</span> slave2DataSource<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    routingDataSource<span class=\"token punctuation\">.</span><span class=\"token function\">setTargetDataSources</span><span class=\"token punctuation\">(</span>dataSources<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    routingDataSource<span class=\"token punctuation\">.</span><span class=\"token function\">setDefaultTargetDataSource</span><span class=\"token punctuation\">(</span>masterDataSource<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> routingDataSource<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>해당 과정을 통해서 우리가 구현한 <code class=\"language-text\">RoutingDataSource</code>의 인스턴스를 생성한 뒤, 등록해 줄 각각의 <code class=\"language-text\">DataSource</code>를 <code class=\"language-text\">String Type</code>의 <code class=\"language-text\">Key</code>로 매핑하고, 기본 <code class=\"language-text\">DataSource</code>를 <code class=\"language-text\">Master</code>로 지정한 뒤 <code class=\"language-text\">Bean</code>으로 등록을 해줄 수 있습니다.</p>\n<p>그리고 실제 <code class=\"language-text\">Spring Boot</code>에서 사용하게 될 <code class=\"language-text\">DataSource</code> 를 만드는 작업을 수행하면 됩니다. <strong>여기서 고려해야 할 점은 스프링이 <code class=\"language-text\">DataSource</code>를 통해 <code class=\"language-text\">Connection</code>을 획득하는 일련의 주기에 대해서 확인할 필요가 있습니다.</strong></p>\n<h3>Spring의 Connection 획득 방법과 LazyConnection 처리</h3>\n<p>스프링은 트랜잭션에 진입하기만 하면 바로 <code class=\"language-text\">DataSource</code>를 가져와서 <code class=\"language-text\">Connection</code>을 가져옵니다. 말로만 하면 너무 추상적이니 Spring에서 Transactional을 처리하는 과정을 자세하게 한번 알아봅시다. 밑에 정리된 순서대로 Spring Transactional이 동작을 하게 됩니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token number\">1.</span> <span class=\"token class-name\">CglibAopProxy<span class=\"token punctuation\">.</span>DynamicAdvisedInterceptor</span><span class=\"token punctuation\">.</span><span class=\"token function\">intercept</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">)</span>\n\n<span class=\"token number\">2.</span> <span class=\"token class-name\">TransactionInterceptor</span><span class=\"token punctuation\">.</span><span class=\"token function\">invoke</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">)</span>\n\n<span class=\"token number\">3.</span> <span class=\"token class-name\">TransactionAspectSupport</span><span class=\"token punctuation\">.</span><span class=\"token function\">invokeWithinTransaction</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">)</span>\n\n<span class=\"token number\">4.</span> <span class=\"token class-name\">TransactionAspectSupport</span><span class=\"token punctuation\">.</span><span class=\"token function\">createTransactionIfNecessary</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">)</span>\n\n<span class=\"token number\">5.</span> <span class=\"token class-name\">AbstractPlatformTransactionManager</span><span class=\"token punctuation\">.</span><span class=\"token function\">getTransaction</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">)</span>\n\n<span class=\"token number\">6.</span> <span class=\"token class-name\">AbstractPlatformTransactionManager</span><span class=\"token punctuation\">.</span><span class=\"token function\">startTransaction</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">)</span>\n\n<span class=\"token number\">7.</span> <span class=\"token class-name\">AbstractPlatformTransactionManager</span><span class=\"token punctuation\">.</span><span class=\"token function\">begin</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">)</span>\n\n<span class=\"token number\">8.</span> <span class=\"token class-name\">AbstractPlatformTransactionManager</span><span class=\"token punctuation\">.</span><span class=\"token function\">prepareSynchronization</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">)</span>\n\n<span class=\"token number\">9.</span> <span class=\"token class-name\">TransactionAspectSupport</span><span class=\"token punctuation\">.</span><span class=\"token function\">invokeWithinTransaction</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">)</span>\n\n<span class=\"token number\">10.</span> <span class=\"token class-name\">InvocationCallback</span><span class=\"token punctuation\">.</span><span class=\"token function\">proceedWithInvocation</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">)</span>\n\n<span class=\"token number\">11.</span> <span class=\"token annotation punctuation\">@Transactional</span>이 적용된 실제 타깃이 실행</code></pre></div>\n<p>우리가 여기서 꼭 확인해봐야 할 부분은 7번과 8번 과정입니다. Spring AOP는 7번 과정에서 <code class=\"language-text\">DataSource</code>로 부터 <code class=\"language-text\">Connection</code>을 가져오고 8번 과정에서 트랜잭션의 현재 상태를 <code class=\"language-text\">ThreadLocal</code>에 저장을 하게 됩니다. 즉, <code class=\"language-text\">TransactionSynchronizationManager</code>에 트랜잭션의 정보를 동기화 하는 작업이 <code class=\"language-text\">DataSource</code>로 부터 <code class=\"language-text\">Connection</code>을 가져온 이후에 실행이 된다는 것입니다.</p>\n<p>이때까지의 내용을 그림으로 정리하면 다음과 같습니다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/d047ec358a90f192e103890821624d70/c0ee7/img_5.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 28.82352941176471%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABFElEQVQY052RvUoDQRSFF6ys7NXCzmewCIitVlZ5B1vBxhRCQLCwtTSoiIV2gkRRfA7R/CALYYlJJrsxuzNz53MyCkqwEA98nOLOnDuciZiSiMM5wYn5HecCSIHqJ/S6HcZZH9xkBlGz1ea6fue5p/0a8ydJDibF6ndMkSE6wxUDfB7RbvWAmfllorklKvuH4fwweUKea0jjDHk5/fITpHXJeKRIVdcHjdDGkucF1piwIARu7ewRzS56FtiuVNEWVPMBc7OCuV3D1Fe//XGTt06DQc8H5ilJkhDHMelQ+cDsM/Do+JzSepnSRpnaxVV4oTHaVzKawl+wY4wVbJGGDn/K6TR4xH80+QDfmRQqEPrTKow+ACY5tiYTZk2tAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='img 5' title='img 5' src='/static/d047ec358a90f192e103890821624d70/ca1dc/img_5.png' srcset='/static/d047ec358a90f192e103890821624d70/e7570/img_5.png 170w,\n/static/d047ec358a90f192e103890821624d70/f46e7/img_5.png 340w,\n/static/d047ec358a90f192e103890821624d70/ca1dc/img_5.png 680w,\n/static/d047ec358a90f192e103890821624d70/02d09/img_5.png 1020w,\n/static/d047ec358a90f192e103890821624d70/9d567/img_5.png 1360w,\n/static/d047ec358a90f192e103890821624d70/c0ee7/img_5.png 1870w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>하지만 저희는 Replication을 위해서 <code class=\"language-text\">AbstractRoutingDataSource</code>을 구현하여 트랜잭션 속성에 따라 <code class=\"language-text\">DataSource</code>를 선택해서 선택한 <code class=\"language-text\">DataSource</code>의 <code class=\"language-text\">Connection</code>객체를 리턴할 수 있도록 구현을 해야 했습니다.</p>\n<p>이러한 문제를 해결하기 위해서 <code class=\"language-text\">Spring</code>에서는 <code class=\"language-text\">LazyConnectionDataSourceProxy</code> 을 제공합니다. <code class=\"language-text\">Spring Docs</code>를 확인해보면 다음과 같은 내용을 확인할 수 있습니다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/f9ff4bb6d27ebd645a22301749d8001b/25af7/img_6.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 26.47058823529412%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAvUlEQVQY022QyQrDMAxE/f8/GEIWO3vs7AnBvoRpR+DSQg+PEcLyjKSGYUCapkKWZSjLUpQkSYI8z1FVFYwxom3bwjkLay36vhcdx1HY9x3qvm9s24bjOETJeZ6felmWH67rQggB3vu3+q864HkeKOecODdNA2006rqG1lrc53mWBHxD/UdMx5pmiinYmKZJBqk8w7qukjTCx9yCcDUq+7FH5EMOMl3XdZKOdaQoCumReEeacobG3ICwjud4AdYudd17gQUfAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='img 6' title='img 6' src='/static/f9ff4bb6d27ebd645a22301749d8001b/ca1dc/img_6.png' srcset='/static/f9ff4bb6d27ebd645a22301749d8001b/e7570/img_6.png 170w,\n/static/f9ff4bb6d27ebd645a22301749d8001b/f46e7/img_6.png 340w,\n/static/f9ff4bb6d27ebd645a22301749d8001b/ca1dc/img_6.png 680w,\n/static/f9ff4bb6d27ebd645a22301749d8001b/02d09/img_6.png 1020w,\n/static/f9ff4bb6d27ebd645a22301749d8001b/9d567/img_6.png 1360w,\n/static/f9ff4bb6d27ebd645a22301749d8001b/25af7/img_6.png 1608w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>즉, 실제 쿼리를 호출하기 전까지 <code class=\"language-text\">JDBC Connection</code>을 가져오지 않고 <code class=\"language-text\">Connection Proxy</code>를 주고, 대상 메서드 안에서 쿼리가 실제 발생할 때 우리가 작성한 <code class=\"language-text\">AbstractRoutingDataSource</code> 에서 <code class=\"language-text\">Connection</code>을 얻어 쿼리를 실행하도록 로직을 구현할 수 있습니다.</p>\n<p>설명이 굉장히 길었는데요. 이제 밑의 코드와 같이 설정을 해주면 저희가 원하는데로 <code class=\"language-text\">DataSource</code>를 가져올 수 있게 됩니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Bean</span>\n<span class=\"token annotation punctuation\">@Primary</span>\n<span class=\"token keyword\">public</span> <span class=\"token class-name\">DataSource</span> <span class=\"token function\">dataSource</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">DataSource</span> determinedDataSource <span class=\"token operator\">=</span> <span class=\"token function\">routingDataSource</span><span class=\"token punctuation\">(</span><span class=\"token function\">masterDataSource</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">slave1DataSource</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">slave2DataSource</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">LazyConnectionDataSourceProxy</span><span class=\"token punctuation\">(</span>determinedDataSource<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/03cc3f3d23c5758f89c8351ea8b5fbd7/c0ee7/img_7.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 45.88235294117647%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABqUlEQVQoz42Su2sUURTGB2ysUlmlTWeXv0LwgYggETtFW8HSylpsUlkIIkos0mRjChFcYxDSWSiJJMw+kmx2Mzubmd2dmd29u/fx886dTUANkgPfPfcx853vHD4PG8aYU7izEhbDKUYF5NDd/y/yv72cRCnloO3FJAuQ3+4hy1eRX28hv1xHrt8s8uYD5KjLuJfQrlUJqlVaFZ/A7kUc58rw/q4ySCN08yP6oIRurNm8avMHm1fQrc/I8QARhkTtDu1m4JD1U3Svi5lM8Pr9hGfPX/DwyVPeLa9wnjBxB5nsMQy3GHW2IatjepEdi8SrHxxyYfYy3sVZrt29TzqYEO+uodZv2JZvF21v3EGVr5Dsb3AU9hBBC9MoobYXUTsvkf5rjBXmFO43mszMzeNdmmPh0WOnQES76MobdG3J4r2Dqb0lO/aJuykmChGtTbJKiaG/zGDvEyRTwrFdfv7a4fuPLXLy87V8jAnK6Lot6L/CHK5iTgj/+fjUQuoMaGcNHR4VM8tJ0sy2G6M7gbWVOrGNLmyj9R+kZxVyezt8I6xXxWgK4dTl778BpWaYVY2/54UAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='img 7' title='img 7' src='/static/03cc3f3d23c5758f89c8351ea8b5fbd7/ca1dc/img_7.png' srcset='/static/03cc3f3d23c5758f89c8351ea8b5fbd7/e7570/img_7.png 170w,\n/static/03cc3f3d23c5758f89c8351ea8b5fbd7/f46e7/img_7.png 340w,\n/static/03cc3f3d23c5758f89c8351ea8b5fbd7/ca1dc/img_7.png 680w,\n/static/03cc3f3d23c5758f89c8351ea8b5fbd7/02d09/img_7.png 1020w,\n/static/03cc3f3d23c5758f89c8351ea8b5fbd7/9d567/img_7.png 1360w,\n/static/03cc3f3d23c5758f89c8351ea8b5fbd7/c0ee7/img_7.png 1870w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>여기서 <code class=\"language-text\">@Primary</code> 애노테이션을 작성해준 것을 확인할 수 있는데, 기본적으로 <code class=\"language-text\">Spring Boot</code>의 <code class=\"language-text\">AutoConfiguration</code>은 한 개의 <code class=\"language-text\">DataSource</code>를 가정하고 설정이 되어 있습니다. 현재는 여러 개의 <code class=\"language-text\">DataSource</code>를 사용하는 경우이기 때문에, <code class=\"language-text\">@Primary</code> 애노테이션을 붙여주어서 <code class=\"language-text\">DataSource</code>에 대한 지정을 해주어야 합니다.</p>\n<p>지금까지 과정이 성공적으로 수행이 되었다면 <code class=\"language-text\">Replication</code>을 정상적으로 동작시킬 수 있습니다.</p>\n<h2>Replication 설계를 하면서 고려한 문제들과 앞으로의 개선방향</h2>\n<h3>데이터 정합성 문제</h3>\n<p>이번 작업을 하면서 가장 고민을 했던 부분입니다.  만약 실시간으로 계속 쿠폰이 발행되고, 한쪽에서는 계속 조회되는 환경이라면 동기화 이전 시점에 조회를 하게 될 경우 <code class=\"language-text\">NPE</code>가 발생하게 될 가능성은 남아있었습니다. 이를 해결하기 위해 다양한 방법을 고민해보았는데 2가지 정도의 방법을 찾을 수 있었습니다.</p>\n<p>첫번째 방법은 <strong>반동기(Semi Async)</strong> 방식입니다. <code class=\"language-text\">MySQL Docs</code>를 살펴보면 <strong>비동기(Async)</strong> 방식이 아닌 <strong>반동기(Semi Async)</strong> 방식을 사용할 수 있다고도 나와있습니다. 해당 방법을 통해서 DB의 성능을 조금 포기하고, <code class=\"language-text\">Master - Slave</code>의 동기화를 조금 더 보장해줍니다. 하지만 이 방식은 <code class=\"language-text\">Master</code>가 특정 세션의 트랜잭션을 처리하기 위해서 <code class=\"language-text\">Slave</code>들 중 적어도 1개가 <code class=\"language-text\">ACK</code> 하거나 <code class=\"language-text\">timed out</code>에 도달할 때까지 기다리기 때문에 성능에 악영향을 미쳐 <code class=\"language-text\">Replication</code>의 이점을 살리지 못한다는 생각이 들었습니다.</p>\n<p>두번째 방법은 <strong>타입 스탬프</strong> 방식입니다. 최근 N초 ~ N분 까지의 갱신 내역은 <code class=\"language-text\">Master</code>에서 읽고, 이후 내역은 <code class=\"language-text\">Slave</code> 에서 읽는 방법이라고 할 수 있습니다. 이 방법은 <code class=\"language-text\">Master</code>에 트래픽이 많이 몰려 <code class=\"language-text\">Master</code>의 장애 위험이 높다는 생각이 들었습니다.</p>\n<p>결론적으로 저는 지금처럼 <code class=\"language-text\">MySQL Replication</code>에서 기본적으로 제공하는 <strong>비동기</strong> 방식으로 처리를 하고, 데이터 불일치 현상을 다른 방식으로 해결하기로 결론을 내렸습니다.</p>\n<p>현재 생각하는 해결방법은 <strong>정합성이 중요한 로직에서는 조회 요청 역시 <code class=\"language-text\">Master DB</code>를 타게끔 설정하는 것</strong> 입니다. 물론 <code class=\"language-text\">Master DB</code>의 부하가 생기겠지만, <code class=\"language-text\">Replication</code>을 진행하지 않았을 때보다는 훨씬 부하를 분산시킬 수 있기 때문에 현재 가용할 수 있는 최대한의 <code class=\"language-text\">Scale - up</code>을 한 후, <code class=\"language-text\">Master DB</code>를 통해 정합성 문제를 처리하기로 결론을 내렸습니다.</p>\n<h3>Master 장애시 Slave의 승격 여부</h3>\n<p>만약 <code class=\"language-text\">Master</code>가 장애가 난다면 <code class=\"language-text\">Slave</code> 하나를 승격시켜서 이를 <code class=\"language-text\">Master</code> 처럼 사용해야 할 것입니다. 지금 구조에서 문제라고 생각하는 점은 <code class=\"language-text\">Master</code> 장애시 관리자가 수동으로 이를 처리해야 한다는 점입니다.</p>\n<p>이러한 문제를 <code class=\"language-text\">Group Replicaiton</code>으로 해결해줄 수 있다고 합니다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/b43b3b2a4d2983419700510021171b73/03d4c/img_8.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 61.1764705882353%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAABr0lEQVQoz22S14oCURBE7/9/jj74og+KCmbMOeecBWMtp2EW2Z2By9xQXV3V3U5f3+fzscV3Op3U6/W02WxULpfVarVs3+/3dbvdfvF/P/dN5v3v97uOx6PW67W2262SyaTS6bTtl8ulDoeDYfxI/xECrNfryuVyymQyCgQCajQams/nSqVSms1mRjqdTv0JPZvew/V6teBqtapoNKpsNmtWV6uVJSkUCvY+mUwM/36/9c3h5PNRp1AopHg8rlqtpsFgoOFwqFgspnA4rEgkovF47Bcq93g8tFgszAZBqCgWixqNRkbsNSSfz6tUKhk5Z/ZgwRGPi9frJUfhucQqYM5e0ff7vS6Xi9UNi2B4P5/P1iDuiaXrKIbU8dDpdEwdmfjTDBTRXRoEiRfMOEEMjiTUs9vt2vtut5NDTaVSsTEBSBaawZgEg8HfzmKfhjCbCEgkEqYMB3ScZHA5WLnAHmpZNIJgagkRCxWUhEDscSYGASzc4cQsAwIAUbvdtgZRQ68cNAFlEKMCZezB4w4MZxK45/NpM8aCgCxko/CUwZvJZrNpbwRx7ykjObHcM4c/UAV72WlNxcYAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='img 8' title='img 8' src='/static/b43b3b2a4d2983419700510021171b73/ca1dc/img_8.png' srcset='/static/b43b3b2a4d2983419700510021171b73/e7570/img_8.png 170w,\n/static/b43b3b2a4d2983419700510021171b73/f46e7/img_8.png 340w,\n/static/b43b3b2a4d2983419700510021171b73/ca1dc/img_8.png 680w,\n/static/b43b3b2a4d2983419700510021171b73/02d09/img_8.png 1020w,\n/static/b43b3b2a4d2983419700510021171b73/03d4c/img_8.png 1266w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p><code class=\"language-text\">Group Replication</code>을 사용하면 <code class=\"language-text\">Master DB</code> 장애시 자동으로 <code class=\"language-text\">Slave DB</code>가 <code class=\"language-text\">Master DB</code>로 승격되는 장점이 있습니다. 이러한 이유 때문에 현재 구조인 <code class=\"language-text\">Master - Slave Replication</code> 구조에서 <code class=\"language-text\">Group Replication</code>으로 변경하는 것이 조금 더 장애 대처에 좋을 것이라 생각이 드는데 정확한 내용은 조금 더 학습을 해봐야 할 것으로 보입니다.</p>\n<h2>Replication 작업 과정에서 겪을 수도 있는 문제들</h2>\n<h3>Public key retrieval is not allowed</h3>\n<p>MySQL DB에 접속하려면 기본적으로 url, username, password 3가지 옵션이 필요합니다. 하지만 MySQL 8.0 버전부터는 보안적인 이슈로 <code class=\"language-text\">useSSL</code> 옵션에 대한 추가적인 설정이 필요합니다.</p>\n<p>다음 두 가지 옵션이 필요한데 이는 다음과 같습니다.</p>\n<ul>\n<li>useSSL : DB에 SSL로 연결</li>\n<li>allowPublicKeyRetrieval: 클라이언트가 서버에서 공개키를 자동으로 요청할 수 있도록 설정</li>\n</ul>\n<p>최종적으로 <code class=\"language-text\">application.yml</code>에 2가지 속성을 추가해주면 정상적으로 연결이 됩니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\">jdbc<span class=\"token punctuation\">:</span>mysql<span class=\"token punctuation\">:</span>//xxx.xxx.xx.x<span class=\"token punctuation\">:</span>3306/test_db<span class=\"token punctuation\">?</span>useSSL=false<span class=\"token important\">&amp;allowPublicKeyRetrieval=true</span></code></pre></div>\n<h3>caching<em>sha2</em>password authentication plugin</h3>\n<p>MySQL 8.0은 <code class=\"language-text\">SHA-246 hasing</code>을 구현하는 두 가지 인증 플러그인을 지원합니다.</p>\n<ul>\n<li>sha256_password : 기본적인 SHA-256 인증을 구현한 플러그인</li>\n<li>caching<em>sha2</em>password : sha256_password와 동일한데 성능 향상을 위해 서버 캐싱을 이용</li>\n</ul>\n<p>문제는 <code class=\"language-text\">caching_sha2_password</code>를 사용하려면 다음 조건 중 하나가 만족해야 한다는 점입니다.</p>\n<ul>\n<li>SSL 보안연결을 사용</li>\n<li>RSA 보안을 적용한 비암호 연결을 사용</li>\n</ul>\n<p>하지만 저는 테스트 용으로 로컬에서 작업을 하고 있었기 때문에 보안 연결을 사용하지 않아 아래와 같은 문제가 발생했었습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">Last_IO_Error</span><span class=\"token operator\">:</span> error connecting <span class=\"token keyword\">to</span> <span class=\"token namespace\">master</span> 'replication<span class=\"token annotation punctuation\">@test</span><span class=\"token operator\">:</span><span class=\"token number\">3306</span>' <span class=\"token operator\">-</span> retry<span class=\"token operator\">-</span>time<span class=\"token operator\">:</span> <span class=\"token number\">60</span> retries<span class=\"token operator\">:</span> <span class=\"token number\">1</span> message<span class=\"token operator\">:</span> <span class=\"token class-name\">Authentication</span> plugin 'caching_sha2_password' reported error<span class=\"token operator\">:</span> <span class=\"token class-name\">Authentication</span> <span class=\"token keyword\">requires</span> <span class=\"token namespace\">secure</span> connection<span class=\"token punctuation\">.</span></code></pre></div>\n<p>이를 해결하는 방법은 이전의 <code class=\"language-text\">mysql_native_password</code>를 사용하면 됩니다. 사용자의 암호를 <code class=\"language-text\">DDL</code>을 통해서 이전 방식으로 변경할 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">mysql<span class=\"token operator\">></span> ALTER <span class=\"token environment constant\">USER</span> <span class=\"token string\">'replication'</span>@<span class=\"token string\">'%'</span> IDENTIFIED WITH mysql_native_password BY <span class=\"token string\">'password'</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>그리고 MySQL을 재시작하면 정상적으로 MySQL에 접속할 수 있는 것을 확인할 수 있습니다.</p>\n<p>단, 해당 방식은 MySQL이 지원하는 예전 방식이기 때문에 실제로 운영환경에서는 보안 작업을 처리한 후, 사용하는게 좋을 것으로 보입니다.</p>\n<h2>마무리</h2>\n<p>지금까지 MySQL의 Replication 과 Spring Boot에서의 활용방법에 대해서 학습한 내용과 고민한 부분을 작성해보았습니다. (추가적으로 성능 테스트 결과를 보충해서 작성할 예정입니다) 위에서 소개된 방법들이 정답은 아니기 때문에, 앞으로도 조금 더 DB Scale-out에 대해서 고민을 해봐야겠습니다.</p>\n<blockquote>\n<p>참고한 곳</p>\n</blockquote>\n<ul>\n<li><a href=\"https://docs.spring.io/spring-framework/docs/4.2.x/spring-framework-reference/html/transaction.html\">https://docs.spring.io/spring-framework/docs/4.2.x/spring-framework-reference/html/transaction.html</a></li>\n<li><a href=\"https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/jdbc/datasource/LazyConnectionDataSourceProxy.html\">https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/jdbc/datasource/LazyConnectionDataSourceProxy.html</a></li>\n<li><a href=\"https://ssup2.github.io/theory_analysis/MySQL_Replication/\">https://ssup2.github.io/theory<em>analysis/MySQL</em>Replication/</a></li>\n<li><a href=\"https://backtony.github.io/spring/mysql/aws/2021-09-28-spring-mysql-1/\">https://backtony.github.io/spring/mysql/aws/2021-09-28-spring-mysql-1/</a></li>\n<li><a href=\"https://trandent.com/article/etc/detail/320833\">https://trandent.com/article/etc/detail/320833</a></li>\n</ul>","frontmatter":{"title":"Replication과 Spring Boot","date":"October 16, 2022","update":"October 16, 2022","tags":["Replication"],"series":null},"fields":{"slug":"/Replication과-SpringBoot/","readingTime":{"minutes":31.29}}},"seriesList":{"edges":[{"node":{"id":"863212f2-1cb1-5101-804a-5416ffb5b9d3","fields":{"slug":"/Nginx와-Gzip을-활용한-프론트-최적화/"},"frontmatter":{"title":"Nginx와 Gzip을 활용한 프론트 최적화"}}},{"node":{"id":"4c21b76a-ad6b-5e0b-b0e7-a0c0e94b12a9","fields":{"slug":"/Replication과-SpringBoot/"},"frontmatter":{"title":"Replication과 Spring Boot"}}}]},"previous":{"fields":{"slug":"/Nginx와-Gzip을-활용한-프론트-최적화/"},"frontmatter":{"title":"Nginx와 Gzip을 활용한 프론트 최적화"}},"next":{"fields":{"slug":"/Transactional과-Lock-1/"},"frontmatter":{"title":"Transactional과-Lock-1"}}},"pageContext":{"id":"4c21b76a-ad6b-5e0b-b0e7-a0c0e94b12a9","series":null,"previousPostId":"863212f2-1cb1-5101-804a-5416ffb5b9d3","nextPostId":"d0b1bfd4-e5bc-5544-8671-7428d41327c9"}},"staticQueryHashes":[]}