{"componentChunkName":"component---src-templates-post-jsx","path":"/JpaTransactionManager는 JDBC도 처리해준다/","result":{"data":{"site":{"siteMetadata":{"title":"rookie"}},"markdownRemark":{"id":"5d3cba24-3007-5309-a0f7-2430e555a818","excerpt":"스프링은 트랜잭션 처리에 대한 추상화를 제공하기 때문에 제공되는 PlatformTransactionManager(정확하게는 AbstractTransactionManager)를 기준으로 여러 형태의 트랜잭션 제공 기술들을 사용할 수 있도록 기능을 제공하고 있습니다. 직접 JpaTransactionManager를 확인해보면, JDBC를 사용하기 위해서는 Da…","html":"<p>스프링은 트랜잭션 처리에 대한 추상화를 제공하기 때문에 제공되는 <strong>PlatformTransactionManager</strong>(정확하게는 AbstractTransactionManager)를 기준으로 여러 형태의 트랜잭션 제공 기술들을 사용할 수 있도록 기능을 제공하고 있습니다.</p>\n<p>직접 <strong>JpaTransactionManager</strong>를 확인해보면, JDBC를 사용하기 위해서는 <strong>DataSourceTransactionManager</strong>를, JPA의 구현체인 Hibernate에 대한 트랜잭션을 사용하기 위해서는 <strong>HibernateTransactionManager</strong>를, JPA에 대해서는 <strong>JpaTransactionManager</strong>를 지원하고 있습니다.</p>\n<p>여기서 문득 궁금증이 생겼던 점은 프로젝트에서 JPA와 JDBC를 둘다 사용하고 있음에도 불구하고 <strong>TransactionManager</strong>를 변경하는 작업을 해준적이 없다는 점입니다.</p>\n<h2>JpaTransactionManger는 JDBC도 지원을 한다.</h2>\n<p>놀랍게도 <strong>JpaTransactionManager</strong>는 동일한 데이터베이스에 대해 JPA 형태의 접근 방식과 JDBC 형태의 DB 접근 방식이 섞여 있는 하나의 기능에 대해 온전한 트랜잭션을 제공하고 있습니다.</p>\n<p>이는 <strong>JpaTransactionManager</strong>의 API 명세에서도 확인할 수 있습니다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/6b926de0c8279fefc94d135dd933a034/f97d7/img.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 8.823529411764705%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAa0lEQVQI1yWMyw4DIQwD9/9/kgUnAbatQN3H1bXoYeRMHGUDCksRgBI0c2Y5zJavvXB3dcacMwET0FzW7b7n9SOlxM1rJ6LT++dPe9G8slgwotKiEXKvx+rr8VYf8sbzfvi9Hl7KOSfHGPwBYhmTtMs6yyoAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='img' title='img' src='/static/6b926de0c8279fefc94d135dd933a034/ca1dc/img.png' srcset='/static/6b926de0c8279fefc94d135dd933a034/e7570/img.png 170w,\n/static/6b926de0c8279fefc94d135dd933a034/f46e7/img.png 340w,\n/static/6b926de0c8279fefc94d135dd933a034/ca1dc/img.png 680w,\n/static/6b926de0c8279fefc94d135dd933a034/02d09/img.png 1020w,\n/static/6b926de0c8279fefc94d135dd933a034/9d567/img.png 1360w,\n/static/6b926de0c8279fefc94d135dd933a034/f97d7/img.png 2000w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>즉, JPA와 JDBC가 하나의 트랜잭션 내에서 동일한 데이터베이스만 바라보고 있다면 이들을 묶어서 트랜잭션으로 처리해줄 수 있다는 점입니다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/7fac832314ffc9a5ee63c34369e208a8/f97d7/img_1.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 8.823529411764705%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAX0lEQVQI1z2MSw7AIAhEvf8p/YC1Jsbvys200NjFCzM8gonpBsULgaLCMSGEAOccrLXw3msWJBORTnHMjFKK0nvHGAOGiJFzfsv8mFOFHBxqrYrktRZaa787D2W398YD8wqV75oZv94AAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='img 1' title='img 1' src='/static/7fac832314ffc9a5ee63c34369e208a8/ca1dc/img_1.png' srcset='/static/7fac832314ffc9a5ee63c34369e208a8/e7570/img_1.png 170w,\n/static/7fac832314ffc9a5ee63c34369e208a8/f46e7/img_1.png 340w,\n/static/7fac832314ffc9a5ee63c34369e208a8/ca1dc/img_1.png 680w,\n/static/7fac832314ffc9a5ee63c34369e208a8/02d09/img_1.png 1020w,\n/static/7fac832314ffc9a5ee63c34369e208a8/9d567/img_1.png 1360w,\n/static/7fac832314ffc9a5ee63c34369e208a8/f97d7/img_1.png 2000w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<h2>DataSourceTransactionManager만 사용한다면?</h2>\n<p>그렇다면 JDBC를 처리하는 방법인 <strong>DataSourceTransactionManager</strong>만 사용한다면 어떨까요?? 한번 테스트를 통해서 이를 확인해보도록 하겠습니다.</p>\n<p>먼저 <strong>DataSourceTransactionManager</strong>를 빈으로 등록해주는 작업을 수행해주겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Configuration</span>\n<span class=\"token annotation punctuation\">@EnableJpaAuditing</span>\n<span class=\"token annotation punctuation\">@EnableJpaRepositories</span><span class=\"token punctuation\">(</span>\n    basePackages <span class=\"token operator\">=</span> <span class=\"token string\">\"com.playground.transactionManager\"</span><span class=\"token punctuation\">,</span>\n    transactionManagerRef <span class=\"token operator\">=</span> <span class=\"token string\">\"jpaTransactionManager\"</span>\n<span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@EnableTransactionManagement</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">DatabaseConfig</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token annotation punctuation\">@Bean</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">PlatformTransactionManager</span> <span class=\"token function\">datasourceTransactionManager</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">DataSource</span> dataSource<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">DataSourceTransactionManager</span> dataSourceTransactionManager <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">DataSourceTransactionManager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        dataSourceTransactionManager<span class=\"token punctuation\">.</span><span class=\"token function\">setDataSource</span><span class=\"token punctuation\">(</span>dataSource<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        \n        <span class=\"token keyword\">return</span> dataSourceTransactionManager<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Bean</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">PlatformTransactionManager</span> <span class=\"token function\">jpaTransactionManager</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">EntityManagerFactory</span> entityManagerFactory<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">JpaTransactionManager</span> jpaTransactionManager <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">JpaTransactionManager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        jpaTransactionManager<span class=\"token punctuation\">.</span><span class=\"token function\">setEntityManagerFactory</span><span class=\"token punctuation\">(</span>entityManagerFactory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        \n        <span class=\"token keyword\">return</span> jpaTransactionManager<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token annotation punctuation\">@Bean</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">LocalContainerEntityManagerFactoryBean</span> <span class=\"token function\">entityManagerFactory</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">DataSource</span> dataSource<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">LocalContainerEntityManagerFactoryBean</span> emf <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">LocalContainerEntityManagerFactoryBean</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        emf<span class=\"token punctuation\">.</span><span class=\"token function\">setJpaVendorAdapter</span><span class=\"token punctuation\">(</span><span class=\"token function\">jpaVendorAdapter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        emf<span class=\"token punctuation\">.</span><span class=\"token function\">setDataSource</span><span class=\"token punctuation\">(</span>dataSource<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        emf<span class=\"token punctuation\">.</span><span class=\"token function\">setPersistenceUnitName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"persistenceJpa\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        emf<span class=\"token punctuation\">.</span><span class=\"token function\">setPackagesToScan</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"com.playground.transactionManager.*\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        emf<span class=\"token punctuation\">.</span><span class=\"token function\">setJpaProperties</span><span class=\"token punctuation\">(</span><span class=\"token function\">additionalProperties</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">return</span> emf<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// JpaVendor, Properties 등등 생략...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>그리고 실제 테스트를 수행하는 메서드에 <code class=\"language-text\">@Transactional</code> 애노테이션에 <strong>DataSourceTransactionManager</strong> 를 사용하도록 작업을 수행해줍니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@RequiredArgsConstructor</span>\n<span class=\"token annotation punctuation\">@Service</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">TestJdbcTransactionManagerService</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">JdbcTemplate</span> jdbcTemplate<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">MemberRepository</span> memberRepository<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Transactional</span><span class=\"token punctuation\">(</span>transactionManager <span class=\"token operator\">=</span> <span class=\"token string\">\"datasourceTransactionManager\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Long</span> <span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 생략...</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>그리고 테스트를 수행해보면 다음과 같은 에러가 발생하는 것을 확인할 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">Caused</span> by<span class=\"token operator\">:</span> <span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span></span>IllegalStateException</span><span class=\"token operator\">:</span> \n    <span class=\"token class-name\">Already</span> value <span class=\"token punctuation\">[</span><span class=\"token class-name\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>jdbc<span class=\"token punctuation\">.</span>datasource<span class=\"token punctuation\">.</span></span>ConnectionHolder</span><span class=\"token annotation punctuation\">@19f0c22e</span><span class=\"token punctuation\">]</span> \n    <span class=\"token keyword\">for</span> key <span class=\"token punctuation\">[</span><span class=\"token class-name\">HikariDataSource</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">HikariPool</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> bound <span class=\"token keyword\">to</span> <span class=\"token namespace\">thread</span> <span class=\"token punctuation\">[</span><span class=\"token class-name\">Test</span> worker<span class=\"token punctuation\">]</span>\n        at <span class=\"token class-name\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>transaction<span class=\"token punctuation\">.</span>support<span class=\"token punctuation\">.</span></span>TransactionSynchronizationManager</span><span class=\"token punctuation\">.</span><span class=\"token function\">bindResource</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">TransactionSynchronizationManager</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">193</span><span class=\"token punctuation\">)</span>\n        at <span class=\"token class-name\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>orm<span class=\"token punctuation\">.</span>jpa<span class=\"token punctuation\">.</span></span>JpaTransactionManager</span><span class=\"token punctuation\">.</span><span class=\"token function\">doBegin</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">JpaTransactionManager</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">421</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>즉, 결론적으로 <strong>JpaTransactionManager</strong> 를 통해서는 JPA와 JDBC를 둘다 사용할 수 있지만, <strong>DataSourceTransactionManager</strong> 만으로는 JDBC만 사용을 할 수 있습니다.</p>\n<h2>참고</h2>\n<ul>\n<li><a href=\"https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/orm/jpa/JpaTransactionManager.html\">https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/orm/jpa/JpaTransactionManager.html</a></li>\n</ul>","frontmatter":{"title":"JpaTransactionManager는 JDBC도 처리해준다","date":"December 13, 2022","update":"December 13, 2022","tags":["Transaction"],"series":null},"fields":{"slug":"/JpaTransactionManager는 JDBC도 처리해준다/","readingTime":{"minutes":3.29}}},"seriesList":{"edges":[{"node":{"id":"863212f2-1cb1-5101-804a-5416ffb5b9d3","fields":{"slug":"/Nginx와-Gzip을-활용한-프론트-최적화/"},"frontmatter":{"title":"Nginx와 Gzip을 활용한 프론트 최적화"}}},{"node":{"id":"4c21b76a-ad6b-5e0b-b0e7-a0c0e94b12a9","fields":{"slug":"/Replication과-SpringBoot/"},"frontmatter":{"title":"Replication과 Spring Boot"}}},{"node":{"id":"aae5e42a-02b5-56c8-8475-67f77087a495","fields":{"slug":"/JPA를-사용함으로서-겪었던-문제들/"},"frontmatter":{"title":"JPA를 사용함으로서 겪었던 문제들"}}},{"node":{"id":"948cec5b-7366-505a-992f-1dd680a012ee","fields":{"slug":"/테스트에서의 @Transactional/"},"frontmatter":{"title":"테스트에서의 @Transactional"}}},{"node":{"id":"c4eb0572-f278-5d08-9052-32b5b549b9bb","fields":{"slug":"/DAO와-Repository/"},"frontmatter":{"title":"DAO와 Repository"}}},{"node":{"id":"9adaf203-e9ac-55e1-a772-b716b41c886a","fields":{"slug":"/캐시 설계 전략에 대해서 고민해보기/"},"frontmatter":{"title":"캐시 설계 전략에 대해서 고민해보기"}}},{"node":{"id":"402909e7-5260-5a3b-9183-5ac1017382fe","fields":{"slug":"/로컬 캐시와 글로벌 캐시에 대해서 고민해보기/"},"frontmatter":{"title":"로컬 캐시와 글로벌 캐시에 대해서 고민해보기"}}},{"node":{"id":"c20ecd3e-8f83-53ad-89dd-dc937758fc6e","fields":{"slug":"/현재 시간을 검증해야 하는 로직 개선에 대해 고민해보기/"},"frontmatter":{"title":"현재 시간을 검증해야 하는 로직 개선에 대해 고민해보기"}}},{"node":{"id":"5d3cba24-3007-5309-a0f7-2430e555a818","fields":{"slug":"/JpaTransactionManager는 JDBC도 처리해준다/"},"frontmatter":{"title":"JpaTransactionManager는 JDBC도 처리해준다"}}}]},"previous":{"fields":{"slug":"/현재 시간을 검증해야 하는 로직 개선에 대해 고민해보기/"},"frontmatter":{"title":"현재 시간을 검증해야 하는 로직 개선에 대해 고민해보기"}},"next":null},"pageContext":{"id":"5d3cba24-3007-5309-a0f7-2430e555a818","series":null,"previousPostId":"c20ecd3e-8f83-53ad-89dd-dc937758fc6e","nextPostId":null}},"staticQueryHashes":[]}