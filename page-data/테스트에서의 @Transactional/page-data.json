{"componentChunkName":"component---src-templates-post-jsx","path":"/테스트에서의 @Transactional/","result":{"data":{"site":{"siteMetadata":{"title":"rookie"}},"markdownRemark":{"id":"948cec5b-7366-505a-992f-1dd680a012ee","excerpt":"테스트 격리를 위해서는 데이터를 롤백시키는 과정이 필요합니다. 하지만 이 과정에서 잘못된 방법을 사용할 경우 몇가지 문제가 발생할 수 있는데요. 이번 포스팅에서는 문제가 생길 수 있는 상황들과 테스트 격리 방법을 조금 더 고도화하기 위해서 고민했던 내용에 대해서 작성해보려고 합니다. SpringBootTest는 @Transactional로 롤백되지 않을 …","html":"<p>테스트 격리를 위해서는 데이터를 롤백시키는 과정이 필요합니다. 하지만 이 과정에서 잘못된 방법을 사용할 경우 몇가지 문제가 발생할 수 있는데요. 이번 포스팅에서는 문제가 생길 수 있는 상황들과 테스트 격리 방법을 조금 더 고도화하기 위해서 고민했던 내용에 대해서 작성해보려고 합니다.</p>\n<h2>SpringBootTest는 @Transactional로 롤백되지 않을 수도 있다</h2>\n<p><code class=\"language-text\">@DataJpaTest</code>를 사용하면 영속성 계층에 대해서 편리하게 테스트를 할 수 있습니다. <code class=\"language-text\">@DataJpaTest</code> 안에 <code class=\"language-text\">@Transactional</code>이 있어서 테스트가 끝나면 트랜잭션을 롤백시키기 때문에, 각각의 테이블이 비워지면서 모든 테스트가 격리되게 됩니다.</p>\n<p>그렇다면 <code class=\"language-text\">@SpringBootTest</code>에서는 어떻게 데이터를 롤백해야 할까요?? <code class=\"language-text\">@SpringBootTest</code>를 보면 <code class=\"language-text\">@Transactional</code>이 사용되지 않고 있습니다. 그렇다면 <code class=\"language-text\">@Transactional</code>만 잘 추가해주면 롤백이 잘 수행된다고 할 수 있을까요??</p>\n<h3>SpringBootTest의 테스트 환경</h3>\n<p>기본적으로 <code class=\"language-text\">@SpringBootTest</code>는 서버를 시작하지 않습니다. 그래서 <code class=\"language-text\">webEnvironment</code> 설정을 통해 테스트를 어떤 환경에서 시작할 건지 설정을 할 수 있습니다. 설정값은 다음과 같습니다.</p>\n<ul>\n<li>MOCK (default) : 내장 서버가 실행되지 않는다. mock 기반 테스트를 실행</li>\n<li>RANDOM_PORT : 랜덤 포트 번호로 실제 웹 서버와 함께 WebServerApplicaitonContext가 로드됨</li>\n<li>DEFINE_PORT : 설정된 포트 번호로 실제 웹 서버와 함께 WebServerApplicaitonContext가 로드됨</li>\n<li>NONE : SpringApplicaiton을 통해 ApplicaitonContext를 로드하지만 어떠한 웹 환경도 제공하지 않음</li>\n</ul>\n<p>여기서 실제 서블릿 환경을 실행시키기 위해 <code class=\"language-text\">RANDOM_PORT</code>와 <code class=\"language-text\">DEFINE_PORT</code>로 설정을 하고 <code class=\"language-text\">@Transactional</code>을 작동시키면 롤백이 되지 않는 것을 확인할 수 있습니다. 즉, 테스트들이 격리되지 않아서 전체 테스트에 실패를 하게 됩니다. 왜 이런 현상이 발생하게 되는 걸까요??</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/e1b8248e1a9bf4a4727599c21c1b1ecb/f97d7/img.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 31.176470588235293%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAvklEQVQY022QWQ6EMAxDuQ5UoiylLF3o/S+V0csoIyTmI5Q6sWunyznLeZ7inBPvvaSU9F5rlVKKniEE2fdd7vvWPpzjOLRijDLPs0zTpBrdP8HrupSEQGtN1nVVIhg9ikcQ4qSPIPef4DAM2mDYXIDjbNs2xREHx/mzmIHf9/1b0MQsLrFwboL0bcYcc1+W5esQokUGtEjgCFDERRjs+ZitBj7FXMeHSAiO46j/7IVherYv3BMNjLJVPPlE/gAW5cVKHDrFtgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='img' title='img' src='/static/e1b8248e1a9bf4a4727599c21c1b1ecb/ca1dc/img.png' srcset='/static/e1b8248e1a9bf4a4727599c21c1b1ecb/e7570/img.png 170w,\n/static/e1b8248e1a9bf4a4727599c21c1b1ecb/f46e7/img.png 340w,\n/static/e1b8248e1a9bf4a4727599c21c1b1ecb/ca1dc/img.png 680w,\n/static/e1b8248e1a9bf4a4727599c21c1b1ecb/02d09/img.png 1020w,\n/static/e1b8248e1a9bf4a4727599c21c1b1ecb/9d567/img.png 1360w,\n/static/e1b8248e1a9bf4a4727599c21c1b1ecb/f97d7/img.png 2000w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/f7155d32ab2198d58d2714b69d2457db/f97d7/img_1.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 11.76470588235294%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAZElEQVQI1zWNSQpEMRBC/3UykZCEzNP9L2VjQS8KhVfqd85B7x21Vqy1xM85sfcG2b0X3nuUUvDekx9yspQSrLVQSsEYI/exIOcskCF6amtNdIyBEAJijOI5/OfMOOegtZYy6g+k2kDhjQLz6AAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='img 1' title='img 1' src='/static/f7155d32ab2198d58d2714b69d2457db/ca1dc/img_1.png' srcset='/static/f7155d32ab2198d58d2714b69d2457db/e7570/img_1.png 170w,\n/static/f7155d32ab2198d58d2714b69d2457db/f46e7/img_1.png 340w,\n/static/f7155d32ab2198d58d2714b69d2457db/ca1dc/img_1.png 680w,\n/static/f7155d32ab2198d58d2714b69d2457db/02d09/img_1.png 1020w,\n/static/f7155d32ab2198d58d2714b69d2457db/9d567/img_1.png 1360w,\n/static/f7155d32ab2198d58d2714b69d2457db/f97d7/img_1.png 2000w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>이렇게 <strong>서블릿 환경을 실행시키게 되면, 별도의 스레드에서 스프링 컨테이너가 실행</strong>되게 됩니다. 이후 테스트가 종료되고 나서 이를 롤백시키기 위해서는, 하나의 트랜잭션으로 묶여야 하는데, <strong>스프링 컨테이너가 실제로 구동되어 테스트와 다른 스레드에서 실행이 되게 되어 <code class=\"language-text\">@Transactional</code>을 적용해도 롤백이 되지 않는 것</strong>입니다.</p>\n<h3>테스트 환경 격리시키기</h3>\n<p>결국 실제 서블릿 환경을 실행시키는 인수 테스트를 할 때는, 모든 테이블의 데이터를 삭제해서 초기화해주는 방법이 가장 깔끔한 것 같습니다. 이를 구현하기 위해서 많은 방법들이 있겠지만 저는 <code class=\"language-text\">TRUNCATE</code> 명령어를 통해서 모든 테이블의 데이터를 제거해주도록 하겠습니다.</p>\n<p><code class=\"language-text\">TRUNCATE</code>를 활용한 테스트 격리는 다음 순으로 이루어집니다.</p>\n<ol>\n<li>테스트가 끝나면 모든 테이블에 대한 TRUNCATE TABLE 명령어를 얻어옴</li>\n<li>제약조건 무호화 명령어 실행</li>\n<li>모든 TRUNCATE TABLE 명령어를 실행시킴</li>\n<li>제약조건 재설정 명령어를 실행시킴</li>\n</ol>\n<p>위의 방법들을 이용해서 <code class=\"language-text\">TRUNCATE</code> 명령어를 수행하는 로직을 구현하는 것 까지는 일반적으로 할 수 있습니다. <code class=\"language-text\">JPA</code>의 <code class=\"language-text\">EntityManager</code>를 통해서 구현할 수도 있고, <code class=\"language-text\">JPA</code> 의존이 싫다고 하면 <code class=\"language-text\">JdbcTemplate</code>을 통해서 작성도 가능합니다.</p>\n<p>하지만 이를 적용하기 위해서는 구현한 클래스에 대해서 모든 테스트 클래스에 상속을 적용해줘야 합니다. 상속 자체가 나쁜건 아니지만, 꼭 필요한 시점에 다른 상속이 필요할 때도 있고, 상위 <code class=\"language-text\">AcceptanceTest</code>에 어떠한 다른 코드가 추가되어 기존 인수 테스트에 영향을 줄 수 있는 여지가 있기 때문에 상속보다는 다른 방법으로 이를 해결하고 싶었습니다.</p>\n<p>이를 해결하기 위해서 <code class=\"language-text\">TestExecutionListener</code>, <code class=\"language-text\">Custom Annotation</code>, <code class=\"language-text\">Environment</code>를 활용하면 상속을 사용하지 않고도 인수테스트 환경을 구성할 수 있습니다. <code class=\"language-text\">Spring</code>은 테스트의 실행 주기에 개입할 수 있도록 리스너 인터페이스인 <code class=\"language-text\">TestExecutionListener</code> 를 제공하고 있습니다. 이 구현체를 만들어 테스트 실행 시점에 등록한다면 특정 시점에 개입 할 수 있게 됩니다.  제공되는 각각의 메서드들은 다음과 같습니다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/fde04e7fac8a965e6ee40db9e21ffd56/9aa73/img_2.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 30.58823529411765%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA5klEQVQY022Q16qFUAxE/f+fE44VH+wFe0MFFXNZgf12hSEmmWTPxBrHUaIokjRNpW1baZpGyrLUWFWV+L4vjuOI53kShqHmxCRJdA7evu8yz7M8zyPWsiwSx7EURSHHcWhzXVeN0zRJ3/f60DAMGruuU9R1rX0W0YP3vq9YJEEQqCoWoZiaiVmWqfo8zxX8w2UhnPM85bouxfd9YvEqNox8gFrAED3bthXY/v1+ahk+wDouUYggXei6rqpE0bZt+jIkclRxSwPUUTMRLuAM932LxQ2wBSiyiMh9jHVzS+rkzGDvv+8P7+u9zz3FNw0AAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='img 2' title='img 2' src='/static/fde04e7fac8a965e6ee40db9e21ffd56/ca1dc/img_2.png' srcset='/static/fde04e7fac8a965e6ee40db9e21ffd56/e7570/img_2.png 170w,\n/static/fde04e7fac8a965e6ee40db9e21ffd56/f46e7/img_2.png 340w,\n/static/fde04e7fac8a965e6ee40db9e21ffd56/ca1dc/img_2.png 680w,\n/static/fde04e7fac8a965e6ee40db9e21ffd56/02d09/img_2.png 1020w,\n/static/fde04e7fac8a965e6ee40db9e21ffd56/9d567/img_2.png 1360w,\n/static/fde04e7fac8a965e6ee40db9e21ffd56/9aa73/img_2.png 1912w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>여기서 우리는 각각의 테스트들이 실행되기 전 <code class=\"language-text\">TRUNCATE</code>를 해주면 되기 때문에 <code class=\"language-text\">beforeTestMethod</code>를 이용해서 구현을 하면 되겠습니다.</p>\n<p>추가적으로 자바 8 이후로 등장한 <code class=\"language-text\">AbstractTestExecutionListener</code>를 사용한다면 필요한 메서드만 오버라이딩 해서 사용할 수 있습니다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/e5e8fd9c3fb12c282c01d4dcc78d10b2/a82f2/img_3.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 23.52941176470588%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAw0lEQVQY01WPW67DIAxEsxzehoCBJPd2/7ua2jSV0o+jGRvLeDZODj0ZcKsYx4U+D4x5LuUx0YfqgZ4DzmLRmeXtXH2d0xlFfdkrNsqEXDK89zDG/mItrGLM7Z1gVr1Ues4p7vYO299hcU2LtltQCigUsGfViCx1Ch6JaBFjQkofrxpCWIc82UZ2GCVIJI+rJ4HwmoT/mTFrRCOPygPcJ/ba0Lh/fGNZGNdVPwu9/OqchxWMRFqYG414x/lGfPrvsufSN71WmiTdz8uXAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='img 3' title='img 3' src='/static/e5e8fd9c3fb12c282c01d4dcc78d10b2/ca1dc/img_3.png' srcset='/static/e5e8fd9c3fb12c282c01d4dcc78d10b2/e7570/img_3.png 170w,\n/static/e5e8fd9c3fb12c282c01d4dcc78d10b2/f46e7/img_3.png 340w,\n/static/e5e8fd9c3fb12c282c01d4dcc78d10b2/ca1dc/img_3.png 680w,\n/static/e5e8fd9c3fb12c282c01d4dcc78d10b2/02d09/img_3.png 1020w,\n/static/e5e8fd9c3fb12c282c01d4dcc78d10b2/a82f2/img_3.png 1358w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>여기서 저희가 작성해야 할 기능은 크게 두 가지입니다. 하나는 기존과 같이 <code class=\"language-text\">TRUNCATE</code>를 해주는 기능이고, 또 하나는<code class=\"language-text\">RestAssured</code>을 수행하기 위해서 사용할 <code class=\"language-text\">Port</code>를 등록해주는 것입니다. <code class=\"language-text\">Environment</code> 를 통해 이러한 Port를 얻어올 수 있습니다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/79a60006b0c8e6147989680423e3e4a3/f97d7/img_4.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 15.88235294117647%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAfklEQVQI12WNSQ4DIQwE5zdRMNhsBgb+/64OS6SRkkOpval8DX2hF0YrCb0GaBTElJByQdY6U8EsB3lwzsE6mthdMzNk9pdYwtCIcVeM3lBrhZaGmKdU804fPUIMEPE/QvsV2v1wC+2yryWtJc9jDyKCMWby3kl0OLN/nnuDD1DtXMEoxxkBAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='img 4' title='img 4' src='/static/79a60006b0c8e6147989680423e3e4a3/ca1dc/img_4.png' srcset='/static/79a60006b0c8e6147989680423e3e4a3/e7570/img_4.png 170w,\n/static/79a60006b0c8e6147989680423e3e4a3/f46e7/img_4.png 340w,\n/static/79a60006b0c8e6147989680423e3e4a3/ca1dc/img_4.png 680w,\n/static/79a60006b0c8e6147989680423e3e4a3/02d09/img_4.png 1020w,\n/static/79a60006b0c8e6147989680423e3e4a3/9d567/img_4.png 1360w,\n/static/79a60006b0c8e6147989680423e3e4a3/f97d7/img_4.png 2000w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>그리고 기존과 동일하게 <code class=\"language-text\">TRUNCATE</code> 기능을 작성해주겠습니다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/d1eed57ce64ff9c3a52f0747bb9b56b9/f97d7/img_5.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 8.823529411764705%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAaElEQVQI102Maw7DIAyDex0SqkJC1/Io6u5/KC+MTtqPT7Yjx0s9Emp/I5eG1m+cpkeuKK2j1AvZGP60m6b94QUNG+LKIGIwT4gIi6hCNEGsOHyIMrMovPff4lQPcg7uhz2PAR78DX4AQEI+/3Cj690AAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='img 5' title='img 5' src='/static/d1eed57ce64ff9c3a52f0747bb9b56b9/ca1dc/img_5.png' srcset='/static/d1eed57ce64ff9c3a52f0747bb9b56b9/e7570/img_5.png 170w,\n/static/d1eed57ce64ff9c3a52f0747bb9b56b9/f46e7/img_5.png 340w,\n/static/d1eed57ce64ff9c3a52f0747bb9b56b9/ca1dc/img_5.png 680w,\n/static/d1eed57ce64ff9c3a52f0747bb9b56b9/02d09/img_5.png 1020w,\n/static/d1eed57ce64ff9c3a52f0747bb9b56b9/9d567/img_5.png 1360w,\n/static/d1eed57ce64ff9c3a52f0747bb9b56b9/f97d7/img_5.png 2000w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>지금까지 만든 <code class=\"language-text\">TestExecutionListener</code>를 테스트 실행 시에 등록하기 위해서 <code class=\"language-text\">@TestExecutionListeners</code>를 사용해주면 됩니다. 같이 사용한 <code class=\"language-text\">mergeMode</code> 속성은 <code class=\"language-text\">Default</code> 로 존재하는 다른 리스너들을 대체할 것인지를 설정하는 것인데, <code class=\"language-text\">Default</code> 리스너를 함께 사용하도록 하면 됩니다.</p>\n<p>그리고 <code class=\"language-text\">Custom Annotation</code>을 만들어 각 인수테스트에서 사용하도록 하면 깔끔하게 테스트 환경을 격리시킬 수 있습니다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/a4c0ecc3bd823d696739cd74cae193c3/f97d7/img_6.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 14.117647058823529%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAkklEQVQI10XN6w6DIAwFYJ9mCRXaAoLKjM69/zudFWe2H19O2vQytOaxtM3smMuKaSrQGBE5QTmCaIQjsnSGrvrH0d37G97niONQHOcT+/7C1lbkUlHmBbnOqDkiiYdohAhDxV2kp6rpjxUSFBwEQ02Ekh4ohZBzsMVk+mD8HmG24RHMghC8pTN0J199Dozgu4APWJRdiUXXGC8AAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='img 6' title='img 6' src='/static/a4c0ecc3bd823d696739cd74cae193c3/ca1dc/img_6.png' srcset='/static/a4c0ecc3bd823d696739cd74cae193c3/e7570/img_6.png 170w,\n/static/a4c0ecc3bd823d696739cd74cae193c3/f46e7/img_6.png 340w,\n/static/a4c0ecc3bd823d696739cd74cae193c3/ca1dc/img_6.png 680w,\n/static/a4c0ecc3bd823d696739cd74cae193c3/02d09/img_6.png 1020w,\n/static/a4c0ecc3bd823d696739cd74cae193c3/9d567/img_6.png 1360w,\n/static/a4c0ecc3bd823d696739cd74cae193c3/f97d7/img_6.png 2000w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<h2>AcceptanceTest가 아닌 다른 테스트에서의 @Transactional</h2>\n<p>위의 인수테스트에서는 <code class=\"language-text\">@Transactional</code>을 사용하지 않고 테스트를 수행했습니다. 그렇다면 <code class=\"language-text\">Random Port</code>를 사용하지 않아도 괜찮은 <code class=\"language-text\">Application Layer</code>에서는 <code class=\"language-text\">@Transactional</code>을 사용해도 괜찮을까요?? 다음 상황을 통해 한번 살펴보도록 하겠습니다.</p>\n<h3>운영 코드와 테스트 코드의 괴리</h3>\n<p>만약 운영코드에 실수로 <code class=\"language-text\">@Transactional</code>을 작성하지 않았다고 가정해보겠습니다. 아니면 작성이 되어있다가 운영코드에서 <code class=\"language-text\">@Transactional</code>이 지워지는 상황도 발생할 수 있겠네요. 이렇게 될 경우, <code class=\"language-text\">LazyInitializationException</code> 이 발생하게 됩니다.</p>\n<p>이유는 생각보다 간단합니다. 서비스 계층에서 트랜잭션이 걸려있지 않아 <code class=\"language-text\">Lazy Fetching</code>이 불가능하기 때문입니다. <code class=\"language-text\">@Transactional</code>이 존재하지 않아 세션이 이미 종료된 상태인데 <code class=\"language-text\">DataBase</code>에 <code class=\"language-text\">Lazy</code>로 또 접근하려 하기 때문입니다.</p>\n<p>하지만 테스트는 정상적으로 작동하게 됩니다. <strong>그 이유는 테스트 환경에서는 <code class=\"language-text\">@Transactional</code>이 작성되어 있기 때문에 세션이 유지되기 때문</strong>입니다. 이러한 구조는 운영 코드와 테스트 코드간에 괴리를 유발하며, 추후 장애가 발생할 수 있는 요인 중 하나라고 할 수 있습니다.</p>\n<h3>영속성 컨텍스트에서 새로운 데이터가 조회되지 않을 수 있다</h3>\n<p>보통 <code class=\"language-text\">JPA</code>를 사용한 프로젝트에서 테스트 코드에 <code class=\"language-text\">@Transacitonal</code>을 붙이게 되면, 메서드 단위로 트랜잭션이 적용되게 됩니다. 이는 <strong>테스트 대상의 메서드가 트랜잭션을 이어받게 됨을 의미</strong>하는데요. 이 경우 <strong>트랜잭션 커밋이 메서드 종료시점에 수행</strong>되므로 <code class=\"language-text\">Repository</code>를 통해 객체를 조회할 때 예상과 다르게 조회가 될 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token annotation builtin\">@Transactional</span>\n<span class=\"token annotation builtin\">@SpringBootTest</span>\n<span class=\"token keyword\">class</span> CouponService <span class=\"token annotation builtin\">@Autowired</span> <span class=\"token keyword\">constructor</span><span class=\"token punctuation\">(</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> couponService<span class=\"token operator\">:</span> CouponService<span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> couponRepository<span class=\"token operator\">:</span> CouponRepository<span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> userRepository<span class=\"token operator\">:</span> UserRepository<span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> userHistoryRepository<span class=\"token operator\">:</span> UserHistoryRepository<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token annotation builtin\">@Test</span>\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">createCoupon</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// given</span>\n        couponRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token function\">Coupon</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"커피 쿠폰\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">val</span> savedUser <span class=\"token operator\">=</span> userRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token function\">User</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"루키\"</span></span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        userHistoryRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token function\">UserHistory</span><span class=\"token punctuation\">(</span>savedUser<span class=\"token punctuation\">,</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"커피 쿠폰\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">val</span> request <span class=\"token operator\">=</span> <span class=\"token function\">CouponRequest</span><span class=\"token punctuation\">(</span><span class=\"token number\">1L</span><span class=\"token punctuation\">,</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"커피 쿠폰\"</span></span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\">// when</span>\n        couponService<span class=\"token punctuation\">.</span><span class=\"token function\">findCoupon</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span> \n\n        <span class=\"token comment\">// then</span>\n        <span class=\"token keyword\">val</span> results <span class=\"token operator\">=</span> userHistoryRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>results<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">hasSize</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위의 코드 중, <code class=\"language-text\">couponService.findCoupon()</code>은 <code class=\"language-text\">userRepository.findById()</code>을 호출해서 <code class=\"language-text\">User</code> 객체를 가져오게 되는데, 가져온 <code class=\"language-text\">User</code> 객체는 영속성 컨텍스트에서 캐싱된 객체로서 아직 <code class=\"language-text\">userHistory</code> 컬렉션에 객체가 추가되지 않은 상태입니다. 이러한 현상은 <code class=\"language-text\">userHistoryRepository.save()</code> 가 <strong>상위 트랜잭션을 이어받아 하나의 트랜잭션에서 수행되어 커밋이 일어나지 않았기 때문</strong>입니다.</p>\n<p>이를 해결하는 방법은 간단합니다. <code class=\"language-text\">@Transactional</code>을 제거한다면, 새로운 트랜잭션에서 요청이 수행되면서 정상적으로 테스트가 성공하게 됩니다.</p>\n<h2>마무리</h2>\n<p>이 포스팅 주제와는 관련이 없는데, 레벨 2 쯤이였나.. 주말에 수달이랑 프롤로그 근로 때문에 인수테스트를 같이 살펴보고 있었는데 지나가던 포비가 말을 걸어주셔서 인수테스트 관련으로 잠깐 얘기한 적이 있었습니다. 당시 인수테스트의 가독성 향상과 속도 향상에 빠져있던 시기라 포비에게 이것저것 여쭤봤었고, 그 중에 한가지가 기억이 남았습니다.</p>\n<p><strong>‘현업에서도 인수테스트에 대해서 고민을 많이하고, 지금의 코드처럼 상속을 통해서 해결하기도 해요. 하지만 상속으로 하면 제약사항이 생기게 되잖아요?? 이 부분에 대해서 한번 고민해보는 것도 좋을 것 같아요.’</strong></p>\n<p>당시에 이 말을 듣고, 여려 방면으로 인수테스트에서의 상속 제거에 대해서 고민해보고 시도해봤는데 번번히 실패를 했어서 잠시 포기를 했었습니다… 그러다가 최근 구구의 JdbcTemplate 미션 때문에 검색하던 도중 <code class=\"language-text\">AbstractTestExecutionListener</code>라는 방법과 <code class=\"language-text\">Property</code>를 가져올 수 있는 방법을 알게되어서 이 문제를 해결할 수 있었습니다.</p>\n<p>아직 인수 테스트에서의 제가 고민하고 있는 부분들은 완벽하게 해결되지는 않았습니다. <strong>테스트의 가독성이라는 고민</strong>은 계속해서 남아있는 상황인데, 프롤로그에서 사용하고 있는 <code class=\"language-text\">BDD</code> 기반의 <code class=\"language-text\">Cucumber</code>를 사용하지 않고도 가독성있게 테스트를 작성할 수 있는 방법을 계속 고민해보고 시도해보려고 합니다.</p>\n<blockquote>\n<p>참고</p>\n</blockquote>\n<ul>\n<li><a href=\"https://docs.spring.io/spring-boot/docs/2.1.6.RELEASE/reference/html/boot-features-testing.html\">https://docs.spring.io/spring-boot/docs/2.1.6.RELEASE/reference/html/boot-features-testing.html</a></li>\n<li><a href=\"https://www.baeldung.com/spring-testexecutionlistener\">https://www.baeldung.com/spring-testexecutionlistener</a></li>\n<li><a href=\"https://github.com/next-step/atdd-subway-path\">https://github.com/next-step/atdd-subway-path</a></li>\n<li><a href=\"https://github.com/woowacourse/jwp-refactoring/pull/334/commits/2fa9080066998b4c7e4ba36e3aab7d99433f9861\">https://github.com/woowacourse/jwp-refactoring/pull/334/commits/2fa9080066998b4c7e4ba36e3aab7d99433f9861</a></li>\n</ul>","frontmatter":{"title":"테스트에서의 @Transactional","date":"October 29, 2022","update":"October 29, 2022","tags":["Transactional"],"series":null},"fields":{"slug":"/테스트에서의 @Transactional/","readingTime":{"minutes":13.865}}},"seriesList":{"edges":[{"node":{"id":"863212f2-1cb1-5101-804a-5416ffb5b9d3","fields":{"slug":"/Nginx와-Gzip을-활용한-프론트-최적화/"},"frontmatter":{"title":"Nginx와 Gzip을 활용한 프론트 최적화"}}},{"node":{"id":"4c21b76a-ad6b-5e0b-b0e7-a0c0e94b12a9","fields":{"slug":"/Replication과-SpringBoot/"},"frontmatter":{"title":"Replication과 Spring Boot"}}},{"node":{"id":"aae5e42a-02b5-56c8-8475-67f77087a495","fields":{"slug":"/JPA를-사용함으로서-겪었던-문제들/"},"frontmatter":{"title":"JPA를 사용함으로서 겪었던 문제들"}}},{"node":{"id":"948cec5b-7366-505a-992f-1dd680a012ee","fields":{"slug":"/테스트에서의 @Transactional/"},"frontmatter":{"title":"테스트에서의 @Transactional"}}},{"node":{"id":"c4eb0572-f278-5d08-9052-32b5b549b9bb","fields":{"slug":"/DAO와-Repository/"},"frontmatter":{"title":"DAO와 Repository"}}}]},"previous":{"fields":{"slug":"/JPA를-사용함으로서-겪었던-문제들/"},"frontmatter":{"title":"JPA를 사용함으로서 겪었던 문제들"}},"next":{"fields":{"slug":"/DAO와-Repository/"},"frontmatter":{"title":"DAO와 Repository"}}},"pageContext":{"id":"948cec5b-7366-505a-992f-1dd680a012ee","series":null,"previousPostId":"aae5e42a-02b5-56c8-8475-67f77087a495","nextPostId":"c4eb0572-f278-5d08-9052-32b5b549b9bb"}},"staticQueryHashes":[]}