<?xml version="1.0" encoding="UTF-8"?><rss xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title><![CDATA[RSS Feed of rookie]]></title><description><![CDATA[시간이 흘러도 변화에 대응되는 코드를 추구합니다.]]></description><link>https://wishoon.github.io</link><generator>GatsbyJS</generator><lastBuildDate>Fri, 09 Dec 2022 08:32:47 GMT</lastBuildDate><item><title><![CDATA[현재 시간을 검증해야 하는 로직 개선에 대해 고민해보기]]></title><description><![CDATA[…]]></description><link>https://wishoon.github.io/현재 시간을 검증해야 하는 로직 개선에 대해 고민해보기/</link><guid isPermaLink="false">https://wishoon.github.io/현재 시간을 검증해야 하는 로직 개선에 대해 고민해보기/</guid><pubDate>Fri, 09 Dec 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;현재 우아한테크코스 기간동안 진행했던 프로젝트인 “꼭꼭” 프로젝트를 개선하는 작업을 개인적으로 해보고 있습니다. 개선사항으로 느꼈던 부분 중 하나가 바로 “현재 시간을 검증해야 하는 로직”이였는데요. 이번 글에서는 해당 부분을 개선하기 위해서 어떤 방법을 고민했었는지를 작성해보는 시간을 가져보려고 합니다.&lt;/p&gt;
&lt;h2&gt;문제 사항은 무엇인가?&lt;/h2&gt;
&lt;p&gt;제작하고 있는 어플리케이션은 쿠폰을 발급하고, 사용을 신청하고, 사용을 승인하는 상태 변경 흐름을 기반으로 동작하게 됩니다. 이때 발급된 쿠폰에 대하여 사용 신청을 하는 로직을 구성하면서 몇가지 고민 상황을 만나게 됩니다.&lt;/p&gt;
&lt;h2&gt;고민 1. 시간을 검증하는 책임을 어디에 둘 것인가?&lt;/h2&gt;
&lt;h3&gt;생성자에서 검증하기&lt;/h3&gt;
&lt;p&gt;비즈니스 로직을 작성하면서 가장 먼저 만났던 문제는 &lt;strong&gt;“시간을 검증하는 책임을 어디에 맡길 것인가?”&lt;/strong&gt; 였습니다. 현재 검증하고자 하는 시간은 &lt;strong&gt;“예약을 할 때 필요한 시간”&lt;/strong&gt;입니다. 예약시간은 현재 시간 이전으로는 설정할 수 없다는 비즈니스 로직을 가지기 때문에, 객체 응집도를 위해서 &lt;strong&gt;도메인 내부에서 검증&lt;/strong&gt;을 하는 것이 좋을 것이라 생각하였습니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Reservation&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Reservation&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Long&lt;/span&gt; id&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                       &lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;
                       &lt;span class=&quot;token keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;LocalDateTime&lt;/span&gt; appointedTime&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                       &lt;span class=&quot;token keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Condition&lt;/span&gt; condition&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;validateReservationAppointedTime&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;appointedTime&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;id &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; id&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;appointedTime &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; appointedTime&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;condition &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; condition&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;validateReservationAppointedTime&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;LocalDateTime&lt;/span&gt; appointedTime&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;appointedTime&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;isBefore&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;LocalDateTime&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;now&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;IllegalArgumentException&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;현재 시간보다 이전에 예약을 할 수 없습니다.&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;하지만 이러한 설계는 한 가지 문제를 가지게 됩니다. 바로 예약 도메인을 반환할 때 문제가 생기는 것인데요. 위의 로직을 보게 되면 생성자에서 이를 검증해주고 있습니다. 예약을 생성하는 로직에서는 이러한 검증은 올바르다고 할 수 있지만, &lt;strong&gt;예약을 조회하는 로직에서 해당 검증은 적절&lt;/strong&gt;하다고 할 수 있을까요??&lt;/p&gt;
&lt;p&gt;예약을 한 시간보다 이후에 예약을 조회하는 경우 해당 검증으로 인해 예외가 발생할 수 밖에 없습니다. 이러한 문제상황 때문에 생성자에서 &lt;code class=&quot;language-text&quot;&gt;Validate&lt;/code&gt;를 하는 것은 적절하지 못하다는 판단을 하게 되었습니다.&lt;/p&gt;
&lt;h3&gt;Domain Layer의 정적 팩터리 메서드를 활용해 검증하기&lt;/h3&gt;
&lt;p&gt;그렇다면 예약을 생성하는 로직에만 시간 검증을 포함해주면 발생하고 있는 문제를 해결할 수 있을 것이라 생각하였습니다. 다음과 같이 &lt;strong&gt;예약을 생성하는 정적 팩터리 메서드를 활용&lt;/strong&gt;한다면 문제를 해결할 수 있을 것 같습니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Reservation&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Reservation&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Long&lt;/span&gt; id&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                       &lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;
                       &lt;span class=&quot;token keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;LocalDateTime&lt;/span&gt; appointedTime&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                       &lt;span class=&quot;token keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Condition&lt;/span&gt; condition&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;id &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; id&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;appointedTime &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; appointedTime&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;condition &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; condition&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Reservation&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;create&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Long&lt;/span&gt; id&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                                     &lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;
                                     &lt;span class=&quot;token keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;LocalDateTime&lt;/span&gt; appointedTime&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                                     &lt;span class=&quot;token keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Condition&lt;/span&gt; condition&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;validateReservationAppointedTime&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;appointedTime&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Reservation&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;id&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; appointedTime&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; condition&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;validateReservationAppointedTime&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;LocalDateTime&lt;/span&gt; appointedTime&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;appointedTime&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;isBefore&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;LocalDateTime&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;now&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;IllegalArgumentException&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;현재 시간보다 이전에 예약을 할 수 없습니다.&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;하지만 해당 로직을 사용하기에는 몇가지 문제점이 있었는데요. 뒤에서도 설명하겠지만 첫번째로는 &lt;strong&gt;&lt;code class=&quot;language-text&quot;&gt;LocalDateTime&lt;/code&gt;을 사용하는 테스트 로직에서 문제가 발생&lt;/strong&gt;합니다. 이는 뒤에서 자세하게 설명하겠습니다.&lt;/p&gt;
&lt;p&gt;두번째로는 &lt;strong&gt;객체 생성을 할 수 있는 기능이 두 곳이라는 점&lt;/strong&gt;입니다. 생성자로도 예약을 생성할 수 있고, 정적 팩터리 메서드로도 예약을 생성할 수 있기 때문에 협업을 하는 프로젝트에서는 착각의 소지를 줄 수 있는 여지를 남기게 됩니다. 이러한 점 때문에 정적 팩터리 메서드를 사용하는 방법에 대해서도 반려를 하게 되었습니다.&lt;/p&gt;
&lt;h3&gt;Application Layer에서 검증하기&lt;/h3&gt;
&lt;p&gt;마지막으로 고민한 방법이면서 최종 채택한 방법으로 &lt;strong&gt;&lt;code class=&quot;language-text&quot;&gt;Application Layer&lt;/code&gt;에서 검증하는 방법&lt;/strong&gt;을 선택하였습니다. 사실 어찌보면 가장 단순한 해결책이라고 할 수도 있습니다. 하지만 무분별하게 &lt;code class=&quot;language-text&quot;&gt;Application Layer&lt;/code&gt;에서 검증을 수행하게 되면 도메인 로직이 외부로 드러나게 되고, 응집도가 낮아지는 문제가 발생할 수 있기 때문에 정말 필요할 때만 이를 사용하고 있습니다.&lt;/p&gt;
&lt;p&gt;해당 기능에서 &lt;code class=&quot;language-text&quot;&gt;Application Layer&lt;/code&gt;에서 시간 검증을 수행한 이유는 다음과 같습니다.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;예약을 생성하는 로직에서 현재 시간을 검증하는 로직은 오직 한 곳에서만 이루어진다.&lt;/li&gt;
&lt;li&gt;시간 관련 테스트가 수월해진다. (뒤에서 설명)&lt;/li&gt;
&lt;li&gt;예약을 생성하는 요청에 대한 검증이기 때문에 어떻게 보면 도메인 검증이라고 보기 어려울 수 있다.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;다음과 같은 내용들을 근거로 해서 최종적으로 &lt;code class=&quot;language-text&quot;&gt;Application Layer&lt;/code&gt;에서 시간 검증을 수행해주기로 하엿습니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token annotation punctuation&quot;&gt;@RequiredArgsConstructor&lt;/span&gt;
&lt;span class=&quot;token annotation punctuation&quot;&gt;@Service&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ReservationService&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ReservationRepository&lt;/span&gt; reservationRepository&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ReservationValidator&lt;/span&gt; reservationValidator&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  
    &lt;span class=&quot;token annotation punctuation&quot;&gt;@Transactional&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Long&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Long&lt;/span&gt; memberId&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ReservationCreateRequest&lt;/span&gt; request&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        reservationValidator&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;validateExistsCoupon&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;request&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getCouponId&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;validateReservationAppointedTime&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;request&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getAppointedTime&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;Reservation&lt;/span&gt; reservation &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;createReservation&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;memberId&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; request&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; reservationRepository&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;reservation&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getId&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;validateReservationAppointedTime&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;LocalDateTime&lt;/span&gt; appointedTime&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;appointedTime&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;isBefore&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;LocalDateTime&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;now&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;clock&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;IllegalArgumentException&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;현재 시간보다 이전에 예약을 할 수 없습니다.&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;고민 2. 현재 시간을 검증하는 로직을 어떻게 구성할 것인가?&lt;/h2&gt;
&lt;p&gt;사실 이번 글의 핵심이라고도 할 수 있습니다. 검증을 수행해야 하는 부분이 &lt;strong&gt;“현재 시간”&lt;/strong&gt;은 매번 테스트할 때마다 시간이 달라지기 때문입니다. 따라서 &lt;strong&gt;지금 작성한 테스트 코드가 시간이 지나면 실패하는 테스트 코드로 변경&lt;/strong&gt;될 수 있습니다. 어떻게 하면 위의 문제를 해결할 수 있을까요??&lt;/p&gt;
&lt;h3&gt;LocalDateTime.now()는 모킹이 가능할까??&lt;/h3&gt;
&lt;p&gt;일차적으로는 &lt;code class=&quot;language-text&quot;&gt;LocalDateTime.now()&lt;/code&gt; 에 대한 값을 모킹하는 것을 고려해볼 수 있습니다. 하지만 Mockito의 코어 라이브러리는 &lt;code class=&quot;language-text&quot;&gt;mockito-core&lt;/code&gt; 에서는 &lt;code class=&quot;language-text&quot;&gt;LocalDateTime.now()&lt;/code&gt; 와 같은 &lt;code class=&quot;language-text&quot;&gt;static method&lt;/code&gt;를 모킹하는 기능을 기본적으로 제공하지 않습니다.&lt;/p&gt;
&lt;p&gt;왜 &lt;code class=&quot;language-text&quot;&gt;static method&lt;/code&gt;에 대해서 모킹하는 기능을 제공하지 않을까요?? 이를 가능하게 하려면 추가적인 라이브러리를 적용해야 하고, private 메서드, final 클래스 등이 테스트가 가능한 상태가 되어버립니다. 즉 &lt;code class=&quot;language-text&quot;&gt;private method&lt;/code&gt;도 테스트할 수 있는 상태가 되어버리기게 됩니다. &lt;code class=&quot;language-text&quot;&gt;private method&lt;/code&gt;에 대한 테스트 불필요성은 검색만 해보면 쉽게 확인할 수 있기 때문에 생략하도록 하겠습니다.&lt;/p&gt;
&lt;h3&gt;Clock을 통한 문제 해결&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;LocalDateTime.now()&lt;/code&gt;의 코드를 확인해보면 밑의 사진과 같은 코드를 확인할 수 있습니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/0d0ccba125cf24d56ead775d7002cf3f/949cf/img.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 31.176470588235293%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA5UlEQVQY022QWW7DMAwFfZ1qI6nFTrwk9z/V65Nsp0XRjwFFkBqKmpJF2ENhiwx0KdC5QVplNNYE+XnWdZazl/RzJ0oYeO/hvhymqPFT1DlBW4FUCiuFjcK71tJPHFwDrkEpR0QNFOaEchjKbpQkFgLxF2ziBj0K+6ScjLz8yq3LTqZsAblEZIqMZ6uUzwXWMionF76kS4P4caHLztfcBIQUxrpj5cLGh3ls2eHJv1v3F9btYHzj/TqwbytqWzgsI/R/cu5f+h92ppi4f3DQ6CFmUOXqokNguUKY97OonsLr4l9u6TftCrsHGsC4cAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img&apos; title=&apos;img&apos; src=&apos;/static/0d0ccba125cf24d56ead775d7002cf3f/ca1dc/img.png&apos; srcset=&apos;/static/0d0ccba125cf24d56ead775d7002cf3f/e7570/img.png 170w,
/static/0d0ccba125cf24d56ead775d7002cf3f/f46e7/img.png 340w,
/static/0d0ccba125cf24d56ead775d7002cf3f/ca1dc/img.png 680w,
/static/0d0ccba125cf24d56ead775d7002cf3f/02d09/img.png 1020w,
/static/0d0ccba125cf24d56ead775d7002cf3f/9d567/img.png 1360w,
/static/0d0ccba125cf24d56ead775d7002cf3f/949cf/img.png 1740w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;해당 코드를 확인해보면 &lt;code class=&quot;language-text&quot;&gt;Clock&lt;/code&gt;이라는 클래스를 확인할 수 있습니다. &lt;code class=&quot;language-text&quot;&gt;now(Clock.systemDefaultZone());&lt;/code&gt;을 확인해보면 접근 제어자가 &lt;code class=&quot;language-text&quot;&gt;public&lt;/code&gt;으로 되어있는 것을 확인할 수 있습니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/008334fcaae5e77e3e412cb0f9b0dad5/949cf/img_1.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 40%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABN0lEQVQoz01RWxKDIBDzOshjeSiCoLad3v9K6YKt9iMkuzDZzDJoUrAzgYI5MRmub32Ba6UlpPzHCKkE48tSYDBeIxSHafMIlbneuvd33+tfz6+290Ox8GVhVLgU4XIGzQsGZTVspDPFTHfCXhu0gS3J2NPIjp60aW2Yie/1ycpgsE7BRwM3KTg28AunSA4ucpKFYL2FUoqhoaTCOLL5KL9oWnz5xDCTRJocagzMHrnsOB5vrMzbuiClhJRX5LXABQdDGqMQEOI2+t/rIHjSMnvUNSPXA2vdEFNGXHI3v8wcJ54nxDgjhAAigjamm/xMe8J2JDY8SkbdH9gfL063sUnt9fF6YzueKNuBUnkAmx/Pd79rbzIPNFpfpoNpk/i7DcNad8K5W18933dJZLu29txt04aT/gw/PZ78PxdTT+cAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 1&apos; title=&apos;img 1&apos; src=&apos;/static/008334fcaae5e77e3e412cb0f9b0dad5/ca1dc/img_1.png&apos; srcset=&apos;/static/008334fcaae5e77e3e412cb0f9b0dad5/e7570/img_1.png 170w,
/static/008334fcaae5e77e3e412cb0f9b0dad5/f46e7/img_1.png 340w,
/static/008334fcaae5e77e3e412cb0f9b0dad5/ca1dc/img_1.png 680w,
/static/008334fcaae5e77e3e412cb0f9b0dad5/02d09/img_1.png 1020w,
/static/008334fcaae5e77e3e412cb0f9b0dad5/9d567/img_1.png 1360w,
/static/008334fcaae5e77e3e412cb0f9b0dad5/949cf/img_1.png 1740w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;즉, 매개변수인 &lt;code class=&quot;language-text&quot;&gt;Clock&lt;/code&gt;을 &lt;code class=&quot;language-text&quot;&gt;Bean&lt;/code&gt;으로 등록하여 우리가 원하는 시간으로 설정한다면 &lt;code class=&quot;language-text&quot;&gt;LocalDateTime.now()&lt;/code&gt;을 우리가 원하는 결과로 만들 수 있을 것으로 보입니다.&lt;/p&gt;
&lt;p&gt;그러면 하나씩 적용을 해보도록 하겠습니다. 앞에서 언급한 것처럼 &lt;code class=&quot;language-text&quot;&gt;Clock&lt;/code&gt;을 빈으로 등록해 줍니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/8408ddf92dc226b212a2a1abffa33491/949cf/img_2.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 41.76470588235294%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA8ElEQVQoz5VSSXLEIAz0c0AyAoyNN2Y75f8v6ghqnEqlxlOZQ9OIpWlJdPc7oxSrEOQ1YZgEEhzCIIgpgYlBRGDmf6F7XBi3nXBVVF7nHuI9RATOCXrnPhNcAmMSRuwZdR68OhsSYoyKoYm/Ejx7pDOW4ANhzARigjEG1lbYBiL78uKpoLXqbGR83QgpOq3hjKDunKbaHIp/ipsfPsQq/xXuSAdRZE17Tz3KMmHbL5iXrfFWrlj3gjyvmPLS1mMI5w5ZN5y64F476zR9Nq0h1WVFrWcap8Y1HtIIedOorh46AquH7PObHDVsMOZX/D7lb/Sz9MJVVAchAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 2&apos; title=&apos;img 2&apos; src=&apos;/static/8408ddf92dc226b212a2a1abffa33491/ca1dc/img_2.png&apos; srcset=&apos;/static/8408ddf92dc226b212a2a1abffa33491/e7570/img_2.png 170w,
/static/8408ddf92dc226b212a2a1abffa33491/f46e7/img_2.png 340w,
/static/8408ddf92dc226b212a2a1abffa33491/ca1dc/img_2.png 680w,
/static/8408ddf92dc226b212a2a1abffa33491/02d09/img_2.png 1020w,
/static/8408ddf92dc226b212a2a1abffa33491/9d567/img_2.png 1360w,
/static/8408ddf92dc226b212a2a1abffa33491/949cf/img_2.png 1740w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;그리고 &lt;code class=&quot;language-text&quot;&gt;Application Layer&lt;/code&gt;에서 검증을 위해 사용되고 있는 &lt;code class=&quot;language-text&quot;&gt;LocalDateTime.now()&lt;/code&gt;에 매개변수 &lt;code class=&quot;language-text&quot;&gt;Clock&lt;/code&gt;을 넣어줍니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/b1bce1b362dbf002aa948c574226c854/949cf/img_3.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 53.529411764705884%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABlElEQVQoz3VTW3KkMAzkOIMtvx9gDEySrU3V3v9AvZKT3RpqJh9dkgVqrFYzHV1jqQolE2IkEBGUUk/QWl/yRzzWpug0vCW4kOBiRkgZxpjxkPTXByS+InpJ2J3Cn3TDZ7H4PN/w+zix9R01r1hSQysd0YUnwsfzhbBZhY9ww53HPUrFnhJCCHA+wBoPz9DcMM83qHnm5vkiwROh9xq1WpTq4UjBWDfGFhmCt/AxsrYJKRcEzkOI0PSzBBNpWUpD3070taP3A/v5jv24o++Svw30/YRz7rKcf7cd5OqrPskLOVfUsiKXBXVtvPGMZVlRGWvbRly47lkG5/y4pUTP0lhrYZ3lyYijwaR4g87IpgO8E/0KN8YxdpAxU0HkDxBvnowdMEwiThAyQ99OMMQ1YtswWdE3ZD2jSs46CkZuFLKcuTmR/o+gf/Ipa7jQjBYNzpbxfqz4OLeBX/cN975gqxmtNZYkszSJZckoPKIT/V7ZJn9fOYi5WXTP5vZscoHhM1ke1cpI3MC3Uwwhc2KlQXL9e/4C50pVZDVzEgYAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 3&apos; title=&apos;img 3&apos; src=&apos;/static/b1bce1b362dbf002aa948c574226c854/ca1dc/img_3.png&apos; srcset=&apos;/static/b1bce1b362dbf002aa948c574226c854/e7570/img_3.png 170w,
/static/b1bce1b362dbf002aa948c574226c854/f46e7/img_3.png 340w,
/static/b1bce1b362dbf002aa948c574226c854/ca1dc/img_3.png 680w,
/static/b1bce1b362dbf002aa948c574226c854/02d09/img_3.png 1020w,
/static/b1bce1b362dbf002aa948c574226c854/9d567/img_3.png 1360w,
/static/b1bce1b362dbf002aa948c574226c854/949cf/img_3.png 1740w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;그리고 해당 로직을 검증할 테스트 코드에서 &lt;code class=&quot;language-text&quot;&gt;clock.instant()&lt;/code&gt;를 모킹하여 우리가 원하는 시간으로 변경하는 작업을 수행해줍니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/c16f9b424e05b8a35059bfba91624438/949cf/img_4.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 36.47058823529412%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAyklEQVQoz4WQWw7CIBBFux2B4TU8CjXuf1fXgdbEVqMfJ4HAPXBn6UUhRgutNdTtBqXUB/Psbf3af1svNRF6ywiR4X0AEcGQmZCgzTnwVzgEzoVdGA6hSIbIkGDMJfz3hwa9BmT2sORgNMFad2BPdb+N4nq+WOew9g25VFRuKHHF2jb0+wNtu8t8WRp4OO/38KX6lSnMdUXKBTlVMOe5L7XNR5gT4kDEVsSvn4fgZUQHfuDkbhShXOCUJZCmbARnWEL7PM3vyupc+QnWutaaCbqDPAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 4&apos; title=&apos;img 4&apos; src=&apos;/static/c16f9b424e05b8a35059bfba91624438/ca1dc/img_4.png&apos; srcset=&apos;/static/c16f9b424e05b8a35059bfba91624438/e7570/img_4.png 170w,
/static/c16f9b424e05b8a35059bfba91624438/f46e7/img_4.png 340w,
/static/c16f9b424e05b8a35059bfba91624438/ca1dc/img_4.png 680w,
/static/c16f9b424e05b8a35059bfba91624438/02d09/img_4.png 1020w,
/static/c16f9b424e05b8a35059bfba91624438/9d567/img_4.png 1360w,
/static/c16f9b424e05b8a35059bfba91624438/949cf/img_4.png 1740w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;이러한 작업을 통해 성공적으로 현재 시간에 대한 테스트를 수행할 수 있습니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/d115c521859a7694c161ec346f4c41e2/949cf/img_5.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 34.11764705882353%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABKElEQVQoz42Q626DMAyFeRxoy3VQLgkkpIW2UOg6aZq2SX3/tziz01FNkybtxyfHsXx8bOfzdsPb+wfGccI0X3CeZpyGEV3X2/zyfMWO3t1wwuE0Uu1sc212xB5m36NWLWSjCQUnlAbyeEY3v6IdrmjHF4huQlgZxHKPvB2QVC3KqoKsa1QU8zxHWZYoigI5URT3d5qmcNy0gc8NZkCmDkibHkFp4GUKXItkhydhkGUZ6m/B9XqN1Wpl428crVsoslyT3UYxmnIN/rc1QkgJ13Wx3W6t8GazsbCo53mPyDj33ekG6gfNchNt71OK+uGK12KXkoYkSYIgCCxRFCEMQzjc8BeLYEWCLBbHsRXj5sUtD2D4rpz/W5Ad8posJISw4r7vPxwy7PAL7J/rDfq97W8AAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 5&apos; title=&apos;img 5&apos; src=&apos;/static/d115c521859a7694c161ec346f4c41e2/ca1dc/img_5.png&apos; srcset=&apos;/static/d115c521859a7694c161ec346f4c41e2/e7570/img_5.png 170w,
/static/d115c521859a7694c161ec346f4c41e2/f46e7/img_5.png 340w,
/static/d115c521859a7694c161ec346f4c41e2/ca1dc/img_5.png 680w,
/static/d115c521859a7694c161ec346f4c41e2/02d09/img_5.png 1020w,
/static/d115c521859a7694c161ec346f4c41e2/9d567/img_5.png 1360w,
/static/d115c521859a7694c161ec346f4c41e2/949cf/img_5.png 1740w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2&gt;고민 3. 해당 검증을 하는 테스트 환경을 어떻게 구성할 것인가?&lt;/h2&gt;
&lt;h3&gt;Mocking으로 인한 테스크 코드 실행시간의 문제&lt;/h3&gt;
&lt;p&gt;일반적으로는 위의 방법을 통해 문제를 해결할 수 있지만 한 가지 고려해야 할 점이 있습니다. 바로 &lt;code class=&quot;language-text&quot;&gt;Mocking&lt;/code&gt;을 한다는 점입니다. Mocking을 하게 되면 기본의 빈과는 다르기 때문에 &lt;code class=&quot;language-text&quot;&gt;Spring Context&lt;/code&gt;가 새로 띄어지게 됩니다. 이는 곧 &lt;strong&gt;테스트 코드 실행 시간의 증가를 의미&lt;/strong&gt;합니다.&lt;/p&gt;
&lt;p&gt;실제로 실행 로그를 통해 확인해보면 새로운 &lt;code class=&quot;language-text&quot;&gt;Spring Context&lt;/code&gt;가 띄워지는 것을 확인할 수 있습니다.&lt;/p&gt;
&lt;p&gt;&lt;figure class=&apos;gatsby-resp-image-figure&apos; style=&apos;margin-bottom: 16px;&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; &apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/b73190009eb1f95acd946767f62160ce/949cf/img_6.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 38.82352941176471%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAzklEQVQoz42SRw4EMQgE/Z3JOef/P4pVIbU1u6c9lFBjDBgc1nW1bducfd/tPE/DB+jjOBz8aOJ0pnuwLIsTCFTwdV32PE8MRt/3HS2J8ROPT/pdMIzjaGKaJq8yDEPU8zxH0ND3vb3vvQlFUZgoy9JtkiR/k6bplw50Q8Wu65y2bS3LMg+UFehf3++ZJyRJVVXWNI3Vde0BeZ5H6Bqri2+fkD8wG20Oy7M5ZJbMi4FrAbyAOWnz763TGARtSZYOSagl6Bdo0xTSRpUU9NU+it0CZMULIx8AAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;같은 `@IntegrationTest`를 사용하는 `CouponQueryServiceTest`를 실행했을 때 발생하는 로그&apos; title=&apos;같은 `@IntegrationTest`를 사용하는 `CouponQueryServiceTest`를 실행했을 때 발생하는 로그&apos; src=&apos;/static/b73190009eb1f95acd946767f62160ce/ca1dc/img_6.png&apos; srcset=&apos;/static/b73190009eb1f95acd946767f62160ce/e7570/img_6.png 170w,
/static/b73190009eb1f95acd946767f62160ce/f46e7/img_6.png 340w,
/static/b73190009eb1f95acd946767f62160ce/ca1dc/img_6.png 680w,
/static/b73190009eb1f95acd946767f62160ce/02d09/img_6.png 1020w,
/static/b73190009eb1f95acd946767f62160ce/9d567/img_6.png 1360w,
/static/b73190009eb1f95acd946767f62160ce/949cf/img_6.png 1740w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;
    &lt;figcaption class=&apos;gatsby-resp-image-figcaption&apos;&gt;같은 `@IntegrationTest`를 사용하는 `CouponQueryServiceTest`를 실행했을 때 발생하는 로그&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;br&gt;
&lt;p&gt;&lt;figure class=&apos;gatsby-resp-image-figure&apos; style=&apos;margin-bottom: 16px;&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; &apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/30daac0f30badb2526aa2d8bed3a4b73/949cf/img_7.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 36.47058823529412%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAwElEQVQoz52RW66DMAxEsx4IAQLi/dr/ptx7LM1VVKn96MdobOIxtiec52nbttlxHLbvu3OM0bqus2VZ/O2+b7uuy57nsXmevY4cLfXE0od1Xb1ITJO6rq1tW5umyXOEFMOqJQfE/JQYDjG1PpHQNI1zVVU/IfQ52ziONgyDg5jpPgmY/mvD3Pe+Rv5rTCOawgiZVkgp/Tcrv5U1bBbYW3fhXu83BDKLN8xCA9AI2jKUhxXLZZkkN3FZBsjV0hzwAplP39oGHQXYAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;같은 `@IntegrationTest`를 사용하는 `ReservationTest`를 실행했을 때 발생하는 로그&apos; title=&apos;같은 `@IntegrationTest`를 사용하는 `ReservationTest`를 실행했을 때 발생하는 로그&apos; src=&apos;/static/30daac0f30badb2526aa2d8bed3a4b73/ca1dc/img_7.png&apos; srcset=&apos;/static/30daac0f30badb2526aa2d8bed3a4b73/e7570/img_7.png 170w,
/static/30daac0f30badb2526aa2d8bed3a4b73/f46e7/img_7.png 340w,
/static/30daac0f30badb2526aa2d8bed3a4b73/ca1dc/img_7.png 680w,
/static/30daac0f30badb2526aa2d8bed3a4b73/02d09/img_7.png 1020w,
/static/30daac0f30badb2526aa2d8bed3a4b73/9d567/img_7.png 1360w,
/static/30daac0f30badb2526aa2d8bed3a4b73/949cf/img_7.png 1740w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;
    &lt;figcaption class=&apos;gatsby-resp-image-figcaption&apos;&gt;같은 `@IntegrationTest`를 사용하는 `ReservationTest`를 실행했을 때 발생하는 로그&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;h3&gt;프로젝트 테스트 구성 환경의 문제&lt;/h3&gt;
&lt;p&gt;현재 통합 테스트의 환경을 설정하는 애노테이션인 &lt;code class=&quot;language-text&quot;&gt;@IntegrationTest&lt;/code&gt;는 &lt;code class=&quot;language-text&quot;&gt;DEFINED_PORT&lt;/code&gt;를 사용하고 있습니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/3cc2833d35e9834ec5c02c5df486ac91/949cf/img_8.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 31.76470588235294%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA/ElEQVQY022P4W7DIAyE+zgLJAUcCAEMJN37P9PNpN1UqftxOsuWP93djq7BRaFVjZK/UNhiSztCDKDVwzoHYyxWH+BoFfeXO7OCrL/cGgelFKZpwu3oA6bQm0KtHq0zan+IDuRSUVIDp449lQvkwwYSJwGtAiQ7gPQGPATEAzjhPB1qI5RyB/OGzKf4ida+BZix7elKGl9zzFmaRNGOSAt2pwQoVTtrPI4ZLRN6ZYEktCODWxZnpJ3AfpE0RpJozPMMrfWH1Ei4GYVgZwRyGPNmNchpxCh7LwoKK2ksy3LVuh7FP6WflZe7keG5nMby7/im19Mv7L90QwP4A9TOvep3xskDAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 8&apos; title=&apos;img 8&apos; src=&apos;/static/3cc2833d35e9834ec5c02c5df486ac91/ca1dc/img_8.png&apos; srcset=&apos;/static/3cc2833d35e9834ec5c02c5df486ac91/e7570/img_8.png 170w,
/static/3cc2833d35e9834ec5c02c5df486ac91/f46e7/img_8.png 340w,
/static/3cc2833d35e9834ec5c02c5df486ac91/ca1dc/img_8.png 680w,
/static/3cc2833d35e9834ec5c02c5df486ac91/02d09/img_8.png 1020w,
/static/3cc2833d35e9834ec5c02c5df486ac91/9d567/img_8.png 1360w,
/static/3cc2833d35e9834ec5c02c5df486ac91/949cf/img_8.png 1740w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;이 때문에 같은 환경 내에서 한번 더 &lt;code class=&quot;language-text&quot;&gt;Spring Context&lt;/code&gt;가 띄워질 경우 포트 충돌이 발생하게 됩니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/c430055c48849be8d51ece184c77a4d4/949cf/img_9.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 27.058823529411764%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAv0lEQVQY03WPWQ6CMBgGuQ77mhRJtFILKIGKLPH+J/nsX1NCTHyYdEunU6fiEo/nCt6NyKoa6YmDsRJl+SXPc7iuC8/zdnzf38dfHFFLvOYNba9wFg0uGsaYESVJgjiOEYYhoigy41F2fMTi3DuJbV2gphmjmiBujZGRwEJSSxAEf+tMYSsE1mXFvL3RDwpXIVEUxS6wlce1JU3T/dyuHclrzLpuWjYMulC2nS4sNJkRE1RM36WLNCfsPkmo2go/kkmh4Lk5vzsAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 9&apos; title=&apos;img 9&apos; src=&apos;/static/c430055c48849be8d51ece184c77a4d4/ca1dc/img_9.png&apos; srcset=&apos;/static/c430055c48849be8d51ece184c77a4d4/e7570/img_9.png 170w,
/static/c430055c48849be8d51ece184c77a4d4/f46e7/img_9.png 340w,
/static/c430055c48849be8d51ece184c77a4d4/ca1dc/img_9.png 680w,
/static/c430055c48849be8d51ece184c77a4d4/02d09/img_9.png 1020w,
/static/c430055c48849be8d51ece184c77a4d4/9d567/img_9.png 1360w,
/static/c430055c48849be8d51ece184c77a4d4/949cf/img_9.png 1740w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;이러한 문제를 해결하기 위해 저는 테스트 환경에서 하나의 &lt;code class=&quot;language-text&quot;&gt;LocalDateTime.now&lt;/code&gt;를 가지도록 해주기 위해서 &lt;code class=&quot;language-text&quot;&gt;Clock&lt;/code&gt;을 빈으로 등록하는 시점에 시간을 설정하는 방법을 선택하였습니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/1dfb0b1d39f63c0a64b52170017f78ef/949cf/img_10.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 29.411764705882355%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAx0lEQVQY05WRW5aEIAxEWY4JBAKC0PPc/6pqAnbr35yZj3sqSkylxL1/MB4PQe0KLQnMHkSbKcN7v/RV/wX3NTzeGuNzBLSjobZu2qGa/zXoGpjEo2R7mB+HABFZrO2Irg1/5+5zMXp8D0avGXttyKWg7BUpJUiMJ2YQzCyIEfypqz4XiK/eIHDzpdphzwG1Vot8WOSxYs96muxmoJqQckRUsX8dkSYakXPB0ce5jBa46cAWbyO2y6An2xO6WJGIb71qunst+g+MeLcxdloojAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 10&apos; title=&apos;img 10&apos; src=&apos;/static/1dfb0b1d39f63c0a64b52170017f78ef/ca1dc/img_10.png&apos; srcset=&apos;/static/1dfb0b1d39f63c0a64b52170017f78ef/e7570/img_10.png 170w,
/static/1dfb0b1d39f63c0a64b52170017f78ef/f46e7/img_10.png 340w,
/static/1dfb0b1d39f63c0a64b52170017f78ef/ca1dc/img_10.png 680w,
/static/1dfb0b1d39f63c0a64b52170017f78ef/02d09/img_10.png 1020w,
/static/1dfb0b1d39f63c0a64b52170017f78ef/9d567/img_10.png 1360w,
/static/1dfb0b1d39f63c0a64b52170017f78ef/949cf/img_10.png 1740w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;이를 통해 &lt;code class=&quot;language-text&quot;&gt;Clock&lt;/code&gt;을 모킹할 때 마다 &lt;code class=&quot;language-text&quot;&gt;Spring Context&lt;/code&gt;가 새로 띄워지는 문제를 제거하여 테스트 코드 실행 시간을 단축할 수 있었고, 전체 테스트를 구동했을 때 포트 충돌이 발생하는 문제를 해결할 수 있었습니다.&lt;/p&gt;
&lt;p&gt;하지만 해당 방법이 완벽한 것은 아닙니다. 모킹된 &lt;code class=&quot;language-text&quot;&gt;LocalDateTime&lt;/code&gt;이 전역적으로 모든 테스트에 설정된다는 점인데요. 이 때문에 협업 시에 문제가 발생할 수 있습니다. 이러한 부분은 &lt;code class=&quot;language-text&quot;&gt;Trade-Off&lt;/code&gt; 라고 보고 있는데, 문서화를 통해 같이 작업하는 사람들에게 미리 공지를 하는 방법으로 해결을 할 수 있을 것이라 생각합니다.&lt;/p&gt;
&lt;h2&gt;참고&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://stackoverflow.com/questions/68340718/mockito-mock-static-function-does-not-work-if-the-function-is-called-in-a-thread&quot;&gt;https://stackoverflow.com/questions/68340718/mockito-mock-static-function-does-not-work-if-the-function-is-called-in-a-thread&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://docs.oracle.com/javase/8/docs/api/java/time/LocalDate.html#now-java.time.Clock-&quot;&gt;https://docs.oracle.com/javase/8/docs/api/java/time/LocalDate.html#now-java.time.Clock-&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[캐시 설계 전략에 대해서 고민해보기]]></title><description><![CDATA[…]]></description><link>https://wishoon.github.io/캐시 설계 전략에 대해서 고민해보기/</link><guid isPermaLink="false">https://wishoon.github.io/캐시 설계 전략에 대해서 고민해보기/</guid><pubDate>Thu, 08 Dec 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;온라인 면접만 보다가 최근 처음으로 오프라인 기술 면접을 보게 되었습니다. 기술 질문 중 분산 환경에서의 캐시의 정합성을 어떻게 보장할 것인가에 대한 내용이 나왔었고 어찌어찌 대답은 했지만 썩 만족할만큼 대답을 하진 못했던 것 같습니다. 이번 글을 통해서 캐시에 대해서 한번 살펴보고 어떻게 구현을 해야할지 고민해보는 시간을 가져보려고 합니다.&lt;/p&gt;
&lt;h2&gt;캐시 전략이란?&lt;/h2&gt;
&lt;p&gt;캐시 전략은 웹 서비스 환경에서 시스템 성능 향상을 기대할 수 있는 중요한 기술입니다. 일반적으로 캐시는 메모리를 사용하기 때문에 기준의 RDMBS 보다 훨씬 빠르게 데이터를 응답할 수 있어 서비스 이용자들에게 빠르게 서비스를 제공할 수 있습니다. 따라서 어느 종류의 데이터를 캐시에 저장할지, 얼만큼 데이터를 캐시에 저장할지에 대해 “캐시 지침 전략”을 고민해볼 필요가 있습니다.&lt;/p&gt;
&lt;p&gt;기본적으로 캐시를 호출하게 되면 &lt;code class=&quot;language-text&quot;&gt;cache hit&lt;/code&gt; 와 &lt;code class=&quot;language-text&quot;&gt;cache miss&lt;/code&gt;로 동작한다고 할 수 있습니다.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;cache hit : 캐시 스토어에 데이터가 있을 경우 바로 가져옴&lt;/li&gt;
&lt;li&gt;cache miss : 캐시 스토어에 데이터가 없을 경우 데이터베이스 에서 가져옴&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;캐시를 사용하게 되면 반드시 고려해야 하는 문제가 있습니다. 바로 &lt;strong&gt;데이터 정합성&lt;/strong&gt; 입니다.&lt;/p&gt;
&lt;p&gt;데이터 정합성이란, 어느 한 데이터가 캐시와 데이터베이스 두 곳에서 같이 관리되어 같은 데이터임에도 불구하고 &lt;strong&gt;데이터 정보값이 서로 다른 현상&lt;/strong&gt;을 말합니다. 이전에는 그냥 데이터베이스에서 데이터 조회와 변경을 처리하였기 때문에 정합성 문제가 발생하지 않았지만, 캐시라는 다른 데이터 저장소를 이용하기 때문에 두 저장소에 저장된 값이 서로 다른 현상이 일어날 수 있는 것입니다.&lt;/p&gt;
&lt;p&gt;이러한 기본 개념을 바탕으로 캐시 전략을 어떻게 수립할지 각 패턴에 대해서 한번 살펴보도록 하겠습니다.&lt;/p&gt;
&lt;h2&gt;캐시 전략의 패턴&lt;/h2&gt;
&lt;h3&gt;캐시 읽기 전략 - Cashe Aside 패턴&lt;/h3&gt;
&lt;p&gt;데이터를 찾을 때 &lt;strong&gt;우선 캐시에 저장된 데이터가 있는지 우선적으로 확인하는 전략&lt;/strong&gt;을 말합니다. 만일 캐시에 데이터가 없을 경우 DB에서 조회를 하는 방식으로 동작합니다.&lt;/p&gt;
&lt;p&gt;읽기가 많은 경우에 적합하며, 가용성 측면에서 Cache 서버에 장애가 발생해도 데이터베이스를 통해 문제 없이 서비스를 운용할 수 있습니다. 다만 캐시에 붙어있는 Connection이 많다면 데이터베이스에 부하가 발생하는 문제가 생길 수 있습니다. 또한 Cashe 서버와 데이터베이스 간의 데이터 정합성 문제가 발생할 수 있으며, 초기 요청은 반드시 데이터베이스를 호출해야 하는 단점이 있습니다.&lt;/p&gt;
&lt;p&gt;이 때문에 반복적으로 동일 쿼리를 수행하는 서비스에 적합한 아키텍처라고 할 수 있습니다.&lt;/p&gt;
&lt;h3&gt;캐시 읽기 전략 - Read Through 패턴&lt;/h3&gt;
&lt;p&gt;데이터를 찾을 때 &lt;strong&gt;무조건 캐시에서만 데이터를 읽어오는 전략&lt;/strong&gt;을 말합니다. 만일 캐시에 데이터가 없을 경우 DB에서 조회를 하는 방식으로 동작합니다. Cashe Aside와 비슷하지만 데이터 동기화를 라이브러리 혹은 캐시 제공자에게 위임하는 방식이 차이점이 있습니다.&lt;/p&gt;
&lt;p&gt;읽기가 많은 경우에 적합하며, 캐시와 데이터베이스의 데이터 정합성이 보장되기 때문에 정합성에 대한 고민을 하지 않고 서비스를 운용할 수 있습니다. 다만 캐시가 문제가 발생했을 경우 서비스 전체가 중단되어 버리는 문제가 발생할 수 있습니다. 이 때문에 캐시 스토어를 가용성 측면에서 Replication과 Cluster로 구성하여 문제가 없도록 설계해야 합니다.&lt;/p&gt;
&lt;p&gt;즉, 반복적으로 동일 쿼리를 수행하는 서비스 중 정합성이 보장되어야 하는 서비스에 적합한 아키텍처라고 할 수 있습니다.&lt;/p&gt;
&lt;h3&gt;캐시 쓰기 전략 - Write Back 패턴&lt;/h3&gt;
&lt;p&gt;데이터를 저장할 때 &lt;strong&gt;데이터베이스에 바로 저장하지 않고 캐시에 모아서 일정 주기로 배치 작업을 수행해서 데이터베이스에 반영하는 전략&lt;/strong&gt;을 말합니다.&lt;/p&gt;
&lt;p&gt;한번에 데이터를 저장하기 때문에 쓰기 쿼리 커넥션의 회수 비용과 부하를 줄일 수 있어 쓰기가 빈번하면서 일기 작업시 많은 양의 자원이 소모되는 서비스에 적합하다고 할 수 있습니다. 또한 서버는 캐시만 바라보고 있기 때문에 데이터 정합성을 확보할 수 있습니다. 다만 캐시에서 오류가 발생할 경우 서비스 전체가 중단되는 문제가 있습니다. 이 때문에 캐시 스토어를 가용성 측면에서 &lt;code class=&quot;language-text&quot;&gt;Replicaiton&lt;/code&gt;과 &lt;code class=&quot;language-text&quot;&gt;Cluster&lt;/code&gt;로 구성하여 문제가 없도록 설계해야 합니다. 또한 자주 사용되지 않는 데이터가 저장되어 캐시의 리소스 낭비가 발생할 수 있기 때문에 &lt;code class=&quot;language-text&quot;&gt;TTL&lt;/code&gt;을 유의미하게 사용해야 합니다.&lt;/p&gt;
&lt;p&gt;즉, 쓰기가 빈번하고 읽기 작업에 많은 리소스가 소모되면서 정합성이 보장되어야 하는 서비스에 적합한 아키텍처라고 할 수 있습니다.&lt;/p&gt;
&lt;h3&gt;캐시 쓰기 전략 - Write Through 패턴&lt;/h3&gt;
&lt;p&gt;데이터를 저장할 때 &lt;strong&gt;캐시와 데이터베이스에 동시에 데이터를 저장하는 전략&lt;/strong&gt;을 말합니다.&lt;/p&gt;
&lt;p&gt;캐시와 데이터베이스가 항상 동기화 되어 있어, 캐시의 데이터는 항상 최신 상태로 유지되기 때문에 안정적으로 데이터 정합성을 확보해야 하는 서비스에 적합하다고 할 수 있습니다. 다만 매번 두번의 쓰기 요청이 발생하기 때문에 빈번한 수정, 생성이 발생하는 서비스에서는 성능 이슈가 발생할 수 있습니다. 다만 자주 사용되지 않는 데이터가 저장되어 캐시의 리소스 낭비가 발생할 수 있기 때문에 &lt;code class=&quot;language-text&quot;&gt;TTL&lt;/code&gt;을 유의미하게 사용해야 합니다.&lt;/p&gt;
&lt;p&gt;즉, 안정적으로 데이터 정합성을 보장해야 하는 서비스에 적합한 아키텍처라고 할 수 있습니다.&lt;/p&gt;
&lt;h3&gt;캐시 쓰기 전략 - Write Around 패턴&lt;/h3&gt;
&lt;p&gt;데이터를 저장할 때 데이터베이스에 데이터를 저장하는 전략을 말합니다.&lt;/p&gt;
&lt;p&gt;캐시를 거치지 않기 때문에 속도가 매우 빠릅니다. 하지만 &lt;code class=&quot;language-text&quot;&gt;cashe miss&lt;/code&gt;가 발생해야만 데이터베이스와 동기화를 수행하기 때문에, 캐시와 데이터베이스간의 불일치가 발생할 수 있습니다. 이 때문에 저장된 데이터가 수정, 삭제될 때마다 캐시 또한 삭제하거나 변경하는 작업을 수행해야 하며, 캐시의 &lt;code class=&quot;language-text&quot;&gt;Expire&lt;/code&gt;를 짧게 조정하는 하도록 설계해야 합니다.&lt;/p&gt;
&lt;p&gt;즉, 데이터가 한 번 쓰여지고, 덜 자주 읽어지는 서비스에 적합한 아키텍처라고 할 수 있습니다.&lt;/p&gt;
&lt;h2&gt;캐시 전략 조합해보기&lt;/h2&gt;
&lt;p&gt;일반적으로는 &lt;code class=&quot;language-text&quot;&gt;Lock Aside&lt;/code&gt; + &lt;code class=&quot;language-text&quot;&gt;Write Around&lt;/code&gt;를 사용하지만 정확성 보장이 되지 않습니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/923cd5ad703d6d2ab9fcb866c63fadf1/f97d7/img.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 33.529411764705884%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAAA3ElEQVQoz4WRAW+DIBCF+f9/0dSVVTrNag0osCLwdkdXh1uzveTLhVMej0PknPGAtVvn+zqm+IOEeZ5hrS11WRYk6rEEvlQb1Qdor+GC2+HXD5zPCu3hAPkq0bZtMS+GD+dnYlM2/EsmmN3/omkaSCnhvYdzbqvGGHRdh5fjEcMwwFuDWY9YzPWOvsJM73DUr28kQghgOGmMcWNd14K9XErN9D1RP9EMuVKDI9FM9G5kAv8o0YZMqVMFbjdYegylFNTphGmavhM+e4xfUKIaTuZpLH3f440Yx3Ez/AQFLyP0ZsspzgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img&apos; title=&apos;img&apos; src=&apos;/static/923cd5ad703d6d2ab9fcb866c63fadf1/ca1dc/img.png&apos; srcset=&apos;/static/923cd5ad703d6d2ab9fcb866c63fadf1/e7570/img.png 170w,
/static/923cd5ad703d6d2ab9fcb866c63fadf1/f46e7/img.png 340w,
/static/923cd5ad703d6d2ab9fcb866c63fadf1/ca1dc/img.png 680w,
/static/923cd5ad703d6d2ab9fcb866c63fadf1/02d09/img.png 1020w,
/static/923cd5ad703d6d2ab9fcb866c63fadf1/9d567/img.png 1360w,
/static/923cd5ad703d6d2ab9fcb866c63fadf1/f97d7/img.png 2000w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;이러한 내용을 보안하기 위해 &lt;code class=&quot;language-text&quot;&gt;Read Through&lt;/code&gt; + &lt;code class=&quot;language-text&quot;&gt;Write Around&lt;/code&gt; 조합을 통해 데이터 정합성 이슈에 대한 안정 장치를 구성할 수 있습니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/8f00f38e730dcbcdca837994f9aad9f2/f97d7/img_1.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 35.29411764705882%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAAA4UlEQVQoz32R23LDIAxE/f+f2HY8qXnwU6bhfhVbIceuk0nKzFpgkDhaJvDovR/a1+dIndCoHRrrWitSSsi5IKaI1pqcnc7Jz+KPJNvkkGpCKJEVkFvG9eeKeZ6hlMLXxye00X8F96KvRm0Vrri3+9YbkE0H1DQm67rKbd57aSPGKDLGCMHl+4KbvgmZzx7xTuqHokML+bHg6D/nDCKS+a7hU+H/0XES73EvbAFrxDPmZt9W8L9276dATN7HhSGAuANi+qo11KI2H5dFYMTDdw/yoEHHxGdRKbDWQnPhEXewX7eMJXVssM8BAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 1&apos; title=&apos;img 1&apos; src=&apos;/static/8f00f38e730dcbcdca837994f9aad9f2/ca1dc/img_1.png&apos; srcset=&apos;/static/8f00f38e730dcbcdca837994f9aad9f2/e7570/img_1.png 170w,
/static/8f00f38e730dcbcdca837994f9aad9f2/f46e7/img_1.png 340w,
/static/8f00f38e730dcbcdca837994f9aad9f2/ca1dc/img_1.png 680w,
/static/8f00f38e730dcbcdca837994f9aad9f2/02d09/img_1.png 1020w,
/static/8f00f38e730dcbcdca837994f9aad9f2/9d567/img_1.png 1360w,
/static/8f00f38e730dcbcdca837994f9aad9f2/f97d7/img_1.png 2000w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;정말 정합성이 중요한 서비스라면, 항상 캐시에 데이터를 먼저 쓰는 방식인 &lt;code class=&quot;language-text&quot;&gt;Read Through&lt;/code&gt; + &lt;code class=&quot;language-text&quot;&gt;Write Through&lt;/code&gt; 방식을 통해 완전하게 데이터 정합성 문제를 해결하는 방법을 선택할 수 있습니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/f5bde0f34a73e011b22eb8925a3877a3/f97d7/img_2.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 33.529411764705884%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAw0lEQVQoz41RDQuDIBTs///DILTGWBDLzPzAMm9puJVrsIPj0KfPe2fhvUdiwFFzYi9FkVJCa/3WdK/AAV8NMmy70FaBPR+41zXoxubWgBAC59zecF3XuLhqEGqBoTbIHpPoYSYOZ8x+wC0Qhp8MFV3XoSxLCCFgrY32zXZBKYW2bUEpjWqNhF+Wg1tgDiOrETGNNHJymPQX81gitkfnWZ+yL/An8mzHcQSpqjgBY+wz8tVvXv5w5i7EwznHMAwxnlR/AXiEJaUa+cKJAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 2&apos; title=&apos;img 2&apos; src=&apos;/static/f5bde0f34a73e011b22eb8925a3877a3/ca1dc/img_2.png&apos; srcset=&apos;/static/f5bde0f34a73e011b22eb8925a3877a3/e7570/img_2.png 170w,
/static/f5bde0f34a73e011b22eb8925a3877a3/f46e7/img_2.png 340w,
/static/f5bde0f34a73e011b22eb8925a3877a3/ca1dc/img_2.png 680w,
/static/f5bde0f34a73e011b22eb8925a3877a3/02d09/img_2.png 1020w,
/static/f5bde0f34a73e011b22eb8925a3877a3/9d567/img_2.png 1360w,
/static/f5bde0f34a73e011b22eb8925a3877a3/f97d7/img_2.png 2000w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2&gt;캐시 저장 방식 지침&lt;/h2&gt;
&lt;p&gt;캐시 솔루션은 자주 사용되면서 자주 변경되지 않는 데이터의 경우 캐시 스토어에 적용하여 반영할 경우 높은 성능 향상을 이뤄낼 수 있습니다. 이를 &lt;code class=&quot;language-text&quot;&gt;Cashe Hit Rating&lt;/code&gt; 이라고 합니다.&lt;/p&gt;
&lt;p&gt;또한 캐시를 저장하는 곳이 &lt;strong&gt;메모리이기 때문에 휘발될 수 있다는 점에 주의&lt;/strong&gt;를 해야합니다.&lt;/p&gt;
&lt;p&gt;이러한 내용들을 바탕으로 캐시 스토어에 저장되는 내용은 중요한 정보, 민감 정보등은 저장하지 않는 것이 좋으며, 캐시 스토어가 장애가 발생했을 경우 대응할 수 있는 방안을 고려하여 설계하는 것이 바람직 합니다.&lt;/p&gt;
&lt;h2&gt;캐시 삭제 방식 지침&lt;/h2&gt;
&lt;p&gt;캐시에 저장된 데이터의 경우 캐시 서버에만 단독으로 저장되는 경우도 있을 수 있지만, 대부분의 경우 영구 저장소에 저장된 데이터를 바탕으로 하여 복사된 데이터를 기준으로 동작하는 경우가 많습니다. 즉, 영구 저장소의 데이터와 캐시 스토어의 데이터를 동기화 하는 작업이 반드시 필요하다고 할 수 있습니다.&lt;/p&gt;
&lt;p&gt;만약 캐시의 만료 정책이 제대로 구현되지 않은 경우 클라이언트는 데이터가 변경되었음에도 오래된 정보가 캐싱되어 있어 데이터 정합성이 맞지 않는 문제가 발생할 수 있다고 할 수 있습니다.&lt;/p&gt;
&lt;p&gt;따라서 캐시를 구성할 때는 기본 만료 정책을 구성해야 하며, 캐시된 데이터가 기간이 만료되면 데이터를 제거하고 원래의 영구 저장소에서 데이터를 검색해서 사용자에게 제공해야 합니다. 추가적으로 고려해야 할 점은 캐시의 만료 주기가 너무 짧으면 캐시를 사용하는 이점이 줄어들기 때문에 시스템에 맞게 적절한 만료주기를 구성하여 적용하는 것이 바람직 합니다.&lt;/p&gt;
&lt;h2&gt;캐시 공유 방식 지침&lt;/h2&gt;
&lt;p&gt;보통 분산 환경에서 어플리케이션을 운용하기 때문에 캐시는 여러 인스턴스에서 공유되어 사용됩니다. 이 때문에 각 어플리케이션에서 캐시의 데이터를 읽고 수정할 수 있습니다. 따라서 &lt;strong&gt;캐시에 보관되어 있는 데이터 정합성에 문제가 발생&lt;/strong&gt;할 수 있습니다.&lt;/p&gt;
&lt;p&gt;이를 해결하기 위해서 첫 번째로 고민한 방식은 캐시 데이터를 변경하기 직전에 데이터가 검색된 이후 변경되지 않았는지 확인하는 방법입니다. 변경되지 않았다면 즉시 업데이트를 하고, 변경되었다면 업데이트 여부를 애플리케이션 레벨에서 결정하도록 수정하는 방식을 취할 수 있습니다.&lt;/p&gt;
&lt;p&gt;해당 방식은 업데이트가 적게 발생하고, 충돌이 잘 발생하지 않는 상황에서 적용하기 용이하다고 할 수 있습니다.&lt;/p&gt;
&lt;p&gt;두 번째로 고민한 방법은 캐시 데이터를 업데이트 하기 전에 Lock을 잡는 방식입니다. 해당하는 경우 조금 더 안전하게 정합성 문제를 해결할 수 있지만 Lock으로 인해 대기현상이 발생하게 됩니다.&lt;/p&gt;
&lt;p&gt;해당 방식은 데이터의 사이즈가 작아 빠르게 업데이트가 가능한 업무와 빈번한 업데이트가 발생하는 상황에 적용하기 용이하다고 할 수 있습니다.&lt;/p&gt;
&lt;h2&gt;마무리..&lt;/h2&gt;
&lt;p&gt;기본적으로 캐시에 대해서 어떻게 사용해야 하는지, 전략은 어떤 방식이 있는지 알아볼 수 있는 시간이였습니다. 이후로는 단일 서버와 분산 서버 환경에서 어떻게 캐시를 구현하는지, 가용성을 올리기 위해서는 어떤 부분을 고민해야 하는지를 계속 학습해보려고 합니다.&lt;/p&gt;
&lt;h2&gt;참고&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://inpa.tistory.com/entry/REDIS-%F0%9F%93%9A-%EC%BA%90%EC%8B%9CCache-%EC%84%A4%EA%B3%84-%EC%A0%84%EB%9E%B5-%EC%A7%80%EC%B9%A8-%EC%B4%9D%EC%A0%95%EB%A6%AC&quot;&gt;https://inpa.tistory.com/entry/REDIS-📚-캐시Cache-설계-전략-지침-총정리&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://learn.microsoft.com/ko-kr/azure/architecture/patterns/cache-aside&quot;&gt;https://learn.microsoft.com/ko-kr/azure/architecture/patterns/cache-aside&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://dzone.com/articles/using-read-through-amp-write-through-in-distribute&quot;&gt;https://dzone.com/articles/using-read-through-amp-write-through-in-distribute&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://brunch.co.kr/@springboot/151&quot;&gt;https://brunch.co.kr/@springboot/151&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[동시성 문제 해결을 통한 제고 시스템 구현하기 - 2]]></title><description><![CDATA[저번 글에서는 트랜잭션의 관점에서 어떻게 동시성 문제를 해결하는지 살펴보고, Spring…]]></description><link>https://wishoon.github.io/동시성 문제 해결을 통한 제고 시스템 구현하기 - 2/</link><guid isPermaLink="false">https://wishoon.github.io/동시성 문제 해결을 통한 제고 시스템 구현하기 - 2/</guid><pubDate>Mon, 05 Dec 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;저번 글에서는 트랜잭션의 관점에서 어떻게 동시성 문제를 해결하는지 살펴보고, Spring에서는 어떻게 트랜잭션을 지원하는지 살펴보는 시간을 가졌었습니다.&lt;/p&gt;
&lt;p&gt;이번 시간에서는 요구사항을 구현하기 위해 추가적으로 필요한 개념과 실제 코드를 통해 동시성 문제를 해결해보는 과정을 한번 작성해보려고 합니다.&lt;/p&gt;
&lt;h2&gt;분산 환경에서 동시성 문제를 해결하기 위해 고민해야 할 점&lt;/h2&gt;
&lt;p&gt;일반적으로 웹 어플리케이션을 개발하게 된다면 프로세스를 단 하나만 사용하는 서비스는 거의 없습니다. 대량의 사용자 요청을 받아내기 위해서 분산 환경을 운용하여 부하를 분산하게 됩니다. 이러한 조건 때문에 기본적으로 단일 환경에서 사용할 수 있는 동시성 제어를 위한 기능들은 사용을 할 수 없습니다.&lt;/p&gt;
&lt;p&gt;이러한 &lt;strong&gt;분산 환경에서도 공유 자원에 대한 상호 배제를 구현해서 동시성 문제를 해결하는 방법 중 하나가 바로 분산 락&lt;/strong&gt; 입니다. 기본적으로 분산 락은 락에 대한 정보를 어떠한 공간에 보관하는 작업을 수행합니다. 그리고 보관된 공간에 대해서 여러 분산 환경에서도 공통되게 바라볼 수 있는 환경을 구축하고, 해당 환경들이 공유 자원에 접근할 수 있는지 확인하는 작업을 수행하며 동작이 이루어지게 됩니다. 이를 통해서 분산 환경에서도 공유 자원에 대한 상호 배제를 수행할 수 있게 됩니다.&lt;/p&gt;
&lt;p&gt;이러한 분산 락을 구현하기 위한 기술로는 MySQL의 Named Lock과 Redis, Zookeeper가 존재합니다. 저는 Redis를 사용해서 분산 락을 구현하기로 하였습니다. Redis를 사용한 이유는 Single Thread 기반으로 동작하기 때문에 동시성을 제어할 때 좋은 선택이라는 생각이 들었고, 락을 보관하는 정보과 휘발성 데이터에 가깝다고 생각했기 때문에 Memory DB인 Redis를 사용하기로 결정하였습니다.&lt;/p&gt;
&lt;h2&gt;Redis를 활용하기 위한 방법 고민하기&lt;/h2&gt;
&lt;p&gt;Redis를 사용하기로 결정하였으므로 어떻게 Redis를 이용해 Lock을 수행해야 할지 고민해야 했습니다. 크게 스핀 락과 Message Broker 방식 중에서 고민하였습니다.&lt;/p&gt;
&lt;h3&gt;스핀 락&lt;/h3&gt;
&lt;p&gt;먼저 고민한 방법은 스핀 락 방법입니다. 스핀 락은 락을 사용할 수 있을 때 까지 지속적으로 계속 확인을 요청하며 기다리는 방식을 말합니다. 즉, 레디스 서버에 지속적으로 락을 획득할 수 있는지 확인 요청을 보내어 공유 자원 획득여부를 확인하는 방식으로 구현을 고민해볼 수 있습니다.&lt;/p&gt;
&lt;p&gt;Redis에서는 &lt;code class=&quot;language-text&quot;&gt;SETNX&lt;/code&gt; 명령을 통해서 이를 구현할 수 있습니다. Key 값을 식별할 수 있는 유니크 값으로 설정하고 Value 값을 “Lock”을 의미하는 값으로 두어 각 요청마다 Key의 Lock 유무를 판단해 스핀 락을 구현할 수 있습니다. 이러한 환경을 구축하는 Redis Client로는 &lt;code class=&quot;language-text&quot;&gt;Lettuce&lt;/code&gt;를 활용하여 구현할 수 있습니다.&lt;/p&gt;
&lt;p&gt;이렇게 스핀 락을 구현하게 되면 위에서 언급한 Redis Client인 &lt;code class=&quot;language-text&quot;&gt;Lettuce&lt;/code&gt; 만으로 간단하게 구현을 할 수 있습니다. 하지만 스핀 락이 가지는 단점인 계속 요청을 하여 서버에 부하를 줄 수 있다는 점 때문에 해당 방법은 사용하지 않았습니다.&lt;/p&gt;
&lt;h3&gt;Message Broker&lt;/h3&gt;
&lt;p&gt;다음으로 고민한 방법은 Message Broker라는 방법입니다. Redis에서 &lt;code class=&quot;language-text&quot;&gt;SUBSCRIBE&lt;/code&gt; 명령을 통해 특정 채널을 구독하고, &lt;code class=&quot;language-text&quot;&gt;PUBLISH&lt;/code&gt; 명령으로 특정 채널에 메시지를 발행할 수 있는 기능을 제공하고 있습니다. 이러한 원리를 이용해 락을 해제하는 프로세스에서 락을 대기하는 프로세스에게 “락 획득 시도 메시지”라는 PUBLISH 명령으로 메시지를 발행하게 되면 분산 락을 구현할 수 있습니다.&lt;/p&gt;
&lt;p&gt;이러한 방법을 사용할 수 있도록 Redis의 Message Broker 기능을 활용한 &lt;code class=&quot;language-text&quot;&gt;Redisson&lt;/code&gt; 라이브러리를 통해 분산 락 기능을 간단하게 구현할 수 있습니다.&lt;/p&gt;
&lt;p&gt;이렇게 Message Broker 기능을 통해 분산 락을 구현하게 되면 스핀락 방식이 아니므로 불필요한 트래픽이 발생하지 않아 서버의 부하를 낮출 수 있다는 장점이 있어 이번 구현에서는 Message Broker 방식을 사용하기로 하였습니다.&lt;/p&gt;
&lt;h2&gt;Annotation 기반의 분산 락 구현하기&lt;/h2&gt;
&lt;p&gt;Message Broker 방식의 분산 락을 구현하면서 스프링 AOP를 사용하여서 &lt;code class=&quot;language-text&quot;&gt;@Transactional&lt;/code&gt;과 같이 Annotation 기반으로 분산 락을 적용하기로 하였습니다. 이렇게 Annotation 기반으로 구현을 한 이유는 다음과 같습니다.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;분산 락을 적용하고자 하는 코드에 어노테이션만 사용하면 분산락을 처리할 수 있음&lt;/li&gt;
&lt;li&gt;공통적으로 반복되는 코드를 제거할 수 있음&lt;/li&gt;
&lt;li&gt;비즈니스 로직과 분산 락을 처리하는 로직의 관심사를 분리하여 코드를 작성할 수 있음&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;이러한 이유들을 기반으로 하여 이제 Annotation을 기반으로 분산 락을 작성해보도록 하겠습니다. 먼저 분산락을 적용하기 위한 어노테이션을 작성해줍니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token annotation punctuation&quot;&gt;@Target&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;ElementType&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;METHOD&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token annotation punctuation&quot;&gt;@Retention&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;RetentionPolicy&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;RUNTIME&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token annotation punctuation&quot;&gt;@interface&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;DistributeLock&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; 

    &lt;span class=&quot;token class-name&quot;&gt;TimeUnit&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;timeUnit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;default&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;TimeUnit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;SECONDS&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; 

    &lt;span class=&quot;token keyword&quot;&gt;long&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;waitTime&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;default&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5L&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; 

    &lt;span class=&quot;token keyword&quot;&gt;long&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;leaseTime&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;default&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3L&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;분산 락을 적용하기 위해서는 각 요청에 유니크한 Key가 필요합니다. 이러한 이유 때문에 Annotation에서 Key를 받을 수 있도록 기능을 제공하도록 코드를 작성합니다. 또한 분산 락에 필요한 시간을 설정해주기 위해 락 획득 대기 시간과, 임대 시간을 설정해줄 수 있는 기능을 제공하도록 코드를 작성하여 Annotation을 완성합니다.&lt;/p&gt;
&lt;p&gt;이렇게 개발된 Annotation을 선언한 메소드를 호출했을때 실행되는 Asepct를 개발해주도록 하겠습니다.&lt;code class=&quot;language-text&quot;&gt;@Around&lt;/code&gt; 어노테이션을 이용해서 &lt;code class=&quot;language-text&quot;&gt;PointCut&lt;/code&gt;을 설정하고 실제 부가기능을 구현할 Advice를 작성해줍니다. 먼저 실제 호출해야 하는 정보가 담겨있는 객체(ProceedingJoinPoint)와 호출한 메서드에 선언되어 있는 &lt;code class=&quot;language-text&quot;&gt;@DistributeLock&lt;/code&gt; 정보를 가져오는 로직을 작성해줍니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;DistributeLockAspect&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;RedissonClient&lt;/span&gt; redissonClient&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token annotation punctuation&quot;&gt;@Around&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;@annotation(com.woowacourse.kkogkkog.common.distribute.DistributeLock)&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Object&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;lock&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ProceedingJoinPoint&lt;/span&gt; joinPoint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Throwable&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;MethodSignature&lt;/span&gt; signature &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;MethodSignature&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; joinPoint&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getSignature&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;Method&lt;/span&gt; method &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; signature&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getMethod&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;DistributeLock&lt;/span&gt; lock &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; method&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getAnnotation&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;DistributeLock&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;@DistributeLock&lt;/code&gt;에는 락의 Key로 사용하기 위해 전달한 정보가 있습니다. 해당 정보(Key)를 가져오기 위해 &lt;code class=&quot;language-text&quot;&gt;SpringEL&lt;/code&gt;을 파싱하는 작업을 수행하여 정보를 가져오는 작업을 수행해줍니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Object&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;getDynamicValueParser&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; parameterNames&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Object&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; args&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt; key&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token class-name&quot;&gt;ExpressionParser&lt;/span&gt; parser &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;SpelExpressionParser&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token class-name&quot;&gt;StandardEvaluationContext&lt;/span&gt; context &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;StandardEvaluationContext&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; parameterNames&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;length&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      context&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;setVariable&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;parameterNames&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; args&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; parser&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;parseExpression&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;key&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getValue&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;context&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Object&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;그리고 가져온 키를 바탕으로 &lt;code class=&quot;language-text&quot;&gt;Redisson&lt;/code&gt;에 해당 락의 &lt;code class=&quot;language-text&quot;&gt;RLock&lt;/code&gt;의 인터페이스를 가져오는 작업을 수행합니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token class-name&quot;&gt;RLock&lt;/span&gt; rLock &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; redissonClient&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getLock&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;key&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;이후 try-catch 메서드를 이용해서 &lt;code class=&quot;language-text&quot;&gt;Lock&lt;/code&gt; 획득을 시도하는 로직을 작성해줍니다. 만약 획득이 실패할경우 분기문을 통해서 &lt;code class=&quot;language-text&quot;&gt;Lock&lt;/code&gt;이 해제 될 때까지 &lt;code class=&quot;language-text&quot;&gt;SUBSCRIBE&lt;/code&gt;를 수행하는 로직을 수행해줍니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;boolean&lt;/span&gt; available &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; rLock&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;tryLock&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;distributeLock&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;waitTime&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; distributeLock&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;leaseTime&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; distributeLock&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;timeUnit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;available&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;만약 &lt;code class=&quot;language-text&quot;&gt;Lock&lt;/code&gt; 획득에 성공했다면 실제 선언된 메서드의 로직을 수행합니다. 이때 우리가 고려해줘야 할 점이 있습니다. 바로 &lt;strong&gt;실제 선언된 메서드가 호출되어 커밋이 된 이후에 &lt;code class=&quot;language-text&quot;&gt;Lock&lt;/code&gt;을 해제&lt;/strong&gt;해야 한다는 점입니다.&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Lock&lt;/code&gt;을 선점한 뒤, 쿠폰의 재고 조회 및 차감에 대한 비즈니스 로직이 수행되게 되는데 이때 트랜잭션이 커밋되고 이후에 &lt;code class=&quot;language-text&quot;&gt;Lock&lt;/code&gt;이 해제되어야 다른 클라이언트가 잘못된 재고의 수량을 읽지 않게 됩니다.&lt;/p&gt;
&lt;p&gt;예제를 보면 그 상황을 알 수 있습니다. [사용자 1], [사용자 2]가 동시에 재고라는 공유자원에 접근하고 있습니다. 이 때, [사용자 1]이 트랜잭션이 커밋이 되기 전 &lt;code class=&quot;language-text&quot;&gt;Lock&lt;/code&gt;을 해제합니다. 이 순간에 [사용자 2]가 &lt;code class=&quot;language-text&quot;&gt;Lock&lt;/code&gt;을 획득 해 재고의 값을 읽게 된다면 아직 [사용자 1]의 트랜잭션이 커밋되지 않아 차감이 이루어지기 전의 값을 그대로 읽어오게 됩니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/856509d175c3f7089d0a8daf3c8086ad/f97d7/img.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 92.3529411764706%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsTAAALEwEAmpwYAAABpklEQVQ4y5WUC5OCMAyE/f+/EOYEUcEXLxUV3zm/3IWRonLXmUxqabebzdbB/X6X4/Eoy+VSoiiS2Wymwdr1ehUGewgGa3ybTCaSJInmNE2lrmvdM7jdbgo0Go0UiMyG9XotVVV1AFkbDod6Zjwe6/48z2W1WsnlcvkBnE6n+oHbCObz+VwOh0MHkP0wPJ1OClSWpc5ZaxgCyG1kgttdwOdsgyq2221rTQEBC8NQ2ZE9z9Oydrtdh+HzHMAsy2S/3ytww9AasVgsVGhY8ttlaKMXEEHpMh+ZA1YUhXbuE0P0e1kymgVB0HSOOeX3aYgbaEwLkE3GCpY2hy3de+fD8/msJaNzq8vSM1x2ANA4qsBeBHOIcJkyRCtucAOjugyRwfxKmFxIhXyqITf6vq/562EXMtq8eil0lMMWMMRiZAVkI3rQrRhjP241/djwCpDyaAjBA8BunFHAjmi/IO80pGTzLYFv4zjWhjYMW8HhD96Dof2ZmM0oGZYN4POhd0AuoL19sllOuyx/HAaII2Bj/0p0GLDNZvM/QPelAFwWueSPBmEx+/4N4SdrbWe0FGsAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img&apos; title=&apos;img&apos; src=&apos;/static/856509d175c3f7089d0a8daf3c8086ad/ca1dc/img.png&apos; srcset=&apos;/static/856509d175c3f7089d0a8daf3c8086ad/e7570/img.png 170w,
/static/856509d175c3f7089d0a8daf3c8086ad/f46e7/img.png 340w,
/static/856509d175c3f7089d0a8daf3c8086ad/ca1dc/img.png 680w,
/static/856509d175c3f7089d0a8daf3c8086ad/02d09/img.png 1020w,
/static/856509d175c3f7089d0a8daf3c8086ad/9d567/img.png 1360w,
/static/856509d175c3f7089d0a8daf3c8086ad/f97d7/img.png 2000w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;이러한 문제를 해결하기 위해 트랜잭션이 커밋된 이후에 &lt;code class=&quot;language-text&quot;&gt;Lock&lt;/code&gt;을 해제하는 방법으로 변경한다면 정상적으로 우리가 원하는 결과를 얻을 수 있습니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 662px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/77dbeba0d4001eb4b63d7d9555625ea1/46b67/img_1.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 86.47058823529412%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsTAAALEwEAmpwYAAABiElEQVQ4y62UiY6CUAxF+f/Pc5wo7oILiIkLbuDS8TRT5vEkZiaZl1QKNKe9bTGQ57nf73K5XKTX68lsNpMwDGW/3+vzx+NRmcUeDgcZDocymUzUNpuNPucE/OR5rgFxHEsURWoACeS4QJ6TeDqdahzAdrst6/W6DuQFQUDxue52uxfg7XaToijUsiyT8/ms/vV6/QEiwTIi2cAu0L3aSdO0ds/7Cjgejytov99XMxluhW5PAaKO1lBprUJA8/lcKwTOfZNk97parRR0Op2kLMs60CpEKj593G63b4Ekp6cvko/Ho5ZPRmy5XGpmErl98/0kSZqB7CByWYePVks+n2sQP7OTyK+QfbP9ZLL4QF/2EInulK2H/mITOxqNaiuGj5oKSDBZ1L4rMGtabAPa8JBuAwz83fKPPwyAnU5H22MG1AYY+Lvlm1+htYfWYPhUTKIK+Jvq3Aq73a4MBgNdfv5IuLfv/i2wSbINxYb4LxXaUMyA/gnIZ8U/S5YmslgsVCqSzfgQDPgF6/IdvjvbgjIAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 1&apos; title=&apos;img 1&apos; src=&apos;/static/77dbeba0d4001eb4b63d7d9555625ea1/46b67/img_1.png&apos; srcset=&apos;/static/77dbeba0d4001eb4b63d7d9555625ea1/e7570/img_1.png 170w,
/static/77dbeba0d4001eb4b63d7d9555625ea1/f46e7/img_1.png 340w,
/static/77dbeba0d4001eb4b63d7d9555625ea1/46b67/img_1.png 662w&apos; sizes=&apos;(max-width: 662px) 100vw, 662px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;이러한 개념들을 바탕으로 Advice에 로직을 구현한다면 다음과 같이 구현한다면 목표했던 Annotation 기반의 분산 락을 구현할 수 있게 됩니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token annotation punctuation&quot;&gt;@Around&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;@annotation(com.woowacourse.kkogkkog.common.distribute.DistributeLock)&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Object&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;lock&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ProceedingJoinPoint&lt;/span&gt; joinPoint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Throwable&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token class-name&quot;&gt;MethodSignature&lt;/span&gt; signature &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;MethodSignature&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; joinPoint&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getSignature&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token class-name&quot;&gt;Method&lt;/span&gt; method &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; signature&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getMethod&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token class-name&quot;&gt;DistributeLock&lt;/span&gt; lock &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; method&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getAnnotation&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;DistributeLock&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt; key &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;RLOCK_&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;getDynamicValueParser&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;signature&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getParameterNames&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; joinPoint&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getArgs&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; lock&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token class-name&quot;&gt;RLock&lt;/span&gt; rLock &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; redissonClient&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getLock&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;key&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;boolean&lt;/span&gt; available &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; rLock&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;tryLock&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;lock&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;waitTime&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; lock&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;leaseTime&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; lock&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;timeUnit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;available&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; aopRequiresNewTransaction&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;proceed&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;joinPoint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;catch&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Exception&lt;/span&gt; e&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;Thread&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;currentThread&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;interrupt&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;InterruptedException&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;finally&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
         rLock&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;unlock&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;글을 마치며&lt;/h2&gt;
&lt;p&gt;1, 2 편을 글을 정리하면서 각 트랜잭션의 격리는 어떻게 이루어지는지, 스프링에서는 이러한 트랜잭션을 제공하는지, 분산 환경에서는 어떻게 동시성을 보장해야하는지를 알 수 있었습니다. 그리고 이를 바탕으로 하여 목표했던 분산 환경에서의 상호배제도 구현을 할 수 있었습니다.&lt;/p&gt;
&lt;p&gt;지금은 간단한 분산 환경을 가정하고 구현을 하였지만 향후 현업에서는 더 많은 트래픽을 감당하기 위해서 다중으로 분산 처리가 되어 있을 거라 생각합니다. 해당 환경에서도 지금 내용을 기반으로 하여 적절한 상호배제를 구현하는 것이 남은 숙제라는 생각이 듭니다.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Github PR&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/wishoon/2022-KkogKkog/pull/27&quot;&gt;https://github.com/wishoon/2022-KkogKkog/pull/27&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;참고&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://redisson.org/glossary/java-distributed-lock.html&quot;&gt;https://redisson.org/glossary/java-distributed-lock.html&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://hyperconnect.github.io/2019/11/15/redis-distributed-lock-1.html&quot;&gt;https://hyperconnect.github.io/2019/11/15/redis-distributed-lock-1.html&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://d2.naver.com/helloworld/294797&quot;&gt;https://d2.naver.com/helloworld/294797&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://youtu.be/UOWy6zdsD-c?t=176&quot;&gt;https://youtu.be/UOWy6zdsD-c?t=176&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[동시성 문제 해결을 통한 제고 시스템 구현하기 - 1]]></title><description><![CDATA[…]]></description><link>https://wishoon.github.io/동시성 문제 해결을 통한 제고 시스템 구현하기 - 1/</link><guid isPermaLink="false">https://wishoon.github.io/동시성 문제 해결을 통한 제고 시스템 구현하기 - 1/</guid><pubDate>Wed, 16 Nov 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;재고를 기반으로 운영되는 쿠폰 시스템은 개발자가 고려해야 할 점이 많습니다. 현재 개발되고 있는 프로젝트는 자바와 스프링을 기반으로 한 웹 어플리케이션으로 운용되고 있습니다. 이러한 어플리케이션은 기본적으로 멀티 스레드 환경에서 구동이 되기 때문에 공유 자원에 대한 경쟁 상태가 발생하지 않도록 주의를 기울여 개발을 해야 합니다.&lt;/p&gt;
&lt;p&gt;이러한 문제를 해결하기 위해 우리는 다양한 부분에 대해서 고민을 해볼 필요성이 있습니다. 그 중의 하나가 데이터베이스의 상태를 변화시키는 작업의 단위라고 불리는 &lt;code class=&quot;language-text&quot;&gt;트랜잭션&lt;/code&gt; 이라고 생각합니다. 이번 글에서는 트랜잭션의 관점에서 어떻게 동시성 문제를 해결하는지 살펴보고, Spring에서는 어떻게 트랜잭션을 지원하는지 그 개념과 동작원리를 살펴보는 시간을 가져보려고 합니다.&lt;/p&gt;
&lt;h2&gt;Transactional의 개념과 격리레벨&lt;/h2&gt;
&lt;h3&gt;트랜잭션이란?&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;트랜잭션은 데이터베이스 상태를 변화시키는 하나의 논리적인 작업기능을 구성하는 단위&lt;/strong&gt;를 말합니다. 어떤 작업들이 성공적으로 완료되어야 구성된 작업의 결과를 반영하고, 오류가 발생했을 때는 이전에 있었던 모든 작업들이 성공적이라고 해도 없었던일 처럼 완전히 되돌리는 것이 트랜잭션의 개념이라고 할 수 있습니다.&lt;/p&gt;
&lt;p&gt;이러한 트랜잭션을 수행함에 있어서 동시에 여러 트랜잭션이 변경을 수행할 때 일관성을 유지하는 기능을 제공하고 안정성과 성능을 조절하기 위해서 필요한 설정이 바로 트랜잭션의 격리 레벨이라고 할 수 있습니다.&lt;/p&gt;
&lt;h3&gt;트랜잭션의 격리 레벨이란 무엇인가?&lt;/h3&gt;
&lt;p&gt;트랜잭션 격리 레벨이란 앞서서 말했듯이 &lt;strong&gt;동시에 여러 트랜잭션이 처리될 때, 트랜잭션끼리 얼마나 서로 고립되어 있는지를 나타내는 것&lt;/strong&gt;입니다. 즉, 특정 트랜잭션이 다른 트랜잭션에 변경할 데이터를 볼 수 있도록 허용할지 말지를 결정합니다.&lt;/p&gt;
&lt;p&gt;이를 수행하기 위해서, 트랜잭션이 독립적인 수행을 하도록 &lt;code class=&quot;language-text&quot;&gt;Locking&lt;/code&gt;을 통해, 하나의 트랜잭션이 데이터베이스를 다루는 동안 다른 트랜잭션이 해당 트랜잭션에 관여하지 못하도록 막는 작업이 필요합니다.&lt;/p&gt;
&lt;p&gt;하지만 무조건적인 &lt;code class=&quot;language-text&quot;&gt;Locking&lt;/code&gt;으로 동시에 수행되는 수많은 트랜잭션을 순서대로 처리하도록 설계하게 되면 데이터베이스의 동시성 성능이 떨어지게 됩니다. 이러한 성능저하를 줄이기 위해서 &lt;code class=&quot;language-text&quot;&gt;Locking&lt;/code&gt;의 범위를 줄인다면, 데이터 일관성이 깨지는 문제가 발생할 수도 있습니다. 따라서 최대한 효율적으로 &lt;code class=&quot;language-text&quot;&gt;Locking&lt;/code&gt; 설정하는 것이 좋습니다.&lt;/p&gt;
&lt;h3&gt;Locking Reads&lt;/h3&gt;
&lt;p&gt;기본적으로 &lt;code class=&quot;language-text&quot;&gt;SELECT&lt;/code&gt;문을 통해 데이터를 조회하게 되면 &lt;code class=&quot;language-text&quot;&gt;Non-Locking&lt;/code&gt; 상태라고 할 수 있습니다. 때문에 읽기 작업과 쓰기 작업이 하나의 트랜잭션에서 같이 발생되는 경우 다른 트랜잭션에 의해 변경될 가능성이 있습니다. InnoDB에서는 이러한 문제를 해결하기 위해 &lt;code class=&quot;language-text&quot;&gt;FOR SHARE&lt;/code&gt;, &lt;code class=&quot;language-text&quot;&gt;FOR UPDATE&lt;/code&gt; 라는 &lt;code class=&quot;language-text&quot;&gt;Locking Reads&lt;/code&gt;를 제공합니다.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;code class=&quot;language-text&quot;&gt;SELECT … FOR SHARE&lt;/code&gt;&lt;/strong&gt; 는 조회하는 인덱스 레코드에 &lt;code class=&quot;language-text&quot;&gt;S-Lock&lt;/code&gt; 을 설정합니다. 다른 트랜잭션에서 레코드를 읽을 수는 있지만, &lt;code class=&quot;language-text&quot;&gt;S-Lock&lt;/code&gt;을 설정한 트랜잭션이 커밋되기 전까지 레코드를 수정할 수 없으며, &lt;code class=&quot;language-text&quot;&gt;X-Lock&lt;/code&gt;을 설정할 수 없습니다.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;code class=&quot;language-text&quot;&gt;SELECT … FOR UPDATE&lt;/code&gt;&lt;/strong&gt; 는 조회하는 인덱스 레코드에 대해 &lt;code class=&quot;language-text&quot;&gt;UPDATE&lt;/code&gt; 문을 실행한 것과 동일하게 레코드 및 관련 인덱스에 &lt;code class=&quot;language-text&quot;&gt;X-Lock&lt;/code&gt;을 설정합니다. 다른 트랜잭션에서 레코드를 읽거나 쓰는 작업이 불가능하며, &lt;code class=&quot;language-text&quot;&gt;S-Lock&lt;/code&gt;이나 &lt;code class=&quot;language-text&quot;&gt;X-Lock&lt;/code&gt;을 설정할 수 없습니다.&lt;/p&gt;
&lt;p&gt;이러한 &lt;code class=&quot;language-text&quot;&gt;Locking Reads&lt;/code&gt;를 바탕으로 &lt;code class=&quot;language-text&quot;&gt;Locking&lt;/code&gt;을 구현하게 됩니다.&lt;/p&gt;
&lt;h3&gt;Locking과 Consistent Read&lt;/h3&gt;
&lt;p&gt;InnoDB에서 기본적으로 &lt;code class=&quot;language-text&quot;&gt;Locking&lt;/code&gt;은 트랜잭션의 격리 수준을 구현되기 위해서 사용됩니다. 이를 구현하기 위한 대표적인 방법으로 &lt;strong&gt;Record Lock, Gap Lock, Next-Key Lock&lt;/strong&gt;을 살펴보고자 합니다.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;code class=&quot;language-text&quot;&gt;Record Lock&lt;/code&gt;&lt;/strong&gt; 은 하나의 인덱스 레코드에만 Lock을 거는 것을 말합니다. 만약 테이블에 인덱스가 정의되지 않았다고 하더라도 InnoDB를 기준으로 primary key 혹은 unique key를 통해서 Clustered Index를 생성하기 때문에 이를 활용하여 Record Lock을 적용할 수 있습니다.&lt;/p&gt;
&lt;p&gt;만약 &lt;code class=&quot;language-text&quot;&gt;SELECT content FROM coupon WHERE id = 1 FOR UPDATE;&lt;/code&gt; 와 같은 쿼리를 실행하게 된다면 id가 1에 해당하는 레코드에 Record Lock이 설정되기 때문에 다른 트랜잭션에서 해당 레코드를 변경할 수 없습니다.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;code class=&quot;language-text&quot;&gt;Gap Lock&lt;/code&gt;&lt;/strong&gt; 은 인덱스 레코드간의 범위에 Lock을 거는 것을 말합니다. 최초 레코드 이전, 마지막 레코드 이후를 가상의 인덱스 레코드로 생각해서 Lock을 설정할 수 있으며, 다른 트랜잭션에서 해당 범위에 데이터를 삽입하거나 변경할 수 없습니다.&lt;/p&gt;
&lt;p&gt;만약 &lt;code class=&quot;language-text&quot;&gt;SELECT content FROM coupon WHERE id ≥ 1 FOR UPDATE;&lt;/code&gt; 와 같은 쿼리를 실행하고 다른 트랜잭션이 id가 10인 데이터를 삽입하려고 한다면, 해당 id 값은 Gap Lock으로 설정되어 있기 때문에 삽입하거나 혹은 변경할 수 없습니다.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;code class=&quot;language-text&quot;&gt;Next Key-Lock&lt;/code&gt;&lt;/strong&gt; 은 Record Lock과 해당 인덱스 레코드 앞의 Gap에 대한 Gap Lock을 조합하여 Lock을 거는 것을 말합니다.&lt;/p&gt;
&lt;p&gt;이렇게 &lt;code class=&quot;language-text&quot;&gt;Locking&lt;/code&gt;이 설정됨에 따라서 격리 수준을 구현할 수 있게 되었지만 동시성 성능은 떨어지게 되었습니다. MySQL의 InnoDB는 이렇게 동시성 성능이 떨어지는 문제를 해결하기 위해서 &lt;code class=&quot;language-text&quot;&gt;MVCC&lt;/code&gt;라는 개념을 도입하였습니다. 이는 각 트랜잭션의 격리 레벨에 따라 상이하지만, 특정 시점의 &lt;code class=&quot;language-text&quot;&gt;Snapshot&lt;/code&gt; 정보를 바탕으로 하여, 기존과 같이 &lt;code class=&quot;language-text&quot;&gt;Locking&lt;/code&gt;을 사용하지 않고도 &lt;code class=&quot;language-text&quot;&gt;일관된 읽기(Consistent Read)&lt;/code&gt;를 제공하여 동시성을 제어할 수 있게 됩니다.&lt;/p&gt;
&lt;h2&gt;트랜잭션 격리 레벨에 대해서 자세히 알아보자&lt;/h2&gt;
&lt;p&gt;지금까지의 내용들을 바탕으로 트랜잭션 격리 레벨을 구성할 수 있으며 READ UNCOMMITTED, READ COMMITTED, REPEATABLE READ, SERIALIZABLE 총 4단계로 구분할 수 있습니다.&lt;/p&gt;
&lt;p&gt;그러면 4가지 키워드들에 대해서 하나씩 살펴보도록 하겠습니다.&lt;/p&gt;
&lt;h3&gt;READ UNCOMMITTED&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Read Uncommitted&lt;/code&gt;는 커밋 전의 트랜잭션의 데이터 변경 내용을 다른 트랜잭션이 읽는 것을 허용하는 격리 레벨을 말합니다. &lt;code class=&quot;language-text&quot;&gt;Read Uncommitted&lt;/code&gt; 에서는 일반적인 SELECT 문은 Non-Locking Read로 수행되지만 MVCC를 사용하지 않아 Consistent Read를 보장하지 않습니다.&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Read Uncommitted&lt;/code&gt; 에서는  &lt;code class=&quot;language-text&quot;&gt;Dirty Read&lt;/code&gt;현상이 발생할 수 있습니다. &lt;code class=&quot;language-text&quot;&gt;Transaction 1&lt;/code&gt;에서 INSERT로 추가된 &lt;code class=&quot;language-text&quot;&gt;Coupon&lt;/code&gt;이 &lt;code class=&quot;language-text&quot;&gt;COMMIT&lt;/code&gt; 되기 이전에 새로운 &lt;code class=&quot;language-text&quot;&gt;Transaction 2&lt;/code&gt;에서 &lt;code class=&quot;language-text&quot;&gt;Coupon&lt;/code&gt;을 조회한다고 가정해보겠습니다. 하지만 &lt;code class=&quot;language-text&quot;&gt;Transaction 1&lt;/code&gt;에서 오류가 발생해서 &lt;code class=&quot;language-text&quot;&gt;ROLLBACK&lt;/code&gt;이 되게 되었습니다. 이 경우 &lt;code class=&quot;language-text&quot;&gt;Transaction 2&lt;/code&gt;는 &lt;code class=&quot;language-text&quot;&gt;ROLLBACK&lt;/code&gt; 여부를 확인하지 못하고 &lt;code class=&quot;language-text&quot;&gt;ROLLBACK&lt;/code&gt; 된 &lt;code class=&quot;language-text&quot;&gt;Coupon&lt;/code&gt;를 정상적인 데이터라 생각하고 작업을 계속 진행하게 됩니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/1c58f2297bbd2ee4528da955e586337f/c1e63/img.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 69.41176470588235%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAABWElEQVQ4y5WTcY+CMAzF/f7fzz88LhEvAQkiCIKAoHW/Jl244SVek2ZvrH3rXsvm+XwK9ng8xPAnZrHLHPDGNsfjUS6Xi9zvdxmGQX0cR+n7Xr+BzUMyzud5VqyE0zRJXddyu9300EjLspT9fi9N0yjebreS57lP5lUYl8LhCTlIkkSKovBVdV2neFktpGAIl09dEbKhqtC4yLRdrmZVVYnlrwi5xXQx/8uoMssyOcSxrhCvNCQo7F7btprAGRhZrteraho7stTtM9fMjwj5RtdpAg0DQ3I+n708Fju80zAkRCvTlpUKmAKTB9w7z6Mvyb4jr+1bwv8MODa63FWFjEXYFKsyxOi52+0kdjNKY5az6QmZu2VlEDCX6IZ+4CiKNJlYdK3dXELeOF8NdpqmmoQ+OIGsSGErxHauv6PzJk3k9HP4XWH4THOCbLW/w76Zt8VJuqr0cr0AWyJHCzi8MkAAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img&apos; title=&apos;img&apos; src=&apos;/static/1c58f2297bbd2ee4528da955e586337f/ca1dc/img.png&apos; srcset=&apos;/static/1c58f2297bbd2ee4528da955e586337f/e7570/img.png 170w,
/static/1c58f2297bbd2ee4528da955e586337f/f46e7/img.png 340w,
/static/1c58f2297bbd2ee4528da955e586337f/ca1dc/img.png 680w,
/static/1c58f2297bbd2ee4528da955e586337f/02d09/img.png 1020w,
/static/1c58f2297bbd2ee4528da955e586337f/9d567/img.png 1360w,
/static/1c58f2297bbd2ee4528da955e586337f/c1e63/img.png 1680w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;이처럼 트랜잭션에서 처리한 작업이 완료되지 않아도 볼 수 있는 현상을 &lt;code class=&quot;language-text&quot;&gt;Dirty Read&lt;/code&gt; 현상을 확인할 수 있습니다.&lt;/p&gt;
&lt;h3&gt;READ COMMITTED&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Read Committed&lt;/code&gt;는 &lt;code class=&quot;language-text&quot;&gt;COMMIT&lt;/code&gt;이 완료된 트랜잭션의 변경사항만 다른 트랜잭션에서 조회가 가능합니다. 이로 인해서 &lt;code class=&quot;language-text&quot;&gt;Read Uncommitted&lt;/code&gt;에서 발생하는 &lt;code class=&quot;language-text&quot;&gt;Dirty Read&lt;/code&gt;가 발생하지 않습니다. 이렇게 되는 이유는 &lt;code class=&quot;language-text&quot;&gt;Read Committed&lt;/code&gt; 부터는 &lt;code class=&quot;language-text&quot;&gt;MVCC&lt;/code&gt;인 &lt;code class=&quot;language-text&quot;&gt;Consistent Read&lt;/code&gt;로 문제를 해결하기 때문입니다.&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Read Committed&lt;/code&gt;에서 데이터의 변경이 일어나게 되면 변경 전 데이터는 &lt;strong&gt;언두 영역으로 복사가 됩니다&lt;/strong&gt;. 그리고 &lt;strong&gt;다른 트랜잭션에서 해당 테이블의 데이터를 조회할 경우, 변경된 테이블 데이터를 조회하는 것이 아니라 언두 영역에 복사된(Snapshot) 레코드를 조회&lt;/strong&gt;하게 됩니다. 이 때문에 발생할 수 있는 문제를 해결할 수 있습니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/70f38cbbad9f0e4729e7d1b5abb1f338/c1e63/img_1.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 69.41176470588235%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAABcklEQVQ4y42T6Y7CMAyEef/3Q/wAlkM9OAq9aGlLqTefhVFaVmgjWXESezwTJ7NhGITxfD7F/P8Mi/Vz8Ge2iONYsiyTruukaRq1tm3lfr/rHr7ZFIzzvu/VV8DH4yF5nktd13pooNfrVTabjRRFof58PpfT6fRONkCKgvEGRG4YhpIkiQIRUFXViBVF0jTVcwB9qeyNAH3K/qAQZyTjk+THocjyR4AEUR1pVDOwy+Ui2+1WrwP2y+VSJcOYK/hZr3VN3ggQBrvdThOiKJLb7aaSrTkwYaYAYMyr1UqC/V7CINBiH00xZr48gGF3OBzkeDwqk7IspXpJtdG62BHDKaBJ5hpoFkCwWiwWyubs9nKnpHCFSmdJGHxn6DP1H/3wWtdZKlkcOYuldHeYurn/xtA3zgwcFlbEH91fkrl4/22RiDy6zA/CpxHcpcrzGH88bAII5ClwiNEQZppgezSHefpTPh62LxFmZiT6ZnvTv2y5jF+6SkToUd4HywAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 1&apos; title=&apos;img 1&apos; src=&apos;/static/70f38cbbad9f0e4729e7d1b5abb1f338/ca1dc/img_1.png&apos; srcset=&apos;/static/70f38cbbad9f0e4729e7d1b5abb1f338/e7570/img_1.png 170w,
/static/70f38cbbad9f0e4729e7d1b5abb1f338/f46e7/img_1.png 340w,
/static/70f38cbbad9f0e4729e7d1b5abb1f338/ca1dc/img_1.png 680w,
/static/70f38cbbad9f0e4729e7d1b5abb1f338/02d09/img_1.png 1020w,
/static/70f38cbbad9f0e4729e7d1b5abb1f338/9d567/img_1.png 1360w,
/static/70f38cbbad9f0e4729e7d1b5abb1f338/c1e63/img_1.png 1680w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;하지만 &lt;code class=&quot;language-text&quot;&gt;Read Committed&lt;/code&gt;는 &lt;code class=&quot;language-text&quot;&gt;COMMIT&lt;/code&gt; 된 데이터에 대해서는 정합성을 유지한다는 판단을 하기 때문에 &lt;code class=&quot;language-text&quot;&gt;Commit&lt;/code&gt;이 발생할 경우 기존 &lt;code class=&quot;language-text&quot;&gt;Snapshot&lt;/code&gt;을 새로운 &lt;code class=&quot;language-text&quot;&gt;Snapshot&lt;/code&gt;으로 다시 덮어쓰게 됩니다. 이 때문에 &lt;code class=&quot;language-text&quot;&gt;Read Committed&lt;/code&gt;에서는 &lt;code class=&quot;language-text&quot;&gt;None Repetable Read&lt;/code&gt;현상이 발생할 수 있습니다.&lt;/p&gt;
&lt;p&gt;DB에는 &lt;code class=&quot;language-text&quot;&gt;Coupon&lt;/code&gt;이 2개가 있다고 가정해보겠습니다. &lt;code class=&quot;language-text&quot;&gt;Transaction 1&lt;/code&gt;에서 쿼리가 먼저 시작되고 나서 &lt;code class=&quot;language-text&quot;&gt;Transaction 2&lt;/code&gt;에서 &lt;code class=&quot;language-text&quot;&gt;Coupon&lt;/code&gt; 의 2번 ID를 조회하면 &lt;strong&gt;커피가 조회가 되게 됩니다&lt;/strong&gt;. 하지만 &lt;code class=&quot;language-text&quot;&gt;Transcation 1&lt;/code&gt;에서 &lt;strong&gt;UPDATE&lt;/strong&gt; 쿼리가 &lt;code class=&quot;language-text&quot;&gt;COMMIT&lt;/code&gt; 된 이후 &lt;code class=&quot;language-text&quot;&gt;Transaction 2&lt;/code&gt; 에서 다시 똑같은 &lt;strong&gt;SELECT&lt;/strong&gt; 쿼리를 사용하여 다시 &lt;code class=&quot;language-text&quot;&gt;Coupon&lt;/code&gt;를 조회하게 될 경우 &lt;strong&gt;UPDATE&lt;/strong&gt; 쿼리의 경우 &lt;strong&gt;술이 조회가 되게 됩니다.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/71d0a5f25c77b56741a5b781c61a53df/c1e63/img_2.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 69.41176470588235%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAABmUlEQVQ4y41T686CMAz1/d/P+AP9vAByR9i4i9SexpqhifmWNHRbe3pOOzbLshDW4/Eg9f+zNNbNgb/RTRRFVFUVTdNEwzCIjeNIfd/LGXy1TzDcz/MsvgDe73eq65q6rpNLBS3Lko7HIxljxN9ut5Sm6TtZAVEUGG9AyA3DkPI8FyAEtG27YoUit9tN7gHoSsXZCtCl7C4Uwh2S4SPJjYMizV8BIgjVIQ3VFKwoCjqdTtIOsPc8TySDMVrwdzjIHnkrQDA4n8+ScL1eqWkakazDARN8UQBg+O73ewouFwqDQIp9DUWZufIADHZxHFOSJMLEWkvtS6qukWNXDD8BVTLagGEBCKx2u52wycKAalZiuJCJI8qZ5U+GLlP30S+vfV9XZJhxncTUFTl/E5p/MXQNdwquzwWSPR6I7/vkM7uM2X8xROPdtwUAyMOU8QfBxyDQSwAa25Dh/lrus+G+rgCxQSCeAh41DAPBF0PQMwwHSmyekeE+Wu5fw2dl+NFDVyKYqSHINTnnmJGLmDShisFsltLATOmV/wStHUFFcYJuTgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 2&apos; title=&apos;img 2&apos; src=&apos;/static/71d0a5f25c77b56741a5b781c61a53df/ca1dc/img_2.png&apos; srcset=&apos;/static/71d0a5f25c77b56741a5b781c61a53df/e7570/img_2.png 170w,
/static/71d0a5f25c77b56741a5b781c61a53df/f46e7/img_2.png 340w,
/static/71d0a5f25c77b56741a5b781c61a53df/ca1dc/img_2.png 680w,
/static/71d0a5f25c77b56741a5b781c61a53df/02d09/img_2.png 1020w,
/static/71d0a5f25c77b56741a5b781c61a53df/9d567/img_2.png 1360w,
/static/71d0a5f25c77b56741a5b781c61a53df/c1e63/img_2.png 1680w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;이처럼 &lt;strong&gt;하나의 트랜잭션 내에서 똑같은 SELECT 쿼리를 실행했을 때 항상 같은 결과를 가져오지 못하는 &lt;code class=&quot;language-text&quot;&gt;None-Repetable Read&lt;/code&gt;가 발생하게 됩니다.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;또한 Read Committed 레벨에서는 &lt;code class=&quot;language-text&quot;&gt;Record Lock&lt;/code&gt;만을 사용하기 때문에 &lt;strong&gt;데이터가 중간에 삽입, 삭제 될 경우 SELECT의 결과가 다르게 나타나는 &lt;code class=&quot;language-text&quot;&gt;Phantom Read&lt;/code&gt; 현상도 발생&lt;/strong&gt;하게 됩니다.&lt;/p&gt;
&lt;h3&gt;REPEATABLE READ&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Repeatable Read&lt;/code&gt;는 트랜잭션 범위 내에서 조회한 내용이 항상 동일함을 보장합니다. 여기서 &lt;code class=&quot;language-text&quot;&gt;Read Committed&lt;/code&gt;와 다른 점은 언두 영역에 백업된 레코드의 여러 버전 가운데 몇 번째 이전의 버전을 찾는지에 있습니다. 모든 &lt;code class=&quot;language-text&quot;&gt;InnoDB&lt;/code&gt;의 트랜잭션은 고유한 트랜잭션 번호를 가지며, 언두 영역에 백업된 모든 레코드에는 변경을 발생시킨 트랜잭션의 번호가 포함되어 있습니다.&lt;/p&gt;
&lt;p&gt;밑의 그림과 같이 자신의 트랜잭션 번호보다 작은 트랜잭션 번호만 보게 되는 것을 확인할 수 있습니다. 이를 통해 처음 생성된 &lt;code class=&quot;language-text&quot;&gt;Snapshot&lt;/code&gt;을 기반으로 하나의 트랜잭션 내에서 일관된 읽기를 제공합니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/917c5a252b1ba1278e013bf682c3e18b/c1e63/img_3.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 74.70588235294117%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAABqklEQVQ4y31TibKCMAz0/7/wOaNyiaAUyiU35mX7CFPEZ2eipcdmN5seiMfr9TIhw55/G3LOvn/AzzRN1Pf95tA8z1QUBT2fT8rzfBNVVdH9fqfT6UTX65Wi282cXwHHcaS2bTeASPJ4PEhrTVEUmbnrunQ+nylRin6OR3IvFwOoOQnObwCFoS1nGAazjsMIfHf8rZhdmWVUcbKaQyfJFhB0wSLhDUhqmmZljX/IxtpftFTw2ZTZKceh3HNJeR5NtmQAhmFIHm8AtOs6cxlJ0jSlG9cojmOzD8lyWUbPzJF4xxD1AGBd14adsMIcSWRNXJV6d4uSFXCwMsgQU1ACh6WBnWIz4K6cXQE52QYQl8uyNAbYLsNhrAMoYxMgOwiCtUVWyXxvBwipABBZ0kafBhihhUIuEeqbcrJ/28ZubMiDZBiGGoMdgMAYbBPeF/Y7QGR9b2y8FARMQuvgIpRg/lXyJ0AwFLdhDpi0Szs1b+Xo+f4O8NPTgyzUFTJ93zdO4/0qlt/ojNpcm9CccGfKew3xPy6Z7ac38HeVMGOHX4rLLyXwKWNz5qWGv6C2i5sxqYuZAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 3&apos; title=&apos;img 3&apos; src=&apos;/static/917c5a252b1ba1278e013bf682c3e18b/ca1dc/img_3.png&apos; srcset=&apos;/static/917c5a252b1ba1278e013bf682c3e18b/e7570/img_3.png 170w,
/static/917c5a252b1ba1278e013bf682c3e18b/f46e7/img_3.png 340w,
/static/917c5a252b1ba1278e013bf682c3e18b/ca1dc/img_3.png 680w,
/static/917c5a252b1ba1278e013bf682c3e18b/02d09/img_3.png 1020w,
/static/917c5a252b1ba1278e013bf682c3e18b/9d567/img_3.png 1360w,
/static/917c5a252b1ba1278e013bf682c3e18b/c1e63/img_3.png 1680w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Repeatable Read&lt;/code&gt; 는 일반적인 SQL 표준에서는 &lt;code class=&quot;language-text&quot;&gt;Phantom Read&lt;/code&gt;가 발생하게 됩니다. 밑의 사진을 보게되면 조회를 하기 위해서 &lt;code class=&quot;language-text&quot;&gt;SELECT … FOR UPDATE&lt;/code&gt; 쿼리를 사용하고 있습니다. &lt;code class=&quot;language-text&quot;&gt;FOR UPDATE&lt;/code&gt; 쿼리를 사용하게 되면 레코드에 쓰기 잠금을 걸어버리게 되는데, 언두 레코드에는 이를 적용할 수 없습니다. 이 때문에, 언두 영역의 변경 전 데이터(Snapshot)를 가져오는 것이 아니라, 현재 레코드의 값을 가져오게 되어 &lt;code class=&quot;language-text&quot;&gt;Phantom Read&lt;/code&gt;가 발생한다고 할 수 있습니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 631px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/61351edc58d71e84ef8858479aac81ab/077d3/img_4.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 79.41176470588235%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAABuElEQVQ4y52UW2/CMAyF9///GbAHxBt3GLfSFijQO209f5HS0ZZt2ixZTZrk+PjYyVtVVWLNjp///cU498bg8Xh0wIqikDiOJU1TiaLIjHHGeZ6bM77vi+d5crlczD7MALKxLMsG4O12k8PhIMfjUdbrtex2O1ksFjKZTGSz2Uiv15P3wUCGw6HM53MJw/ALMEmSDnUAcRhcr9d67Ku76rv9XhwNlirbXNlaDANIGvf7XbIsM47BmLRJrf6qlxosOp+lCAIJlDUeK3CkAWtAwEgv0E1WD1hZfVhzHEf2yupD0410rUJTXcsUqNB0YyVVA3IYbVarlXiuZ9IDyHVdA4SfTiej3XQ6lbgt0ZNsBhBBOQwQ7Egb1mdNDSCYE5Q5lbWyoDWOPA1AW/L/GqCdosDC9iMRbfRXTc4/CmW/HYakTDoAs4AzRzukQDv6kH5cLpemN/v9voxGI9ODzBuA7T60lafKbMZtUWazmQli9YSMvUUNwPZNsa2DA85B2+zMf9SwDfjb40CwxqPSbptXDJ+L0i5QqAwf3Co9lys43kiZYrQBv2sPLKdfeTjGY/FV02S7lVC7BPsEdgfatlWQFHYAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 4&apos; title=&apos;img 4&apos; src=&apos;/static/61351edc58d71e84ef8858479aac81ab/077d3/img_4.png&apos; srcset=&apos;/static/61351edc58d71e84ef8858479aac81ab/e7570/img_4.png 170w,
/static/61351edc58d71e84ef8858479aac81ab/f46e7/img_4.png 340w,
/static/61351edc58d71e84ef8858479aac81ab/077d3/img_4.png 631w&apos; sizes=&apos;(max-width: 631px) 100vw, 631px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;하지만 저희가 주로 사용하는 MySQL의 &lt;code class=&quot;language-text&quot;&gt;InnoDB&lt;/code&gt; &lt;strong&gt;기준으로는 &lt;code class=&quot;language-text&quot;&gt;Repetable Read&lt;/code&gt; 조건에서 &lt;code class=&quot;language-text&quot;&gt;Phantom Read&lt;/code&gt;가 발생하지 않습니다.&lt;/strong&gt; 그 이유는 Locking Read와 UPDATE, DELETE 문의 경우 검색 조건에 따라 사용되는 &lt;code class=&quot;language-text&quot;&gt;Lock&lt;/code&gt;이 다르게 적용되기 때문입니다.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;고유한 검색 조건이 있는 고유 인덱스에 대한 쿼리는 Record Lock이 적용&lt;/li&gt;
&lt;li&gt;범위 검색 조건의 경우 스캔한 인덱스 범위에 Gap Lock과 Next-key Lock이 적용&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;이러한 이유 때문에 중간에 특정 데이터가 추가 혹은 변경되어 발생하는 &lt;code class=&quot;language-text&quot;&gt;Phantom Read&lt;/code&gt; 현상은 &lt;code class=&quot;language-text&quot;&gt;InnoDB&lt;/code&gt;의 &lt;code class=&quot;language-text&quot;&gt;Repetable Read&lt;/code&gt;에서는 발생하지 않습니다.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;그럼에도 발생할 수 있는 &lt;code class=&quot;language-text&quot;&gt;Phantom Read&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;일반적으로는 거의 발생하지 않지만 &lt;code class=&quot;language-text&quot;&gt;Repetable Read&lt;/code&gt; 수준임에도 불구하고 &lt;code class=&quot;language-text&quot;&gt;Phantom Read&lt;/code&gt;가 발생할 수 있는 상황이 있습니다.&lt;/p&gt;
&lt;p&gt;B 트랜잭션이 추가한 레코드에 A 트랜잭션이 UPDATE 쿼리를 수행하게 될 경우, 처음 SELECT 쿼리로 생성된 &lt;code class=&quot;language-text&quot;&gt;Snapshot&lt;/code&gt; 에는 존재하지 않지만 실제 디스크에는 데이터가 존재하기 때문에 해당 레코드가 영향을 받게 됩니다. 이후 SELECT 쿼리를 수행할 때 &lt;code class=&quot;language-text&quot;&gt;Snapshot&lt;/code&gt;이 초기화되어 &lt;code class=&quot;language-text&quot;&gt;Phantom Read&lt;/code&gt;가 발생하게 됩니다.&lt;/p&gt;
&lt;p&gt;하지만 해당 상황은 조금 억지스럽게 &lt;code class=&quot;language-text&quot;&gt;Phantom Read&lt;/code&gt;가 발생할 수 있는 상황을 연출한 것이라 해당 상황이 생길 수 있다는 것만 인지를 하고 넘어가도록 하겠습니다.&lt;/p&gt;
&lt;h3&gt;Serializable&lt;/h3&gt;
&lt;p&gt;가장 단순한 격리 수준이면서, 가장 엄걱한 격리 수준입니다. 일반적인 읽기 작업에 대해서도 &lt;code class=&quot;language-text&quot;&gt;S-Lock&lt;/code&gt;을 획득해야 하며, 동시에 다른 트랜잭션은 해당 레코드의 변경이 불가능 합니다. 이 때문에 한 트랜잭션에서 읽고 쓰고 있는 레코드에 대해서는 다른 트랜잭션에서 절대 접근할 수 없습니다.&lt;/p&gt;
&lt;p&gt;하지만 일반적인 읽기 작업에 대해서도 &lt;code class=&quot;language-text&quot;&gt;S-Lock&lt;/code&gt;을 통해 블로킹 처리를 수행하기 때문에 동시성이 매우 떨어지게 되어 사용하는 것을 권장하지 않습니다.&lt;/p&gt;
&lt;h2&gt;스프링에서의 트랜잭션&lt;/h2&gt;
&lt;p&gt;이처럼 트랜잭션은 위에서 설명한 트랜잭션의 격리 레벨을 이용하여 트랜잭션의 원칙 중 하나인 격리성을 수행한다고 할 수 있습니다. 그렇다면 스프링에서는 이러한 트랜잭션을 어떤 방식을 통해 구현하고 있을까요??&lt;/p&gt;
&lt;h3&gt;스프링이 제공하는 트랜잭션 기술&lt;/h3&gt;
&lt;p&gt;JDBC를 사용하는 개발자가 직접 여러 개의 작업을 하나의 트랜잭션으로 관리하기 위해서는 Connection 객체를 공유하는 작업을 추가적으로 해주어야 합니다. 이러한 로직을 매번 개발자가 작성해주어야 하기 때문에 상당히 불편한 작업이라고 할 수 있습니다.&lt;/p&gt;
&lt;p&gt;Spring은 이러한 문제를 해결하기 위해 트랜잭션을 동기화 하는 기술을 제공하고 있습니다. &lt;code class=&quot;language-text&quot;&gt;TransactionSynchronizeManager&lt;/code&gt;을 통해서 트랜잭션을 시작하기 위한 Connection 객체를 특정 저장소에 보관해 두고 필요할 때 꺼내서 사용하는 방식으로 동기화를 적용할 수 있습니다. 또한 해당 동기화는 작업 스레드마다 Connection 객체를 독립적으로 관리하기 때문에 멀티 스레드 환경에서도 문제가 발생할 여지 없이 Connection 객체를 공유할 수 있습니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token class-name&quot;&gt;TransactionSynchronizeManager&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;initSynchronization&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token class-name&quot;&gt;Connection&lt;/span&gt; connection &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;DataSourceUtils&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getConnection&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dataSource&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;하지만 해당 코드는 JDBC만 사용했을 때 유효합니다. 만약 JPA로 코드를 변경해야 한다면 기존의 Connection을 획득하는 코드를 변경해야 할 것입니다.&lt;/p&gt;
&lt;p&gt;Spring은 이러한 문제를 해결하기 위해 트랜잭션을 추상화 하는 기술을 제공하고 있습니다. &lt;code class=&quot;language-text&quot;&gt;PlatformTransactionManger&lt;/code&gt;를 통해서 각 트랜잭션 기술들의 공통점을 담은 트랜잭션 추상화 기술을 이용해 일관되게 트랜잭션을 처리할 수 있도록 기능을 제공합니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/8677ee7577aa52a9c3609d7ba9916ab1/f97d7/img_5.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 54.70588235294118%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABtklEQVQoz21S7XKbMBDkaTpICDBTx7EFNmC+EzBfjt04M+37P8VWOsBx2vzY4bR3t+hWZ1iWhQWO42AbP2MjNwiCPaTvYyclpPTh+wFxfhAQR9jtYNs2HjWMJeCcw3UdRO+qsZIoyhcMb78wXm/oz1fCeP3AeLnR93L7TTWOEtS9/wlqCCHguR5htXIVVnBtF0/hGuv9TzjCufOe59FX93x7Q7qlxelvC4hjHMITECtB8TLNY823goKrJq794GCMqWZGDcxksGxOmLgpd69REOIfQVvYOIw+9rVEWdXoxgtO/Rn1qUM7vKFuOhX3qNseTTcQ1w5nNOqs66Iovj+OoccUloBMt9hFWxwOIdK8JByTDEmSI6tL5HWFNC0Ur5AVyIoKuXqUonpVWyDJSz2RMXmnrssU+EQyZhL0eOYPE85GwH4SFGuO8uYMFX/xUGiC8S9CbPZoAbfYLPTpH2OP56mHBNdZhed4jzAMkaQ54iRFfEyRzWNPXKJGLBHFCeW1FbqGbEmnODomtOiG3ww41Kla0vK+wBpNO2CY41M3olXm68fSy64fRMe9hspfP/6ohX9HGEX4C+j+axS8gv3HAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 5&apos; title=&apos;img 5&apos; src=&apos;/static/8677ee7577aa52a9c3609d7ba9916ab1/ca1dc/img_5.png&apos; srcset=&apos;/static/8677ee7577aa52a9c3609d7ba9916ab1/e7570/img_5.png 170w,
/static/8677ee7577aa52a9c3609d7ba9916ab1/f46e7/img_5.png 340w,
/static/8677ee7577aa52a9c3609d7ba9916ab1/ca1dc/img_5.png 680w,
/static/8677ee7577aa52a9c3609d7ba9916ab1/02d09/img_5.png 1020w,
/static/8677ee7577aa52a9c3609d7ba9916ab1/9d567/img_5.png 1360w,
/static/8677ee7577aa52a9c3609d7ba9916ab1/f97d7/img_5.png 2000w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;또한 스프링은 각 데이터 접근 기술에 대한 트랜잭션 매니저의 구현체도 제공을 하고 있습니다. 이 때문에 우리는 필요한 구현체를 스프링 빈으로 등록하고 주입받아 사용하기만 하면 트랜잭션을 사용할 수가 있습니다. 여기에 스프링 부트까지 사용한다면 &lt;code class=&quot;language-text&quot;&gt;AutoConfiguration&lt;/code&gt;을 통해서 의존성으로 등록한 데이터 접근 기술을 자동으로 인식해, 적절한 트랜잭션 메니저를 스프링 빈으로 등록해주어 개발자가 사용할 수 있게 됩니다.&lt;/p&gt;
&lt;h3&gt;@Transactional 등장&lt;/h3&gt;
&lt;p&gt;이렇게 스프링에서 제공하는 동기화 기법인 &lt;code class=&quot;language-text&quot;&gt;TransactionSynchronizeManager&lt;/code&gt;와 추상화 기법인 &lt;code class=&quot;language-text&quot;&gt;PlatformTransactionManager&lt;/code&gt;를 통해서 조금 더 편리하게 개발이 가능해 졌습니다.&lt;/p&gt;
&lt;p&gt;하지만 아직까지 문제가 있습니다. 바로 비즈니스 코드와 데이터 엑세스 기술이 코드에 강하게 결합한다는 문제가 발생합니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token annotation punctuation&quot;&gt;@Service&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;UserSerivce&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;businessMethod&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;TransactionStatus&lt;/span&gt; status &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; transactionManager&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getTransaction&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;DefaultTransactionDefinition&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token function&quot;&gt;businessLogic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            transactionManager&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;commit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;status&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// 성공시 커밋&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;catch&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Exception&lt;/span&gt; e&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            transactionManger&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;rollback&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;status&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 실패시 롤백&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;IllegalStateException&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;e&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;이는 코드의 유지보수를 어렵게 하고 중복된 코드를 만들어 개발자의 작업 생산성을 저하시킵니다. 이러한 문제를 해결하기 스프링은 &lt;strong&gt;프록시 방식을 적용하여 비즈니스 코드와 데이터 엑세스 기술을 분리하여 사용할 수 있도록 기능을 제공&lt;/strong&gt;하고 있습니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// 프록시 코드&lt;/span&gt;
&lt;span class=&quot;token annotation punctuation&quot;&gt;@Component&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;TransactionUserSerivceProxy&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;UserService&lt;/span&gt; target&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    
    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;businessMethod&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;TransactionStatus&lt;/span&gt; status &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; transactionManager&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getTransaction&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;DefaultTransactionDefinition&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            target&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;businessMethod&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            transactionManager&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;commit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;status&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// 성공시 커밋&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;catch&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Exception&lt;/span&gt; e&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            transactionManger&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;rollback&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;status&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 실패시 롤백&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;IllegalStateException&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;e&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// 실제 비즈니스 코드&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;MemberService&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;businessMethod&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;businessLogic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;또한 &lt;strong&gt;Advisor 기능&lt;/strong&gt;과 &lt;strong&gt;동적 프록시 생성기&lt;/strong&gt;를 이용한 &lt;strong&gt;트랜잭션 애노테이션(@Transactional)&lt;/strong&gt; 을 통해 개발자가 조금 더 편하게 선언적으로 트랜잭션을 이용할 수 있도록 기능을 제공하고 있습니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token annotation punctuation&quot;&gt;@Transactional&lt;/span&gt;
&lt;span class=&quot;token annotation punctuation&quot;&gt;@Service&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;MemberService&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;businessMethod&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;businessLogic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;다음 글에서는..&lt;/h2&gt;
&lt;p&gt;이번 글에서는 트랜잭션의 관점에서 어떻게 동시성 문제를 해결하는지 살펴보고, Spring에서는 어떻게 트랜잭션을 지원하는지 그 개념과 동작원리를 살펴보는 시간을 가졌었습니다. 다음 글에서는 실제 주어진 요구사항을 해결하기 위해 필요한 추가적인 개념과 실제 코드를 통해 해결하는 과정을 살펴보도록 하겠습니다.&lt;/p&gt;
&lt;h2&gt;참고&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://dev.mysql.com/doc/refman/8.0/en/innodb-transaction-isolation-levels.html&quot;&gt;https://dev.mysql.com/doc/refman/8.0/en/innodb-transaction-isolation-levels.html&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://dev.mysql.com/doc/refman/8.0/en/innodb-locking.html&quot;&gt;https://dev.mysql.com/doc/refman/8.0/en/innodb-locking.html&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[DAO와 Repository]]></title><description><![CDATA[우테코 미션을 진행하다보면 유행?이 되는 논쟁이 있습니다. 그 중에 하나가 Repository와 DAO…]]></description><link>https://wishoon.github.io/DAO와-Repository/</link><guid isPermaLink="false">https://wishoon.github.io/DAO와-Repository/</guid><pubDate>Tue, 01 Nov 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;우테코 미션을 진행하다보면 유행?이 되는 논쟁이 있습니다. 그 중에 하나가 Repository와 DAO의 차이점 입니다. 당시 미션을 진행할 때는 “그냥 부르는 명칭의 차이가 아닌가?” 라는 생각을 했었습니다. 그리고 지금 이 시점에서 어느 정도 Repository와 DAO의 차이에 대해서 설명할 수 있을 것 같은데요. 이번 글에서는 제가 생각하고 있는 Repository와 DAO의 차이점에 대해서 정리를 해보고자 합니다.&lt;/p&gt;
&lt;h2&gt;DAO란 무엇일까??&lt;/h2&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;DAO&lt;/code&gt;는 Data Acess Object의 약자이며, J2EE에서 최초로 등장한 개념입니다. 인터페이스를 활용한 API를 제공하여 어플리케이션 계층과 퍼시스턴스 계층을 분리하기 위해서 만들어진 패턴이라고 할 수 있습니다. &lt;strong&gt;하나의 데이터베이스 테이블에 대한 저수준의 CRUD 책임을 가지기 때문에, 한 테이블 당 1 : 1로 매핑&lt;/strong&gt;되어서 만들어집니다.&lt;/p&gt;
&lt;p&gt;그렇다면 이 &lt;code class=&quot;language-text&quot;&gt;DAO&lt;/code&gt;는 왜 만들어지게 되었을까요?? 어플리케이션을 개발하다보면 영구한 저장소가 필요하게 됩니다. 흔히 저희가 데이터베이스라고 명칭하는 것들을 말하는데요. 이러한 데이터베이스는 저희가 아는 종류만 해도 매우 다양하게 존재합니다. 이러한 데이터베이스에 접근하기 위해서 각 데이터베이스에서 제공하는 Public API를 통해서 접근을 하게 됩니다.&lt;/p&gt;
&lt;p&gt;하지만 이러한 데이터베이스 API를 직접적으로 사용하게 되면 몇가지 문제가 발생할 수 있습니다.&lt;/p&gt;
&lt;p&gt;일반적으로 데이터베이스의 종류로 MySQL을 사용하게 됩니다. 이때 데이터베이스 운용 가격의 문제로 Maria DB로 변경해야 한다고 요구사항이 발생했다면, 우리는 이때까지 MySQL에서 제공하는 API로 작성된 로직을 전부 변경해야하는 문제가 발생하게 됩니다. 이는 어플리케이션 계층과 퍼시스턴스 계층에 속한 MySQL 관련 로직이 &lt;strong&gt;직접적으로 강하게 연결되어 있어 변경에 취약하다는 점이 문제&lt;/strong&gt;라고 할 수 있습니다. 이는 객체지향적 관점에서 보더라도 &lt;code class=&quot;language-text&quot;&gt;OCP&lt;/code&gt;를 위반하였다고 할 수 있습니다.&lt;/p&gt;
&lt;p&gt;이러한 문제를 &lt;code class=&quot;language-text&quot;&gt;DAO&lt;/code&gt;를 통해서 해결할 수 있습니다. 앞서서 설명했듯이 데이터베이스 구현체를 그대로 사용하지 않고 인터페이스를 통해 API를 추상화 함으로써, &lt;strong&gt;실제 구현체가 변경되더라도 어플리케이션 계층을 변경하지 않아도 되는 효과&lt;/strong&gt;를 가질 수가 있습니다.&lt;/p&gt;
&lt;h2&gt;Repository란 무엇일까??&lt;/h2&gt;
&lt;p&gt;그렇다면 &lt;code class=&quot;language-text&quot;&gt;Repository&lt;/code&gt;는 무엇일까요?? &lt;strong&gt;도메인 주도 설계&lt;/strong&gt;에서 정의한 &lt;code class=&quot;language-text&quot;&gt;Repository&lt;/code&gt;는 다음과 같습니다.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;전역적인 접근이 필요한 각 객체 타입에 대해 메모리상에 해당 타입의 객체로 구성된 컬렉션이 있다는 착각을 불러 일으키는 객체를 만든다. 잘 알려진 전역 인터페이스를 토대로 한 접근 방법을 마련하라. 객체를 추가하고 제거하는 메서드를 제공하고, 이 메서드가 실제로 데이터 저장소에 데이터를 삽입하고 데이터 저장소에서 제거하는 연산을 캡슐화하게 하라. 특정한 기준으로 객체를 선택하고 속성값이 특정 기준을 만족하는 완전히 인스턴스화된 객체나 객체 컬렉션을 반환하는 메서드를 제공함으로써 실제 저장소와 질의 기술을 캡슐화하라. 실질적으로 직접 접근해야 하는 AGGREGATE의 루트에 대해서만 REPOSITORY를 제공하고, 모든 객체 저장과 접근은 REPOSITORY에 위임해서 클라이언트가 모델에 집중하게 하라.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;여기서 우리가 주목해야 할 부분은 &lt;strong&gt;객체로 구성된 컬랙션&lt;/strong&gt;과 &lt;strong&gt;캡슐화&lt;/strong&gt; 라고 생각합니다. 일반적인 웹 어플리케이션 아키텍쳐를 살펴보겠습니다. 여기서 &lt;code class=&quot;language-text&quot;&gt;Repository&lt;/code&gt;는 어느 계층에 속한다고 말할 수 있을까요??&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/28bb1061a8e448ac01689ce7e0cfc886/8a72f/img.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 70.58823529411764%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAABaklEQVQ4y5VTDZOCIBDt///GM00TEchUTCurd7y9o2m86c5jhgFc2H0f6wbf4/F4yHq9XuG9xziOch6GAXVtZE7ThPv9juUbrnG/WQaZSGuN4/EoZ+8HpNsdsjRHkZcwxkpRztd3cWzwy+Dl2+2Gvu9R6xplqcLeyzciJ9qI7i1Crrw4zzOmcYINiLzvYa0V9OfzWWJMyMSrKJMuH+qqxjbJAuUsJHRCMya5XC6/U44BVjbGyIOmaZDvCqiyQqW00I3aseCfGr4GSZtou66TxHSexU6n0/805OVIjYnYKs452dMcxqKGqxK2bSuUo55d1wcNc6TpDkmyhQ+0V1FeuhybnA9pSLlX2BdKGpzx1abwMul+6cSemxkV50mZGlIGol/VNtSHqIhAqUr6kBpSMyJmc3OywKt+bxPS1TzPJYnWBslHKr+eCm3TtR12WfH81hyaH7Tftk10nKZY4+Ds4emwc4egpZXiS8qfHnJEvfLoYGkAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img&apos; title=&apos;img&apos; src=&apos;/static/28bb1061a8e448ac01689ce7e0cfc886/ca1dc/img.png&apos; srcset=&apos;/static/28bb1061a8e448ac01689ce7e0cfc886/e7570/img.png 170w,
/static/28bb1061a8e448ac01689ce7e0cfc886/f46e7/img.png 340w,
/static/28bb1061a8e448ac01689ce7e0cfc886/ca1dc/img.png 680w,
/static/28bb1061a8e448ac01689ce7e0cfc886/8a72f/img.png 780w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;우리가 개발하고 있는 프로젝트에서 &lt;code class=&quot;language-text&quot;&gt;Repository&lt;/code&gt;는 데이터베이스에 데이터를 저장하기 위해서 사용되게 됩니다. 그러면 &lt;strong&gt;퍼시스턴스(Infrastructure) 계층&lt;/strong&gt;에 속한다고 말할 수 있을 것 같습니다. 하지만 &lt;strong&gt;도메인 주도 설계&lt;/strong&gt;에서는 &lt;code class=&quot;language-text&quot;&gt;Repository&lt;/code&gt;는 &lt;strong&gt;객체의 상태를 관리하는(CRUD) 저장소이기 때문에 도메인 계층에 속한다&lt;/strong&gt;고 말하고 있습니다. 그렇다면 무엇 때문에 우리는 &lt;code class=&quot;language-text&quot;&gt;Repository&lt;/code&gt;가 퍼시스턴스 계층에 속한다고 생각했던 걸까요??&lt;/p&gt;
&lt;p&gt;우리는 대부분의 프로젝트에서 JPA를 사용하고 있습니다. 이때 JPA를 통해서 데이터베이스에 접근하기 위해서 우리는 &lt;code class=&quot;language-text&quot;&gt;JpaRepository&lt;/code&gt;라는 객체를 상속받아 &lt;code class=&quot;language-text&quot;&gt;XXXRepository&lt;/code&gt;를 구현해 사용을 하고 있습니다. 이 부분 때문에 우리는 &lt;code class=&quot;language-text&quot;&gt;**Repository&lt;/code&gt;가 퍼시스턴스 계층에 속한다고 생각**하게 됩니다.&lt;/p&gt;
&lt;p&gt;하지만 생각해보면 우리는 어플리케이션 계층에서 비즈니스 로직을 작성할 때 &lt;code class=&quot;language-text&quot;&gt;Repository&lt;/code&gt; 내부가 어떻게 구현되어 있는지 모르고 사용을 합니다. 단순히 &lt;strong&gt;Public API를 통해 나와있는 그 기능을 사용할 뿐&lt;/strong&gt;입니다. 예를 들면, &lt;code class=&quot;language-text&quot;&gt;save()&lt;/code&gt; 메서드가 존재하면 해당 객체를 저장하는 기능이구나, &lt;code class=&quot;language-text&quot;&gt;find()&lt;/code&gt; 메서드가 있으면 해당 객체를 조회하는 기능이구나 와 같이 생각하는 것 처럼 말입니다. (물론 이론상 그렇다는거고 실제로는 JPA의 동작방식을 이해해야 한다고 개인적으로 생각합니다.)&lt;/p&gt;
&lt;p&gt;이처럼 내부 구현을 몰라도 어플리케이션 계층에서 사용이 가능한 이유는 &lt;code class=&quot;language-text&quot;&gt;Repository&lt;/code&gt;가 &lt;code class=&quot;language-text&quot;&gt;Interface&lt;/code&gt;로 구성이 되어 있기 때문입니다. 내부 구현체를 숨김으로써 &lt;strong&gt;어플리케이션 계층에서는 도메인의 상태만 관리하는 기능을 수행하도록 API를 제공&lt;/strong&gt;하고, 실제 구현체에서는 &lt;strong&gt;해당 도메인을 영속화하는 기능을 수행하기 위해 인프라 스트럭쳐와 관련되 모듈들을 Import 하여 기능을 동작&lt;/strong&gt;한다고 할 수 있습니다. 즉, 정리하면 우리가 사용하는 관점에서 &lt;code class=&quot;language-text&quot;&gt;Repository&lt;/code&gt;의 &lt;code class=&quot;language-text&quot;&gt;Interface&lt;/code&gt;는 도메인 레이어, &lt;code class=&quot;language-text&quot;&gt;Repository&lt;/code&gt;의 구현체는 퍼시스턴스(영속성) 레이어에 속한다고 할 수 있습니다.&lt;/p&gt;
&lt;h2&gt;Dao와 Repository의 차이&lt;/h2&gt;
&lt;p&gt;지금까지 내용을 통해 &lt;code class=&quot;language-text&quot;&gt;DAO&lt;/code&gt;와 &lt;code class=&quot;language-text&quot;&gt;Repository&lt;/code&gt;의 핵심적인 차이점에 대해서 정리를 하면, &lt;code class=&quot;language-text&quot;&gt;**DAO&lt;/code&gt;는 데이터베이스의 테이블과 1 : 1 매핑이 되는 저수준의 CRUD 기능**을 제공한다고 할 수 있습니다. &lt;code class=&quot;language-text&quot;&gt;Repository&lt;/code&gt;는 도메인에 대해서 CRUD 기능을 제공하며 이러한 도메인은 데이터베이스 테이블과 1 : 1 매핑이 되는 것이 아닌 하나의 개념 단위를 묶인 것(Aggregate)이라고 할 수 있습니다. 즉, &lt;code class=&quot;language-text&quot;&gt;Repository&lt;/code&gt;의 구현체에서는 여러개의 &lt;code class=&quot;language-text&quot;&gt;DAO&lt;/code&gt;를 조합하는 방식으로 하나의 개념을 군집화하여 구현할 수도 있다 할 수 있습니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;OrderRepositoryImpl&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;OrderRepository&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;OrderTableDao&lt;/span&gt; orderTableDao&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;OrderDao&lt;/span&gt; orderDao&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// 생략..&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;사실 &lt;code class=&quot;language-text&quot;&gt;DAO&lt;/code&gt;를 사용하더라도 도메인에서 사용하는 &lt;code class=&quot;language-text&quot;&gt;Repository Interface&lt;/code&gt;와 같이 구현하면 충분히 &lt;code class=&quot;language-text&quot;&gt;Repository&lt;/code&gt;와 동일하게 사용을 할 수 있다고 생각합니다. 하지만 애초에 &lt;code class=&quot;language-text&quot;&gt;DAO&lt;/code&gt;와 &lt;code class=&quot;language-text&quot;&gt;Repository&lt;/code&gt; 설계의 목적 자체가 다르다고 생각을 하기 때문에 목적에 맞게 사용을 하는 것이 좋다고 생각합니다. 어쩌면 JPA에서 &lt;code class=&quot;language-text&quot;&gt;JpaRepository&lt;/code&gt; 라는 이름을 통해서 &lt;code class=&quot;language-text&quot;&gt;Repository&lt;/code&gt;를 제공하고 있기 때문에 &lt;code class=&quot;language-text&quot;&gt;Repository&lt;/code&gt;르 명명되는 것들이 자연스럽게 된 것 같기도 합니다&lt;/p&gt;
&lt;h2&gt;참고&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://johngrib.github.io/wiki/pattern/repository/&quot;&gt;https://johngrib.github.io/wiki/pattern/repository/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.baeldung.com/java-dao-vs-repository&quot;&gt;https://www.baeldung.com/java-dao-vs-repository&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[테스트에서의 @Transactional]]></title><description><![CDATA[…]]></description><link>https://wishoon.github.io/테스트에서의 @Transactional/</link><guid isPermaLink="false">https://wishoon.github.io/테스트에서의 @Transactional/</guid><pubDate>Sat, 29 Oct 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;테스트 격리를 위해서는 데이터를 롤백시키는 과정이 필요합니다. 하지만 이 과정에서 잘못된 방법을 사용할 경우 몇가지 문제가 발생할 수 있는데요. 이번 포스팅에서는 문제가 생길 수 있는 상황들과 테스트 격리 방법을 조금 더 고도화하기 위해서 고민했던 내용에 대해서 작성해보려고 합니다.&lt;/p&gt;
&lt;h2&gt;SpringBootTest는 @Transactional로 롤백되지 않을 수도 있다&lt;/h2&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;@DataJpaTest&lt;/code&gt;를 사용하면 영속성 계층에 대해서 편리하게 테스트를 할 수 있습니다. &lt;code class=&quot;language-text&quot;&gt;@DataJpaTest&lt;/code&gt; 안에 &lt;code class=&quot;language-text&quot;&gt;@Transactional&lt;/code&gt;이 있어서 테스트가 끝나면 트랜잭션을 롤백시키기 때문에, 각각의 테이블이 비워지면서 모든 테스트가 격리되게 됩니다.&lt;/p&gt;
&lt;p&gt;그렇다면 &lt;code class=&quot;language-text&quot;&gt;@SpringBootTest&lt;/code&gt;에서는 어떻게 데이터를 롤백해야 할까요?? &lt;code class=&quot;language-text&quot;&gt;@SpringBootTest&lt;/code&gt;를 보면 &lt;code class=&quot;language-text&quot;&gt;@Transactional&lt;/code&gt;이 사용되지 않고 있습니다. 그렇다면 &lt;code class=&quot;language-text&quot;&gt;@Transactional&lt;/code&gt;만 잘 추가해주면 롤백이 잘 수행된다고 할 수 있을까요??&lt;/p&gt;
&lt;h3&gt;SpringBootTest의 테스트 환경&lt;/h3&gt;
&lt;p&gt;기본적으로 &lt;code class=&quot;language-text&quot;&gt;@SpringBootTest&lt;/code&gt;는 서버를 시작하지 않습니다. 그래서 &lt;code class=&quot;language-text&quot;&gt;webEnvironment&lt;/code&gt; 설정을 통해 테스트를 어떤 환경에서 시작할 건지 설정을 할 수 있습니다. 설정값은 다음과 같습니다.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;MOCK (default) : 내장 서버가 실행되지 않는다. mock 기반 테스트를 실행&lt;/li&gt;
&lt;li&gt;RANDOM_PORT : 랜덤 포트 번호로 실제 웹 서버와 함께 WebServerApplicaitonContext가 로드됨&lt;/li&gt;
&lt;li&gt;DEFINE_PORT : 설정된 포트 번호로 실제 웹 서버와 함께 WebServerApplicaitonContext가 로드됨&lt;/li&gt;
&lt;li&gt;NONE : SpringApplicaiton을 통해 ApplicaitonContext를 로드하지만 어떠한 웹 환경도 제공하지 않음&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;여기서 실제 서블릿 환경을 실행시키기 위해 &lt;code class=&quot;language-text&quot;&gt;RANDOM_PORT&lt;/code&gt;와 &lt;code class=&quot;language-text&quot;&gt;DEFINE_PORT&lt;/code&gt;로 설정을 하고 &lt;code class=&quot;language-text&quot;&gt;@Transactional&lt;/code&gt;을 작동시키면 롤백이 되지 않는 것을 확인할 수 있습니다. 즉, 테스트들이 격리되지 않아서 전체 테스트에 실패를 하게 됩니다. 왜 이런 현상이 발생하게 되는 걸까요??&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/e1b8248e1a9bf4a4727599c21c1b1ecb/f97d7/img.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 31.176470588235293%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAvklEQVQY022QWQ6EMAxDuQ5UoiylLF3o/S+V0csoIyTmI5Q6sWunyznLeZ7inBPvvaSU9F5rlVKKniEE2fdd7vvWPpzjOLRijDLPs0zTpBrdP8HrupSEQGtN1nVVIhg9ikcQ4qSPIPef4DAM2mDYXIDjbNs2xREHx/mzmIHf9/1b0MQsLrFwboL0bcYcc1+W5esQokUGtEjgCFDERRjs+ZitBj7FXMeHSAiO46j/7IVherYv3BMNjLJVPPlE/gAW5cVKHDrFtgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img&apos; title=&apos;img&apos; src=&apos;/static/e1b8248e1a9bf4a4727599c21c1b1ecb/ca1dc/img.png&apos; srcset=&apos;/static/e1b8248e1a9bf4a4727599c21c1b1ecb/e7570/img.png 170w,
/static/e1b8248e1a9bf4a4727599c21c1b1ecb/f46e7/img.png 340w,
/static/e1b8248e1a9bf4a4727599c21c1b1ecb/ca1dc/img.png 680w,
/static/e1b8248e1a9bf4a4727599c21c1b1ecb/02d09/img.png 1020w,
/static/e1b8248e1a9bf4a4727599c21c1b1ecb/9d567/img.png 1360w,
/static/e1b8248e1a9bf4a4727599c21c1b1ecb/f97d7/img.png 2000w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/f7155d32ab2198d58d2714b69d2457db/f97d7/img_1.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 11.76470588235294%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAZElEQVQI1zWNSQpEMRBC/3UykZCEzNP9L2VjQS8KhVfqd85B7x21Vqy1xM85sfcG2b0X3nuUUvDekx9yspQSrLVQSsEYI/exIOcskCF6amtNdIyBEAJijOI5/OfMOOegtZYy6g+k2kDhjQLz6AAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 1&apos; title=&apos;img 1&apos; src=&apos;/static/f7155d32ab2198d58d2714b69d2457db/ca1dc/img_1.png&apos; srcset=&apos;/static/f7155d32ab2198d58d2714b69d2457db/e7570/img_1.png 170w,
/static/f7155d32ab2198d58d2714b69d2457db/f46e7/img_1.png 340w,
/static/f7155d32ab2198d58d2714b69d2457db/ca1dc/img_1.png 680w,
/static/f7155d32ab2198d58d2714b69d2457db/02d09/img_1.png 1020w,
/static/f7155d32ab2198d58d2714b69d2457db/9d567/img_1.png 1360w,
/static/f7155d32ab2198d58d2714b69d2457db/f97d7/img_1.png 2000w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;이렇게 &lt;strong&gt;서블릿 환경을 실행시키게 되면, 별도의 스레드에서 스프링 컨테이너가 실행&lt;/strong&gt;되게 됩니다. 이후 테스트가 종료되고 나서 이를 롤백시키기 위해서는, 하나의 트랜잭션으로 묶여야 하는데, &lt;strong&gt;스프링 컨테이너가 실제로 구동되어 테스트와 다른 스레드에서 실행이 되게 되어 &lt;code class=&quot;language-text&quot;&gt;@Transactional&lt;/code&gt;을 적용해도 롤백이 되지 않는 것&lt;/strong&gt;입니다.&lt;/p&gt;
&lt;h3&gt;테스트 환경 격리시키기&lt;/h3&gt;
&lt;p&gt;결국 실제 서블릿 환경을 실행시키는 인수 테스트를 할 때는, 모든 테이블의 데이터를 삭제해서 초기화해주는 방법이 가장 깔끔한 것 같습니다. 이를 구현하기 위해서 많은 방법들이 있겠지만 저는 &lt;code class=&quot;language-text&quot;&gt;TRUNCATE&lt;/code&gt; 명령어를 통해서 모든 테이블의 데이터를 제거해주도록 하겠습니다.&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;TRUNCATE&lt;/code&gt;를 활용한 테스트 격리는 다음 순으로 이루어집니다.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;테스트가 끝나면 모든 테이블에 대한 TRUNCATE TABLE 명령어를 얻어옴&lt;/li&gt;
&lt;li&gt;제약조건 무호화 명령어 실행&lt;/li&gt;
&lt;li&gt;모든 TRUNCATE TABLE 명령어를 실행시킴&lt;/li&gt;
&lt;li&gt;제약조건 재설정 명령어를 실행시킴&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;위의 방법들을 이용해서 &lt;code class=&quot;language-text&quot;&gt;TRUNCATE&lt;/code&gt; 명령어를 수행하는 로직을 구현하는 것 까지는 일반적으로 할 수 있습니다. &lt;code class=&quot;language-text&quot;&gt;JPA&lt;/code&gt;의 &lt;code class=&quot;language-text&quot;&gt;EntityManager&lt;/code&gt;를 통해서 구현할 수도 있고, &lt;code class=&quot;language-text&quot;&gt;JPA&lt;/code&gt; 의존이 싫다고 하면 &lt;code class=&quot;language-text&quot;&gt;JdbcTemplate&lt;/code&gt;을 통해서 작성도 가능합니다.&lt;/p&gt;
&lt;p&gt;하지만 이를 적용하기 위해서는 구현한 클래스에 대해서 모든 테스트 클래스에 상속을 적용해줘야 합니다. 상속 자체가 나쁜건 아니지만, 꼭 필요한 시점에 다른 상속이 필요할 때도 있고, 상위 &lt;code class=&quot;language-text&quot;&gt;AcceptanceTest&lt;/code&gt;에 어떠한 다른 코드가 추가되어 기존 인수 테스트에 영향을 줄 수 있는 여지가 있기 때문에 상속보다는 다른 방법으로 이를 해결하고 싶었습니다.&lt;/p&gt;
&lt;p&gt;이를 해결하기 위해서 &lt;code class=&quot;language-text&quot;&gt;TestExecutionListener&lt;/code&gt;, &lt;code class=&quot;language-text&quot;&gt;Custom Annotation&lt;/code&gt;, &lt;code class=&quot;language-text&quot;&gt;Environment&lt;/code&gt;를 활용하면 상속을 사용하지 않고도 인수테스트 환경을 구성할 수 있습니다. &lt;code class=&quot;language-text&quot;&gt;Spring&lt;/code&gt;은 테스트의 실행 주기에 개입할 수 있도록 리스너 인터페이스인 &lt;code class=&quot;language-text&quot;&gt;TestExecutionListener&lt;/code&gt; 를 제공하고 있습니다. 이 구현체를 만들어 테스트 실행 시점에 등록한다면 특정 시점에 개입 할 수 있게 됩니다.  제공되는 각각의 메서드들은 다음과 같습니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/fde04e7fac8a965e6ee40db9e21ffd56/9aa73/img_2.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 30.58823529411765%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA5klEQVQY022Q16qFUAxE/f+fE44VH+wFe0MFFXNZgf12hSEmmWTPxBrHUaIokjRNpW1baZpGyrLUWFWV+L4vjuOI53kShqHmxCRJdA7evu8yz7M8zyPWsiwSx7EURSHHcWhzXVeN0zRJ3/f60DAMGruuU9R1rX0W0YP3vq9YJEEQqCoWoZiaiVmWqfo8zxX8w2UhnPM85bouxfd9YvEqNox8gFrAED3bthXY/v1+ahk+wDouUYggXei6rqpE0bZt+jIkclRxSwPUUTMRLuAM932LxQ2wBSiyiMh9jHVzS+rkzGDvv+8P7+u9zz3FNw0AAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 2&apos; title=&apos;img 2&apos; src=&apos;/static/fde04e7fac8a965e6ee40db9e21ffd56/ca1dc/img_2.png&apos; srcset=&apos;/static/fde04e7fac8a965e6ee40db9e21ffd56/e7570/img_2.png 170w,
/static/fde04e7fac8a965e6ee40db9e21ffd56/f46e7/img_2.png 340w,
/static/fde04e7fac8a965e6ee40db9e21ffd56/ca1dc/img_2.png 680w,
/static/fde04e7fac8a965e6ee40db9e21ffd56/02d09/img_2.png 1020w,
/static/fde04e7fac8a965e6ee40db9e21ffd56/9d567/img_2.png 1360w,
/static/fde04e7fac8a965e6ee40db9e21ffd56/9aa73/img_2.png 1912w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;여기서 우리는 각각의 테스트들이 실행되기 전 &lt;code class=&quot;language-text&quot;&gt;TRUNCATE&lt;/code&gt;를 해주면 되기 때문에 &lt;code class=&quot;language-text&quot;&gt;beforeTestMethod&lt;/code&gt;를 이용해서 구현을 하면 되겠습니다.&lt;/p&gt;
&lt;p&gt;추가적으로 자바 8 이후로 등장한 &lt;code class=&quot;language-text&quot;&gt;AbstractTestExecutionListener&lt;/code&gt;를 사용한다면 필요한 메서드만 오버라이딩 해서 사용할 수 있습니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/e5e8fd9c3fb12c282c01d4dcc78d10b2/a82f2/img_3.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 23.52941176470588%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAw0lEQVQY01WPW67DIAxEsxzehoCBJPd2/7ua2jSV0o+jGRvLeDZODj0ZcKsYx4U+D4x5LuUx0YfqgZ4DzmLRmeXtXH2d0xlFfdkrNsqEXDK89zDG/mItrGLM7Z1gVr1Ues4p7vYO299hcU2LtltQCigUsGfViCx1Ch6JaBFjQkofrxpCWIc82UZ2GCVIJI+rJ4HwmoT/mTFrRCOPygPcJ/ba0Lh/fGNZGNdVPwu9/OqchxWMRFqYG414x/lGfPrvsufSN71WmiTdz8uXAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 3&apos; title=&apos;img 3&apos; src=&apos;/static/e5e8fd9c3fb12c282c01d4dcc78d10b2/ca1dc/img_3.png&apos; srcset=&apos;/static/e5e8fd9c3fb12c282c01d4dcc78d10b2/e7570/img_3.png 170w,
/static/e5e8fd9c3fb12c282c01d4dcc78d10b2/f46e7/img_3.png 340w,
/static/e5e8fd9c3fb12c282c01d4dcc78d10b2/ca1dc/img_3.png 680w,
/static/e5e8fd9c3fb12c282c01d4dcc78d10b2/02d09/img_3.png 1020w,
/static/e5e8fd9c3fb12c282c01d4dcc78d10b2/a82f2/img_3.png 1358w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;여기서 저희가 작성해야 할 기능은 크게 두 가지입니다. 하나는 기존과 같이 &lt;code class=&quot;language-text&quot;&gt;TRUNCATE&lt;/code&gt;를 해주는 기능이고, 또 하나는&lt;code class=&quot;language-text&quot;&gt;RestAssured&lt;/code&gt;을 수행하기 위해서 사용할 &lt;code class=&quot;language-text&quot;&gt;Port&lt;/code&gt;를 등록해주는 것입니다. &lt;code class=&quot;language-text&quot;&gt;Environment&lt;/code&gt; 를 통해 이러한 Port를 얻어올 수 있습니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/79a60006b0c8e6147989680423e3e4a3/f97d7/img_4.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 15.88235294117647%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAfklEQVQI12WNSQ4DIQwE5zdRMNhsBgb+/64OS6SRkkOpval8DX2hF0YrCb0GaBTElJByQdY6U8EsB3lwzsE6mthdMzNk9pdYwtCIcVeM3lBrhZaGmKdU804fPUIMEPE/QvsV2v1wC+2yryWtJc9jDyKCMWby3kl0OLN/nnuDD1DtXMEoxxkBAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 4&apos; title=&apos;img 4&apos; src=&apos;/static/79a60006b0c8e6147989680423e3e4a3/ca1dc/img_4.png&apos; srcset=&apos;/static/79a60006b0c8e6147989680423e3e4a3/e7570/img_4.png 170w,
/static/79a60006b0c8e6147989680423e3e4a3/f46e7/img_4.png 340w,
/static/79a60006b0c8e6147989680423e3e4a3/ca1dc/img_4.png 680w,
/static/79a60006b0c8e6147989680423e3e4a3/02d09/img_4.png 1020w,
/static/79a60006b0c8e6147989680423e3e4a3/9d567/img_4.png 1360w,
/static/79a60006b0c8e6147989680423e3e4a3/f97d7/img_4.png 2000w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;그리고 기존과 동일하게 &lt;code class=&quot;language-text&quot;&gt;TRUNCATE&lt;/code&gt; 기능을 작성해주겠습니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/d1eed57ce64ff9c3a52f0747bb9b56b9/f97d7/img_5.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 8.823529411764705%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAaElEQVQI102Maw7DIAyDex0SqkJC1/Io6u5/KC+MTtqPT7Yjx0s9Emp/I5eG1m+cpkeuKK2j1AvZGP60m6b94QUNG+LKIGIwT4gIi6hCNEGsOHyIMrMovPff4lQPcg7uhz2PAR78DX4AQEI+/3Cj690AAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 5&apos; title=&apos;img 5&apos; src=&apos;/static/d1eed57ce64ff9c3a52f0747bb9b56b9/ca1dc/img_5.png&apos; srcset=&apos;/static/d1eed57ce64ff9c3a52f0747bb9b56b9/e7570/img_5.png 170w,
/static/d1eed57ce64ff9c3a52f0747bb9b56b9/f46e7/img_5.png 340w,
/static/d1eed57ce64ff9c3a52f0747bb9b56b9/ca1dc/img_5.png 680w,
/static/d1eed57ce64ff9c3a52f0747bb9b56b9/02d09/img_5.png 1020w,
/static/d1eed57ce64ff9c3a52f0747bb9b56b9/9d567/img_5.png 1360w,
/static/d1eed57ce64ff9c3a52f0747bb9b56b9/f97d7/img_5.png 2000w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;지금까지 만든 &lt;code class=&quot;language-text&quot;&gt;TestExecutionListener&lt;/code&gt;를 테스트 실행 시에 등록하기 위해서 &lt;code class=&quot;language-text&quot;&gt;@TestExecutionListeners&lt;/code&gt;를 사용해주면 됩니다. 같이 사용한 &lt;code class=&quot;language-text&quot;&gt;mergeMode&lt;/code&gt; 속성은 &lt;code class=&quot;language-text&quot;&gt;Default&lt;/code&gt; 로 존재하는 다른 리스너들을 대체할 것인지를 설정하는 것인데, &lt;code class=&quot;language-text&quot;&gt;Default&lt;/code&gt; 리스너를 함께 사용하도록 하면 됩니다.&lt;/p&gt;
&lt;p&gt;그리고 &lt;code class=&quot;language-text&quot;&gt;Custom Annotation&lt;/code&gt;을 만들어 각 인수테스트에서 사용하도록 하면 깔끔하게 테스트 환경을 격리시킬 수 있습니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/a4c0ecc3bd823d696739cd74cae193c3/f97d7/img_6.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 14.117647058823529%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAkklEQVQI10XN6w6DIAwFYJ9mCRXaAoLKjM69/zudFWe2H19O2vQytOaxtM3smMuKaSrQGBE5QTmCaIQjsnSGrvrH0d37G97niONQHOcT+/7C1lbkUlHmBbnOqDkiiYdohAhDxV2kp6rpjxUSFBwEQ02Ekh4ohZBzsMVk+mD8HmG24RHMghC8pTN0J199Dozgu4APWJRdiUXXGC8AAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 6&apos; title=&apos;img 6&apos; src=&apos;/static/a4c0ecc3bd823d696739cd74cae193c3/ca1dc/img_6.png&apos; srcset=&apos;/static/a4c0ecc3bd823d696739cd74cae193c3/e7570/img_6.png 170w,
/static/a4c0ecc3bd823d696739cd74cae193c3/f46e7/img_6.png 340w,
/static/a4c0ecc3bd823d696739cd74cae193c3/ca1dc/img_6.png 680w,
/static/a4c0ecc3bd823d696739cd74cae193c3/02d09/img_6.png 1020w,
/static/a4c0ecc3bd823d696739cd74cae193c3/9d567/img_6.png 1360w,
/static/a4c0ecc3bd823d696739cd74cae193c3/f97d7/img_6.png 2000w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2&gt;AcceptanceTest가 아닌 다른 테스트에서의 @Transactional&lt;/h2&gt;
&lt;p&gt;위의 인수테스트에서는 &lt;code class=&quot;language-text&quot;&gt;@Transactional&lt;/code&gt;을 사용하지 않고 테스트를 수행했습니다. 그렇다면 &lt;code class=&quot;language-text&quot;&gt;Random Port&lt;/code&gt;를 사용하지 않아도 괜찮은 &lt;code class=&quot;language-text&quot;&gt;Application Layer&lt;/code&gt;에서는 &lt;code class=&quot;language-text&quot;&gt;@Transactional&lt;/code&gt;을 사용해도 괜찮을까요?? 다음 상황을 통해 한번 살펴보도록 하겠습니다.&lt;/p&gt;
&lt;h3&gt;운영 코드와 테스트 코드의 괴리&lt;/h3&gt;
&lt;p&gt;만약 운영코드에 실수로 &lt;code class=&quot;language-text&quot;&gt;@Transactional&lt;/code&gt;을 작성하지 않았다고 가정해보겠습니다. 아니면 작성이 되어있다가 운영코드에서 &lt;code class=&quot;language-text&quot;&gt;@Transactional&lt;/code&gt;이 지워지는 상황도 발생할 수 있겠네요. 이렇게 될 경우, &lt;code class=&quot;language-text&quot;&gt;LazyInitializationException&lt;/code&gt; 이 발생하게 됩니다.&lt;/p&gt;
&lt;p&gt;이유는 생각보다 간단합니다. 서비스 계층에서 트랜잭션이 걸려있지 않아 &lt;code class=&quot;language-text&quot;&gt;Lazy Fetching&lt;/code&gt;이 불가능하기 때문입니다. &lt;code class=&quot;language-text&quot;&gt;@Transactional&lt;/code&gt;이 존재하지 않아 세션이 이미 종료된 상태인데 &lt;code class=&quot;language-text&quot;&gt;DataBase&lt;/code&gt;에 &lt;code class=&quot;language-text&quot;&gt;Lazy&lt;/code&gt;로 또 접근하려 하기 때문입니다.&lt;/p&gt;
&lt;p&gt;하지만 테스트는 정상적으로 작동하게 됩니다. &lt;strong&gt;그 이유는 테스트 환경에서는 &lt;code class=&quot;language-text&quot;&gt;@Transactional&lt;/code&gt;이 작성되어 있기 때문에 세션이 유지되기 때문&lt;/strong&gt;입니다. 이러한 구조는 운영 코드와 테스트 코드간에 괴리를 유발하며, 추후 장애가 발생할 수 있는 요인 중 하나라고 할 수 있습니다.&lt;/p&gt;
&lt;h3&gt;영속성 컨텍스트에서 새로운 데이터가 조회되지 않을 수 있다&lt;/h3&gt;
&lt;p&gt;보통 &lt;code class=&quot;language-text&quot;&gt;JPA&lt;/code&gt;를 사용한 프로젝트에서 테스트 코드에 &lt;code class=&quot;language-text&quot;&gt;@Transacitonal&lt;/code&gt;을 붙이게 되면, 메서드 단위로 트랜잭션이 적용되게 됩니다. 이는 &lt;strong&gt;테스트 대상의 메서드가 트랜잭션을 이어받게 됨을 의미&lt;/strong&gt;하는데요. 이 경우 &lt;strong&gt;트랜잭션 커밋이 메서드 종료시점에 수행&lt;/strong&gt;되므로 &lt;code class=&quot;language-text&quot;&gt;Repository&lt;/code&gt;를 통해 객체를 조회할 때 예상과 다르게 조회가 될 수 있습니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;kotlin&quot;&gt;&lt;pre class=&quot;language-kotlin&quot;&gt;&lt;code class=&quot;language-kotlin&quot;&gt;&lt;span class=&quot;token annotation builtin&quot;&gt;@Transactional&lt;/span&gt;
&lt;span class=&quot;token annotation builtin&quot;&gt;@SpringBootTest&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; CouponService &lt;span class=&quot;token annotation builtin&quot;&gt;@Autowired&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;constructor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; couponService&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; CouponService&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; couponRepository&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; CouponRepository&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; userRepository&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; UserRepository&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; userHistoryRepository&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; UserHistoryRepository&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token annotation builtin&quot;&gt;@Test&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;fun&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;createCoupon&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token comment&quot;&gt;// given&lt;/span&gt;
        couponRepository&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Coupon&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string-literal singleline&quot;&gt;&lt;span class=&quot;token string&quot;&gt;&quot;커피 쿠폰&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; savedUser &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; userRepository&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;User&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string-literal singleline&quot;&gt;&lt;span class=&quot;token string&quot;&gt;&quot;루키&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        userHistoryRepository&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;UserHistory&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;savedUser&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string-literal singleline&quot;&gt;&lt;span class=&quot;token string&quot;&gt;&quot;커피 쿠폰&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; request &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;CouponRequest&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1L&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string-literal singleline&quot;&gt;&lt;span class=&quot;token string&quot;&gt;&quot;커피 쿠폰&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

        &lt;span class=&quot;token comment&quot;&gt;// when&lt;/span&gt;
        couponService&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;findCoupon&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;request&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; 

        &lt;span class=&quot;token comment&quot;&gt;// then&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; results &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; userHistoryRepository&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;findAll&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;assertThat&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;results&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;hasSize&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;위의 코드 중, &lt;code class=&quot;language-text&quot;&gt;couponService.findCoupon()&lt;/code&gt;은 &lt;code class=&quot;language-text&quot;&gt;userRepository.findById()&lt;/code&gt;을 호출해서 &lt;code class=&quot;language-text&quot;&gt;User&lt;/code&gt; 객체를 가져오게 되는데, 가져온 &lt;code class=&quot;language-text&quot;&gt;User&lt;/code&gt; 객체는 영속성 컨텍스트에서 캐싱된 객체로서 아직 &lt;code class=&quot;language-text&quot;&gt;userHistory&lt;/code&gt; 컬렉션에 객체가 추가되지 않은 상태입니다. 이러한 현상은 &lt;code class=&quot;language-text&quot;&gt;userHistoryRepository.save()&lt;/code&gt; 가 &lt;strong&gt;상위 트랜잭션을 이어받아 하나의 트랜잭션에서 수행되어 커밋이 일어나지 않았기 때문&lt;/strong&gt;입니다.&lt;/p&gt;
&lt;p&gt;이를 해결하는 방법은 간단합니다. &lt;code class=&quot;language-text&quot;&gt;@Transactional&lt;/code&gt;을 제거한다면, 새로운 트랜잭션에서 요청이 수행되면서 정상적으로 테스트가 성공하게 됩니다.&lt;/p&gt;
&lt;h2&gt;마무리&lt;/h2&gt;
&lt;p&gt;이 포스팅 주제와는 관련이 없는데, 레벨 2 쯤이였나.. 주말에 수달이랑 프롤로그 근로 때문에 인수테스트를 같이 살펴보고 있었는데 지나가던 포비가 말을 걸어주셔서 인수테스트 관련으로 잠깐 얘기한 적이 있었습니다. 당시 인수테스트의 가독성 향상과 속도 향상에 빠져있던 시기라 포비에게 이것저것 여쭤봤었고, 그 중에 한가지가 기억이 남았습니다.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;‘현업에서도 인수테스트에 대해서 고민을 많이하고, 지금의 코드처럼 상속을 통해서 해결하기도 해요. 하지만 상속으로 하면 제약사항이 생기게 되잖아요?? 이 부분에 대해서 한번 고민해보는 것도 좋을 것 같아요.’&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;당시에 이 말을 듣고, 여려 방면으로 인수테스트에서의 상속 제거에 대해서 고민해보고 시도해봤는데 번번히 실패를 했어서 잠시 포기를 했었습니다… 그러다가 최근 구구의 JdbcTemplate 미션 때문에 검색하던 도중 &lt;code class=&quot;language-text&quot;&gt;AbstractTestExecutionListener&lt;/code&gt;라는 방법과 &lt;code class=&quot;language-text&quot;&gt;Property&lt;/code&gt;를 가져올 수 있는 방법을 알게되어서 이 문제를 해결할 수 있었습니다.&lt;/p&gt;
&lt;p&gt;아직 인수 테스트에서의 제가 고민하고 있는 부분들은 완벽하게 해결되지는 않았습니다. &lt;strong&gt;테스트의 가독성이라는 고민&lt;/strong&gt;은 계속해서 남아있는 상황인데, 프롤로그에서 사용하고 있는 &lt;code class=&quot;language-text&quot;&gt;BDD&lt;/code&gt; 기반의 &lt;code class=&quot;language-text&quot;&gt;Cucumber&lt;/code&gt;를 사용하지 않고도 가독성있게 테스트를 작성할 수 있는 방법을 계속 고민해보고 시도해보려고 합니다.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;참고&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://docs.spring.io/spring-boot/docs/2.1.6.RELEASE/reference/html/boot-features-testing.html&quot;&gt;https://docs.spring.io/spring-boot/docs/2.1.6.RELEASE/reference/html/boot-features-testing.html&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.baeldung.com/spring-testexecutionlistener&quot;&gt;https://www.baeldung.com/spring-testexecutionlistener&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/next-step/atdd-subway-path&quot;&gt;https://github.com/next-step/atdd-subway-path&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/woowacourse/jwp-refactoring/pull/334/commits/2fa9080066998b4c7e4ba36e3aab7d99433f9861&quot;&gt;https://github.com/woowacourse/jwp-refactoring/pull/334/commits/2fa9080066998b4c7e4ba36e3aab7d99433f9861&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[JPA를 사용함으로서 겪었던 문제들]]></title><description><![CDATA[…]]></description><link>https://wishoon.github.io/JPA를-사용함으로서-겪었던-문제들/</link><guid isPermaLink="false">https://wishoon.github.io/JPA를-사용함으로서-겪었던-문제들/</guid><pubDate>Mon, 24 Oct 2022 00:00:00 GMT</pubDate><content:encoded>&lt;h2&gt;들어가기 전에..&lt;/h2&gt;
&lt;p&gt;데이터 접근 기술에 관련된 개발 효율성은 &lt;code class=&quot;language-text&quot;&gt;JPA&lt;/code&gt;를 알기 전과 후로 나뉜다고 할 수 있습니다. 그만큼 &lt;code class=&quot;language-text&quot;&gt;JPA&lt;/code&gt;는 개발자에게 많은 도움을 주는 도구라고 할 수 있습니다. 하지만 그만큼 잘못 사용하면 독으로 다가올 수도 있는 도구인데요.&lt;/p&gt;
&lt;p&gt;이번 글에서는 &lt;code class=&quot;language-text&quot;&gt;JPA&lt;/code&gt;를 사용함으로써 겪었던 문제들을 소개하기 전, 먼저 그에 대한 개념을 설명하고 각각의 문제사항에 대해서 공유해보는 시간을 가져보겠습니다.&lt;/p&gt;
&lt;h2&gt;영속성 컨텍스트&lt;/h2&gt;
&lt;p&gt;영속성 컨텍스트는 &lt;code class=&quot;language-text&quot;&gt;Entity&lt;/code&gt;를 논리적인 개념으로 영구히 저장하는 환경을 말합니다. 이러한 영속성 컨텍스트는 &lt;strong&gt;엔티티 매니저를 통해서 접근&lt;/strong&gt;할 수가 있습니다. 엔티티 메니저는 &lt;strong&gt;하나의 쓰레드마다 하나의 엔티티 메니저가 대응(하나의 트랜잭션 단위라고 봐도 됨)&lt;/strong&gt;되며 내부적으로 &lt;code class=&quot;language-text&quot;&gt;DB Connection Pool&lt;/code&gt;을 사용해서 &lt;code class=&quot;language-text&quot;&gt;DB&lt;/code&gt;에 접근을 수행합니다.&lt;/p&gt;
&lt;p&gt;이렇게 관리되는 영속성 컨텍스트는 4가지 상태의 생명주기(Transient, Managed, Detached, Removed)로 분류할 수 있습니다.&lt;/p&gt;
&lt;h3&gt;문제 상황 - 왜 SELECT 쿼리가 발생하는 걸까?&lt;/h3&gt;
&lt;p&gt;예전에 프로젝트를 하던 도중, &lt;code class=&quot;language-text&quot;&gt;UUID&lt;/code&gt;를 &lt;code class=&quot;language-text&quot;&gt;Entity&lt;/code&gt;의 ID 값으로 설정해야 하는 경우가 있었습니다. 해당 &lt;code class=&quot;language-text&quot;&gt;Entity&lt;/code&gt;를 기반으로 비즈니스 로직을 작성하고 이에 기반한 테스트 코드도 무사히 잘 작동하는 것을 보고 안심하고 다른 작업을 수행하려고 하는데 이상한 점을 발견할 수 있었습니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token class-name&quot;&gt;Hibernate&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; 
    select
        studyLog0_&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;id as id1_0_0_&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        studyLog0_&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;name as name2_0_0_ 
    from
        studyLog studyLog0_ 
    where
        studyLog0_&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;id&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;

&lt;span class=&quot;token class-name&quot;&gt;Hibernate&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; 
    insert 
        into
            studyLog
            &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;name&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; id&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; 
        values
            &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;위와 같이 &lt;code class=&quot;language-text&quot;&gt;INSERT&lt;/code&gt; 작업 전, &lt;code class=&quot;language-text&quot;&gt;SELECT&lt;/code&gt; 쿼리가 한번 발생한 후 &lt;code class=&quot;language-text&quot;&gt;INSERT&lt;/code&gt;가 수행되는 문제를 확인할 수 있었습니다.&lt;/p&gt;
&lt;h3&gt;Spring Data JPA에서의 save() 처리 방식&lt;/h3&gt;
&lt;p&gt;Spring Data JPA의 &lt;code class=&quot;language-text&quot;&gt;SimpleJpaRepository&lt;/code&gt;는 &lt;code class=&quot;language-text&quot;&gt;JpaRepository&lt;/code&gt;를 구현하는 구현체로 제공되는 기본적인 &lt;code class=&quot;language-text&quot;&gt;CRUD&lt;/code&gt;가 어떻게 동작하는지 확인을 할 수 있습니다.&lt;/p&gt;
&lt;p&gt;여기서 코드를 확인해보면, 새로운 객체를 생성할 때는 &lt;code class=&quot;language-text&quot;&gt;persist()&lt;/code&gt;, 객체를 수정할 때는 &lt;code class=&quot;language-text&quot;&gt;merge()&lt;/code&gt;를 호출하여 인스턴스의 영속성 관리를 해주고 있는 것을 확인할 수 있습니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/6c625e4f26060b0f128c341e9745bb0b/d98b8/img.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 33.529411764705884%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAxUlEQVQoz5WRQW5DIQxEc5iqagDb2B/4TZssqt7/TFObNlKkfBZdDJaM5mEPp++vF9yur+jbG3LOKCWDStQyFb2U0pPu/aiPOu2aIMIYkqFCUBX0VqFbg9qGPKHPxiPYBBLLNFaXOaSqgSjACvYHuBJI7iqzF1ssgeyXVg3NBrrtLq99oLm21h0gh+YlMI53rbhedlw+bxhjBxP9ZUj/zzDW+/AcI0OzNieL1YUZ6XxeTrKcMKZI8bv592eJeGb4mNPKfKQfTIDVW4T5t5MAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img&apos; title=&apos;img&apos; src=&apos;/static/6c625e4f26060b0f128c341e9745bb0b/ca1dc/img.png&apos; srcset=&apos;/static/6c625e4f26060b0f128c341e9745bb0b/e7570/img.png 170w,
/static/6c625e4f26060b0f128c341e9745bb0b/f46e7/img.png 340w,
/static/6c625e4f26060b0f128c341e9745bb0b/ca1dc/img.png 680w,
/static/6c625e4f26060b0f128c341e9745bb0b/02d09/img.png 1020w,
/static/6c625e4f26060b0f128c341e9745bb0b/9d567/img.png 1360w,
/static/6c625e4f26060b0f128c341e9745bb0b/d98b8/img.png 1588w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;코드를 보면 &lt;code class=&quot;language-text&quot;&gt;entityInformation.isNew()&lt;/code&gt; 라는 메서드가 존재합니다. isNew() 메서드는 새로운 Entity를 판단하기 위해서 ID 값을 확인하는데 기본 전략을 다음과 같습니다.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ID 타입이 객체 타입일 때 : null&lt;/li&gt;
&lt;li&gt;ID 타입이 기본 타입일 때 : 0&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;이를 통해서 &lt;code class=&quot;language-text&quot;&gt;Entity&lt;/code&gt;를 식별하는 값인 ID 값의 존재 여부를 파악한 뒤, &lt;code class=&quot;language-text&quot;&gt;persist&lt;/code&gt;와 &lt;code class=&quot;language-text&quot;&gt;merge&lt;/code&gt;를 선택해 수행한다고 할 수 있습니다.&lt;/p&gt;
&lt;p&gt;여기서 문제가 되는 점은 바로 &lt;code class=&quot;language-text&quot;&gt;entityInformation.isNew()&lt;/code&gt; 부분이였습니다. 일반적인 경우 &lt;code class=&quot;language-text&quot;&gt;@GeneratedValue(strategy = *IDENTITY*)&lt;/code&gt;를 사용하기 때문에 ID 값이 &lt;code class=&quot;language-text&quot;&gt;null&lt;/code&gt; 이여서 &lt;code class=&quot;language-text&quot;&gt;persist&lt;/code&gt; 가 수행이 되었습니다. 하지만 지금과 같이 ID 값이 이미 존재하기 때문에 &lt;code class=&quot;language-text&quot;&gt;merge&lt;/code&gt;가 수행된 것이였습니다.&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;merge&lt;/code&gt;는 영속성 컨텍스트의 1차 캐시에 해당 식별자가 있는지 확인하고 없는 경우 &lt;code class=&quot;language-text&quot;&gt;database&lt;/code&gt;를 조회하는 작업을 수행합니다. 즉, 해당 경우에는 &lt;code class=&quot;language-text&quot;&gt;UUID&lt;/code&gt;이기 때문에 1차 캐시에 동일한 값이 없으므로 &lt;strong&gt;무조건적으로 &lt;code class=&quot;language-text&quot;&gt;SELECT&lt;/code&gt; 쿼리가 한번 발생하게 되는 구조&lt;/strong&gt;라고 할 수 있습니다.&lt;/p&gt;
&lt;h3&gt;문제 해결 방법&lt;/h3&gt;
&lt;p&gt;다행이도 &lt;code class=&quot;language-text&quot;&gt;JPA&lt;/code&gt;에서는 &lt;code class=&quot;language-text&quot;&gt;Persistable&lt;/code&gt; 인터페이스를 재정의해서 문제를 해결할 수 있습니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/ea1edb8c23d55b74c0fe67be0af9d585/d98b8/img_1.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 31.176470588235293%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAj0lEQVQY052POQ7DMAwE9R3xlGTFShr//1cb+gAcIIWdFEOy4XCZqhKqMZoTSnGU1uC1QlTBzCCmrd8lkTCkGzjQrrBZIR6i/C0iupYnNcKyEF7PSBRy1nN5Ix8csitpoihTpJu6g00gK/5B2VkP3UookcoeFijKcPgcc6BVd/mvQlNBt4zRBKOX89U/X34DC2q1ocDKwTsAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 1&apos; title=&apos;img 1&apos; src=&apos;/static/ea1edb8c23d55b74c0fe67be0af9d585/ca1dc/img_1.png&apos; srcset=&apos;/static/ea1edb8c23d55b74c0fe67be0af9d585/e7570/img_1.png 170w,
/static/ea1edb8c23d55b74c0fe67be0af9d585/f46e7/img_1.png 340w,
/static/ea1edb8c23d55b74c0fe67be0af9d585/ca1dc/img_1.png 680w,
/static/ea1edb8c23d55b74c0fe67be0af9d585/02d09/img_1.png 1020w,
/static/ea1edb8c23d55b74c0fe67be0af9d585/9d567/img_1.png 1360w,
/static/ea1edb8c23d55b74c0fe67be0af9d585/d98b8/img_1.png 1588w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;isNew()&lt;/code&gt; 메서드를 재정의해서 새로운 엔티티 확인 여부를 개발자가 직접 정의할 수 있도록 구현을 할 수 있습니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token annotation punctuation&quot;&gt;@Getter&lt;/span&gt;
&lt;span class=&quot;token annotation punctuation&quot;&gt;@NoArgsConstructor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;access &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;AccessLevel&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;PROTECTED&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;StudyLog&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Persistable&lt;/span&gt;&lt;span class=&quot;token generics&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token annotation punctuation&quot;&gt;@Id&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt; uuid&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token annotation punctuation&quot;&gt;@CreatedDate&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;LocalDateTime&lt;/span&gt; createdDate&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; 

    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Item&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt; id&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;id &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; id&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token annotation punctuation&quot;&gt;@Override&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;isNew&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; createdDate &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; 
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;이렇게 구현을 하게 될 경우 원하는 대로 &lt;code class=&quot;language-text&quot;&gt;INSERT&lt;/code&gt; 쿼리가 한번만 나가는 것을 확인할 수 있습니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token class-name&quot;&gt;Hibernate&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; 
    insert 
        into
            studyLog
            &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;name&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; id&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; 
        values
            &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;Flush&lt;/h2&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;entityManager.commit()&lt;/code&gt;을 호출하게 되면 JPA의 영속성 컨텍스트에 있는 객체들이 DB로 반영되게 됩니다. 하지만 실제로는 &lt;code class=&quot;language-text&quot;&gt;commit()&lt;/code&gt; 메서드가 &lt;code class=&quot;language-text&quot;&gt;flush()&lt;/code&gt; 메서드를 호출해 이를 반영하는 것입니다.&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Flush&lt;/code&gt;는 영속성 컨텍스트의 내용을 &lt;code class=&quot;language-text&quot;&gt;DB&lt;/code&gt;에 반영하는 것을 말하며, 정확하게는 &lt;code class=&quot;language-text&quot;&gt;쓰기 지연 SQL&lt;/code&gt; 저장소에 있는 &lt;code class=&quot;language-text&quot;&gt;SQL&lt;/code&gt; 쿼리가 &lt;code class=&quot;language-text&quot;&gt;DB&lt;/code&gt;로 보내주는 역할을 한다고 할 수 있습니다.&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Flush&lt;/code&gt;가 호출되는 상황은 크게 다음과 같습니다.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;트랜잭션에 commit이 발생할 때&lt;/li&gt;
&lt;li&gt;EntityManager의 flush 메서드를 호출했을 때&lt;/li&gt;
&lt;li&gt;JPQL 쿼리가 실행될 때 - (정확하게 말하면 틀린말)&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;문제 상황 - 왜 데이터베이스에 반영이 안되지..?&lt;/h3&gt;
&lt;p&gt;변경감지를 통해서 해당 객체의 데이터 값을 변경해야 하는 비즈니스 로직을 작성해야 했었습니다. 다음과 같이 테스트 코드를 작성하고 비즈니스 로직을 완성하였습니다. (예시를 위해 코드를 간단하게 변경하였습니다)&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/b1dd4171aa2cf4417836686c86a02678/d98b8/img_2.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 30%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA2UlEQVQY05WRW5aEIAxE3Q6g5MVDnd7/tqoDanf/zsc1OULqVIpFOOBsAUUJOWeklP5NjPGuCcuaIloRvP52lNqhVsAkMC4TIYWowUqFDvxczJB1Q+YNRG7CBeMUj1iGeib2y20O1dZhVsHGIMkX7n4OphVpXX+cPS7j3bvg+OQtw8igjshA/UJAcD41xEkIdz/XvOq3T5fDIdD3c2LVnWpBs31iUtH6gXYcKL2h7r5BqzjOjt7LFP/m6Q5XX4GY57p2ZzQoHoF6duri4z/rEwF9Ith89nmQhzfvrLl8oPXWVgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 2&apos; title=&apos;img 2&apos; src=&apos;/static/b1dd4171aa2cf4417836686c86a02678/ca1dc/img_2.png&apos; srcset=&apos;/static/b1dd4171aa2cf4417836686c86a02678/e7570/img_2.png 170w,
/static/b1dd4171aa2cf4417836686c86a02678/f46e7/img_2.png 340w,
/static/b1dd4171aa2cf4417836686c86a02678/ca1dc/img_2.png 680w,
/static/b1dd4171aa2cf4417836686c86a02678/02d09/img_2.png 1020w,
/static/b1dd4171aa2cf4417836686c86a02678/9d567/img_2.png 1360w,
/static/b1dd4171aa2cf4417836686c86a02678/d98b8/img_2.png 1588w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;하지만 테스트가 실패하는 것을 확인할 수 있었습니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/4cb2c0150fbe0875aa7faadb9206db48/d98b8/img_3.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 8.235294117647058%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAAsTAAALEwEAmpwYAAAARUlEQVQI12NwNjD87wLE7oZG/70Mjf97AGlrPf3/utra/7W0tP5rA2lSMAPIEFeggY76Bv/NdfX+G+ro/NcEGgQzjFRDAXRRPV5GPIy4AAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 3&apos; title=&apos;img 3&apos; src=&apos;/static/4cb2c0150fbe0875aa7faadb9206db48/ca1dc/img_3.png&apos; srcset=&apos;/static/4cb2c0150fbe0875aa7faadb9206db48/e7570/img_3.png 170w,
/static/4cb2c0150fbe0875aa7faadb9206db48/f46e7/img_3.png 340w,
/static/4cb2c0150fbe0875aa7faadb9206db48/ca1dc/img_3.png 680w,
/static/4cb2c0150fbe0875aa7faadb9206db48/02d09/img_3.png 1020w,
/static/4cb2c0150fbe0875aa7faadb9206db48/9d567/img_3.png 1360w,
/static/4cb2c0150fbe0875aa7faadb9206db48/d98b8/img_3.png 1588w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;그런데 또 웃긴상황인건 실제 프로덕션 코드에서는 정상적으로 로직이 동작하는 것을 확인할 수 있었습니다. 그렇다는 것은 실제 프로덕션 코드는 문제가 없고 테스트 코드를 잘못 작성했다는 얘기였습니다. 하지만 아무리봐도 코드 자체는 문제가 없어보였습니다.&lt;/p&gt;
&lt;h3&gt;Flush의 동작 방식을 다시 학습하자 ㅠㅠ&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Flush&lt;/code&gt; 호출 상황에 대한 검색을 해보면 위에서 언급된 다음 3가지 상황이 나오게 됩니다.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;트랜잭션에 commit이 발생할 때&lt;/li&gt;
&lt;li&gt;EntityManager의 flush 메서드를 호출했을 때&lt;/li&gt;
&lt;li&gt;JPQL 쿼리가 실행될 때&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;그렇다면 테스트 코드에서는 이러한 조건을 하나라도 만족하는 것이 있을까요?? 눈치 채셨겠지만 해당 조건을 만족하는 코드가 존재하지 않습니다. 실제 프로덕션 처럼 &lt;code class=&quot;language-text&quot;&gt;commit&lt;/code&gt;을 하는 과정이 없기 때문입니다.&lt;/p&gt;
&lt;h3&gt;해결 방법&lt;/h3&gt;
&lt;p&gt;해결방법은 간단했습니다. 아까 말한 것 처럼, 실제 프로덕션에서는 &lt;code class=&quot;language-text&quot;&gt;Transaction&lt;/code&gt;이 끝나는 시점에 &lt;code class=&quot;language-text&quot;&gt;commit&lt;/code&gt;이 이루어지기 때문에 &lt;code class=&quot;language-text&quot;&gt;Flush&lt;/code&gt;가 호출되었습니다. 테스트 코드는 이러한 과정이 없기 때문에 직접 &lt;code class=&quot;language-text&quot;&gt;Flush&lt;/code&gt;를 날려주는 코드를 작성해주면 됩니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/085f26460e43ddb3795634a1c9e1e310/d98b8/img_4.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 28.82352941176471%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA5UlEQVQY011QSRLDIAzrd8JiMIuBNO3/f6U6kHYmPWhkMBKyH++x4eiMUjK8Jzjn4KyDd37irJ33qzfZzzfW2QVrYYyZbK3BIxChj4YqglwFkRNSyKis51jAMel9RdFeymUiZgaxB0UCqf5mSBTQZMdoB3p/Yjxf4JzgWVNGdwnPpEaF2wVzwzelMVYNdZTKDSPtKFlQWwd5h227C62xfyaX0Znsl9CuhNLHRJEGZh03NbQylGV+0vYdMrr2ZXETHK+h6wi3cX+G535yqRPnjr416z5LEXDKCDkgMCGmxSHQMvoz/AAasbppqOYrrAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 4&apos; title=&apos;img 4&apos; src=&apos;/static/085f26460e43ddb3795634a1c9e1e310/ca1dc/img_4.png&apos; srcset=&apos;/static/085f26460e43ddb3795634a1c9e1e310/e7570/img_4.png 170w,
/static/085f26460e43ddb3795634a1c9e1e310/f46e7/img_4.png 340w,
/static/085f26460e43ddb3795634a1c9e1e310/ca1dc/img_4.png 680w,
/static/085f26460e43ddb3795634a1c9e1e310/02d09/img_4.png 1020w,
/static/085f26460e43ddb3795634a1c9e1e310/9d567/img_4.png 1360w,
/static/085f26460e43ddb3795634a1c9e1e310/d98b8/img_4.png 1588w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3&gt;문제 상황 - 왜 데이터베이스에 반영이 안되지 22..?&lt;/h3&gt;
&lt;p&gt;프로젝트 중, 한 메서드에서 도메인의 카운트를 감소하고 다른 도메인에서 논리적 삭제를 해주는 코드를 작성해야 했었습니다. 역시 다음과 같이 테스트 코드를 작성하기 비즈니스 로직을 완성하였습니다. (예시를 위해 코드를 간단하게 변경하였습니다)&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/7eeb7fad8b486d919cae200eefce6da7/d98b8/img_5.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 60.58823529411765%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAACB0lEQVQoz2VS2XLbMAzUr7Qzaa2DEg8dpChRcmLHTtK6nmTS//+T7ZJ2kknzsAKIERZYAJmROSYr4AeJvm8h6gZVWUFUglZc/LpGTVRCQBCVqFCWJYqi+IQYy/I8x9BbLPOKMG3h3MT3iGlcYGn7zsL5GX5eMDhPOGitoJSEkCzQXApWVZVIs7zI0ZqehDt4FxKmsMW83mKwFrptYboe3WDR0kY0VKFI2hh2rgQa2VDRlbC4Eq7THbwlGTv1c4BpO0gpWVl8SL36sZuEKL0qL7iOIIsfWSt0akCvbepGKYVik7/PJSaXVZQWib7O7ssMoxw3zZzVBDt6zs1xhitc76GVQdsPlNjCuh5Gy/fk//HeoZEtgtvC9wHOThhJPrgRHYmi9Lj5fLNBLP6GmHex+acCqcOmlqzcwaguketGQ5Rx2JLQMEZxGYY+t6s1pNKom4YzVslPC7kWyWJQmyiLm4xbJLFWLX/WUIxrwyLcdNt1fLepYx0XRiLNd4wJNlTG06GS7PT8ivPLXxyffmP/8IiH0x8c6IfbHSaejuUNDle4KXyAd3mxAfu7gDue2hpWZOeXV/w6P2O7PyTsjo/YH58Sov8Wj/AsMDJpZHKyy5bxe56bwcJlbsOCrLs9wOxOKOYDNv4eP/0eN26X8IOI74Rxj+/9im/dQlxsfIvliEJI3u+MsCz4B0qAglCtRAMZAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 5&apos; title=&apos;img 5&apos; src=&apos;/static/7eeb7fad8b486d919cae200eefce6da7/ca1dc/img_5.png&apos; srcset=&apos;/static/7eeb7fad8b486d919cae200eefce6da7/e7570/img_5.png 170w,
/static/7eeb7fad8b486d919cae200eefce6da7/f46e7/img_5.png 340w,
/static/7eeb7fad8b486d919cae200eefce6da7/ca1dc/img_5.png 680w,
/static/7eeb7fad8b486d919cae200eefce6da7/02d09/img_5.png 1020w,
/static/7eeb7fad8b486d919cae200eefce6da7/9d567/img_5.png 1360w,
/static/7eeb7fad8b486d919cae200eefce6da7/d98b8/img_5.png 1588w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;JPQL&lt;/code&gt; 쿼리가 실행되기 때문에, 당연히 &lt;code class=&quot;language-text&quot;&gt;Flush&lt;/code&gt;가 발생할 것이라 생각했지만, 로그를 확인해보니 예상과 다르게 &lt;code class=&quot;language-text&quot;&gt;Flush&lt;/code&gt;가 동작하지 않는 것을 확인할 수 있었습니다.&lt;/p&gt;
&lt;h3&gt;JPQL은 해당 쿼리와 관련이 있는 엔티티만 플러시를 한다&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Flush&lt;/code&gt; 호출 상황에 대한 블로그 검색을 해보면 대부분 &lt;code class=&quot;language-text&quot;&gt;JPQL&lt;/code&gt; 쿼리가 실행될 때 &lt;code class=&quot;language-text&quot;&gt;Flush&lt;/code&gt;가 호출되어 있다고 작성되어 있습니다. 하지만 &lt;code class=&quot;language-text&quot;&gt;Hibernate Docs&lt;/code&gt;를 살펴보면 다음과 같이 작성되어 있습니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/b0c4559bca6319ad1d6b1e3873551a89/d98b8/img_6.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 17.058823529411764%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAkElEQVQI10VPiw6DIBDz//9wG6LZnCgPJ5rIdISOOzJHaGgvvaZUYfFwg4K3BqZ/Mn9pjbHrMh8QwwYcO9L+PvHT5zx+QCelhGrrH7CNwHxvYeQNrqmhxRWjuMC1NWt6rRSYWpm9hdOOy9rlnbjM/8CwrrCqz61GbkeYcjNCaVvms9HsY48qPvpR8J6S6HLgF90y4t/GXvimAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 6&apos; title=&apos;img 6&apos; src=&apos;/static/b0c4559bca6319ad1d6b1e3873551a89/ca1dc/img_6.png&apos; srcset=&apos;/static/b0c4559bca6319ad1d6b1e3873551a89/e7570/img_6.png 170w,
/static/b0c4559bca6319ad1d6b1e3873551a89/f46e7/img_6.png 340w,
/static/b0c4559bca6319ad1d6b1e3873551a89/ca1dc/img_6.png 680w,
/static/b0c4559bca6319ad1d6b1e3873551a89/02d09/img_6.png 1020w,
/static/b0c4559bca6319ad1d6b1e3873551a89/9d567/img_6.png 1360w,
/static/b0c4559bca6319ad1d6b1e3873551a89/d98b8/img_6.png 1588w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;현재 위의 코드에서는 영속성 컨텍스트에서 &lt;code class=&quot;language-text&quot;&gt;Member - StudyLog&lt;/code&gt;간의 &lt;code class=&quot;language-text&quot;&gt;Entity Actions&lt;/code&gt;가 존재하지 않습니다. 즉, 위에서 말한 &lt;code class=&quot;language-text&quot;&gt;Flush&lt;/code&gt;가 호출되는 상황에서  &lt;code class=&quot;language-text&quot;&gt;JPQL&lt;/code&gt; &lt;strong&gt;쿼리가 실행될 때 Flush가 호출된다&lt;/strong&gt; 라는 말은 엄밀히 말하면 잘못된 말이라고 할 수 있습니다.&lt;/p&gt;
&lt;h3&gt;해결 방법&lt;/h3&gt;
&lt;p&gt;해결 방법은 간단합니다. 다음과 같이 영속성 컨텍스트에 &lt;code class=&quot;language-text&quot;&gt;Flush&lt;/code&gt; 처리를 해주면 됩니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/9cc9f9a25d2aef43dd3bbc6c944108db/d98b8/img_7.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 62.35294117647059%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAAB7UlEQVQoz3WTaZKbMBSEOc3EYEloQexis7ENnkkySe5/lc6T8BJPVX58pb3VrwWRkTu4ShAaZWEhUgm2ZxBMBDiR0pxHiJQQYJxhv98jSZIX/FwU72IUeY3BTejdAU3do64cOhrXZUtrFeq2Q9uPKOuWaKCNgtIKQnEISaT+YhZEoziJkZkcQzejqfog6OiwGw8oypIOZzCZhc3L0HpScikVuTYiiKYyfQomJGiURVeTo9wFN1XT0CYJzvlWGrGVuLUP2Ov4JphASY2MRK0pyEFOYwVGh32WIU/KjpOr4IQu+Zrda4ZxDFuUaLthc1c7lGVzy9DB6AyZzalEQxFYaJUivh3+yrNkmaErRjTWoSKRumlhSMTn5TPkXCCOd/CXe/7n7lGyFAqFqZCbEtZS2dpgT/OMcfpE6BUFBe9fkvpefGu3NT9mjD1cBkGfj9QakrJUXEESKZf0aRjCl2yQ51ko++7aP5o2JuzxL3x3Hs2XFefrB47nBdPpjAO1/WFGQWXnVQNb1k+qf2kefb/3TvT5+w++//zE0YvNM5b1ivX9A+dlwelywTBND/pxfDKMGMYJHfWH+Uh7V0zHE6J6+YHu+gtmWqEJNa5I+wvk4Fmgx/v8grga8Vb0+FYMeMt7sHaG6Y7hB+i7Ds45/AWd2YIqx8+gIAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 7&apos; title=&apos;img 7&apos; src=&apos;/static/9cc9f9a25d2aef43dd3bbc6c944108db/ca1dc/img_7.png&apos; srcset=&apos;/static/9cc9f9a25d2aef43dd3bbc6c944108db/e7570/img_7.png 170w,
/static/9cc9f9a25d2aef43dd3bbc6c944108db/f46e7/img_7.png 340w,
/static/9cc9f9a25d2aef43dd3bbc6c944108db/ca1dc/img_7.png 680w,
/static/9cc9f9a25d2aef43dd3bbc6c944108db/02d09/img_7.png 1020w,
/static/9cc9f9a25d2aef43dd3bbc6c944108db/9d567/img_7.png 1360w,
/static/9cc9f9a25d2aef43dd3bbc6c944108db/d98b8/img_7.png 1588w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;하지만 과연 프로덕션 코드에서 이렇게 &lt;code class=&quot;language-text&quot;&gt;Flush&lt;/code&gt;를 직접 호출하는 것이 올바른 방법인지에 대해서는 아직 의문점을 가지고 있는 상태입니다. 더 좋은 방법이 있다면 그 방법을 통해서 문제를 해결할 것 같습니다.&lt;/p&gt;
&lt;p&gt;해당 문제를 해결하면서 들었던 생각은, 가끔 간접참조를 통해서 각 &lt;code class=&quot;language-text&quot;&gt;Entity&lt;/code&gt;들을 설계하는 경우가 많은데 해당 경우에 &lt;strong&gt;영속성 컨텍스트의 상태가 어떻게 관리가 될 것&lt;/strong&gt;인지 항상 고려하고 사용해야 할 것 같습니다.&lt;/p&gt;
&lt;h2&gt;N + 1&lt;/h2&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;N + 1&lt;/code&gt; 은 &lt;strong&gt;조회 시 1개의 쿼리를 생각하고 설계를 하였으나 생각하지 못한 조회의 쿼리가 N개가 추가적으로 발생하는 문제&lt;/strong&gt;를 말합니다. JPA의 경우 객체에 대해서 조회를 하게 되면서, 다양한 연관관계들의 매핑에 의해 관계가 맺어진 다른 객체가 함께 조회되는 경우 &lt;code class=&quot;language-text&quot;&gt;N + 1&lt;/code&gt; 이 발생하게 됩니다.&lt;/p&gt;
&lt;h3&gt;문제상황 - 즉시 로딩에서의 N + 1 문제점&lt;/h3&gt;
&lt;p&gt;1 : N 관계를 가지고 있는 엔티티 관계가 있다고 가정하겠습니다. 1에 해당하는 엔티티에 대해서 전체 조회를 위해 Spring Data JPA의 &lt;code class=&quot;language-text&quot;&gt;findAll()&lt;/code&gt; 메서드를 이용해서 조회를 하게 되면 N + 1 문제가 발생하게 됩니다.&lt;/p&gt;
&lt;h3&gt;작성된 JPQL은 결과를 반환할 때 연관관계까지 고려하지 않는다&lt;/h3&gt;
&lt;p&gt;위처럼 &lt;code class=&quot;language-text&quot;&gt;findAll()&lt;/code&gt; 쿼리 메서드를 호출할 경우 &lt;code class=&quot;language-text&quot;&gt;select x from Table x&lt;/code&gt; 라는 &lt;code class=&quot;language-text&quot;&gt;JPQL&lt;/code&gt;로 번역이 되게 됩니다. &lt;code class=&quot;language-text&quot;&gt;JPQL&lt;/code&gt;은 결과를 반환할 때 해당 엔티티의 연관관계를 고려하지 않습니다. 즉, SELECT 절에 지정된 엔티티만 조회를 하게 됩니다.&lt;/p&gt;
&lt;p&gt;이렇게 엔티티 조회를 한 후, JPA는 조회한 엔티티의 내부 연관관계를 확인합니다. 현재 연관관계가 즉시로딩으로 설정되어 있기 때문에 연관된 엔티티를 검색하면서 N번의 쿼리가 발생하게 됩니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/a66ba9e4dd66150dcba185d741faf118/919e0/img_8.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 55.294117647058826%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABRElEQVQoz4WS646CUAyEeR6VyxFQOQiC4F14/7fp5qspYdmY/TFpD2mHmbZBHMdyPB6lrmu5Xq/yer3Eey+bzUaiKFKEYShJkohzTuNXuEQCiiBdr9dyPp+VEOL3+y3P53PK8zz/nxRCkt1up6qappGqqjQnohxUdSXb7VbJvuNDGqCuKApVczgcZLVaTTaxbZFv1Fqkefl2ZjlJYm26XC5qmXm2bas/eTwecr/fZRzH6c0YqOn7Xsdxu90kTdOPwvlc9vu9qqSYIiJgtvyg7zuN1GRZpqPCHX3GEdhAbTnkXdcpoS+9nE4nJTFFzNn7QmvnmCzPCe1MaByGQRfCGMghBVjkjWoUWu+0FFZt6sqy1EJs5Hmmp0ITIDebBpvbdEpuNkMjRBHNZsMw3+xvm25xh+6vZbaKLW6RCFgEJMv7MyLDD79DaNNJE1UAAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 8&apos; title=&apos;img 8&apos; src=&apos;/static/a66ba9e4dd66150dcba185d741faf118/ca1dc/img_8.png&apos; srcset=&apos;/static/a66ba9e4dd66150dcba185d741faf118/e7570/img_8.png 170w,
/static/a66ba9e4dd66150dcba185d741faf118/f46e7/img_8.png 340w,
/static/a66ba9e4dd66150dcba185d741faf118/ca1dc/img_8.png 680w,
/static/a66ba9e4dd66150dcba185d741faf118/02d09/img_8.png 1020w,
/static/a66ba9e4dd66150dcba185d741faf118/919e0/img_8.png 1308w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/3807eec63f476b6de655dd3edf4a948b/cda85/img_9.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 152.35294117647058%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAeCAYAAAAsEj5rAAAACXBIWXMAAAsTAAALEwEAmpwYAAACz0lEQVRIx5WV6ZKqQAyFfR83FHHFBQQVtGqmLN//Vfr6pedw2ca690eTXtInyUk6DJ7Pp7vf7+56vbqiKFwURS4IAjebzf57cG/AZ7lcusvl4vI8d+v12o3HYzedTm1wrnl7BMG0oQeoAS4WC3c4HFySJCZXq5XbbDZmiDOM4DlrBucM9jiTHsADuToajewQL2+3m4Wfpqk7nU5GB8a0RifLMnc+n11ZlnbOfD6few8BBX273ZoiF1A6Ho8ujmNT3u/3JgFFYrwebiPkNiB84iWAUMAegPIKUAB9MoJuUgQIb1l2NkA8JLw43hmI99R7R/hwyF3CFFgHEA8FBocA4mV5L620FDbj8XjYHpFAEXodDgmDcMSj9zC2S0gAoQCjSZpUBslyuAj7k4KyvER5t9sZOEAYE5eEzTmghF9xKEIpGzhUQigHANK3J6yRfp36sskz20OPO4AbIJ7hMpfwAuB6KTRfRt+TDLplQ+yESzjwyFwvgTme6+UAXM+qyib4Aa5eynA4tEtwp2ZBGJbxsrA9whVgBTrzoBWgsvv9/WXcTCYTAyd05jQK5pIKTR62RxUyIZJRvQ4kHmOMNZK9envrBVSl441/KX+fHqWhZoCkoOHxN8AZgK/Xy6qelwEIBggPA8qu5kh6oMB6GywTwoV8PNtuN41MNhLQMzoNlgW8EBIhwiNrGmYULczjMAzf69D2tJZEV/o9ZbOuXgk0qFWpZNS+0CEiuEWPNWeNt4wkKVxQYuoNVtKMvNsYun2v6J86thpsBfjTYLuJCT4Dqn19AmwnpqdjNwEBYq6eiNcM8SguKf6PPyn9UwAsilsFRCXAr/6A+u1S8L1JqXfs4/FgZQSAPcuTN8AZejJA2fiib5UNvOifrFLBC99gvSHk5ZIbKGDoYRBP7UcPGBbqXZeCrQ9CqRe1BnuSjKps2MQCHGKFdb0Ls0YC+NsT1PgD117nBnUCKLsAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 9&apos; title=&apos;img 9&apos; src=&apos;/static/3807eec63f476b6de655dd3edf4a948b/ca1dc/img_9.png&apos; srcset=&apos;/static/3807eec63f476b6de655dd3edf4a948b/e7570/img_9.png 170w,
/static/3807eec63f476b6de655dd3edf4a948b/f46e7/img_9.png 340w,
/static/3807eec63f476b6de655dd3edf4a948b/ca1dc/img_9.png 680w,
/static/3807eec63f476b6de655dd3edf4a948b/cda85/img_9.png 928w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3&gt;문제상황 - 지연 로딩에서의 N + 1 문제점&lt;/h3&gt;
&lt;p&gt;역시 동일하게 1 : N 관계를 가지고 있는 엔티티 관계가 있다고 가정하겠습니다. 지연 로딩으로 설정하였기 때문에 연관된 객체를 사용하는 시점에 조회를 하게 됩니다. 이 때문에 N + 1이 발생하지 않는다고 생각할 수 있지만, 상황에 따라서 N + 1 문제가 발생하게 됩니다.&lt;/p&gt;
&lt;h3&gt;지연 로딩은 연관된 객체를 프록시로 가진다.&lt;/h3&gt;
&lt;p&gt;지연 로딩을 사용한 상태에서 &lt;code class=&quot;language-text&quot;&gt;findAll()&lt;/code&gt; 쿼리 메서드를 호출할 경우 역시 동일하게 &lt;code class=&quot;language-text&quot;&gt;select x from Table x&lt;/code&gt; 라는 &lt;code class=&quot;language-text&quot;&gt;JPQL&lt;/code&gt;로 번역이 되게 됩니다. 이 때 SELECT 절에 지정된 엔티티만 조회하여 정보를 가져오게 되고, 연관관계가 맺어진 엔티티는 프록시로 가져오게 됩니다. 이 때문에 처음에는 N + 1 이 발생하지 않지만, 추후에 연관관계가 맺어진 엔티티를 조회한다면 프록시가 아닌 실제 엔티티를 가져오기 위해 조회쿼리가 발생해 N + 1 이 발생하게 됩니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/a66ba9e4dd66150dcba185d741faf118/919e0/img_10.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 55.294117647058826%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABRElEQVQoz4WS646CUAyEeR6VyxFQOQiC4F14/7fp5qspYdmY/TFpD2mHmbZBHMdyPB6lrmu5Xq/yer3Eey+bzUaiKFKEYShJkohzTuNXuEQCiiBdr9dyPp+VEOL3+y3P53PK8zz/nxRCkt1up6qappGqqjQnohxUdSXb7VbJvuNDGqCuKApVczgcZLVaTTaxbZFv1Fqkefl2ZjlJYm26XC5qmXm2bas/eTwecr/fZRzH6c0YqOn7Xsdxu90kTdOPwvlc9vu9qqSYIiJgtvyg7zuN1GRZpqPCHX3GEdhAbTnkXdcpoS+9nE4nJTFFzNn7QmvnmCzPCe1MaByGQRfCGMghBVjkjWoUWu+0FFZt6sqy1EJs5Hmmp0ITIDebBpvbdEpuNkMjRBHNZsMw3+xvm25xh+6vZbaKLW6RCFgEJMv7MyLDD79DaNNJE1UAAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 10&apos; title=&apos;img 10&apos; src=&apos;/static/a66ba9e4dd66150dcba185d741faf118/ca1dc/img_10.png&apos; srcset=&apos;/static/a66ba9e4dd66150dcba185d741faf118/e7570/img_10.png 170w,
/static/a66ba9e4dd66150dcba185d741faf118/f46e7/img_10.png 340w,
/static/a66ba9e4dd66150dcba185d741faf118/ca1dc/img_10.png 680w,
/static/a66ba9e4dd66150dcba185d741faf118/02d09/img_10.png 1020w,
/static/a66ba9e4dd66150dcba185d741faf118/919e0/img_10.png 1308w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/3807eec63f476b6de655dd3edf4a948b/cda85/img_11.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 152.35294117647058%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAeCAYAAAAsEj5rAAAACXBIWXMAAAsTAAALEwEAmpwYAAACz0lEQVRIx5WV6ZKqQAyFfR83FHHFBQQVtGqmLN//Vfr6pedw2ca690eTXtInyUk6DJ7Pp7vf7+56vbqiKFwURS4IAjebzf57cG/AZ7lcusvl4vI8d+v12o3HYzedTm1wrnl7BMG0oQeoAS4WC3c4HFySJCZXq5XbbDZmiDOM4DlrBucM9jiTHsADuToajewQL2+3m4Wfpqk7nU5GB8a0RifLMnc+n11ZlnbOfD6few8BBX273ZoiF1A6Ho8ujmNT3u/3JgFFYrwebiPkNiB84iWAUMAegPIKUAB9MoJuUgQIb1l2NkA8JLw43hmI99R7R/hwyF3CFFgHEA8FBocA4mV5L620FDbj8XjYHpFAEXodDgmDcMSj9zC2S0gAoQCjSZpUBslyuAj7k4KyvER5t9sZOEAYE5eEzTmghF9xKEIpGzhUQigHANK3J6yRfp36sskz20OPO4AbIJ7hMpfwAuB6KTRfRt+TDLplQ+yESzjwyFwvgTme6+UAXM+qyib4Aa5eynA4tEtwp2ZBGJbxsrA9whVgBTrzoBWgsvv9/WXcTCYTAyd05jQK5pIKTR62RxUyIZJRvQ4kHmOMNZK9envrBVSl441/KX+fHqWhZoCkoOHxN8AZgK/Xy6qelwEIBggPA8qu5kh6oMB6GywTwoV8PNtuN41MNhLQMzoNlgW8EBIhwiNrGmYULczjMAzf69D2tJZEV/o9ZbOuXgk0qFWpZNS+0CEiuEWPNWeNt4wkKVxQYuoNVtKMvNsYun2v6J86thpsBfjTYLuJCT4Dqn19AmwnpqdjNwEBYq6eiNcM8SguKf6PPyn9UwAsilsFRCXAr/6A+u1S8L1JqXfs4/FgZQSAPcuTN8AZejJA2fiib5UNvOifrFLBC99gvSHk5ZIbKGDoYRBP7UcPGBbqXZeCrQ9CqRe1BnuSjKps2MQCHGKFdb0Ls0YC+NsT1PgD117nBnUCKLsAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 11&apos; title=&apos;img 11&apos; src=&apos;/static/3807eec63f476b6de655dd3edf4a948b/ca1dc/img_11.png&apos; srcset=&apos;/static/3807eec63f476b6de655dd3edf4a948b/e7570/img_11.png 170w,
/static/3807eec63f476b6de655dd3edf4a948b/f46e7/img_11.png 340w,
/static/3807eec63f476b6de655dd3edf4a948b/ca1dc/img_11.png 680w,
/static/3807eec63f476b6de655dd3edf4a948b/cda85/img_11.png 928w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3&gt;해결 방법&lt;/h3&gt;
&lt;p&gt;N + 1 문제를 해결하기 위해서는 &lt;code class=&quot;language-text&quot;&gt;FetchJoin&lt;/code&gt;, &lt;code class=&quot;language-text&quot;&gt;BatchSize&lt;/code&gt;, &lt;code class=&quot;language-text&quot;&gt;EntityGraph&lt;/code&gt;총 3가지 방법을 통해서 문제를 해결할 수 있습니다.&lt;/p&gt;
&lt;p&gt;저는 &lt;code class=&quot;language-text&quot;&gt;FetchJoin&lt;/code&gt;과 &lt;code class=&quot;language-text&quot;&gt;BatchSize&lt;/code&gt;를 각 상황에 맞게 적절하게 섞어서 사용하기로 하였습니다. &lt;code class=&quot;language-text&quot;&gt;EntityGraph&lt;/code&gt;를 고려하지 않은 이유는 &lt;code class=&quot;language-text&quot;&gt;Join&lt;/code&gt; 방식이 &lt;code class=&quot;language-text&quot;&gt;Left Outer Join&lt;/code&gt;으로 강제된다는 점 때문에 좀 더 상황에 맞게 대처가 가능한 나머지 방법들을 사용하여서 문제를 해결하였습니다.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;FetchJoin을 통한 해결방법&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;FetchJoin은 SQL에서 사용하는 조인의 종류가 아니고 JPQL에서 성능 최적화를 위해 제공하는 기능입니다. FetchJoin을 통해 연관된 엔티티나 컬렉션을 한 번에 같이 조회를 할 수 있습니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token annotation punctuation&quot;&gt;@Query&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;select distinct u from User u left join fetch u.articles&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token class-name&quot;&gt;List&lt;/span&gt;&lt;span class=&quot;token generics&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;User&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;findFetchAll&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/84b4d9a808e0c1e17d02beb2c9695c3b/d5719/img_12.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 121.76470588235296%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAYAAAD6S912AAAACXBIWXMAAAsTAAALEwEAmpwYAAACIElEQVQ4y5WVWZKjMBAFOZAXhPcVDHgL2hG+/2XUk2KeXPLgjp6PCkCgrFeLiqyua999df56vfrz+ezzPA/mnAvW3+dxPXd/LR++ZtzM53MPuGka37atn81mfjweR3CE/cKy16apr6rKd13nT6eT3+12Afy/0AAsiiIA9vt9tO12G9Yj0OWp/RQyGwkZ6HQ6DTaZTFJ17pc5VPJHo1GA3m43v9lsYlE+2Y8hk6v7/R7CpCgUCYUyq9oqH4LHohSF88fj0T8ejwA+HA6x8tzLGQVDgBy9pyWjxzBeooyCsKnfXAUgJiCdgAO+6zshLVxmGxmvQC+XSzDAZVmGpkc9ilnDAALme6syAarJy/IYmxxlwDDg72G/n6pMJbdACsRGAOSUMFH3fD7DfdPUfr1exxzaXA4qRIFVCIxzDkxqecb4lmcdggSIp+VyGQDkkJ4kT9qMYgCsC0bPLhaLYaAdFG3bK6SSbESdKqzicOUZ4GDIKOSlQkYlQKkD0OewCVccqpU0SDLNOykEWDd1DBOgCiSgrqxLLfv+UUgb4Enq6D+BFCJOAK1Wq6S6rxy6V7jkA5D6io9Y5zTgyBrv3s9yr9CEy0f0F2AUUEFaAoDUWOuBprFdMrH7CpMzGluhMcFZB2g32/+N/edktsIaDCgkj8C5DoX5aUYmR0/DAXXkUi1BcWhm4Dpq1tIcmt+kPEmtnTTVn1EmJ6zhSMOC6mvqfAMW5RQKeO2L0AAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 12&apos; title=&apos;img 12&apos; src=&apos;/static/84b4d9a808e0c1e17d02beb2c9695c3b/ca1dc/img_12.png&apos; srcset=&apos;/static/84b4d9a808e0c1e17d02beb2c9695c3b/e7570/img_12.png 170w,
/static/84b4d9a808e0c1e17d02beb2c9695c3b/f46e7/img_12.png 340w,
/static/84b4d9a808e0c1e17d02beb2c9695c3b/ca1dc/img_12.png 680w,
/static/84b4d9a808e0c1e17d02beb2c9695c3b/d5719/img_12.png 758w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;BatchSize를 통한 해결방법&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;하이버네이트가 제공하는 &lt;code class=&quot;language-text&quot;&gt;org.hibernate.annotations.BatchSize&lt;/code&gt; 어노테이션을 이용하면 연관된 엔티티를 조회할 때 지정된 사이즈 만큼 SQL의 IN절을 사용해서 조회합니다. 즉, 연관관계가 있는 엔티티를 조회하면 IN 절을 통해 한번에 조회하게 되어 총 1 + 1의 쿼리가 발생하게 됩니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/5ff4a14c5aa5c56f2dfcff75585ac572/00a68/img_13.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 104.11764705882354%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAAAsTAAALEwEAmpwYAAABy0lEQVQ4y6WU2ZKCQAxF/SAVGhQUcANXyv//nYwnTKQbsSxnHlLdLH3IvUmYnE4nOZ/PwpplmURRJM45jTiOH2us6zPGrl2/nyRJIlVVSV3X0jSNrFYrmc1mvzAXHv4UANmQVZ5ncr/f5XK5yH6/l8Vi8T3UgEVRPCHL5VIjSdzfgWmaKhTpllkAc288G/OQDZCyLLU4gLHgXx5SCLJDNkG1KZZBu/gCyAEgVPp4PGpYC/kHPsIBcojsDoeDAjebjYLIEG8tfPl+n754yIP5fK4vIJe2IQyOr3VTK5RDZsWox75kgpfJlKnZbrcagCnUbrfTa55x3U+SGweyTqdTnRayAny73TRrIG3b6p5M+fDoaJpkax1A6/X6mS33AFAgv/K95MF8d8DeDw4jjSIhj4yAUCS/N9/2p58hMCAAkc2KVCta2DZhvAXaTFtRKEhZFjpFPAds2Q6zHi0Kvy08JDvry+bRMtfrVT+Q57lOFT8PPOUP5U9UkCEPOMA1/UemVBmAfQAr+AgeM03cB97bMagyL3GQxjYvuW9tgmRUIJW18zYczxfJ5iFwmxzaiTAF1lbD4H7QNh040uJYYyMfOD4CZSV7U8PeFFG4H8eJqGdNwu5FAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 13&apos; title=&apos;img 13&apos; src=&apos;/static/5ff4a14c5aa5c56f2dfcff75585ac572/ca1dc/img_13.png&apos; srcset=&apos;/static/5ff4a14c5aa5c56f2dfcff75585ac572/e7570/img_13.png 170w,
/static/5ff4a14c5aa5c56f2dfcff75585ac572/f46e7/img_13.png 340w,
/static/5ff4a14c5aa5c56f2dfcff75585ac572/ca1dc/img_13.png 680w,
/static/5ff4a14c5aa5c56f2dfcff75585ac572/02d09/img_13.png 1020w,
/static/5ff4a14c5aa5c56f2dfcff75585ac572/9d567/img_13.png 1360w,
/static/5ff4a14c5aa5c56f2dfcff75585ac572/00a68/img_13.png 1458w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/a92e11247c963d557182fb48ffecd3b2/6e693/img_14.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 61.76470588235294%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAABI0lEQVQoz5WTV3LDMAwFdSGJ6r33+18ImcUYcuKSOB8YUCCxfHykvKqqZF1XjaIoJE1TyfNcsizToMa31cuyvGqWWUc9SRLxnHM66PteocuyyDzPmqdpkm3bZN/3K8ZxlK7rpGkazW3bKmwYBoV7URSJc4HutiyzNrGQRoAspLmua20Mw1AQ8SqYuwGdcHTUHMehagGiGLUcyfd9CYJAm+h5FxeQ3QGc56lAlAIzMLW+7ySO4wtKfownIAo5JmMyXmIFGVsM9BZok2YsqjAaRXhpxzc//1SIOm6HRrIFavDue7P59Ar0QyGN7I4ybtOeBGMu4m56+CvsAqIIoMFQx61jA3N3hR8A7VLwBoV4hTp7vKj/N5ABf4sdDbjV7cF+AiO+AAtMh1i2UfzGAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 14&apos; title=&apos;img 14&apos; src=&apos;/static/a92e11247c963d557182fb48ffecd3b2/ca1dc/img_14.png&apos; srcset=&apos;/static/a92e11247c963d557182fb48ffecd3b2/e7570/img_14.png 170w,
/static/a92e11247c963d557182fb48ffecd3b2/f46e7/img_14.png 340w,
/static/a92e11247c963d557182fb48ffecd3b2/ca1dc/img_14.png 680w,
/static/a92e11247c963d557182fb48ffecd3b2/02d09/img_14.png 1020w,
/static/a92e11247c963d557182fb48ffecd3b2/9d567/img_14.png 1360w,
/static/a92e11247c963d557182fb48ffecd3b2/6e693/img_14.png 1660w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3&gt;추가적인 문제 상황 - 일대다 관계에서의 페이지네이션&lt;/h3&gt;
&lt;p&gt;1 : N 관계에서의 N + 1 문제 해결과 동시에 페이지네이션까지 고려해야 한다면 &lt;code class=&quot;language-text&quot;&gt;FetchJoin&lt;/code&gt;이 불가능합니다.&lt;/p&gt;
&lt;p&gt;RDMS 관점에서 보면 일대다 관계는 &lt;code class=&quot;language-text&quot;&gt;Collection Join&lt;/code&gt;이 되기 때문에 드라이빙 테이블을 기준으로 드리븐 테이블의 값들이 중복되게 됩니다. 이렇게 조회 값들이 중복된 상태에서  &lt;code class=&quot;language-text&quot;&gt;Collection Fetch&lt;/code&gt;를 해서 &lt;code class=&quot;language-text&quot;&gt;Paging&lt;/code&gt;을 하긴했지만 &lt;code class=&quot;language-text&quot;&gt;applying in memory&lt;/code&gt; 즉, 인메모리를 사용해서 조인을 하는 방법을 사용하기 때문입니다. &lt;strong&gt;이 방법은 &lt;code class=&quot;language-text&quot;&gt;OOM&lt;/code&gt;이 발생할 확률이 매우 높아서 사용을 하면 안됩니다&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;그렇기 때문에 페이징을 적용해야 하는 경우 &lt;code class=&quot;language-text&quot;&gt;BatchSize&lt;/code&gt;로 해결하는 방법이 사실상 가장 좋은 해결책입니다.&lt;/p&gt;
&lt;h2&gt;마무리&lt;/h2&gt;
&lt;p&gt;지금까지 제가 &lt;code class=&quot;language-text&quot;&gt;JPA&lt;/code&gt;를 사용하면서 경험했던 트러블 내용들을 한번 정리해보았습니다. &lt;code class=&quot;language-text&quot;&gt;JPA&lt;/code&gt;는 정말 편리하게 개발을 도와주어 개발 능률을 올려주는 도구이기도 하지만 잘못된 사용시 원인 파악이 힘들어 오히려 능률을 떨어트리는 양날의 검같은 도구인 것 같다는 생각이 사용하면 할수록 드는 것 같습니다. 앞으로도 &lt;code class=&quot;language-text&quot;&gt;JPA&lt;/code&gt;를 항상 조심해서 사용해야겠다는 생각을 하면서 글을 마치겠습니다.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;참고한 곳&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://docs.jboss.org/hibernate/orm/5.4/userguide/html_single/Hibernate_User_Guide.html&quot;&gt;https://docs.jboss.org/hibernate/orm/5.4/userguide/html&lt;em&gt;single/Hibernate&lt;/em&gt;User_Guide.htm&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[Nginx와 Gzip을 활용한 프론트 최적화]]></title><description><![CDATA[문제 상황…]]></description><link>https://wishoon.github.io/Nginx와-Gzip을-활용한-프론트-최적화/</link><guid isPermaLink="false">https://wishoon.github.io/Nginx와-Gzip을-활용한-프론트-최적화/</guid><pubDate>Sun, 16 Oct 2022 00:00:00 GMT</pubDate><content:encoded>&lt;h2&gt;문제 상황&lt;/h2&gt;
&lt;p&gt;5차 데모를 앞두고 프론트 팀의 요구사항으로 다음과 같은 요구사항을 확인할 수 있었습니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/91e2ab4163d16b0d5a9a6a3fe29f7d9e/84e61/img.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 13.529411764705882%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAlklEQVQI102MgQ6DIAxE/f9PHHNuESwMwWGMRgRuwIxZk5feNddrGLthXVekFJHCUYnBn/tHCOHiOPItxssX/T8NEUFwDnobPJVDO1gwYdDSB7126ISClBJDztFJ8UKIqnn+XZYF8zzDOYdGaw0zjpDa4kEWnZzAuMY9l77UhF6OmKytJSVbSuqPMVBKYd93eO+xbVvlCzqr5FbbwFEPAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img&apos; title=&apos;img&apos; src=&apos;/static/91e2ab4163d16b0d5a9a6a3fe29f7d9e/ca1dc/img.png&apos; srcset=&apos;/static/91e2ab4163d16b0d5a9a6a3fe29f7d9e/e7570/img.png 170w,
/static/91e2ab4163d16b0d5a9a6a3fe29f7d9e/f46e7/img.png 340w,
/static/91e2ab4163d16b0d5a9a6a3fe29f7d9e/ca1dc/img.png 680w,
/static/91e2ab4163d16b0d5a9a6a3fe29f7d9e/02d09/img.png 1020w,
/static/91e2ab4163d16b0d5a9a6a3fe29f7d9e/9d567/img.png 1360w,
/static/91e2ab4163d16b0d5a9a6a3fe29f7d9e/84e61/img.png 1566w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;프론트 팀에서는 최적화 대상 중에 하나로 &lt;code class=&quot;language-text&quot;&gt;bundle.js&lt;/code&gt; 에 압축을 하기로 하였고, 이를 위해서 &lt;code class=&quot;language-text&quot;&gt;gzip&lt;/code&gt;으로 압축을 하기로 결정을 하였습니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/e8b03ab7b5d81fb08fd5b2e74b1b48e4/64756/img_1.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 75.29411764705883%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAACc0lEQVQ4y6VTy27TQBTNz7DiQ1jyAfxLF2xASNAPABYpWaSFQsWChqYsiNQozwZImqCYOs8Wx4md+DF+1j7MndSRA4INIx3d55y5985MBnzFcYz/Wen9mbURI4pi+DeRCHphJOyA2zdcEsIoEojitU2SbNL5JrGPkEm4NSfA2+4MR70ZXjSvUBrqOGgrwvd5oKMgzYX+5kLBibTAIZcHHQW1qYF0f5kwDEEIggC268NwPFhcMm+NheXC5D6KrZgnbPIbbJ3n+gESDkLGtm0QGIfFoa0MAZ1jsTJhWTZcxuBwMGZDNyxohgnDsrhuihzS2S1PhvFE215vmPNgb2ahNlmhPFqhNpxjoC7hOkTGsDQtVGQV38YaTnsKGsMFqgMVim6KnBShjUR+PW/g6LiI/IdP8F0Gz3ORdEGHmrYFeTnHyeUYP5c6QtcVlSccG0Lf9zGdTpHf38fHwjGePH6EZ7u7wm/fjsNzHPS1GQ6lL8h2ynhaPxV+ZrPNoVuEk8kEhUIB2b09yLKMbDYrDqGYxSsjQllX8fqijt1KEa86FRjc77C/EI7HYxSLRezs7MA0TZTLZYxGIxGjwcMPkZNauHv6Eg8qR7hTfI7S5Adiftvm74Se50FRFORyOVFZtVpFPp8XPooJQi/AwbCD+833eChVcK/+DmVluCHcmqHD29F1HbVaDfV6HWdnZyiVStA0TcSSlq6vr9G7lNAdyWh/7+KKjyR9qVuEqqqi2+2i3W6j3++jWqmKlqnChFCSJJw3z3HR7qDZaKDVavG3am0TpklpXgQioZfvuu6mAgL56VdRTnD7w9JP7493SKelkY4l+FfOL1A/X2JQMbmEAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 1&apos; title=&apos;img 1&apos; src=&apos;/static/e8b03ab7b5d81fb08fd5b2e74b1b48e4/ca1dc/img_1.png&apos; srcset=&apos;/static/e8b03ab7b5d81fb08fd5b2e74b1b48e4/e7570/img_1.png 170w,
/static/e8b03ab7b5d81fb08fd5b2e74b1b48e4/f46e7/img_1.png 340w,
/static/e8b03ab7b5d81fb08fd5b2e74b1b48e4/ca1dc/img_1.png 680w,
/static/e8b03ab7b5d81fb08fd5b2e74b1b48e4/02d09/img_1.png 1020w,
/static/e8b03ab7b5d81fb08fd5b2e74b1b48e4/64756/img_1.png 1200w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;일반적으로 보통 &lt;code class=&quot;language-text&quot;&gt;Nginx&lt;/code&gt;에서 &lt;code class=&quot;language-text&quot;&gt;gzip&lt;/code&gt;으로 압축을 처리할 수 있기 때문에, 압축 설정을 해주면 다음과 같이 압축이 된 것을 확인할 수 있습니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/cab4d28c1f8d5492a0c1cb9ec05967b3/f967b/img_2.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 5.88235294117647%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAAAsTAAALEwEAmpwYAAAASklEQVQI1x3JXQqAIBAA4a6y/jy0CpWuShFEdP8zTeDb8M1ym1BKpVrD2qD1QalGCIFVFdU0e9sPvPeM85pfRKbHGHHOkXLmeT9+xwMehtF2juIAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 2&apos; title=&apos;img 2&apos; src=&apos;/static/cab4d28c1f8d5492a0c1cb9ec05967b3/ca1dc/img_2.png&apos; srcset=&apos;/static/cab4d28c1f8d5492a0c1cb9ec05967b3/e7570/img_2.png 170w,
/static/cab4d28c1f8d5492a0c1cb9ec05967b3/f46e7/img_2.png 340w,
/static/cab4d28c1f8d5492a0c1cb9ec05967b3/ca1dc/img_2.png 680w,
/static/cab4d28c1f8d5492a0c1cb9ec05967b3/02d09/img_2.png 1020w,
/static/cab4d28c1f8d5492a0c1cb9ec05967b3/9d567/img_2.png 1360w,
/static/cab4d28c1f8d5492a0c1cb9ec05967b3/f967b/img_2.png 1418w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;하지만 저희 프론트 팀은 내부적으로 압축을 최적화해서 &lt;code class=&quot;language-text&quot;&gt;build&lt;/code&gt; 파일을 보내주기 때문에 압축된 파일을 사용하도록 &lt;code class=&quot;language-text&quot;&gt;Nginx&lt;/code&gt;를 설정해야 했습니다.&lt;/p&gt;
&lt;p&gt;이를 사용하기 위해 &lt;code class=&quot;language-text&quot;&gt;Nginx Docs&lt;/code&gt;를 살펴보던 도중, 다음과 같은 내용을 확인할 수 있었습니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/7efe26bee4d77639dd4425c9c37fca50/ad2a0/img_3.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 54.11764705882353%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABiUlEQVQoz41T2Y6DMAzk/3+vlXofQKGUO1AgBMpsxlWqPqy0W2nkxHbGZux6SZLgcrngfD4jDEPcbjf4vo/r9Sr+OI6x2+3QNA3++r1eL3hMfDweyLIM9/sdaZp+wGJlWSLPcxRFgbquoZRCVVVQjZIidauQa+sfWyEVwsKSlWWBzJLwsSMkCQuN4whjjFhiGIa3bzTQRqOfNMbZAIslHKwzKhvkVYOu6zHoAVrrz+N/QRPvNx6rxUWNIC2RlLb9qrDEHfq+l05ITsv7b2DMgbkeP8VY5kk+SX8+icHn8yma0TqfK/BdqG1byWMjHjU6Ho8yYYJTDcMAURRhu91ivV5jv98jCAKJ07ozc06nk+SsVivZDo+T4yTZ6Xd1EX0ymOdZYm4QLkbrBjVNk2BZFnicJjsk2NFms8HhcJA9lG78AHEUSzfcUVr62Q3XjWf6ablOHvVhgBeS8wH3j+dhHNCZ37Vz9hvsUjSkDgT3jgJTXFUr1J3dUa1kiXmn8LLMVibm0Towxn/KD6cQRinQKsUMAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 3&apos; title=&apos;img 3&apos; src=&apos;/static/7efe26bee4d77639dd4425c9c37fca50/ca1dc/img_3.png&apos; srcset=&apos;/static/7efe26bee4d77639dd4425c9c37fca50/e7570/img_3.png 170w,
/static/7efe26bee4d77639dd4425c9c37fca50/f46e7/img_3.png 340w,
/static/7efe26bee4d77639dd4425c9c37fca50/ca1dc/img_3.png 680w,
/static/7efe26bee4d77639dd4425c9c37fca50/02d09/img_3.png 1020w,
/static/7efe26bee4d77639dd4425c9c37fca50/9d567/img_3.png 1360w,
/static/7efe26bee4d77639dd4425c9c37fca50/ad2a0/img_3.png 1490w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;내용을 간단하게 정리하자면, 압축된 파일 버전을 사용하지 않고 일반 파일 버전을 사용하고 싶은 경우 &lt;code class=&quot;language-text&quot;&gt;gzip_static&lt;/code&gt; 설정을 &lt;code class=&quot;language-text&quot;&gt;on&lt;/code&gt; 으로 변경해주면 된다는 내용이였습니다. 즉, 저희는 내부적으로 이미 최적화된 파일을 보내기 때문에 &lt;strong&gt;일반 파일 버전을 보내주는 해당 설정을 적용하면 저희가 원하는 결과&lt;/strong&gt;를 얻을 수 있을 것이라 생각했습니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/8d15dfa211f474088a41c10290e8b8bc/f967b/img_4.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 5.88235294117647%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAAAsTAAALEwEAmpwYAAAASklEQVQI1x3JSQqAMBAAQb8yWQ5OAppdBRHx/29qIbemermrkHKh1E5tg9YPcqk451hVUQ2ztz1hrWWc1/wiMt17jzGGECPP+/EDx4seiEBw3L8AAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 4&apos; title=&apos;img 4&apos; src=&apos;/static/8d15dfa211f474088a41c10290e8b8bc/ca1dc/img_4.png&apos; srcset=&apos;/static/8d15dfa211f474088a41c10290e8b8bc/e7570/img_4.png 170w,
/static/8d15dfa211f474088a41c10290e8b8bc/f46e7/img_4.png 340w,
/static/8d15dfa211f474088a41c10290e8b8bc/ca1dc/img_4.png 680w,
/static/8d15dfa211f474088a41c10290e8b8bc/02d09/img_4.png 1020w,
/static/8d15dfa211f474088a41c10290e8b8bc/9d567/img_4.png 1360w,
/static/8d15dfa211f474088a41c10290e8b8bc/f967b/img_4.png 1418w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;하지만 불행하게도 결과는 동일했습니다. 처음에는 설정 파일을 잘못 작성해서 그런것이라 생각해 &lt;code class=&quot;language-text&quot;&gt;Nginx&lt;/code&gt; 설정을 지우고 다시 작성하기를 반복해 보았지만, 기존과 동일한 결과를 보여주었습니다. 이때 무언가 잘못됨을 깨닫고 공식문서를 꼼꼼하게 읽어보니 마지막 문장을 발견할 수 있었습니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/f673359d6b80447b1be4edb83e3d7629/5266f/img_5.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 7.0588235294117645%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAPElEQVQI1x2JOQ7AQAgD8/9/IjrY5VBS4QgXo/HIj5lBRKCqcHdUFbnnIt7C+ZIdEXRmcnc3vb3sNzP4AQz9TKRyIUECAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 5&apos; title=&apos;img 5&apos; src=&apos;/static/f673359d6b80447b1be4edb83e3d7629/ca1dc/img_5.png&apos; srcset=&apos;/static/f673359d6b80447b1be4edb83e3d7629/e7570/img_5.png 170w,
/static/f673359d6b80447b1be4edb83e3d7629/f46e7/img_5.png 340w,
/static/f673359d6b80447b1be4edb83e3d7629/ca1dc/img_5.png 680w,
/static/f673359d6b80447b1be4edb83e3d7629/02d09/img_5.png 1020w,
/static/f673359d6b80447b1be4edb83e3d7629/9d567/img_5.png 1360w,
/static/f673359d6b80447b1be4edb83e3d7629/5266f/img_5.png 1464w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;해당 설정은 &lt;strong&gt;기본적으로 &lt;code class=&quot;language-text&quot;&gt;Nginx&lt;/code&gt; 오픈소스 빌드에 포함되지 않을 수도 있으며 별도의 모듈에 정의되어 있다는 내용&lt;/strong&gt;이였습니다. 결국 일반적인 오픈소스로는 이를 사용할 수 없었고, 수동으로 &lt;code class=&quot;language-text&quot;&gt;Nginx&lt;/code&gt;를 설치하고 필요한 모듈을 붙여주기로 결론을 내렸습니다.&lt;/p&gt;
&lt;h2&gt;우당탕탕 Nginx 컴파일 설치&lt;/h2&gt;
&lt;h3&gt;컴파일 환경 만들기&lt;/h3&gt;
&lt;p&gt;먼저 &lt;code class=&quot;language-text&quot;&gt;Nginx&lt;/code&gt;의 코어 및 모듈들의 동작에 필요한 라이브러리와 기본 패키지에서 제공하는 모듈을 사용할 수 있게 개발자 패키지와 컴파일러가 필요했습니다. 다음 명령어를 통해 이를 수행할 수 있습니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;apt-get&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;install&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;make&lt;/span&gt; libperl-dev libpcre3 libpcre3-dev zlib1g zlib1g-dev openssl libssl-dev libxml2-dev libxslt1-dev libgd-dev libgeoip-dev google-perftools libgoogle-perftools-dev gcc g++&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;그리고 &lt;code class=&quot;language-text&quot;&gt;Nginx&lt;/code&gt; 사이트에서 &lt;code class=&quot;language-text&quot;&gt;Nginx&lt;/code&gt;파일들을 다운 받습니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;wget&lt;/span&gt; http://nginx.org/download/nginx-1.22.0.tar.gz
&lt;span class=&quot;token function&quot;&gt;tar&lt;/span&gt; &lt;span class=&quot;token parameter variable&quot;&gt;-zxf&lt;/span&gt; nginx-1.22.0.tar.gz
&lt;span class=&quot;token builtin class-name&quot;&gt;cd&lt;/span&gt; nginx-1.22.0&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/a4b78dc1e11956307b5426fe9b89a2ea/d7258/img_6.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 6.470588235294117%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAUElEQVQI1x3KzRJAIBhGYddhLCxU8yUVCakYP/d/S6/R8jxzKjZndC6hUR61dBjiC+4PyHCDtgutDej3p7RYzvL+rscMYxK4WqFNBNEEJiw+6CYflLY1iucAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 6&apos; title=&apos;img 6&apos; src=&apos;/static/a4b78dc1e11956307b5426fe9b89a2ea/ca1dc/img_6.png&apos; srcset=&apos;/static/a4b78dc1e11956307b5426fe9b89a2ea/e7570/img_6.png 170w,
/static/a4b78dc1e11956307b5426fe9b89a2ea/f46e7/img_6.png 340w,
/static/a4b78dc1e11956307b5426fe9b89a2ea/ca1dc/img_6.png 680w,
/static/a4b78dc1e11956307b5426fe9b89a2ea/d7258/img_6.png 966w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Nginx&lt;/code&gt;까지 다운을 받았다면, &lt;code class=&quot;language-text&quot;&gt;Nginx&lt;/code&gt;의 환경설정을 진행해줍니다. 기본 패키지에서 제공하는 모든 기능과 모듈, 실행 파일 위치와 각 기능에 필요한 디렉토리를 설정하는 것을 포함하도록 설정 파일을 작성합니다. &lt;strong&gt;여기서 유의해야 할 점은 &lt;code class=&quot;language-text&quot;&gt;Nginx&lt;/code&gt;는 새로운 모듈을 추가해주기 위해서 재컴파일&lt;/strong&gt;을 해야 합니다. 저는 향후 번거롭지 않도록 패키지에 포함된 모든 모듈을 사용할 수 있도록 작성을 합니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;./configure &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--sbin-path&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;/usr/local/sbin/nginx &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--conf-path&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;/usr/local/nginx/nginx.conf &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--pid-path&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;/var/run/nginx.pid &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-http_ssl_module &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-http_v2_module &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-http_realip_module &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-http_addition_module &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-http_xslt_module &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-http_image_filter_module &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-http_geoip_module &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-http_sub_module &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-http_dav_module &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-http_flv_module &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-http_mp4_module &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-http_gunzip_module &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-http_gzip_static_module &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-http_auth_request_module &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-http_random_index_module &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-http_secure_link_module &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-http_slice_module &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-http_degradation_module &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-http_stub_status_module &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-http_perl_module &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-mail &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-mail_ssl_module &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-stream &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-stream_ssl_module &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-google_perftools_module &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-cpp_test_module &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-debug&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;보통 저희가 사용하는 &lt;code class=&quot;language-text&quot;&gt;apt&lt;/code&gt; 혹은 &lt;code class=&quot;language-text&quot;&gt;apt-get&lt;/code&gt;을 사용해 &lt;code class=&quot;language-text&quot;&gt;Nginx&lt;/code&gt;를 설치하게 되면, 설정 파일이 위치하는 디렉토리가 &lt;code class=&quot;language-text&quot;&gt;/etc/nginx&lt;/code&gt;에 위치하게 됩니다. 하지만 수동으로 설치를 해주게 되면 &lt;code class=&quot;language-text&quot;&gt;/usr/local/nginx&lt;/code&gt;에서 위치하게 됩니다.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;(만약 &lt;code class=&quot;language-text&quot;&gt;Let’s Encrypt&lt;/code&gt;를 사용한다면 해당 설정은 조금 문제가 있기 때문에, 밑의 트러블 슈팅을 참고하시면 됩니다!!)&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;해당 설정 입력 후 실행을 하게 되면, 특별한 문제가 없을 경우 설정 관련 옵션들이 추가되며 컴파일을 할 준비가 끝나게 됩니다.&lt;/p&gt;
&lt;h3&gt;Nginx 컴파일하기&lt;/h3&gt;
&lt;p&gt;이제 &lt;code class=&quot;language-text&quot;&gt;make&lt;/code&gt; 명령어를 통해서 컴파일을 시작합니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;make&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;역시 컴파일도 문제가 없다면 다음과 같은 화면을 만날 수 있습니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/f1684bac58268ad413c0b55690f893fc/d1716/img_7.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 4.117647058823529%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAR0lEQVQI12NQM7L6r2po+d/M0fO/oY3Lf31rZzDWs3T6bwCkQWKKuqb/tc3t/1s4ef83sfcAYvf/xnZuYDlTB0+wGEgeZBYAJw4hU5rog3oAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 7&apos; title=&apos;img 7&apos; src=&apos;/static/f1684bac58268ad413c0b55690f893fc/ca1dc/img_7.png&apos; srcset=&apos;/static/f1684bac58268ad413c0b55690f893fc/e7570/img_7.png 170w,
/static/f1684bac58268ad413c0b55690f893fc/f46e7/img_7.png 340w,
/static/f1684bac58268ad413c0b55690f893fc/ca1dc/img_7.png 680w,
/static/f1684bac58268ad413c0b55690f893fc/d1716/img_7.png 774w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;컴파일도 문제가 없다면 이제 설치를 진행합니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;make&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;install&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;설치에 문제가 없다면, 이제 &lt;code class=&quot;language-text&quot;&gt;Nginx&lt;/code&gt;를 실행할 수 있습니다. 아까의 환경 설정에서 지정한 설정 파일 경로로 이동한 후,  &lt;code class=&quot;language-text&quot;&gt;nginx.conf&lt;/code&gt;에서 원하는 대로 &lt;code class=&quot;language-text&quot;&gt;Nginx&lt;/code&gt;를 설정한 다음 서비스를 시작하면 &lt;code class=&quot;language-text&quot;&gt;Nginx&lt;/code&gt;를 구동할 수 있습니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# Nginx 폴더 위치 찾기&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;find&lt;/span&gt; &lt;span class=&quot;token builtin class-name&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;token parameter variable&quot;&gt;-name&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;*nginx*&quot;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;# Nginx 설정 파일인 nginx.conf로 이동 (sudo vim을 활용해 설정 수정)&lt;/span&gt;
&lt;span class=&quot;token builtin class-name&quot;&gt;cd&lt;/span&gt; /usr/local/nginx

&lt;span class=&quot;token comment&quot;&gt;# Nginx 서비스 시작&lt;/span&gt;
/usr/local/sbin/nginx&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/9d71b27a9a2208e6896fcb875053792e/d1716/img_8.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 11.76470588235294%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAiElEQVQI1x3NSxKCMBBFUVehVTpRkb9JJYJAIIhQoDP2v5tr46AH/er16V1ia7JnT2QdN9OQlp68HkglM37mqiuOkcJ/VrQbsZLdmzfF8OXRL1xUzSk27IOMQ5CzC3WJkkIiUGgbGSf7SF69sHIQFx3KTbTLKtjyhzZww0w3k7UeO42cVSmPNT8DG0AqGWMSNAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 8&apos; title=&apos;img 8&apos; src=&apos;/static/9d71b27a9a2208e6896fcb875053792e/ca1dc/img_8.png&apos; srcset=&apos;/static/9d71b27a9a2208e6896fcb875053792e/e7570/img_8.png 170w,
/static/9d71b27a9a2208e6896fcb875053792e/f46e7/img_8.png 340w,
/static/9d71b27a9a2208e6896fcb875053792e/ca1dc/img_8.png 680w,
/static/9d71b27a9a2208e6896fcb875053792e/d1716/img_8.png 774w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;그리고 압축하고자 하는 &lt;code class=&quot;language-text&quot;&gt;bundle.js&lt;/code&gt;가 잘 전달되었는지 확인을 해보면…&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/89717572bee198461b790fc2d3a09578/c1e63/img_9.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 5.88235294117647%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAAAsTAAALEwEAmpwYAAAARUlEQVQI1x2LSQrAMAwD+xYblRKTzTmk9P//Uu0cBoQ0uvZ62PpgD6YvjukEbqoISzGaGVWVtbbTeTjpSmQAh9zzs9+PP6rGHd39bIPYAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 9&apos; title=&apos;img 9&apos; src=&apos;/static/89717572bee198461b790fc2d3a09578/ca1dc/img_9.png&apos; srcset=&apos;/static/89717572bee198461b790fc2d3a09578/e7570/img_9.png 170w,
/static/89717572bee198461b790fc2d3a09578/f46e7/img_9.png 340w,
/static/89717572bee198461b790fc2d3a09578/ca1dc/img_9.png 680w,
/static/89717572bee198461b790fc2d3a09578/02d09/img_9.png 1020w,
/static/89717572bee198461b790fc2d3a09578/9d567/img_9.png 1360w,
/static/89717572bee198461b790fc2d3a09578/c1e63/img_9.png 1680w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;드디어!! 정상적으로 압축된 파일이 넘어온 것을 확인할 수 있습니다!!&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;참고. Nginx 서비스 명령어&lt;/p&gt;
&lt;/blockquote&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# Nginx 서비스 시작&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; /usr/local/sbin/nginx 

&lt;span class=&quot;token comment&quot;&gt;# Nginx 서비스 정지&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; /usr/local/sbin/nginx &lt;span class=&quot;token parameter variable&quot;&gt;-s&lt;/span&gt; stop 

&lt;span class=&quot;token comment&quot;&gt;# Nginx 서비스 재시작&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; /usr/local/sbin/nginx &lt;span class=&quot;token parameter variable&quot;&gt;-s&lt;/span&gt; reload 

&lt;span class=&quot;token comment&quot;&gt;# Nginx 서비스 설정 파일 syntax 테스트&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; /usr/local/sbin/nginx &lt;span class=&quot;token parameter variable&quot;&gt;-t&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;트러블 슈팅하기&lt;/h2&gt;
&lt;p&gt;압축 파일 전송까지 잘 되었기 때문에 모든 기능이 정상적으로 잘 동작할 것이라 생각했지만, 아쉽게도 그러지 못했습니다.&lt;/p&gt;
&lt;h3&gt;URL로 직접 접근할 경우 발생하는 404&lt;/h3&gt;
&lt;p&gt;처음으로 마주한 문제는 특정 페이지로 이동할 경우 404가 발생하는 상황이 있었습니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/af79ccc75c2759dff930f5c0b199531c/b66f5/img_10.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 24.11764705882353%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA90lEQVQY032MW0rDQBiFsxM1aVMoVpNeAqIICl2Cj1aakkCnTqalC3BxeclLHrKRXCAPyeRynBkpFKH94eOfc/4zR5svnmBPHUwebExnL3AcoR8tmKMxdMPEnT6EPhjBENzcDgSG8u8nFobmGJa9wNv7EsvXD8xnz9DILgCle3zTAzb+DxhlOBIPZMfg+VusXQ9bQkEEqy8X7sYX2T2C4KDen6u1ujN2hOzSmqbBibbl4Jyj64E0TRGGIeI4ViRJgiiKUBQF+r4XuQZd1yn+/nO1tZP5n7ZtVXlZlsjzXO26rpV/njnXkouFEjmyKMsyVFWl9LW85BfUMjTjik6M3QAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 10&apos; title=&apos;img 10&apos; src=&apos;/static/af79ccc75c2759dff930f5c0b199531c/ca1dc/img_10.png&apos; srcset=&apos;/static/af79ccc75c2759dff930f5c0b199531c/e7570/img_10.png 170w,
/static/af79ccc75c2759dff930f5c0b199531c/f46e7/img_10.png 340w,
/static/af79ccc75c2759dff930f5c0b199531c/ca1dc/img_10.png 680w,
/static/af79ccc75c2759dff930f5c0b199531c/02d09/img_10.png 1020w,
/static/af79ccc75c2759dff930f5c0b199531c/9d567/img_10.png 1360w,
/static/af79ccc75c2759dff930f5c0b199531c/b66f5/img_10.png 1668w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;404가 발생한다는 것은, 라우팅 경로가 문제가 있다는 의미이므로 &lt;code class=&quot;language-text&quot;&gt;location&lt;/code&gt; 설정을 수정해주어야 했습니다. 그래서 다음과 같이 해당 경로의 파일을 찾지 못할 경우 최상위 &lt;code class=&quot;language-text&quot;&gt;html&lt;/code&gt;인 &lt;code class=&quot;language-text&quot;&gt;/index.html&lt;/code&gt;로 이동하는 설정을 추가해주면서 404 문제를 해결할 수 있었습니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/e433fcbaf1e7f001c9de4cfce7aed1a4/249e2/img_11.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 22.941176470588236%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA90lEQVQY0z2Q3ZKCMAyFeQlFEEVKRWnLT6kCI7Lu4HCx+/7vczYtixdn0qTtd5J4PlfYphKXqkbTGZjeIC00krJFcC4Q0L2Nu7NyCrMSQUY51X0u4bu4niU8lxBwT49iUeKQKWTDgHx+Q3QvNNMP6nFGN/2i6L+hSKL9wlEa18juA1QrcHGxlxtGSgSiogUfJhyqDowAzDwg7yNOFsKEa2Cb5O68Ybn7u3K8tVXr5NwIGjc3gmnw5wOxuZEGRLrD6f5Eonuwugd/zeDtCEXdMlqPn36Ay8gxudtdWbfwWiJSGmFeLbrWpP94qdweQ6FdLbI1yteR/wACgZLNxb7zwAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 11&apos; title=&apos;img 11&apos; src=&apos;/static/e433fcbaf1e7f001c9de4cfce7aed1a4/ca1dc/img_11.png&apos; srcset=&apos;/static/e433fcbaf1e7f001c9de4cfce7aed1a4/e7570/img_11.png 170w,
/static/e433fcbaf1e7f001c9de4cfce7aed1a4/f46e7/img_11.png 340w,
/static/e433fcbaf1e7f001c9de4cfce7aed1a4/ca1dc/img_11.png 680w,
/static/e433fcbaf1e7f001c9de4cfce7aed1a4/249e2/img_11.png 810w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3&gt;HTTPS 미적용&lt;/h3&gt;
&lt;p&gt;404 까지 해결되었기 때문에 더 이상의 문제는 없을 것이라 생각했으나, 다음과 같이 &lt;code class=&quot;language-text&quot;&gt;HTTPS&lt;/code&gt;가 적용되지 않은 것을 확인할 수 있었습니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/d3176239551ed5f7fd4fc5f176c49786/1e0c2/img_12.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 61.76470588235294%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAACGElEQVQoz3WS604aURSFeRULcpkB5s5cGLnYWiimTdqkD2BqbNJatU1MfEmh8AuBFyCBP9whwOo6p8GowR8re5/JOd+sfYnkwxI8/whBvoh8WGQsoFR+h+O372E7Lkwrh1zOh+sGMEwbum5BUTKIxRI4jKegG/xmOMwVHLyJI3J98wc/L69x+esG384v4PDxUfEYxfIJSoSGzLO6jYNoHFECYkIJBUk1K+9eXf3G7e0dLr7/wNnZOSKTyQTj8Rir1QrthwdkswYyvOzRjWcIWQjM/9Hn2WcM6dpUM6hUauj3+5hNZxCc2WyGyHw+l8lms0Gn24XLx6Hl4MQL4PJxjiUKuK2bMncYxR0BrFZPMRwOpRnBEKyISKbTKdbrNboEpuhOo8uQvXSDAjz21vHyjAXk/BCOm0cuKEKzA1QIHAwGWCwWkiEdvgSqBOqWT0iBQ/Fkn4Rsh2IUQ7K9MrJWAdUPHyVwuVxK2F5gOqNBSetQqQSbn0iqz5RMpZFS0pxojA5rsuS9QNnDTgcuyxPS2b84gQodP5VF1z5boagaaqefXne42awlUOMksxoHwL2zbFdC43QWT6gyFy5T3MPoYfKxh6+W3Ov15HJ7bL5YbLHgYpkN03kmk1sgfvr5y9f9Je9GPhqN0Gq1UK83cH9fZ6yj2WziL9V8oUajgXa7Lc3sVu9xD3cfRBS93Aptt1Li/JpEVU/fCv0D3str/SKLFswAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 12&apos; title=&apos;img 12&apos; src=&apos;/static/d3176239551ed5f7fd4fc5f176c49786/ca1dc/img_12.png&apos; srcset=&apos;/static/d3176239551ed5f7fd4fc5f176c49786/e7570/img_12.png 170w,
/static/d3176239551ed5f7fd4fc5f176c49786/f46e7/img_12.png 340w,
/static/d3176239551ed5f7fd4fc5f176c49786/ca1dc/img_12.png 680w,
/static/d3176239551ed5f7fd4fc5f176c49786/02d09/img_12.png 1020w,
/static/d3176239551ed5f7fd4fc5f176c49786/1e0c2/img_12.png 1076w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;분명 설정 파일에는 &lt;code class=&quot;language-text&quot;&gt;HTTPS&lt;/code&gt;를 위한 설정이 다 되었기 때문에 적용이 되어야 했지만, 다음 화면처럼 적용이 되지 않은 것을 확인할 수 있었습니다. 몇번의 검색끝에 그 이유를 알 수 있었는데, 원인은 &lt;code class=&quot;language-text&quot;&gt;nginx.conf&lt;/code&gt;가 저장되는 위치가 다르기 때문이였습니다.&lt;/p&gt;
&lt;p&gt;위에서 설명했듯이 기존처럼 &lt;code class=&quot;language-text&quot;&gt;apt&lt;/code&gt;, &lt;code class=&quot;language-text&quot;&gt;apt-get&lt;/code&gt;을 통해서 &lt;code class=&quot;language-text&quot;&gt;Nginx&lt;/code&gt;를 설치하게 되면 &lt;code class=&quot;language-text&quot;&gt;/etc/nginx&lt;/code&gt; 에 위치하게 되지만, 수동으로 설치하면 &lt;code class=&quot;language-text&quot;&gt;/usr/local/nginx&lt;/code&gt; 에 위치하게 됩니다. 여기서 문제는 저희가 &lt;code class=&quot;language-text&quot;&gt;HTTPS&lt;/code&gt; 적용을 위해서 사용하는 &lt;code class=&quot;language-text&quot;&gt;Let’s Encrypt&lt;/code&gt;가 &lt;code class=&quot;language-text&quot;&gt;/etc/nginx&lt;/code&gt; 를 기준으로 설정이 적용된다는 점입니다.&lt;/p&gt;
&lt;p&gt;결국 기존과 동일하게 적용을 해주기 위해서 다음과 같이 &lt;code class=&quot;language-text&quot;&gt;nginx.conf&lt;/code&gt;의 설정 위치를 변경해주는 환경 설정 옵션을 작성하고, 기존과 동일하게 설치 작업을 다시 진행주었습니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# 기존의 nginx.conf 위치&lt;/span&gt;
--conf-path&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;/usr/local/nginx/nginx.conf &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;# 변경할 nginx.conf 위치&lt;/span&gt;
&lt;span class=&quot;token parameter variable&quot;&gt;--prefix&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;/usr/share/nginx &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--conf-path&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;/etc/nginx/nginx.conf &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--error-log-path&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;/var/log/error.log &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--http-log-path&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;/var/log/access.log &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# 변경된 설정&lt;/span&gt;
./configure &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--sbin-path&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;/usr/local/sbin/nginx &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;token parameter variable&quot;&gt;--prefix&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;/usr/share/nginx &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--conf-path&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;/etc/nginx/nginx.conf &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--error-log-path&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;/var/log/error.log &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--http-log-path&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;/var/log/access.log &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--pid-path&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;/var/run/nginx.pid &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-http_ssl_module &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-http_v2_module &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-http_realip_module &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-http_addition_module &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-http_xslt_module &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-http_image_filter_module &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-http_geoip_module &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-http_sub_module &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-http_dav_module &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-http_flv_module &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-http_mp4_module &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-http_gunzip_module &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-http_gzip_static_module &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-http_auth_request_module &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-http_random_index_module &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-http_secure_link_module &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-http_slice_module &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-http_degradation_module &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-http_stub_status_module &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-http_perl_module &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-mail &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-mail_ssl_module &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-stream &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-stream_ssl_module &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-google_perftools_module &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-cpp_test_module &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
--with-debug&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;여기까지 완료한다면 기존과 동일하게 서비스를 적용할 수 있으며 &lt;code class=&quot;language-text&quot;&gt;gzip&lt;/code&gt; 까지 깔끔하게 적용된 것을 확인할 수 있습니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/62f847b90f2c38f63df10e4dc42b9e6c/ba099/img_13.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 35.88235294117647%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABq0lEQVQoz22RS08TYRSG55cQoO30QlvaYjttp7eZVpvUpjOtaIIkbpS48HexcW1cmLCAaEww3BIntJoQJSFIAIvQmQZJ5/GbMeJCF0++cxbve95zPklvNClXauQLJSpVjWKxTDyRYmY2xGxA/i+BYJhAIPy7DkUICjxNPJFGyizkUPIqaqlKUa2QU4rE5pKE5ChyOHb7JpJpDKOH2V1EVavo9SbtThfDXMTsPaQu+nyhjFTTGr5JtVYXCXVK5RrZXIF0Jos37E42z3xqQQjusvV2nYOPuwz2tvm0+Y7+m9fsvF+nv72Jtd/HsiwkTW/4cT2hZ+Sl/ZNU8c+gkxV1q3Uf5/QIbmy4HsHFMZwcMPn2GcaXTADXnSDda7Z8o+R8xl8vGksQicaJROb8QZ6xdxtNqzPY/QBX3/k5PGFyee6D4PrqgpFtYwskL40sxCmxYlKsNj0TEh8i/0Ucfmo6iKIUePVyla2NNb5aO2APheGZMDzjZvQDZzxm7DhIz1ae03vwiMfLT1haWsbsGJiGeUvX6NJud3ix8hRnIBIe7eN+2cM9PcQdDf8x/AULfUP0xcAFmgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 13&apos; title=&apos;img 13&apos; src=&apos;/static/62f847b90f2c38f63df10e4dc42b9e6c/ca1dc/img_13.png&apos; srcset=&apos;/static/62f847b90f2c38f63df10e4dc42b9e6c/e7570/img_13.png 170w,
/static/62f847b90f2c38f63df10e4dc42b9e6c/f46e7/img_13.png 340w,
/static/62f847b90f2c38f63df10e4dc42b9e6c/ca1dc/img_13.png 680w,
/static/62f847b90f2c38f63df10e4dc42b9e6c/02d09/img_13.png 1020w,
/static/62f847b90f2c38f63df10e4dc42b9e6c/ba099/img_13.png 1190w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;참고자료&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.nginx.com/nginx/admin-guide/web-server/compression/&quot;&gt;https://docs.nginx.com/nginx/admin-guide/web-server/compression/&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Replication과 Spring Boot]]></title><description><![CDATA[…]]></description><link>https://wishoon.github.io/Replication과-SpringBoot/</link><guid isPermaLink="false">https://wishoon.github.io/Replication과-SpringBoot/</guid><pubDate>Sun, 16 Oct 2022 00:00:00 GMT</pubDate><content:encoded>&lt;h2&gt;사용배경&lt;/h2&gt;
&lt;p&gt;현재 진행하고 있는 프로젝트에서 쿠폰 시스템을 만들고 있습니다. 현재 시스템상 내부 인원들만 사용을 하고 있기 때문에 부하에 대한 문제를 걱정하지 않아도 되지만, 해당 시스템이 실제 상용서비스가 되어 많은 사용자들이 사용한다고 가정한다면 분명 서버와 DB에 많은 부하가 오게 될 것입니다.&lt;/p&gt;
&lt;p&gt;이번 글에서는 &lt;strong&gt;부하 분산 중 DB에서의 처리 방법을 한번 고민&lt;/strong&gt;해보고자 합니다. 그리고 고민의 결과와 적용한 과정에 대해서도 함께 작성해보려고 합니다.&lt;/p&gt;
&lt;h2&gt;DB 성능 확장 방법&lt;/h2&gt;
&lt;p&gt;DB의 성능을 높이기 위해서는 &lt;code class=&quot;language-text&quot;&gt;Scale up&lt;/code&gt; 또는 &lt;code class=&quot;language-text&quot;&gt;Scale out&lt;/code&gt; 하여 성능을 높여야 합니다. 현재 진행하는 프로젝트에서는 &lt;code class=&quot;language-text&quot;&gt;Scale up&lt;/code&gt;을 하기 위한 자원을 제공받을 수 없는 상황이기 때문에, &lt;code class=&quot;language-text&quot;&gt;Scale up&lt;/code&gt;은 고려하지 않고 &lt;code class=&quot;language-text&quot;&gt;Scale out&lt;/code&gt;을 적용하기로 결정했습니다.&lt;/p&gt;
&lt;p&gt;DB를 &lt;code class=&quot;language-text&quot;&gt;Scale out&lt;/code&gt;하는 방법은 &lt;code class=&quot;language-text&quot;&gt;Clusterning&lt;/code&gt;과 &lt;code class=&quot;language-text&quot;&gt;Replication&lt;/code&gt;으로 구분할 수 있습니다. 한번 각각의 방법에 대해서 알아보도록 합시다.&lt;/p&gt;
&lt;h3&gt;Clustering&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Clusterning&lt;/code&gt;은 DB 서버를 2대 이상, DB 스토지리를 1대로 구성하는 형태입니다. &lt;strong&gt;DB 서버 2대를 모두 &lt;code class=&quot;language-text&quot;&gt;Active&lt;/code&gt; 상태로 운영한다면, DB 서버 1대가 죽더라도 다른 DB 서버 1대는 살아있어 서비스를 정상적&lt;/strong&gt;으로 할 수 있습니다. 또한 DB 서버를 여러대로 두게되면, 트래픽을 분산하여 감당하게 되어 CPU와 Memory 부하가 적어지는 장점이 존재합니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 664px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/053f7d357d3fa0ee06a86522a4b3771d/5bd9c/img.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 112.3529411764706%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAAAsTAAALEwEAmpwYAAACkklEQVQ4y41Uy27TQBT1P7BDLPkDlv0HJL4AiR2rCrEBpK6QQGKB2CMWhWWlgtghJELSNFFebuLYVZNGJHHIy0FNiBzH8SMH3/EjduzQjjIaz8y5Z86ceyfcer3GGk6j0TZh06fXbdsC7cObOwDnZ8UwbriL49hIRO4cWHUB/gkwFbwF2wV7h7G2kIDKPqDJLpkd7IALTocGU3qH/Nu7yB1wUNOPUBUvYRr6RiGusORfIvXqDuqvOVydPIXUlAOF1B2FDvvvLxA+7OFon8PnZ7cwzjwH9D5OT3OYTCYswLg8hPj+Hj495vD14DbUszfQZzJ+pH5uEdLs5AEyjir+433nOkIg//xcgqJMmD7r2x6+v+BwcfwQsH4FmFKpuPGZCJlLUxHoH4E/q4IsNo0VAwhCHRNl5EZOS/grHeKi2WZTwpB3hUIhSsiuzKwHcrkcwq1er2M8Hgfz0R8VtVotgsnn83GFfpaKxSLK5TIqlQoLTKfTUFXVC11DW6js0Gq1yjCEzWazUQ/DNWQ7xARst9uONyXMZrMImFXMYsGu2el0wPM8lstltA7DExoHgwH6/T67qq7rMULTNNk+4QhD8xhheIGaoigIr4f7Lky0sENgy7IwHA5jwO1gwhB2ez2mkHwcjUbB2mq1Yp2ubxjGJuMOxvaSGVO4TUj+UCPTU6kUyyZ1+u52u2yPMDcm9GtPEASW1bCqRqMRXPlGhDS2Wi32hqkO5/N5sEfZzWQyrJxkWY7EJBL6G+QXdapFv878zJINpIx83Y6LECaVAPkmiiJ6vR7zjMhIfRLRToVhIHlJ77nZbLJRkiRomhaz6FqFPoCeIJGQX6SO1JKnu2r0WkL/2w79xScl4r+ESV4mHbSr/QOYJ4wptSQmTgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img&apos; title=&apos;img&apos; src=&apos;/static/053f7d357d3fa0ee06a86522a4b3771d/5bd9c/img.png&apos; srcset=&apos;/static/053f7d357d3fa0ee06a86522a4b3771d/e7570/img.png 170w,
/static/053f7d357d3fa0ee06a86522a4b3771d/f46e7/img.png 340w,
/static/053f7d357d3fa0ee06a86522a4b3771d/5bd9c/img.png 664w&apos; sizes=&apos;(max-width: 664px) 100vw, 664px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;하지만, &lt;strong&gt;DB 서버들이 하나의 DB 스토리지를 공유하기 때문에 DB 스토리지에 병목이 생기는 단점&lt;/strong&gt;이 존재합니다.&lt;/p&gt;
&lt;p&gt;이를 해결하기 위해서 DB 서대 2대 중 1대를 &lt;code class=&quot;language-text&quot;&gt;Stand-by&lt;/code&gt; 즉, 사용대기 상태로 두어 단점을 보안할 수 있습니다. &lt;strong&gt;&lt;code class=&quot;language-text&quot;&gt;Stand-by&lt;/code&gt; 상태의 서버는 &lt;code class=&quot;language-text&quot;&gt;Active&lt;/code&gt; 상태의 서버에 문제가 생겼을 때, &lt;code class=&quot;language-text&quot;&gt;Fail Over&lt;/code&gt;를 하여 상호 전환을 하여 장애에 대응&lt;/strong&gt;을 할 수 있습니다. 이를 통해서, DB 스토리지에 대한 병목 현상도 해결할 수 있습니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 664px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/613ac30f3b12d16c2c95f7104950094a/5bd9c/img_1.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 112.3529411764706%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAAAsTAAALEwEAmpwYAAACmUlEQVQ4y41UO48SURjlP9hamW2stLKx1c6YaGXtD9iNlauJf2ALY6LtxkejyRZa2QkBYQivEQbYCEuWl8AwEwQJw2sex/tdZoYZYLJ8yc19nXvm3PN9d0KWZcECC+pNHSYN7WaaBmgf9pwtMIzJMU4Y5mrm4EK8JyLLRiyagPgMGEr2gsnBlmHAcFh+F6G8PMRMEldkhruDkPt1TKGX3yD5+gDCqxAm0afIly6gL+drOaoM7d0Jovfu4OPN6xCOj3BRb7gKqTGFTPKfb5BO7+LsKISvx9fQj70A5h0kEgIUVeEHBl8+IPn4Pj7fuoH4kwewfnyH9neAcDi8QUizn48QY6rETw8BTXIFnZfLkPt9Ps4+P8T72wdovD1hl5nAcSiTyax9JkLu0rAEdM4g/spzn/TlggMkqQhVWRFiOMC/VALnl5erZCwWLEcmUqmUn5BfmVsPCIIAbxSLRfRthRTycAQpn/dhksnktkLLTn06nUY2m0Uul0OhUEA0GsVkMnEPTzWNfzTPSAlD2Hg87vfQW0N0BQLW63XuzWg08oEpNEZK12w0GhBFEbPZzF+H3gn13W4XnU6HX3U+n28R6rrO9wlHGJpvEXoXKBRFgXfd24Iw/sL2gA1W9b1ebwu4eZgwhueFBCokH2VZdtcWrDyo0fWXy+U64wxjbrzjQELyh4JMj0QiPJvUaNxsNvkeYfYmdGpPkiSeVa+qSqXiXnkvQuprtRpUVeV1OB6P3T3KbiwW4+XUarV8Z3YSOhvkFzWqRafOnMySDaSMfN085yPcVQLkW6lUQrvd5p4RGanfRRSo0AskL+k9V6tV3pfZ32c6nW5ZdKVCB0BPkEjIL1JHasnToBq9ktAZO9ncVLYX4S4vd30oKP4Dk+KJkeTx6LAAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 1&apos; title=&apos;img 1&apos; src=&apos;/static/613ac30f3b12d16c2c95f7104950094a/5bd9c/img_1.png&apos; srcset=&apos;/static/613ac30f3b12d16c2c95f7104950094a/e7570/img_1.png 170w,
/static/613ac30f3b12d16c2c95f7104950094a/f46e7/img_1.png 340w,
/static/613ac30f3b12d16c2c95f7104950094a/5bd9c/img_1.png 664w&apos; sizes=&apos;(max-width: 664px) 100vw, 664px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;하지만, &lt;strong&gt;&lt;code class=&quot;language-text&quot;&gt;Fail Over&lt;/code&gt;가 발생하는 시간 동안은 손실이 존재하며, DB 서버 비용은 그대로인데 가용률이 1/2가 된다는 단점이 존재&lt;/strong&gt;합니다.&lt;/p&gt;
&lt;p&gt;또한, &lt;code class=&quot;language-text&quot;&gt;Clustering&lt;/code&gt;이 가지는 본질적인 &lt;strong&gt;문제로 DB 스토리지에 문제가 발생하면, 데이터를 복구할 수 없다는 치명적인 문제&lt;/strong&gt;가 존재합니다.&lt;/p&gt;
&lt;h3&gt;Replication&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Replication&lt;/code&gt;은 각 DB 서버가 각자 DB 스토리지를 가지고 있는 형태입니다. 그리고 이를 실시간으로 동기화하면서 트래픽을 여러 MySQL 서버로 분산시켜주기 때문에 데이터베이스로 인한 병목 현상을 개선할 수 있습니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/7320063af3fcb5938a76de7b86383716/fe486/img_2.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 92.94117647058823%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAACaklEQVQ4y41Uu5ISQRSdXKuMTAz0G/wNQ3/A1NTAyI1MTNUNjCytDdbEzdcyWXkIVUDxWt64gC7vx8DIm5k5zumhmxlYq/YWXcx0H849997TaDacsC3nY8KCG7Zti+V93r3vY+HDara9O8Q4Cqt4LN98QPfBhC0P9TDMxEtnb6YSMTRXYR+T6CucH91F6+N9tArf0R9N90gtl2zRRO/iBb4d3cHo8z38TpxiMF7sFJrVE5y/foST5xoSn54AozjKpSIymYwAWZYlyET+6y9IvX2A42casqdPgUkGleovpFIphdXM7Buk3j3EVfC9KnU4HKJSKXsIt6X+OYP+9TFqPz8o7Hg8RrFY3BECG6yNa+RKDR+oXPYS2qp3y6mOTP5KYQ3jLwqFgpfQacvSRCj4A/V6zVkNxONx5PN5P+G2l6u1iWDgArUasXUkk0lcXl7uCCWQZabTaSGfGVerFQ7Dxfb7fdHjUqnkw25t44JM0xRZO50Oer2e2NtsnHas1yIzz/nN4B7VdbtdhZU82r7fZrOZ0qPrOqLRqJgiV7Va9emVWJlIKZSEzMzSZRDId6rg8p5R8WAwOLgESmGr1XKsUkEulxOlG4aBm4LYZrMp1BLL0iVWKOTDfD5HKBQSKpiVDSdYKvFWsVwuEQgERP84HOKy2azfNtPpVBEwRqORz4fekhaLhSJgTCaTfWO7hNJLchi0xG0IWe6BsVlyJBIRfaRt+ANvVi8hPRcOhwW23W6LC+C9BJrMxCw8IFksFlMT3f9flFi2iFURyxb5hsLgZNloTo0TZG/+R0gs1TUajQOsz9g3WeQ2e979f1/Bn4aYLjfFAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 2&apos; title=&apos;img 2&apos; src=&apos;/static/7320063af3fcb5938a76de7b86383716/ca1dc/img_2.png&apos; srcset=&apos;/static/7320063af3fcb5938a76de7b86383716/e7570/img_2.png 170w,
/static/7320063af3fcb5938a76de7b86383716/f46e7/img_2.png 340w,
/static/7320063af3fcb5938a76de7b86383716/ca1dc/img_2.png 680w,
/static/7320063af3fcb5938a76de7b86383716/fe486/img_2.png 768w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Master&lt;/code&gt;와 &lt;code class=&quot;language-text&quot;&gt;Slave&lt;/code&gt;로 구성된 구조는 &lt;code class=&quot;language-text&quot;&gt;Master&lt;/code&gt; 서버에는 INSERT, UPDATE, DELETE 작업이 전달되고 &lt;code class=&quot;language-text&quot;&gt;Slave&lt;/code&gt; 서버에는 SELECT 작업을 전달합니다. &lt;code class=&quot;language-text&quot;&gt;Slave&lt;/code&gt;는 결국 &lt;code class=&quot;language-text&quot;&gt;Master&lt;/code&gt; 서버에서 복제된 데이터이기 때문에 데이터의 조작이 발생할 수 있는 INSERT, UPDATE, DELETE 작업은 &lt;code class=&quot;language-text&quot;&gt;Master&lt;/code&gt;로 전달이 되고 조회만을 하는 SELECT 작업은 &lt;code class=&quot;language-text&quot;&gt;Slave&lt;/code&gt; 서버를 통하여 진행하게 됩니다.&lt;/p&gt;
&lt;p&gt;위의 그림에서는 &lt;code class=&quot;language-text&quot;&gt;Slave&lt;/code&gt; 서버가 하나뿐이지만 서비스에 맞게 &lt;code class=&quot;language-text&quot;&gt;Slave&lt;/code&gt; 서버를 여러 개로 설정할 수도 있습니다. &lt;strong&gt;데이터베이스에서 발생하는 대부분의 쿼리는 조회인 SELECT인데 이러한 것을 &lt;code class=&quot;language-text&quot;&gt;Slave&lt;/code&gt; 서버를 통해 분산하여 처리할 수 있으니 좀 더 성능 향상을 가져갈 수 있습니다&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;MySQL에서의 &lt;code class=&quot;language-text&quot;&gt;Replication&lt;/code&gt; 동작과정을 조금 더 자세히 살펴보면 다음과 같습니다.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;사용자가 INSERT, UPDATE, DELETE 쿼리를 &lt;code class=&quot;language-text&quot;&gt;Master&lt;/code&gt; 서버로 요청하면, &lt;code class=&quot;language-text&quot;&gt;Master&lt;/code&gt; 서버는 이를 처리하고 &lt;code class=&quot;language-text&quot;&gt;Master&lt;/code&gt; 서버에서 일어나는 모든 변경 이력들을 &lt;strong&gt;바이너리 로그 스레드&lt;/strong&gt;를 사용해서 &lt;strong&gt;바이너리 로그&lt;/strong&gt;에 저장한다.&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;Slave&lt;/code&gt; 서버에서 변경 내역을 요청하면 &lt;code class=&quot;language-text&quot;&gt;Master&lt;/code&gt; 서버의 바이너리 &lt;strong&gt;로그 덤프 스레드&lt;/strong&gt;가 바이너리 로그들을 읽어서 &lt;code class=&quot;language-text&quot;&gt;Slave&lt;/code&gt; 서버로 데이터를 전달한다.&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;Slave&lt;/code&gt; 서버의 &lt;strong&gt;Slave I/O 스레드&lt;/strong&gt;가 요청한 변경 내역들을 &lt;code class=&quot;language-text&quot;&gt;Slave&lt;/code&gt; 서버의 &lt;strong&gt;릴레이 로그&lt;/strong&gt;에 저장합니다.&lt;/li&gt;
&lt;li&gt;최종적으로 &lt;code class=&quot;language-text&quot;&gt;Slave&lt;/code&gt; 서버의 &lt;strong&gt;Slave SQL 스레드&lt;/strong&gt;가 &lt;strong&gt;릴레이 로그&lt;/strong&gt;에 기록된 데이터들을 읽어서 &lt;code class=&quot;language-text&quot;&gt;Slave&lt;/code&gt; 서버에 적용합니다.&lt;/li&gt;
&lt;/ol&gt;
&lt;blockquote&gt;
&lt;p&gt;바이너리 로그란?&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Master&lt;/code&gt; 노드에서의 &lt;code class=&quot;language-text&quot;&gt;DDL&lt;/code&gt; or &lt;code class=&quot;language-text&quot;&gt;DML&lt;/code&gt; 가운데 데이터의 구조나 내용을 변경하는 모든 쿼리 문장과 이력을 기록하는 논리적인 로그를 말합니다.&lt;/p&gt;
&lt;p&gt;전체적인 흐름은 다음 도식과 같습니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/a4f3d97f875cefc753561d7f7f54ece0/8a72f/img_3.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABTUlEQVQoz2VSCXKDMAzk/w9r31AoOUgyEzfEAWIbsA2qV4koSTUjMDp21xLZfrejPM/JOUfeexrHcXmvHTGlFH2XJQ3D8K8G333fU6avmpqmoWmaCObjTB9loNbN/P14EufbtmWfZ4m+WgiBMjzEUBjiRPm+psHHZ+yRizGysrWhfg0OlRmKIFkUotGajpNMkAjhox8ZEHXIISZg9/ud+1ghZrfZbKgoCjqfzzwHXMtZy43X+pryW7rpG+mfhpzpSaW6uq6ZoO8f/QLKCq11PMfL5cIsSCIOBcYY6kCQiK2xKR/5DOL4vNXxeOS6BfDdUCyLwDjkLHGxaTSkvj6pUTteXgj+D1DmAZbD4cAq1nPCWQAlNoWBOrWlU1Wm3PCqEA2yyaqqlisIKM5rwPV287zgfxSxBZBn1XXsGgvQmmeHBWE574DLO7n8JSD/BSBsC0lpYgg8AAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 3&apos; title=&apos;img 3&apos; src=&apos;/static/a4f3d97f875cefc753561d7f7f54ece0/ca1dc/img_3.png&apos; srcset=&apos;/static/a4f3d97f875cefc753561d7f7f54ece0/e7570/img_3.png 170w,
/static/a4f3d97f875cefc753561d7f7f54ece0/f46e7/img_3.png 340w,
/static/a4f3d97f875cefc753561d7f7f54ece0/ca1dc/img_3.png 680w,
/static/a4f3d97f875cefc753561d7f7f54ece0/8a72f/img_3.png 780w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3&gt;그래서.. 어떤 선택을?&lt;/h3&gt;
&lt;p&gt;결론적으로 &lt;code class=&quot;language-text&quot;&gt;DB Scale out&lt;/code&gt;을 하는 방법으로 &lt;code class=&quot;language-text&quot;&gt;Replication&lt;/code&gt;을 선택하기로 했습니다. 이렇게 구성하게 될 경우 DB 스토리지를 여러개로 두기 때문에, 데이터 복구를 못하는 상황을 어느정도 방지할 수 있으며, &lt;code class=&quot;language-text&quot;&gt;Clustering&lt;/code&gt;과 다르게 DB 가용률을 최대로 가져갈 수 있다는 장점을 가져갈 수 있다고 생각했기 때문입니다.&lt;/p&gt;
&lt;p&gt;여기서 고민인 점은 &lt;code class=&quot;language-text&quot;&gt;Slave DB&lt;/code&gt;를 몇대로 설정하는가 입니다. 현재로써는 서비스 사용자가 많지 않기 때문에 &lt;code class=&quot;language-text&quot;&gt;Master 1&lt;/code&gt;, &lt;code class=&quot;language-text&quot;&gt;Slave 1&lt;/code&gt; 구조로 선택해도 문제가 없습니다. 하지만 현재 진행하는 설계는 다수의 사용자를 고려하여 진행하고 있기 때문에 추후 확장에 용이하도록 &lt;strong&gt;N개의 Slave DB를 기준으로 설계&lt;/strong&gt;를 하기로 하였습니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 612px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/b810527eb7cb2dabde817a27d66ac7ca/dbf98/img_4.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 105.29411764705883%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAAAsTAAALEwEAmpwYAAADR0lEQVQ4y42VXWhbZRjH48WuBAW98GJ6IQhOGDiYgswxpQPFMmQgKAwdiJMKDjcYw6Js0zG0Vvy4EZHNXkyH4oqwCfODuTl6s1HbtCRdTdqkycnX+Uqa5CRNzzk55+d7zslHS9JuD7wcyPt/f+f/Js//Sch1XfouwHWauLYploXbtIKn6wR7G5wLbQgTBzeqzaD9gcKZV/Wpy+jfHqT4/RDLF45RPHsIU4oEUM/93QCDCtxVfjpOYiBE7vAj5I9tI30gxGr4t7bPlttNgF7Ztk2pqKHVTKSz76IMP4n88R7k088J6OPkr1+gVLcoL5dwHKcH2gOsVCqkl5IYNuTG3kP+YCfyZ/sonB5AEg5TV3+garpkpBSGYdwZ6IlKuhbAx08gvXkvpeHtaEP3k3s1RPLmHxSE1NNUq9U7Az2RpgVAS0tjxye4duUXbvx1CX1iDGP6R5T0DKlcgXrNuDugruudFjEsmFdrXF3UWFJkUGeFKIUuXlrd/MpOC1gRYrUDXIjHiISniIb/RZGVzuc+UHzfGwPbjlZM9LKxpjGCp7umoX1guYrRsLr7a4F+5zUMHD0lbhOlGJvEURZo1svrxH5blRVfV4xPUU3O0FQTfjzbTkNu0w5ScWsc6eAW0cRbkU88TXboQYy/vwuEQtNOj5cW6fV7KBzfRuH97WSF3srNd9LTAdYmzpN+LYR8chfq6Mvkjj5G9feveoDal/uR3tiC8ulLKGf2kjvyKGZ6thdo/DMmnD2DfOpZCh8+JVLxRF+g/s0BkZrnyQ/vCICHH8bORPoAr58j89Z9qKd2URC5XXohRPriJxQdn9h1+PUrZN95CPWj3WTffoDkPqGbm6QREAWwJWzMXUP9fBDpC3FgZJDSmd0oN86zWKpTWVn1xX56Lo+gjA6SGt2PMvIixZEBsvFpkkJnN5vdtmlPv5uZEhfnFCKJGNb8OCsLf9JYXe3MQa+83/RKTObX2zK6FMa+/TOGNIkltn2g02qJxOIC4elpov/FiSWSuKYhVi24cktjmSYzM2Ei0SizQpfJpEUv1XGtuvfGrsP2pMlmsxRF8C3hal1jt/tVjCxNVcnnc1SWl2k0Gms09GZ5/ajvncj9/xK6+/8DFbYAQ5kwZ6sAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 4&apos; title=&apos;img 4&apos; src=&apos;/static/b810527eb7cb2dabde817a27d66ac7ca/dbf98/img_4.png&apos; srcset=&apos;/static/b810527eb7cb2dabde817a27d66ac7ca/e7570/img_4.png 170w,
/static/b810527eb7cb2dabde817a27d66ac7ca/f46e7/img_4.png 340w,
/static/b810527eb7cb2dabde817a27d66ac7ca/dbf98/img_4.png 612w&apos; sizes=&apos;(max-width: 612px) 100vw, 612px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;실제 프로젝트에는 &lt;code class=&quot;language-text&quot;&gt;Master 1&lt;/code&gt;, &lt;code class=&quot;language-text&quot;&gt;Slave 2&lt;/code&gt; 로 구성하여 작업을 진행하였습니다.&lt;/p&gt;
&lt;h2&gt;MySQL 설정&lt;/h2&gt;
&lt;h3&gt;Master, Slave DB Server 사전 작업&lt;/h3&gt;
&lt;p&gt;MySQL은 기본적으로 &lt;code class=&quot;language-text&quot;&gt;127.0.0.1&lt;/code&gt; 즉, 로컬 호스트에서만 접속할 수 있는데 아래와 같이 MySQL 설정을 변경하여 외부에서 접속이 가능하도록 변경을 해야합니다. 다음과 같이 변경을 하면 됩니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;vim&lt;/span&gt; /etc/mysql/mysql.conf.d/mysqld.cnf

bind-address           &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.0&lt;/span&gt;.0.0
mysqlx-bind-address    &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.0&lt;/span&gt;.0.0&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;Master DB Server 작업&lt;/h3&gt;
&lt;p&gt;기본적인 데이터베이스 부터 한번 생성해보도록 하겠습니다. 먼저 &lt;code class=&quot;language-text&quot;&gt;Master DB&lt;/code&gt;에 대한 데이터베이스를 생성합니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token constant&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;DATABASE&lt;/span&gt; test&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;테스트할 테이블이 있어야 하기 때문에 테이블도 생성해 줍니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token constant&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;TABLE&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
	id &lt;span class=&quot;token constant&quot;&gt;BIGINT&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;NOT&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;NULL&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;AUTO_INCREMENT&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
	name &lt;span class=&quot;token function&quot;&gt;VARCHAR&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;255&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
	&lt;span class=&quot;token class-name&quot;&gt;PRIMARY&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;KEY&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;id&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Replication&lt;/code&gt; 에 필요한 전용 계정을 생성해주고, &lt;code class=&quot;language-text&quot;&gt;Replication&lt;/code&gt;을 위한 권한을 부여해 줍니다. &lt;code class=&quot;language-text&quot;&gt;root&lt;/code&gt;를 사용할 경우 보안상 문제가 될 수 있기 때문에, 다음과 같이 &lt;code class=&quot;language-text&quot;&gt;Slave&lt;/code&gt; 권한을 부여해 줍니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token constant&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;USER&lt;/span&gt; &lt;span class=&quot;token char&quot;&gt;&apos;master&apos;&lt;/span&gt;@&lt;span class=&quot;token char&quot;&gt;&apos;%&apos;&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;IDENTIFIED&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;BY&lt;/span&gt; &apos;password&apos;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token constant&quot;&gt;GRANT&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;REPLICATION&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;SLAVE&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;ON&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;* &lt;span class=&quot;token constant&quot;&gt;TO&lt;/span&gt; &lt;span class=&quot;token char&quot;&gt;&apos;master&apos;&lt;/span&gt;@&lt;span class=&quot;token char&quot;&gt;&apos;%&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;그리고 MySQL 설정 변경을 위해 &lt;code class=&quot;language-text&quot;&gt;my.cnf&lt;/code&gt; 파일로 이동하여 값을 수정해줍니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;vim&lt;/span&gt; /etc/mysql/my.cnf&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;mysqld&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
max_allowed_packet&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1000&lt;/span&gt;M
server&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;id &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
log&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;bin &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; mysql&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;bin
binlog_format &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ROW&lt;/span&gt;
max_binlog_size &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;500&lt;/span&gt;M
sync_binlog &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
expire&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;logs&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;days &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;7&lt;/span&gt;
binlog_do_db &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; test&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;설정들의 세부 값들은 다음과 같습니다.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;max&lt;em&gt;allowed&lt;/em&gt;packet : 서버로 질의하거나 받게되는 패킷의 최대 길이를 설정&lt;/li&gt;
&lt;li&gt;server-id : 서버의 ID, 레플리케이션 토플리지(연결된 망)에서는 고유한 각각의 서버 ID를 가져야 함&lt;/li&gt;
&lt;li&gt;log-bin : 바이너리 로그 파일 경로 → (/var/lib/mysql/mysql-bin.XXXXXX&lt;strong&gt;)&lt;/strong&gt; 형식으로 저장&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;binlog_format : 바이너리 로그의 저장 형식을 지정. STATEMENT, ROW, MIXED 3가지 중 하나를 선택이 가능&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;해당 설정중 &lt;code class=&quot;language-text&quot;&gt;ROW&lt;/code&gt;를 선택. 그 이유는 현재 &lt;code class=&quot;language-text&quot;&gt;InnoDB&lt;/code&gt;를 사용 중이며, 트랜잭션 격리 수준이 &lt;code class=&quot;language-text&quot;&gt;READ COMMITTED&lt;/code&gt;일 경우 &lt;code class=&quot;language-text&quot;&gt;ROW&lt;/code&gt; 기반 로깅만 사용이 가능.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;max&lt;em&gt;binlog&lt;/em&gt;size : 바이너리 로그의 최대 크기&lt;/li&gt;
&lt;li&gt;sync_binlog : N개의 트랜잭션 마다 바이너리 로그를 디스크에 동기화 시킬지 결정. 설정한 1은 안정적이지만, 가장 느린 설정임&lt;/li&gt;
&lt;li&gt;expire-logs-days: 바이너리 로그가 만료되는 기간 설정&lt;/li&gt;
&lt;li&gt;binlog&lt;em&gt;do&lt;/em&gt;db : 레플리케이션을 적용할 데이터베이스 이름 설정&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;설정이 끝났으면 MySQL을 재시작 해줍니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; systemctl restart mysql&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;그리고 &lt;code class=&quot;language-text&quot;&gt;Master&lt;/code&gt;의 상태를 확인해 잘 반영되었는지 확인합니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token constant&quot;&gt;SHOW&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;MASTER&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;STATUS&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/7bd6abe92817db22e1b03707e8f909f2/fcbeb/img_9.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 18.23529411764706%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAnklEQVQY022Q2w6CMBBE+xd4QWOkQLEoBYl4S/z/r1p7ViA8+DCZ3dmd7aQmawZx/VvK60uK7qlASzIv6/wsia1lBWINoyfW/3TmmZ93YGPDXVIXZFs2ykX70Ac4ynE3PRT1aVbGvoqcL7QpjMFgx5TUHN2fOl0mtR8+aj5ebjrbVa2CnUPdSzr2zIDBBDBhpibthsRVmBfR+IIl/mlfa113jWb0AlcAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 9&apos; title=&apos;img 9&apos; src=&apos;/static/7bd6abe92817db22e1b03707e8f909f2/ca1dc/img_9.png&apos; srcset=&apos;/static/7bd6abe92817db22e1b03707e8f909f2/e7570/img_9.png 170w,
/static/7bd6abe92817db22e1b03707e8f909f2/f46e7/img_9.png 340w,
/static/7bd6abe92817db22e1b03707e8f909f2/ca1dc/img_9.png 680w,
/static/7bd6abe92817db22e1b03707e8f909f2/02d09/img_9.png 1020w,
/static/7bd6abe92817db22e1b03707e8f909f2/fcbeb/img_9.png 1206w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;중요!&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;레플리케이션에서는 이 &lt;code class=&quot;language-text&quot;&gt;File&lt;/code&gt;과 &lt;code class=&quot;language-text&quot;&gt;Position&lt;/code&gt; 값으로 &lt;code class=&quot;language-text&quot;&gt;Master - Slave&lt;/code&gt; 서버 동기화가 진행이 됩니다. 또한&lt;code class=&quot;language-text&quot;&gt;File&lt;/code&gt;과 &lt;code class=&quot;language-text&quot;&gt;Position&lt;/code&gt;은 데이터베이스에서 어떤 작업을 할 때마다 변경이 됩니다. &lt;code class=&quot;language-text&quot;&gt;Master DB&lt;/code&gt;의 해당 정보들을 &lt;code class=&quot;language-text&quot;&gt;Slave DB&lt;/code&gt;에서 기입해서 사용하기 때문에, 항상 확인 후 &lt;code class=&quot;language-text&quot;&gt;Master - Slave&lt;/code&gt; 연동을 진행해야 합니다.&lt;/p&gt;
&lt;h3&gt;Slave DB Server 작업&lt;/h3&gt;
&lt;p&gt;이어서 위에서 설명했던 내용을 바탕으로 &lt;code class=&quot;language-text&quot;&gt;Slave DB&lt;/code&gt;를 설정해 줍니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token constant&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;DATABASE&lt;/span&gt; test&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token constant&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;USER&lt;/span&gt; &lt;span class=&quot;token char&quot;&gt;&apos;slave&apos;&lt;/span&gt;@&lt;span class=&quot;token char&quot;&gt;&apos;%&apos;&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;IDENTIFIED&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;BY&lt;/span&gt; &apos;password&apos;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token constant&quot;&gt;GRANT&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;ALL&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;PRIVILEGES&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;ON&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;* &lt;span class=&quot;token constant&quot;&gt;TO&lt;/span&gt; &lt;span class=&quot;token char&quot;&gt;&apos;slave&apos;&lt;/span&gt;@&lt;span class=&quot;token char&quot;&gt;&apos;%&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;$ vim &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;etc&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;mysql&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;my&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;cnf

&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;mysqld&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;

max_allowed_packet&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1000&lt;/span&gt;M
server&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;id &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;
log&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;bin  &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; mysql&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;bin
binlog_format   &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ROW&lt;/span&gt;
max_binlog_size &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;500&lt;/span&gt;M
sync_binlog     &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
expire&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;logs&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;days&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;7&lt;/span&gt;
slow_query_log &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
read_only &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;설정을 변경했기 때문에 역시 MySQL을 재시작 해줍니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; systemctl restart mysql&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;그리고 최종적으로 &lt;code class=&quot;language-text&quot;&gt;MySQL&lt;/code&gt;에서 아래 쿼리를 실행해주면 됩니다. 여기서 &lt;code class=&quot;language-text&quot;&gt;MASTER_LOG_FILE&lt;/code&gt;과  &lt;code class=&quot;language-text&quot;&gt;MASTER_LOG_POS&lt;/code&gt; 값은 아까 &lt;code class=&quot;language-text&quot;&gt;Master DB STATUS&lt;/code&gt;에서 나온 값으로 설정을 하면 됩니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token class-name&quot;&gt;RESET&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;SLAVE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token constant&quot;&gt;CHANGE&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;MASTER&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;TO&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;MASTER_HOST&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&apos;xxx&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;xxx&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;x&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;xxx&apos;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// private IP&lt;/span&gt;
        &lt;span class=&quot;token constant&quot;&gt;MASTER_USER&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token char&quot;&gt;&apos;master&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token constant&quot;&gt;MASTER_PORT&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;8080&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;                     &lt;span class=&quot;token comment&quot;&gt;// 내부적인 이슈로 8080 포트로 연결&lt;/span&gt;
        &lt;span class=&quot;token constant&quot;&gt;MASTER_PASSWORD&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&apos;password&apos;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token constant&quot;&gt;MASTER_LOG_FILE&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&apos;mysql&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;bin&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;00000&lt;/span&gt;x&apos;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token constant&quot;&gt;MASTER_LOG_POS&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;157&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token class-name&quot;&gt;START&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;REPLICA&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;지금까지 잘 설정이 되었다면, 다음 명령어를 입력했을 때 문제가 없다는 것을 확인할 수 있습니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;show slave status\&lt;span class=&quot;token class-name&quot;&gt;G&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 629px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/1b3a1fee510412f41c8f794d99d32f26/7e5f2/img_12.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 114.11764705882352%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAXCAYAAAALHW+jAAAACXBIWXMAAAsTAAALEwEAmpwYAAACpElEQVQ4y52VWXPaUAyFeWs77bSJMZiAAS8YbxgwZt+X7P///6g68lLaCUzog+bahHxXOjoSpWC6I2+8Jn+6pd78wLGX04gmZA3mZA8X1IkXfM7J7E/J4WdrMCOt06Oq3UvPsygVH9ohGb0JDVYnijdPcknTCahhe6S1HTLChNq9MdkMsxhcc6ILwE76oWoGVHcHAhuuHyngjMPZjjS+SDV9qvApYQUSH8EEmKfe9EcCG6weKdm9SulusqRWEJPD5erekFTDowrglv8hLCs5pFq3L5oBiJgc3iiYbKhueVTWTapyyUrDpF+1FkeT7urGdeADAyE6YMnuRYD95YlCzrLF2nXiJTWDJCszugjLSo5EP3QQoGSbAqPFUS7KdcPFuTwSl4Aqf7nhDrkRT4WGk/0budzlsuEXGV3L6i+g7sdZI14Eig4jS9gGmX0WVADrnB0CvkLA1LjATdYXzXsVCI2gD8TH1CBDlAwN0flKrt1ngbk+yC63zfT4LsAOj11ufO0WIDLEWMHMGL3UNkeRovo/GUJ8lDvmCUFmmBSPjZ3DbtPQCos5hn7R4iAdR7ll07+9y81gVJSb+vBEo+2zLAcY++aSAQMUXXZGy7Qx7EcAG16qYTod4VlclqGE7j50B/Iln3VDufHmmY29IU282ZfQskifo4srrITMsDChWW6bESYlWdG9bpHStEnRz8MilbdPi5cFktHObKXl20Y105kFFE2BDwH8+lPhuC/iG79/+XFH35Vqtn3+LFzsBAyBAKEhfIeVhU6P96/SHIxhm38WoDOmBhAje29lz6gwrXJG2AvFPnR458GLmGOUjfUPHfGPMLjuxWKtBp9oFk4AsKnwjqTQCwF2uTwY2uUznO1lUmBspe2mZUlpYVbiP3H2W4O//wZozaCgOuMgWwAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 12&apos; title=&apos;img 12&apos; src=&apos;/static/1b3a1fee510412f41c8f794d99d32f26/7e5f2/img_12.png&apos; srcset=&apos;/static/1b3a1fee510412f41c8f794d99d32f26/e7570/img_12.png 170w,
/static/1b3a1fee510412f41c8f794d99d32f26/f46e7/img_12.png 340w,
/static/1b3a1fee510412f41c8f794d99d32f26/7e5f2/img_12.png 629w&apos; sizes=&apos;(max-width: 629px) 100vw, 629px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;추가적으로 &lt;code class=&quot;language-text&quot;&gt;Master DB&lt;/code&gt; 서버에서 테이블 생성과 데이터 생성을 해보면 바로 &lt;code class=&quot;language-text&quot;&gt;Slave DB&lt;/code&gt; 서버에 잘 반영되는 것을 확인할 수 있습니다.&lt;/p&gt;
&lt;p&gt;[Master DB]&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/88e3c52e23d1c8c35efab4512e0ad0b2/9d567/img_10.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 5.294117647058823%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAAAsTAAALEwEAmpwYAAAATElEQVQI1y3JaRJAIACAUTdBtrEklCJjyf3v9DHG3/ci6QO13WncgVwD7XLSrRdqu6nMRtrPCGXJx4Vi8sSdJhscpfafp/+J1xJpeADycB9o9AYL7QAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 10&apos; title=&apos;img 10&apos; src=&apos;/static/88e3c52e23d1c8c35efab4512e0ad0b2/ca1dc/img_10.png&apos; srcset=&apos;/static/88e3c52e23d1c8c35efab4512e0ad0b2/e7570/img_10.png 170w,
/static/88e3c52e23d1c8c35efab4512e0ad0b2/f46e7/img_10.png 340w,
/static/88e3c52e23d1c8c35efab4512e0ad0b2/ca1dc/img_10.png 680w,
/static/88e3c52e23d1c8c35efab4512e0ad0b2/02d09/img_10.png 1020w,
/static/88e3c52e23d1c8c35efab4512e0ad0b2/9d567/img_10.png 1360w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;[Slave DB]&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/3c5f60d8c700d5daa09b5d2a36d78a36/9d567/img_11.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 15.294117647058824%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAATklEQVQI12PQNLP9r2Zs9R9Eg7CsttF/STXd/2Iq2v/FVXVIxgwgw5QNzP/LaRv/l9c1+a+oZ/pfWtOAfANBhikADQEZpKRvBmZLUOBCAO5pVjAd8mCvAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 11&apos; title=&apos;img 11&apos; src=&apos;/static/3c5f60d8c700d5daa09b5d2a36d78a36/ca1dc/img_11.png&apos; srcset=&apos;/static/3c5f60d8c700d5daa09b5d2a36d78a36/e7570/img_11.png 170w,
/static/3c5f60d8c700d5daa09b5d2a36d78a36/f46e7/img_11.png 340w,
/static/3c5f60d8c700d5daa09b5d2a36d78a36/ca1dc/img_11.png 680w,
/static/3c5f60d8c700d5daa09b5d2a36d78a36/02d09/img_11.png 1020w,
/static/3c5f60d8c700d5daa09b5d2a36d78a36/9d567/img_11.png 1360w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2&gt;SpringBoot 설정&lt;/h2&gt;
&lt;p&gt;DB 서버를 &lt;code class=&quot;language-text&quot;&gt;Master - Slave&lt;/code&gt; 로 이중화 하였으므로, &lt;code class=&quot;language-text&quot;&gt;SpringBoot&lt;/code&gt;에서 사용하는 &lt;code class=&quot;language-text&quot;&gt;DataSource&lt;/code&gt;도 &lt;code class=&quot;language-text&quot;&gt;Master - Slave&lt;/code&gt;를 각각 사용해야 합니다. 이를 구현하기 위한 방법으로 &lt;code class=&quot;language-text&quot;&gt;@Transactional&lt;/code&gt; 애노테이션의 속성을 이용하여 &lt;code class=&quot;language-text&quot;&gt;readOnly = false&lt;/code&gt;인 트랜잭션은 &lt;code class=&quot;language-text&quot;&gt;Master DataSource&lt;/code&gt;를, &lt;code class=&quot;language-text&quot;&gt;readOnly = true&lt;/code&gt;인 트랜잭션은 &lt;code class=&quot;language-text&quot;&gt;Slave DataSource&lt;/code&gt;를 사용하도록 설정해 주겠습니다.&lt;/p&gt;
&lt;h3&gt;application.yml 설정&lt;/h3&gt;
&lt;p&gt;저는 &lt;code class=&quot;language-text&quot;&gt;Master 1&lt;/code&gt;, &lt;code class=&quot;language-text&quot;&gt;Slave 2&lt;/code&gt; 를 바탕으로 &lt;code class=&quot;language-text&quot;&gt;Replication&lt;/code&gt;을 구성했기 때문에 3개의 &lt;code class=&quot;language-text&quot;&gt;DataSource&lt;/code&gt;에 대한 설정을 작성해주어야 합니다. 여기서 하나 유의해야 할 점은 일반적인 &lt;code class=&quot;language-text&quot;&gt;DataSource&lt;/code&gt; 등록 방법과는 과정이 조금 달라진다는 점입니다.&lt;/p&gt;
&lt;p&gt;하나의 &lt;code class=&quot;language-text&quot;&gt;DataSource&lt;/code&gt;만 사용하는 경우에는 &lt;code class=&quot;language-text&quot;&gt;SpringBoot AutoConfiguration&lt;/code&gt;을 통해서 자동으로 빈으로 만들어져 관리되었지만, 2개 이상의 &lt;code class=&quot;language-text&quot;&gt;DataSource&lt;/code&gt;를 사용하는 경우에는 개발자가 직접 빈을 만들어서 사용해야 합니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yaml&quot;&gt;&lt;pre class=&quot;language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;&lt;span class=&quot;token key atrule&quot;&gt;spring&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;datasource&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;master&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token key atrule&quot;&gt;username&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; master
      &lt;span class=&quot;token key atrule&quot;&gt;password&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; password
      &lt;span class=&quot;token key atrule&quot;&gt;driver-class-name&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; com.mysql.cj.jdbc.Driver
      &lt;span class=&quot;token key atrule&quot;&gt;jdbc-url&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; jdbc&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;mysql&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;//XXX.XXX.XXX.XXX&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;3306/test
    &lt;span class=&quot;token key atrule&quot;&gt;slave1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token key atrule&quot;&gt;username&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; slave1
      &lt;span class=&quot;token key atrule&quot;&gt;password&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; password
      &lt;span class=&quot;token key atrule&quot;&gt;driver-class-name&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; com.mysql.cj.jdbc.Driver
      &lt;span class=&quot;token key atrule&quot;&gt;jdbc-url&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; jdbc&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;mysql&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;//XXX.XXX.XXX.XXX&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;3306/test
	&lt;span class=&quot;token key atrule&quot;&gt;slave2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token key atrule&quot;&gt;username&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; slave2
      &lt;span class=&quot;token key atrule&quot;&gt;password&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; password
      &lt;span class=&quot;token key atrule&quot;&gt;driver-class-name&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; com.mysql.cj.jdbc.Driver
      &lt;span class=&quot;token key atrule&quot;&gt;jdbc-url&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; jdbc&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;mysql&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;//XXX.XXX.XXX.XXX&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;3306/test&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;DataSource 빈 등록&lt;/h3&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token annotation punctuation&quot;&gt;@Configuration&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;DataSourceConfig&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;MASTER_SERVER&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;MASTER&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;SLAVE1_SERVER&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;SLAVE1&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;SLAVE1_SERVER&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;SLAVE2&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token annotation punctuation&quot;&gt;@Bean&lt;/span&gt;
    &lt;span class=&quot;token annotation punctuation&quot;&gt;@Qualifier&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;MASTER_SERVER&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token annotation punctuation&quot;&gt;@ConfigurationProperties&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;prefix &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;spring.datasource.master&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;DataSource&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;masterDataSource&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;DataSourceBuilder&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;create&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;build&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token annotation punctuation&quot;&gt;@Bean&lt;/span&gt;
    &lt;span class=&quot;token annotation punctuation&quot;&gt;@Qualifier&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;SLAVE1_SERVER&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token annotation punctuation&quot;&gt;@ConfigurationProperties&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;prefix &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;spring.datasource.slave1&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;DataSource&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;slave1DataSource&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;DataSourceBuilder&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;create&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;build&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token annotation punctuation&quot;&gt;@Bean&lt;/span&gt;
    &lt;span class=&quot;token annotation punctuation&quot;&gt;@Qualifier&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;SLAVE2_SERVER&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token annotation punctuation&quot;&gt;@ConfigurationProperties&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;prefix &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;spring.datasource.slave2&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;DataSource&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;slave2DataSource&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;DataSourceBuilder&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;create&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;build&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;다음과 같이 각 DB 서버에 대응되는 &lt;code class=&quot;language-text&quot;&gt;DataSource&lt;/code&gt; 타입의 빈을 등록하면 됩니다.&lt;/p&gt;
&lt;p&gt;위의 코드를 보면, &lt;code class=&quot;language-text&quot;&gt;@Qualifier&lt;/code&gt; 애노테이션을 사용한 것을 확인할 수 있습니다. 일반적으로 같은 타입 (여기서는 DataSource)의 빈이 2개 이상 등록된 경우 스프링은 어떤 빈을 주입해야 하는지 모릅니다. 이를 해결하기 위해서 &lt;code class=&quot;language-text&quot;&gt;@Qualifier&lt;/code&gt; 애노테이션을 사용하여 &lt;strong&gt;이름을 기반으로 한정자를 명시하여서, 주입받을 빈을 지정&lt;/strong&gt;할 수 있도록 만들면 됩니다.&lt;/p&gt;
&lt;p&gt;추가적으로 &lt;code class=&quot;language-text&quot;&gt;@ConfigurationProperties&lt;/code&gt; ****애노테이션을 사용한 것을 확인할 수 있습니다. 해당 애노테이션을 사용하면 &lt;code class=&quot;language-text&quot;&gt;application.yml&lt;/code&gt;에 명시한 여러 설정 중, 특정 &lt;code class=&quot;language-text&quot;&gt;prefix&lt;/code&gt;에 해당하는 설정 값을 자바 빈에 매핑할 수가 있습니다.&lt;/p&gt;
&lt;h3&gt;AbstractRoutingDataSource&lt;/h3&gt;
&lt;p&gt;스프링은 &lt;code class=&quot;language-text&quot;&gt;Multi DataSource&lt;/code&gt; 환경에서 여러 &lt;code class=&quot;language-text&quot;&gt;DataSource&lt;/code&gt;를 묶고 분기해주기 위해서 &lt;code class=&quot;language-text&quot;&gt;AbstractRoutingDataSource&lt;/code&gt;라는 추상 클래스를 지원합니다.&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;AbstractRoutingDataSource&lt;/code&gt; 를 살펴보면 다음과 같이 구성되어 있는 것을 확인할 수 있습니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;abstract&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;AbstractRoutingDataSource&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;AbstractDataSource&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;InitializingBean&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

	&lt;span class=&quot;token annotation punctuation&quot;&gt;@Nullable&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Map&lt;/span&gt;&lt;span class=&quot;token generics&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Object&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Object&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt; targetDataSources&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

	&lt;span class=&quot;token annotation punctuation&quot;&gt;@Nullable&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Object&lt;/span&gt; defaultTargetDataSource&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

	&lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;boolean&lt;/span&gt; lenientFallback &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

	&lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;DataSourceLookup&lt;/span&gt; dataSourceLookup &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;JndiDataSourceLookup&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

	&lt;span class=&quot;token annotation punctuation&quot;&gt;@Nullable&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Map&lt;/span&gt;&lt;span class=&quot;token generics&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Object&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;DataSource&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt; resolvedDataSources&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

	&lt;span class=&quot;token annotation punctuation&quot;&gt;@Nullable&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;DataSource&lt;/span&gt; resolvedDefaultDataSource&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

	&lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;setTargetDataSources&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Map&lt;/span&gt;&lt;span class=&quot;token generics&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Object&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Object&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt; targetDataSources&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;targetDataSources &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; targetDataSources&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;

	&lt;span class=&quot;token keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;DataSource&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;determineTargetDataSource&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;token class-name&quot;&gt;Assert&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;notNull&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;resolvedDataSources&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;DataSource router not initialized&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token class-name&quot;&gt;Object&lt;/span&gt; lookupKey &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;determineCurrentLookupKey&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token class-name&quot;&gt;DataSource&lt;/span&gt; dataSource &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;resolvedDataSources&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;lookupKey&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dataSource &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lenientFallback &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; lookupKey &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
			dataSource &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;resolvedDefaultDataSource&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dataSource &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;token keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;IllegalStateException&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Cannot determine target DataSource for lookup key [&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; lookupKey &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;]&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; dataSource&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;위의 코드를 보면 &lt;code class=&quot;language-text&quot;&gt;setTargetDataSources()&lt;/code&gt;라는 메서드를 통해 &lt;code class=&quot;language-text&quot;&gt;Map&lt;/code&gt;을 전달합니다. 이때 &lt;code class=&quot;language-text&quot;&gt;Map&lt;/code&gt;의 &lt;code class=&quot;language-text&quot;&gt;Value&lt;/code&gt;로는 &lt;code class=&quot;language-text&quot;&gt;DataSource&lt;/code&gt;를 전달합니다. 전달된 &lt;code class=&quot;language-text&quot;&gt;DataSource&lt;/code&gt;는 &lt;code class=&quot;language-text&quot;&gt;Map&lt;/code&gt;의 &lt;code class=&quot;language-text&quot;&gt;Key&lt;/code&gt;를 통해서 찾을 수 있습니다.&lt;/p&gt;
&lt;p&gt;또한 &lt;code class=&quot;language-text&quot;&gt;determineTargetDataSource()&lt;/code&gt;메서드를 보면 실제로 사용된 &lt;code class=&quot;language-text&quot;&gt;DataSource&lt;/code&gt;를 결정합니다. 내부 코드를 확인해보면 &lt;code class=&quot;language-text&quot;&gt;determineCurrentLookupKey()&lt;/code&gt; 라는 메서드를 사용해서 가져올 &lt;code class=&quot;language-text&quot;&gt;DataSource&lt;/code&gt;의 &lt;code class=&quot;language-text&quot;&gt;Key&lt;/code&gt;를 결정합니다.&lt;/p&gt;
&lt;p&gt;실제 저희가 이를 활용하기 위해서 &lt;code class=&quot;language-text&quot;&gt;AbstractRoutingDataSource&lt;/code&gt; 를 상속받는 구체 클래스를 만들어서 위에서 언급한 &lt;code class=&quot;language-text&quot;&gt;determineCurrentLookupKey()&lt;/code&gt;메서드를 오버라이드하여 트랜잭션의 &lt;code class=&quot;language-text&quot;&gt;readOnly&lt;/code&gt; 값에 따라 다른 &lt;code class=&quot;language-text&quot;&gt;DataSource&lt;/code&gt; 의 &lt;code class=&quot;language-text&quot;&gt;Key&lt;/code&gt;를 반환하도록 구현하겠습니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;RoutingDataSource&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;AbstractRoutingDataSource&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;RoutingCircular&lt;/span&gt;&lt;span class=&quot;token generics&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt; routingCircular&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token annotation punctuation&quot;&gt;@Override&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;setTargetDataSources&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Map&lt;/span&gt;&lt;span class=&quot;token generics&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Object&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Object&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt; targetDataSources&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;super&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;setTargetDataSources&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;targetDataSources&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

        routingCircular &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;RoutingCircular&lt;/span&gt;&lt;span class=&quot;token generics&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
                targetDataSources&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;keySet&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;stream&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
                        &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Object&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;toString&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
                        &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;filter&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;key &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; key&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;contains&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;slave&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
                        &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;collect&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Collectors&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;toList&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;		

    &lt;span class=&quot;token annotation punctuation&quot;&gt;@Override&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Object&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;determineCurrentLookupKey&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;boolean&lt;/span&gt; isReadOnly &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;TransactionSynchronizationManager&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;isCurrentTransactionReadOnly&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;isReadOnly&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; routingCircular&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getOne&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;master&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;해당 코드를 보면, &lt;code class=&quot;language-text&quot;&gt;TransactionSynchronizationManager&lt;/code&gt;의 &lt;code class=&quot;language-text&quot;&gt;isCurrentTransactionReadOnly()&lt;/code&gt;라는 메서드를 사용하였는데, 이를 통해서 현재 트랜잭션의 &lt;code class=&quot;language-text&quot;&gt;read-only&lt;/code&gt; 여부를 확인할 수 있습니다.&lt;/p&gt;
&lt;h3&gt;Slave DB의 다중화 처리&lt;/h3&gt;
&lt;p&gt;위의 코드에서는 한가지 설명하지 않은 부분이 있습니다. 바로 &lt;code class=&quot;language-text&quot;&gt;setTargetDataSources()&lt;/code&gt;과 관련된 설명인데요. 저는 &lt;strong&gt;&lt;code class=&quot;language-text&quot;&gt;Slave DB&lt;/code&gt;를 2개 이상 사용하려고 하기 때문에 &lt;code class=&quot;language-text&quot;&gt;readOnly&lt;/code&gt; 속성만으로는 이를 해결할 수 없습니다&lt;/strong&gt;. 이를 해결하기 위해서 &lt;code class=&quot;language-text&quot;&gt;Slave DB&lt;/code&gt;를 번갈아서 사용하도록 기능을 추가해주도록 하겠습니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;RoutingCircular&lt;/span&gt;&lt;span class=&quot;token generics&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;T&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;List&lt;/span&gt;&lt;span class=&quot;token generics&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;T&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt; dataSources&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Integer&lt;/span&gt; counter &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        
    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;RoutingCircular&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;List&lt;/span&gt;&lt;span class=&quot;token generics&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;T&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt; dataSources&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;dataSources &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; dataSources&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
		
    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;T&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;getOne&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; circularSize &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; dataSources&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;counter &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; circularSize&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            counter &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; dataSources&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;counter&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; circularSize&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;다음과 같이 &lt;code class=&quot;language-text&quot;&gt;RoutingCircular&lt;/code&gt; 클래스를 만들어 통해서 &lt;strong&gt;여러개의 &lt;code class=&quot;language-text&quot;&gt;Slave DB&lt;/code&gt;의 &lt;code class=&quot;language-text&quot;&gt;DataSource&lt;/code&gt;를 순서대로 로드밸런싱&lt;/strong&gt; 할 수 있게 됩니다.&lt;/p&gt;
&lt;h3&gt;라우팅할 DataSource 등록하기&lt;/h3&gt;
&lt;p&gt;지금까지 위에서 만든 &lt;code class=&quot;language-text&quot;&gt;RoutingDataSource&lt;/code&gt;에 우리가 사용할 3가지의 &lt;code class=&quot;language-text&quot;&gt;DataSource&lt;/code&gt; 정보를 등록하고, 이를 빈으로 만들어서 최종적으로 스프링에서 관리되도록 작업을 처리해주겠습니다. &lt;code class=&quot;language-text&quot;&gt;@Qualifier&lt;/code&gt;를 이용해서 어떤 빈을 주입받을 것인지 명확히 지시해서 작업을 진행합니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token annotation punctuation&quot;&gt;@Bean&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;DataSource&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;routingDataSource&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token annotation punctuation&quot;&gt;@Qualifier&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;MASTER_SERVER&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;DataSource&lt;/span&gt; masterDataSource&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
																		&lt;span class=&quot;token annotation punctuation&quot;&gt;@Qualifier&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;SLAVE1_SERVER&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;DataSource&lt;/span&gt; slave1DataSource&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
																		&lt;span class=&quot;token annotation punctuation&quot;&gt;@Qualifier&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;SLAVE2_SERVER&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;DataSource&lt;/span&gt; slave2DataSoucre&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token class-name&quot;&gt;RoutingDataSource&lt;/span&gt; routingDataSource &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;RoutingDataSource&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token class-name&quot;&gt;HashMap&lt;/span&gt;&lt;span class=&quot;token generics&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Object&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Object&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt; dataSources &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;HashMap&lt;/span&gt;&lt;span class=&quot;token generics&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    dataSources&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;put&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;master&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; masterDataSource&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    dataSources&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;put&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;slave1&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; slave1DataSource&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    dataSources&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;put&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;slave2&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; slave2DataSource&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    routingDataSource&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;setTargetDataSources&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dataSources&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    routingDataSource&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;setDefaultTargetDataSource&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;masterDataSource&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; routingDataSource&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;해당 과정을 통해서 우리가 구현한 &lt;code class=&quot;language-text&quot;&gt;RoutingDataSource&lt;/code&gt;의 인스턴스를 생성한 뒤, 등록해 줄 각각의 &lt;code class=&quot;language-text&quot;&gt;DataSource&lt;/code&gt;를 &lt;code class=&quot;language-text&quot;&gt;String Type&lt;/code&gt;의 &lt;code class=&quot;language-text&quot;&gt;Key&lt;/code&gt;로 매핑하고, 기본 &lt;code class=&quot;language-text&quot;&gt;DataSource&lt;/code&gt;를 &lt;code class=&quot;language-text&quot;&gt;Master&lt;/code&gt;로 지정한 뒤 &lt;code class=&quot;language-text&quot;&gt;Bean&lt;/code&gt;으로 등록을 해줄 수 있습니다.&lt;/p&gt;
&lt;p&gt;그리고 실제 &lt;code class=&quot;language-text&quot;&gt;Spring Boot&lt;/code&gt;에서 사용하게 될 &lt;code class=&quot;language-text&quot;&gt;DataSource&lt;/code&gt; 를 만드는 작업을 수행하면 됩니다. &lt;strong&gt;여기서 고려해야 할 점은 스프링이 &lt;code class=&quot;language-text&quot;&gt;DataSource&lt;/code&gt;를 통해 &lt;code class=&quot;language-text&quot;&gt;Connection&lt;/code&gt;을 획득하는 일련의 주기에 대해서 확인할 필요가 있습니다.&lt;/strong&gt;&lt;/p&gt;
&lt;h3&gt;Spring의 Connection 획득 방법과 LazyConnection 처리&lt;/h3&gt;
&lt;p&gt;스프링은 트랜잭션에 진입하기만 하면 바로 &lt;code class=&quot;language-text&quot;&gt;DataSource&lt;/code&gt;를 가져와서 &lt;code class=&quot;language-text&quot;&gt;Connection&lt;/code&gt;을 가져옵니다. 말로만 하면 너무 추상적이니 Spring에서 Transactional을 처리하는 과정을 자세하게 한번 알아봅시다. 밑에 정리된 순서대로 Spring Transactional이 동작을 하게 됩니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token number&quot;&gt;1.&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;CglibAopProxy&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;DynamicAdvisedInterceptor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;intercept&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token number&quot;&gt;2.&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;TransactionInterceptor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;invoke&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token number&quot;&gt;3.&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;TransactionAspectSupport&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;invokeWithinTransaction&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token number&quot;&gt;4.&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;TransactionAspectSupport&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;createTransactionIfNecessary&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token number&quot;&gt;5.&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;AbstractPlatformTransactionManager&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getTransaction&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token number&quot;&gt;6.&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;AbstractPlatformTransactionManager&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;startTransaction&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token number&quot;&gt;7.&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;AbstractPlatformTransactionManager&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;begin&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token number&quot;&gt;8.&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;AbstractPlatformTransactionManager&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;prepareSynchronization&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token number&quot;&gt;9.&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;TransactionAspectSupport&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;invokeWithinTransaction&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token number&quot;&gt;10.&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;InvocationCallback&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;proceedWithInvocation&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token number&quot;&gt;11.&lt;/span&gt; &lt;span class=&quot;token annotation punctuation&quot;&gt;@Transactional&lt;/span&gt;이 적용된 실제 타깃이 실행&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;우리가 여기서 꼭 확인해봐야 할 부분은 7번과 8번 과정입니다. Spring AOP는 7번 과정에서 &lt;code class=&quot;language-text&quot;&gt;DataSource&lt;/code&gt;로 부터 &lt;code class=&quot;language-text&quot;&gt;Connection&lt;/code&gt;을 가져오고 8번 과정에서 트랜잭션의 현재 상태를 &lt;code class=&quot;language-text&quot;&gt;ThreadLocal&lt;/code&gt;에 저장을 하게 됩니다. 즉, &lt;code class=&quot;language-text&quot;&gt;TransactionSynchronizationManager&lt;/code&gt;에 트랜잭션의 정보를 동기화 하는 작업이 &lt;code class=&quot;language-text&quot;&gt;DataSource&lt;/code&gt;로 부터 &lt;code class=&quot;language-text&quot;&gt;Connection&lt;/code&gt;을 가져온 이후에 실행이 된다는 것입니다.&lt;/p&gt;
&lt;p&gt;이때까지의 내용을 그림으로 정리하면 다음과 같습니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/d047ec358a90f192e103890821624d70/c0ee7/img_5.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 28.82352941176471%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABFElEQVQY052RvUoDQRSFF6ys7NXCzmewCIitVlZ5B1vBxhRCQLCwtTSoiIV2gkRRfA7R/CALYYlJJrsxuzNz53MyCkqwEA98nOLOnDuciZiSiMM5wYn5HecCSIHqJ/S6HcZZH9xkBlGz1ea6fue5p/0a8ydJDibF6ndMkSE6wxUDfB7RbvWAmfllorklKvuH4fwweUKea0jjDHk5/fITpHXJeKRIVdcHjdDGkucF1piwIARu7ewRzS56FtiuVNEWVPMBc7OCuV3D1Fe//XGTt06DQc8H5ilJkhDHMelQ+cDsM/Do+JzSepnSRpnaxVV4oTHaVzKawl+wY4wVbJGGDn/K6TR4xH80+QDfmRQqEPrTKow+ACY5tiYTZk2tAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 5&apos; title=&apos;img 5&apos; src=&apos;/static/d047ec358a90f192e103890821624d70/ca1dc/img_5.png&apos; srcset=&apos;/static/d047ec358a90f192e103890821624d70/e7570/img_5.png 170w,
/static/d047ec358a90f192e103890821624d70/f46e7/img_5.png 340w,
/static/d047ec358a90f192e103890821624d70/ca1dc/img_5.png 680w,
/static/d047ec358a90f192e103890821624d70/02d09/img_5.png 1020w,
/static/d047ec358a90f192e103890821624d70/9d567/img_5.png 1360w,
/static/d047ec358a90f192e103890821624d70/c0ee7/img_5.png 1870w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;하지만 저희는 Replication을 위해서 &lt;code class=&quot;language-text&quot;&gt;AbstractRoutingDataSource&lt;/code&gt;을 구현하여 트랜잭션 속성에 따라 &lt;code class=&quot;language-text&quot;&gt;DataSource&lt;/code&gt;를 선택해서 선택한 &lt;code class=&quot;language-text&quot;&gt;DataSource&lt;/code&gt;의 &lt;code class=&quot;language-text&quot;&gt;Connection&lt;/code&gt;객체를 리턴할 수 있도록 구현을 해야 했습니다.&lt;/p&gt;
&lt;p&gt;이러한 문제를 해결하기 위해서 &lt;code class=&quot;language-text&quot;&gt;Spring&lt;/code&gt;에서는 &lt;code class=&quot;language-text&quot;&gt;LazyConnectionDataSourceProxy&lt;/code&gt; 을 제공합니다. &lt;code class=&quot;language-text&quot;&gt;Spring Docs&lt;/code&gt;를 확인해보면 다음과 같은 내용을 확인할 수 있습니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/f9ff4bb6d27ebd645a22301749d8001b/25af7/img_6.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 26.47058823529412%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAvUlEQVQY022QyQrDMAxE/f8/GEIWO3vs7AnBvoRpR+DSQg+PEcLyjKSGYUCapkKWZSjLUpQkSYI8z1FVFYwxom3bwjkLay36vhcdx1HY9x3qvm9s24bjOETJeZ6felmWH67rQggB3vu3+q864HkeKOecODdNA2006rqG1lrc53mWBHxD/UdMx5pmiinYmKZJBqk8w7qukjTCx9yCcDUq+7FH5EMOMl3XdZKOdaQoCumReEeacobG3ICwjud4AdYudd17gQUfAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 6&apos; title=&apos;img 6&apos; src=&apos;/static/f9ff4bb6d27ebd645a22301749d8001b/ca1dc/img_6.png&apos; srcset=&apos;/static/f9ff4bb6d27ebd645a22301749d8001b/e7570/img_6.png 170w,
/static/f9ff4bb6d27ebd645a22301749d8001b/f46e7/img_6.png 340w,
/static/f9ff4bb6d27ebd645a22301749d8001b/ca1dc/img_6.png 680w,
/static/f9ff4bb6d27ebd645a22301749d8001b/02d09/img_6.png 1020w,
/static/f9ff4bb6d27ebd645a22301749d8001b/9d567/img_6.png 1360w,
/static/f9ff4bb6d27ebd645a22301749d8001b/25af7/img_6.png 1608w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;즉, 실제 쿼리를 호출하기 전까지 &lt;code class=&quot;language-text&quot;&gt;JDBC Connection&lt;/code&gt;을 가져오지 않고 &lt;code class=&quot;language-text&quot;&gt;Connection Proxy&lt;/code&gt;를 주고, 대상 메서드 안에서 쿼리가 실제 발생할 때 우리가 작성한 &lt;code class=&quot;language-text&quot;&gt;AbstractRoutingDataSource&lt;/code&gt; 에서 &lt;code class=&quot;language-text&quot;&gt;Connection&lt;/code&gt;을 얻어 쿼리를 실행하도록 로직을 구현할 수 있습니다.&lt;/p&gt;
&lt;p&gt;설명이 굉장히 길었는데요. 이제 밑의 코드와 같이 설정을 해주면 저희가 원하는데로 &lt;code class=&quot;language-text&quot;&gt;DataSource&lt;/code&gt;를 가져올 수 있게 됩니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token annotation punctuation&quot;&gt;@Bean&lt;/span&gt;
&lt;span class=&quot;token annotation punctuation&quot;&gt;@Primary&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;DataSource&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;dataSource&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token class-name&quot;&gt;DataSource&lt;/span&gt; determinedDataSource &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;routingDataSource&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;masterDataSource&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;slave1DataSource&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;slave2DataSource&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;LazyConnectionDataSourceProxy&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;determinedDataSource&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/03cc3f3d23c5758f89c8351ea8b5fbd7/c0ee7/img_7.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 45.88235294117647%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABqUlEQVQoz42Su2sUURTGB2ysUlmlTWeXv0LwgYggETtFW8HSylpsUlkIIkos0mRjChFcYxDSWSiJJMw+kmx2Mzubmd2dmd29u/fx886dTUANkgPfPfcx853vHD4PG8aYU7izEhbDKUYF5NDd/y/yv72cRCnloO3FJAuQ3+4hy1eRX28hv1xHrt8s8uYD5KjLuJfQrlUJqlVaFZ/A7kUc58rw/q4ySCN08yP6oIRurNm8avMHm1fQrc/I8QARhkTtDu1m4JD1U3Svi5lM8Pr9hGfPX/DwyVPeLa9wnjBxB5nsMQy3GHW2IatjepEdi8SrHxxyYfYy3sVZrt29TzqYEO+uodZv2JZvF21v3EGVr5Dsb3AU9hBBC9MoobYXUTsvkf5rjBXmFO43mszMzeNdmmPh0WOnQES76MobdG3J4r2Dqb0lO/aJuykmChGtTbJKiaG/zGDvEyRTwrFdfv7a4fuPLXLy87V8jAnK6Lot6L/CHK5iTgj/+fjUQuoMaGcNHR4VM8tJ0sy2G6M7gbWVOrGNLmyj9R+kZxVyezt8I6xXxWgK4dTl778BpWaYVY2/54UAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 7&apos; title=&apos;img 7&apos; src=&apos;/static/03cc3f3d23c5758f89c8351ea8b5fbd7/ca1dc/img_7.png&apos; srcset=&apos;/static/03cc3f3d23c5758f89c8351ea8b5fbd7/e7570/img_7.png 170w,
/static/03cc3f3d23c5758f89c8351ea8b5fbd7/f46e7/img_7.png 340w,
/static/03cc3f3d23c5758f89c8351ea8b5fbd7/ca1dc/img_7.png 680w,
/static/03cc3f3d23c5758f89c8351ea8b5fbd7/02d09/img_7.png 1020w,
/static/03cc3f3d23c5758f89c8351ea8b5fbd7/9d567/img_7.png 1360w,
/static/03cc3f3d23c5758f89c8351ea8b5fbd7/c0ee7/img_7.png 1870w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;여기서 &lt;code class=&quot;language-text&quot;&gt;@Primary&lt;/code&gt; 애노테이션을 작성해준 것을 확인할 수 있는데, 기본적으로 &lt;code class=&quot;language-text&quot;&gt;Spring Boot&lt;/code&gt;의 &lt;code class=&quot;language-text&quot;&gt;AutoConfiguration&lt;/code&gt;은 한 개의 &lt;code class=&quot;language-text&quot;&gt;DataSource&lt;/code&gt;를 가정하고 설정이 되어 있습니다. 현재는 여러 개의 &lt;code class=&quot;language-text&quot;&gt;DataSource&lt;/code&gt;를 사용하는 경우이기 때문에, &lt;code class=&quot;language-text&quot;&gt;@Primary&lt;/code&gt; 애노테이션을 붙여주어서 &lt;code class=&quot;language-text&quot;&gt;DataSource&lt;/code&gt;에 대한 지정을 해주어야 합니다.&lt;/p&gt;
&lt;p&gt;지금까지 과정이 성공적으로 수행이 되었다면 &lt;code class=&quot;language-text&quot;&gt;Replication&lt;/code&gt;을 정상적으로 동작시킬 수 있습니다.&lt;/p&gt;
&lt;h2&gt;Replication 설계를 하면서 고려한 문제들과 앞으로의 개선방향&lt;/h2&gt;
&lt;h3&gt;데이터 정합성 문제&lt;/h3&gt;
&lt;p&gt;이번 작업을 하면서 가장 고민을 했던 부분입니다.  만약 실시간으로 계속 쿠폰이 발행되고, 한쪽에서는 계속 조회되는 환경이라면 동기화 이전 시점에 조회를 하게 될 경우 &lt;code class=&quot;language-text&quot;&gt;NPE&lt;/code&gt;가 발생하게 될 가능성은 남아있었습니다. 이를 해결하기 위해 다양한 방법을 고민해보았는데 2가지 정도의 방법을 찾을 수 있었습니다.&lt;/p&gt;
&lt;p&gt;첫번째 방법은 &lt;strong&gt;반동기(Semi Async)&lt;/strong&gt; 방식입니다. &lt;code class=&quot;language-text&quot;&gt;MySQL Docs&lt;/code&gt;를 살펴보면 &lt;strong&gt;비동기(Async)&lt;/strong&gt; 방식이 아닌 &lt;strong&gt;반동기(Semi Async)&lt;/strong&gt; 방식을 사용할 수 있다고도 나와있습니다. 해당 방법을 통해서 DB의 성능을 조금 포기하고, &lt;code class=&quot;language-text&quot;&gt;Master - Slave&lt;/code&gt;의 동기화를 조금 더 보장해줍니다. 하지만 이 방식은 &lt;code class=&quot;language-text&quot;&gt;Master&lt;/code&gt;가 특정 세션의 트랜잭션을 처리하기 위해서 &lt;code class=&quot;language-text&quot;&gt;Slave&lt;/code&gt;들 중 적어도 1개가 &lt;code class=&quot;language-text&quot;&gt;ACK&lt;/code&gt; 하거나 &lt;code class=&quot;language-text&quot;&gt;timed out&lt;/code&gt;에 도달할 때까지 기다리기 때문에 성능에 악영향을 미쳐 &lt;code class=&quot;language-text&quot;&gt;Replication&lt;/code&gt;의 이점을 살리지 못한다는 생각이 들었습니다.&lt;/p&gt;
&lt;p&gt;두번째 방법은 &lt;strong&gt;타입 스탬프&lt;/strong&gt; 방식입니다. 최근 N초 ~ N분 까지의 갱신 내역은 &lt;code class=&quot;language-text&quot;&gt;Master&lt;/code&gt;에서 읽고, 이후 내역은 &lt;code class=&quot;language-text&quot;&gt;Slave&lt;/code&gt; 에서 읽는 방법이라고 할 수 있습니다. 이 방법은 &lt;code class=&quot;language-text&quot;&gt;Master&lt;/code&gt;에 트래픽이 많이 몰려 &lt;code class=&quot;language-text&quot;&gt;Master&lt;/code&gt;의 장애 위험이 높다는 생각이 들었습니다.&lt;/p&gt;
&lt;p&gt;결론적으로 저는 지금처럼 &lt;code class=&quot;language-text&quot;&gt;MySQL Replication&lt;/code&gt;에서 기본적으로 제공하는 &lt;strong&gt;비동기&lt;/strong&gt; 방식으로 처리를 하고, 데이터 불일치 현상을 다른 방식으로 해결하기로 결론을 내렸습니다.&lt;/p&gt;
&lt;p&gt;현재 생각하는 해결방법은 &lt;strong&gt;정합성이 중요한 로직에서는 조회 요청 역시 &lt;code class=&quot;language-text&quot;&gt;Master DB&lt;/code&gt;를 타게끔 설정하는 것&lt;/strong&gt; 입니다. 물론 &lt;code class=&quot;language-text&quot;&gt;Master DB&lt;/code&gt;의 부하가 생기겠지만, &lt;code class=&quot;language-text&quot;&gt;Replication&lt;/code&gt;을 진행하지 않았을 때보다는 훨씬 부하를 분산시킬 수 있기 때문에 현재 가용할 수 있는 최대한의 &lt;code class=&quot;language-text&quot;&gt;Scale - up&lt;/code&gt;을 한 후, &lt;code class=&quot;language-text&quot;&gt;Master DB&lt;/code&gt;를 통해 정합성 문제를 처리하기로 결론을 내렸습니다.&lt;/p&gt;
&lt;h3&gt;Master 장애시 Slave의 승격 여부&lt;/h3&gt;
&lt;p&gt;만약 &lt;code class=&quot;language-text&quot;&gt;Master&lt;/code&gt;가 장애가 난다면 &lt;code class=&quot;language-text&quot;&gt;Slave&lt;/code&gt; 하나를 승격시켜서 이를 &lt;code class=&quot;language-text&quot;&gt;Master&lt;/code&gt; 처럼 사용해야 할 것입니다. 지금 구조에서 문제라고 생각하는 점은 &lt;code class=&quot;language-text&quot;&gt;Master&lt;/code&gt; 장애시 관리자가 수동으로 이를 처리해야 한다는 점입니다.&lt;/p&gt;
&lt;p&gt;이러한 문제를 &lt;code class=&quot;language-text&quot;&gt;Group Replicaiton&lt;/code&gt;으로 해결해줄 수 있다고 합니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/b43b3b2a4d2983419700510021171b73/03d4c/img_8.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 61.1764705882353%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAABr0lEQVQoz22S14oCURBE7/9/jj74og+KCmbMOeecBWMtp2EW2Z2By9xQXV3V3U5f3+fzscV3Op3U6/W02WxULpfVarVs3+/3dbvdfvF/P/dN5v3v97uOx6PW67W2262SyaTS6bTtl8ulDoeDYfxI/xECrNfryuVyymQyCgQCajQams/nSqVSms1mRjqdTv0JPZvew/V6teBqtapoNKpsNmtWV6uVJSkUCvY+mUwM/36/9c3h5PNRp1AopHg8rlqtpsFgoOFwqFgspnA4rEgkovF47Bcq93g8tFgszAZBqCgWixqNRkbsNSSfz6tUKhk5Z/ZgwRGPi9frJUfhucQqYM5e0ff7vS6Xi9UNi2B4P5/P1iDuiaXrKIbU8dDpdEwdmfjTDBTRXRoEiRfMOEEMjiTUs9vt2vtut5NDTaVSsTEBSBaawZgEg8HfzmKfhjCbCEgkEqYMB3ScZHA5WLnAHmpZNIJgagkRCxWUhEDscSYGASzc4cQsAwIAUbvdtgZRQ68cNAFlEKMCZezB4w4MZxK45/NpM8aCgCxko/CUwZvJZrNpbwRx7ykjObHcM4c/UAV72WlNxcYAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 8&apos; title=&apos;img 8&apos; src=&apos;/static/b43b3b2a4d2983419700510021171b73/ca1dc/img_8.png&apos; srcset=&apos;/static/b43b3b2a4d2983419700510021171b73/e7570/img_8.png 170w,
/static/b43b3b2a4d2983419700510021171b73/f46e7/img_8.png 340w,
/static/b43b3b2a4d2983419700510021171b73/ca1dc/img_8.png 680w,
/static/b43b3b2a4d2983419700510021171b73/02d09/img_8.png 1020w,
/static/b43b3b2a4d2983419700510021171b73/03d4c/img_8.png 1266w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Group Replication&lt;/code&gt;을 사용하면 &lt;code class=&quot;language-text&quot;&gt;Master DB&lt;/code&gt; 장애시 자동으로 &lt;code class=&quot;language-text&quot;&gt;Slave DB&lt;/code&gt;가 &lt;code class=&quot;language-text&quot;&gt;Master DB&lt;/code&gt;로 승격되는 장점이 있습니다. 이러한 이유 때문에 현재 구조인 &lt;code class=&quot;language-text&quot;&gt;Master - Slave Replication&lt;/code&gt; 구조에서 &lt;code class=&quot;language-text&quot;&gt;Group Replication&lt;/code&gt;으로 변경하는 것이 조금 더 장애 대처에 좋을 것이라 생각이 드는데 정확한 내용은 조금 더 학습을 해봐야 할 것으로 보입니다.&lt;/p&gt;
&lt;h2&gt;Replication 작업 과정에서 겪을 수도 있는 문제들&lt;/h2&gt;
&lt;h3&gt;Public key retrieval is not allowed&lt;/h3&gt;
&lt;p&gt;MySQL DB에 접속하려면 기본적으로 url, username, password 3가지 옵션이 필요합니다. 하지만 MySQL 8.0 버전부터는 보안적인 이슈로 &lt;code class=&quot;language-text&quot;&gt;useSSL&lt;/code&gt; 옵션에 대한 추가적인 설정이 필요합니다.&lt;/p&gt;
&lt;p&gt;다음 두 가지 옵션이 필요한데 이는 다음과 같습니다.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;useSSL : DB에 SSL로 연결&lt;/li&gt;
&lt;li&gt;allowPublicKeyRetrieval: 클라이언트가 서버에서 공개키를 자동으로 요청할 수 있도록 설정&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;최종적으로 &lt;code class=&quot;language-text&quot;&gt;application.yml&lt;/code&gt;에 2가지 속성을 추가해주면 정상적으로 연결이 됩니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yaml&quot;&gt;&lt;pre class=&quot;language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;jdbc&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;mysql&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;//xxx.xxx.xx.x&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;3306/test_db&lt;span class=&quot;token punctuation&quot;&gt;?&lt;/span&gt;useSSL=false&lt;span class=&quot;token important&quot;&gt;&amp;amp;allowPublicKeyRetrieval=true&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;caching&lt;em&gt;sha2&lt;/em&gt;password authentication plugin&lt;/h3&gt;
&lt;p&gt;MySQL 8.0은 &lt;code class=&quot;language-text&quot;&gt;SHA-246 hasing&lt;/code&gt;을 구현하는 두 가지 인증 플러그인을 지원합니다.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;sha256_password : 기본적인 SHA-256 인증을 구현한 플러그인&lt;/li&gt;
&lt;li&gt;caching&lt;em&gt;sha2&lt;/em&gt;password : sha256_password와 동일한데 성능 향상을 위해 서버 캐싱을 이용&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;문제는 &lt;code class=&quot;language-text&quot;&gt;caching_sha2_password&lt;/code&gt;를 사용하려면 다음 조건 중 하나가 만족해야 한다는 점입니다.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;SSL 보안연결을 사용&lt;/li&gt;
&lt;li&gt;RSA 보안을 적용한 비암호 연결을 사용&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;하지만 저는 테스트 용으로 로컬에서 작업을 하고 있었기 때문에 보안 연결을 사용하지 않아 아래와 같은 문제가 발생했었습니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token class-name&quot;&gt;Last_IO_Error&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; error connecting &lt;span class=&quot;token keyword&quot;&gt;to&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;master&lt;/span&gt; &apos;replication&lt;span class=&quot;token annotation punctuation&quot;&gt;@test&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3306&lt;/span&gt;&apos; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; retry&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;time&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;60&lt;/span&gt; retries&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; message&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Authentication&lt;/span&gt; plugin &apos;caching_sha2_password&apos; reported error&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Authentication&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;requires&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;secure&lt;/span&gt; connection&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;이를 해결하는 방법은 이전의 &lt;code class=&quot;language-text&quot;&gt;mysql_native_password&lt;/code&gt;를 사용하면 됩니다. 사용자의 암호를 &lt;code class=&quot;language-text&quot;&gt;DDL&lt;/code&gt;을 통해서 이전 방식으로 변경할 수 있습니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;mysql&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; ALTER &lt;span class=&quot;token environment constant&quot;&gt;USER&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;replication&apos;&lt;/span&gt;@&lt;span class=&quot;token string&quot;&gt;&apos;%&apos;&lt;/span&gt; IDENTIFIED WITH mysql_native_password BY &lt;span class=&quot;token string&quot;&gt;&apos;password&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;그리고 MySQL을 재시작하면 정상적으로 MySQL에 접속할 수 있는 것을 확인할 수 있습니다.&lt;/p&gt;
&lt;p&gt;단, 해당 방식은 MySQL이 지원하는 예전 방식이기 때문에 실제로 운영환경에서는 보안 작업을 처리한 후, 사용하는게 좋을 것으로 보입니다.&lt;/p&gt;
&lt;h2&gt;마무리&lt;/h2&gt;
&lt;p&gt;지금까지 MySQL의 Replication 과 Spring Boot에서의 활용방법에 대해서 학습한 내용과 고민한 부분을 작성해보았습니다. (추가적으로 성능 테스트 결과를 보충해서 작성할 예정입니다) 위에서 소개된 방법들이 정답은 아니기 때문에, 앞으로도 조금 더 DB Scale-out에 대해서 고민을 해봐야겠습니다.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;참고한 곳&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://docs.spring.io/spring-framework/docs/4.2.x/spring-framework-reference/html/transaction.html&quot;&gt;https://docs.spring.io/spring-framework/docs/4.2.x/spring-framework-reference/html/transaction.html&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/jdbc/datasource/LazyConnectionDataSourceProxy.html&quot;&gt;https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/jdbc/datasource/LazyConnectionDataSourceProxy.html&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://ssup2.github.io/theory_analysis/MySQL_Replication/&quot;&gt;https://ssup2.github.io/theory&lt;em&gt;analysis/MySQL&lt;/em&gt;Replication/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://backtony.github.io/spring/mysql/aws/2021-09-28-spring-mysql-1/&quot;&gt;https://backtony.github.io/spring/mysql/aws/2021-09-28-spring-mysql-1/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://trandent.com/article/etc/detail/320833&quot;&gt;https://trandent.com/article/etc/detail/320833&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[다이나믹 프록시와 팩토리 빈]]></title><description><![CDATA[들어가기전.. Spring AOP는 스프링의 3대 축이라고 불리기도 하지만 그만큼 내용의 깊이가 깊고 어려운 항목이기도 합니다. 이로 인해서, Spring AOP…]]></description><link>https://wishoon.github.io/다이나믹-프록시와-팩토리-빈/</link><guid isPermaLink="false">https://wishoon.github.io/다이나믹-프록시와-팩토리-빈/</guid><pubDate>Sat, 15 Oct 2022 00:00:00 GMT</pubDate><content:encoded>&lt;h2&gt;들어가기전..&lt;/h2&gt;
&lt;p&gt;Spring AOP는 스프링의 3대 축이라고 불리기도 하지만 그만큼 내용의 깊이가 깊고 어려운 항목이기도 합니다. 이로 인해서, Spring AOP를 계속 사용하고 있음에도 불구하고 개발자는 인지하지 못하기도 합니다. 이번 시리즈에서는 Spring AOP를 조금씩 알아보는 시간을 가져보려고 합니다.&lt;/p&gt;
&lt;h2&gt;프록시 패턴과 데코레이터 패턴의 차이..?&lt;/h2&gt;
&lt;p&gt;이 두가지 패턴의 차이점을 알기 전에 프록시의 개념에 대해서 간단하게 살펴보겠습니다.&lt;/p&gt;
&lt;p&gt;프록시는 클라이언트라 사용하려고 하는 실제 대상인 것처럼 위장해서 클라이언트의 요청을 받아주는 대리자, 대리인과 같은 역할을 한다고 해서 &lt;strong&gt;프록시&lt;/strong&gt;라고 부릅니다. 그리고 이러한 프록시를 통해 최종적으로 요청을 처리하는 실제 오브젝트를 &lt;strong&gt;타깃&lt;/strong&gt;이라고 부릅니다. 다음 그림은 일반적인 &lt;strong&gt;클라이언트 - 프록시 - 타깃의 구조&lt;/strong&gt;입니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/f9c4cea1f2a7b26c5e4605c6899afd7f/b9339/img.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 21.764705882352942%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAv0lEQVQY042PTQsBURSG/ScfK18bZctCoSwoS3/Cym+w8AeUlKZGFM00ylITVkixYD+3nHPv685MMmHh1Dk9vYvn9MaUUniNkg99GO8EISupV33nH+O7Yj7wpgsy8+BVG2TVwWYa3s2F2PXBRkJnNdCyojkJcbEhDmPNcdCipLcMMlKQp2EgDYVuDzQvgtcdkNMCzwrw7luI/UDLMzprguwGeJqFuDoQx0nwlKwq2H9m5iDPo1AYrfyrzj8crfwEZbkh/wV7WOcAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img&apos; title=&apos;img&apos; src=&apos;/static/f9c4cea1f2a7b26c5e4605c6899afd7f/ca1dc/img.png&apos; srcset=&apos;/static/f9c4cea1f2a7b26c5e4605c6899afd7f/e7570/img.png 170w,
/static/f9c4cea1f2a7b26c5e4605c6899afd7f/f46e7/img.png 340w,
/static/f9c4cea1f2a7b26c5e4605c6899afd7f/ca1dc/img.png 680w,
/static/f9c4cea1f2a7b26c5e4605c6899afd7f/02d09/img.png 1020w,
/static/f9c4cea1f2a7b26c5e4605c6899afd7f/9d567/img.png 1360w,
/static/f9c4cea1f2a7b26c5e4605c6899afd7f/b9339/img.png 1630w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;이러한 프록시는 사용 목적에 따라서 두 가지로 구분할 수 있습니다. 첫째는 클라이언트가 타깃에 접근하는 방법을 제어하기 위해서 사용될 수 있습니다. 두번째는 타깃에 부가적인 기능을 부여해주기 위해서 사용될 수 있습니다. 무엇이 프록시 패턴이고 데코레이터 패턴일까요?? 하나씩 살펴보도록 하겠습니다.&lt;/p&gt;
&lt;h3&gt;데코레이터 패턴&lt;/h3&gt;
&lt;p&gt;데코레이터 패턴은 타깃에 부가적인 기능을 런타임 시 다이내믹하게 부여해주기 위해 프록시를 사용하는 패턴을 말합니다. 데코레이터 패턴은 이름에서도 의미를 유추할 수 있듯이 &lt;strong&gt;하나의 타깃을 여러 겹으로 포장하고 장식을 붙이는데 사용&lt;/strong&gt;이 됩니다. 즉, &lt;strong&gt;프록시가 한 개 이상이 될 수 있음을 의미&lt;/strong&gt;합니다.&lt;/p&gt;
&lt;p&gt;이러한 &lt;strong&gt;데코레이터는 위임하는 대상에게도 인터페이스로 접근을 하기 때문에, 자신이 최종 타깃으로 위임을 하는지 또 다른 데코레이터 프록시로 위임을 하는지 알 수 없습니다&lt;/strong&gt;. 즉, 외부에서 위임을 할 대상을 런타임 시에 주입받을 수 있도록 만들어야 합니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/11cfeec8595716a6984f982e9363ce10/f97d7/img_1.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 18.23529411764706%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA7UlEQVQY022OMU7DQBBFfQt6KiokqBAVFNyBkjNxjRQIRBAKDcHgBCgQRFDRQBSIY5yIhCS2Z2cfY5uSlUbz/9v/VxtoHOK/7tHkFj/qoLJEJ8/mTSd3xm7Qnz66TE1HFSuzWnaKOTruoWWm5NYPisYKcrGHnG0hR6tMhy/k4QHufBtp7eKaGyx6h8xej9GTtYpJawex++/BA0V7H3e6XvPmJkH5Q0269npUjXcZLn1CPq+QOEI+LtHZGz5LjbVrNry23cXLwrKP5kNc3Kk6Af8c8ZC5egrTo2TCe39Q+fyPl9v7OjvPYTzNyBV+AXwXIFM8ZjGPAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 1&apos; title=&apos;img 1&apos; src=&apos;/static/11cfeec8595716a6984f982e9363ce10/ca1dc/img_1.png&apos; srcset=&apos;/static/11cfeec8595716a6984f982e9363ce10/e7570/img_1.png 170w,
/static/11cfeec8595716a6984f982e9363ce10/f46e7/img_1.png 340w,
/static/11cfeec8595716a6984f982e9363ce10/ca1dc/img_1.png 680w,
/static/11cfeec8595716a6984f982e9363ce10/02d09/img_1.png 1020w,
/static/11cfeec8595716a6984f982e9363ce10/9d567/img_1.png 1360w,
/static/11cfeec8595716a6984f982e9363ce10/f97d7/img_1.png 2000w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;이러한 데코레이터 패턴은 타깃의 코드를 손대지 않고, 클라이언트가 호출하는 방법도 변경하지 않은 채로 새로운 기능을 추가할 때 유용한 방법이라고 할 수 있습니다.&lt;/p&gt;
&lt;h3&gt;프록시 패턴&lt;/h3&gt;
&lt;p&gt;프록시 패턴은 타깃의 기능을 확장하거나 추가하지 않습니다. &lt;strong&gt;대신 클라이언트가 타깃에 접근하는 방식을 변경&lt;/strong&gt;해줍니다. 예를 들면, 타깃 오브젝트를 생성하기가 복잡하거나 당장 필요하지 않은 경우, 필요한 시점까지 오브젝트를 생성하지 않는 것이 좋습니다. 하지만 &lt;strong&gt;타깃 오브젝트에 대한 레퍼런스가 미리 필요할 때가 있습니다&lt;/strong&gt;. 이럴 때 프록시 패턴을 사용할 수 있습니다.&lt;/p&gt;
&lt;p&gt;프록시 패턴은 클라이언트에게 &lt;strong&gt;실제 타깃에 대한 레퍼런스를 넘기는 것이 아닌, 프록시를 넘겨주는 것&lt;/strong&gt;을 의미합니다. 그리고 &lt;strong&gt;프록시의 메서드를 통해 타깃을 사용하려고 시도하면, 그때 타깃 오브젝트를 생성해서 요청을 위임하여 객체의 생성을 최대한 늦춥&lt;/strong&gt;니다.&lt;/p&gt;
&lt;p&gt;&lt;span class=&apos;gatsby-resp-image-wrapper&apos; style=&apos;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;&apos;&gt;
      &lt;a class=&apos;gatsby-resp-image-link&apos; href=&apos;/static/04650e9a8e8ffe77e45cd3ac8d59683f/e8464/img_2.png&apos; style=&apos;display: block&apos; target=&apos;_blank&apos; rel=&apos;noopener&apos;&gt;
    &lt;span class=&apos;gatsby-resp-image-background-image&apos; style=&quot;padding-bottom: 34.705882352941174%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABT0lEQVQoz42Su0oDURCG8xq+gZ1Y+ASCiLEUbG0URKtgSmtfwdrOwkIUBC/xgkIUE0SFaJNEIUI2Jtkku3t291w+95IiQkAHhvnP/88M58ycjDGG/7kGDEopHGeAbXfxhUj5YU5sGcZYLA31X1xsjuNQq3/y/Fqh/tEgkGakxpAx0sUEHYywMP53hO1IkUmK8dspF7togbTp9/t0Wg16rRq2VUV7VpqnRHpDeZFFHk4ir5eQZ3Oogwnctz261Uv0yQzh6SzyfB4ZRVXI0rYauLcbhEdT6MICsrBIeDyNetlJG6qnbdTdCqqURz3mUDfLyK8rwk4Ffb+OLuWgvIV+2IxwnjDwUO+7mOIappzHlCKtuIqu74+f4ejoPBEwcFy63R6uJxB+mPCh1NHZj57vJHqMlU5rMn9tVkSbbDabyXa11gmfRp3M03XdBKe/AH4AJKAJ0ZHXpt0AAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&apos;gatsby-resp-image-image&apos; alt=&apos;img 2&apos; title=&apos;img 2&apos; src=&apos;/static/04650e9a8e8ffe77e45cd3ac8d59683f/ca1dc/img_2.png&apos; srcset=&apos;/static/04650e9a8e8ffe77e45cd3ac8d59683f/e7570/img_2.png 170w,
/static/04650e9a8e8ffe77e45cd3ac8d59683f/f46e7/img_2.png 340w,
/static/04650e9a8e8ffe77e45cd3ac8d59683f/ca1dc/img_2.png 680w,
/static/04650e9a8e8ffe77e45cd3ac8d59683f/02d09/img_2.png 1020w,
/static/04650e9a8e8ffe77e45cd3ac8d59683f/9d567/img_2.png 1360w,
/static/04650e9a8e8ffe77e45cd3ac8d59683f/e8464/img_2.png 1536w&apos; sizes=&apos;(max-width: 680px) 100vw, 680px&apos; style=&apos;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&apos; loading=&apos;lazy&apos; decoding=&apos;async&apos;&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;이러한 프록시 패턴은 객체의 생성을 요청시점까지 최대한 늦춤으로써 끝까지 사용하지 않거나, 많은 작업이 진행된 후에 사용되는 비효율적인 생성을 보다 효율적으로 사용할 수 있도록 하는 유용한 방법이라고 할 수 있습니다.&lt;/p&gt;
&lt;h2&gt;다이내믹 프록시&lt;/h2&gt;
&lt;p&gt;프록시는 기존 코드에 영향을 주지 않으면서 타깃의 기능을 확장하거나 접근 방법을 제어할 수 있는 유용한 방법입니다. 하지만 해당방법은 상당히 귀찮은 작업이라고도 할 수 있습니다. &lt;strong&gt;매번 새로운 클래스를 정의해야하고, 인터페이스 처리된 메서드들에 대해서 위임하는 작업들을 전부 해줘야 하기 때문&lt;/strong&gt;입니다.&lt;/p&gt;
&lt;p&gt;이렇게 불편한 작업들을 우리는 &lt;code class=&quot;language-text&quot;&gt;java.lang.reflect&lt;/code&gt;에 있는 패키지에서 프록시를 손쉽게 만들 수 있도록 기능을 제공하고 있습니다.&lt;/p&gt;
&lt;h3&gt;프록시의 구성과 프록시 작성의 문제점&lt;/h3&gt;
&lt;p&gt;프록시는 다음의 두 가지 기능으로 구성됩니다.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;타깃과 같은 메서드를 구현하고 있다가 메소드가 호출되면 타킷 오브젝토로 위임한다.&lt;/li&gt;
&lt;li&gt;지정된 요청에 대해서는 부가기능을 수행한다.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;이렇게 프록시를 만들게 되면 다음과 같이 &lt;strong&gt;위에서 말한 귀찮은 작업&lt;/strong&gt;들을 매번 해줘야 합니다.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;타겟의 인터페이스를 구현하고 위임하는 코드를 작성하기가 번거롭다. 부가기능이 필요없는 메서드도 이를 적용해야 한다. 또한, 타겟의 인터페이스 메서드가 추가되거나 변경될 때마다 함께 수정해줘야 한다.&lt;/li&gt;
&lt;li&gt;부가기능 코드가 중복될 가능성이 많다. 트랜잭션은 DB를 사용하는 대부분의 로직에 적용될 필요가 있다. 예를들어 add()에 부가 기능을 추가해주고, update()에도 부가 기능을 추가해줘야 한다면 트랜잭션 기능을 제공하는 유사한 코드가 여러 매서드에 중복되서 나타날 것이다.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;이러한 문제를 어떻게 해결해야 할까요? 바로 &lt;strong&gt;JDK 다이내믹 프록시&lt;/strong&gt;를 통해서 해결할 수 있습니다.&lt;/p&gt;
&lt;h3&gt;리플랙션&lt;/h3&gt;
&lt;p&gt;다이내믹 프록시는 리플렉션 기능을 이용해서 만들 수 있습니다. 리플랙션을 간단히 설명하자면 자바의 코드 자체를 추상화에서 접근하도록 만든 것이라고 할 수 있습니다.&lt;/p&gt;
&lt;p&gt;자바의 모든 클래스는 그 클래스 자체의 구성정보를 담은 &lt;code class=&quot;language-text&quot;&gt;Class&lt;/code&gt; 타입의 오브젝트를 하나씩 갖고 있습니다. 이러한 &lt;code class=&quot;language-text&quot;&gt;Class&lt;/code&gt; 타입의 오브젝트를 이용하면 클래스 코드에 대한 메타정보를 가져오거나 오브젝트를 조작할 수 있습니다.&lt;/p&gt;
&lt;p&gt;조금 자세하게 예를 들어서 설명하면 &lt;code class=&quot;language-text&quot;&gt;String.class&lt;/code&gt;가 가진 &lt;code class=&quot;language-text&quot;&gt;length()&lt;/code&gt;라는 메서드의 정보를 가져오기 위해서는 다음과 같이 메서드 정보를 가져올 수 있습니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token class-name&quot;&gt;Method&lt;/span&gt; lengthMethod &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getMethod&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;length&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;그리고 이렇게 가져온 메서드의 정보를 가지고 실행도 시킬 수 있습니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; length &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; lengthMethod&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;invoke&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;name&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;리플랙션 사용까지 알았다면 다이내믹 프록시를 적용하는데 큰 어려움이 없을 것 입니다.&lt;/p&gt;
&lt;h3&gt;다이내믹 프록시를 적용해보자&lt;/h3&gt;
&lt;p&gt;다이내믹 프록시는 &lt;strong&gt;프록시 팩토리에 의해 런타임 시 다이내믹하게 만들어지는 오브젝트&lt;/strong&gt;를 말합니다. 다이내믹 프록시 오브젝트는 타깃의 인터페이스와 같은 타입으로 만들어집니다. 이 덕분에 &lt;strong&gt;프록시를 만들 때, 인터페이스를 모두 구현해가면서 클래스를 정의하지 않아도 됩니다&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;여기서 개발자는 다이내믹 프록시를 통해서 만들어주는 오브젝트를 기반으로, 제공하려는 부가기능 제공 코드만 작성을 하면 됩니다. 이런 부가기능 제공 코드는 &lt;code class=&quot;language-text&quot;&gt;InvocationHandler&lt;/code&gt;를 구현한 오브젝트에 담으면 됩니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Object&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;invoke&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Object&lt;/span&gt; proxy&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Method&lt;/span&gt; method&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Object&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; args&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;InvocationHandler&lt;/code&gt;의 유일한 메서드인 &lt;code class=&quot;language-text&quot;&gt;invoke()&lt;/code&gt; 메서드는 리플레션의 &lt;code class=&quot;language-text&quot;&gt;Method&lt;/code&gt;와 메서드를 호출할 때 전달되는 파라미터도 &lt;code class=&quot;language-text&quot;&gt;args&lt;/code&gt;로 받습니다. 즉, 다이내믹 프록시 오브젝트는 &lt;strong&gt;클라이언트의 모든 요청을 리플렉션 정보로 변환해서 &lt;code class=&quot;language-text&quot;&gt;InvocationHandler&lt;/code&gt; 를 구현한 오브젝트의 &lt;code class=&quot;language-text&quot;&gt;invoke()&lt;/code&gt; 메서드로 넘긴다&lt;/strong&gt;고 할 수 있습니다.&lt;/p&gt;
&lt;p&gt;코드를 통해서 이를 한번 확인해보겠습니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;TxHandler&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;InvocationHandler&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Object&lt;/span&gt; target&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;PlatformTransactionManager&lt;/span&gt; transactionManager&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;TxHandler&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Object&lt;/span&gt; target&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;PlatformTransactionManager&lt;/span&gt; transactionManager&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;target &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; target&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;transactionManager &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; transactionManager&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token annotation punctuation&quot;&gt;@Override&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Object&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;invoke&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Object&lt;/span&gt; proxy&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Method&lt;/span&gt; method&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Object&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; args&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Throwable&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;TransactionStatus&lt;/span&gt; transactionStatus &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; transactionManager&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getTransaction&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;DefaultTransactionDefinition&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token class-name&quot;&gt;Object&lt;/span&gt; result &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; method&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;invoke&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;target&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; args&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            transactionManager&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;commit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;transactionStatus&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; result&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;catch&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;InvocationTargetException&lt;/span&gt; e&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            transactionManager&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;rollback&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;transactionStatus&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;throw&lt;/span&gt; e&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getTargetException&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;중요한 내용이라서 흐름을 한번 더 정리해보겠습니다.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;다이내믹 프록시로부터 요청을 전달받으려면 &lt;code class=&quot;language-text&quot;&gt;InvocationHandler&lt;/code&gt;를 구현해야 합니다. 즉, 다이내믹 프록시가 클라이언트로부터 받는 모든 요청은 &lt;code class=&quot;language-text&quot;&gt;invoke()&lt;/code&gt; 메서드로 전달이 됩니다.&lt;/li&gt;
&lt;li&gt;이렇게 전달이 되면 &lt;strong&gt;리플렉션 API&lt;/strong&gt;를 이용해서 &lt;strong&gt;타깃 오브젝트&lt;/strong&gt;의 메서드를 호출합니다.&lt;/li&gt;
&lt;li&gt;이후 지정한 부가기능을 수행하고, 결과를 리턴하면 해당 값을 &lt;strong&gt;다이내믹 프록시&lt;/strong&gt;가 받아서 최종적으로 클라이언트에게 전달합니다.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;이러한 프록시는 다음과 같이 생성할 수 있습니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; txHandler&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;TxHandler&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;target&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; transactionManager&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; userService &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;UserService&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Proxy&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;newProxyInstance&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
     &lt;span class=&quot;token function&quot;&gt;getClass&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getClassLoader&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
	   &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;UserService&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
     txHandler&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;이제 우리는 &lt;strong&gt;다이내믹 프록시&lt;/strong&gt;를 이용해서 조금 더 깔끔하게 &lt;code class=&quot;language-text&quot;&gt;Transactional&lt;/code&gt; 을 적용할 수 있게 되었습니다.&lt;/p&gt;
&lt;p&gt;해당 내용을 구현한 코드는 다음 링크에서 확인할 수 있습니다. → &lt;a href=&quot;https://github.com/woowacourse/jwp-dashboard-jdbc/pull/177/commits/76e7dc9bfb17be6275378bbd7039a29430dd6242&quot;&gt;링크&lt;/a&gt;&lt;/p&gt;
&lt;h2&gt;팩토리 빈&lt;/h2&gt;
&lt;p&gt;위의 내용들을 통해서 조금 더 깔끔하게 &lt;code class=&quot;language-text&quot;&gt;Transactional&lt;/code&gt;을 사용할 수 있는 코드를 만들었습니다. 그렇다면 이를 &lt;strong&gt;스프링의 DI&lt;/strong&gt; 통해 사용할 수 있도록 만들어 볼 수 있을 것 같습니다. 하지만 &lt;strong&gt;DI의 대상이 되는 다이내믹 프록시 오브젝트는 일반적인 스프링 빈으로 등록이 불가능&lt;/strong&gt;합니다.&lt;/p&gt;
&lt;p&gt;스프링의 빈은 기본적으로 클래스 이름과 프로퍼티로 정의됩니다. 이를 기반으로 스프링은 지정된 클래스 이름을 가지고 리플렉션을 통해서 해당 클래스의 오브젝트를 만듭니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token class-name&quot;&gt;Date&lt;/span&gt; now &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Date&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;forName&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;java.util.Date&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;newInstance&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;여기서 문제는 &lt;strong&gt;다이내믹 프록시는 이런 식으로 프록시 오브젝트가 생성되지 않는다는 점&lt;/strong&gt;입니다. 그렇다면 방법이 없는 것일까요?? 스프링은 무언가 다른 방법을 제시해줄 것 같습니다.&lt;/p&gt;
&lt;h3&gt;팩토리 빈&lt;/h3&gt;
&lt;p&gt;팩토리 빈은 클래스 정보를 기반으로 디폴트 생성자를 통해 오브젝트를 만드는 방법 외에 특별하게 빈을 만들 수 있는 방법 중 하나입니다. 여러가지 방법이 있지만 가장 간단한 방법은 스프링의 &lt;code class=&quot;language-text&quot;&gt;FactoryBean&lt;/code&gt; 인터페이스를 구현하는 것 입니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;interface&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;FactoryBean&lt;/span&gt;&lt;span class=&quot;token generics&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;T&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token class-name&quot;&gt;T&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;getObject&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Exception&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;     &lt;span class=&quot;token comment&quot;&gt;// 빈 오브젝트를 생성해서 돌려준다. &lt;/span&gt;
    &lt;span class=&quot;token class-name&quot;&gt;Class&lt;/span&gt;&lt;span class=&quot;token generics&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;T&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;getObjectType&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 생성되는 오브젝트의 타입을 알려준다.&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;isSingleton&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;              &lt;span class=&quot;token comment&quot;&gt;// getObject()가 돌려주는 오브젝트가 항상 같은 싱글톤 오브젝트인지 알려준다.&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;스프링은 &lt;code class=&quot;language-text&quot;&gt;FactoryBean&lt;/code&gt; 인터페이스를 구현한 클래스가 빈의 클래스로 지정되면, &lt;code class=&quot;language-text&quot;&gt;FactoryBean&lt;/code&gt; 클래스의 오브젝트의 &lt;code class=&quot;language-text&quot;&gt;getObject()&lt;/code&gt;를 이용해 오브젝트를 가져오고, 이를 빈 오브젝트로 사용합니다.&lt;/p&gt;
&lt;h3&gt;다이내믹 프록시를 팩토리 빈으로 만들어보자&lt;/h3&gt;
&lt;p&gt;이러한 팩토리 빈을 통해서 다이내믹 프록시를 만들 수 있습니다. 팩토리 빈의 &lt;code class=&quot;language-text&quot;&gt;getObject()&lt;/code&gt; 메서드에 다이내믹 오브젝트를 만들어주는 코드를 작성하면 되기 때문입니다.&lt;/p&gt;
&lt;p&gt;코드를 통해서 이를 확인해보겠습니다.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;TxProxyFactoryBean&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;FactoryBean&lt;/span&gt;&lt;span class=&quot;token generics&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Object&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 범용적으로 사용하기 위해 Object로 지정했다.&lt;/span&gt;
    
    &lt;span class=&quot;token class-name&quot;&gt;Object&lt;/span&gt; target&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token class-name&quot;&gt;PlatformTransactionManager&lt;/span&gt; transactionManager&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt; pattern&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token class-name&quot;&gt;Class&lt;/span&gt;&lt;span class=&quot;token generics&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt; serviceInterface&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 다이내믹 프록시를 생성할 때 필요하다.&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Object&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;getObject&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Exception&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;TxHandler&lt;/span&gt; txHandler &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;TxHandler&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        txHandler&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;setTarget&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;target&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        txHandler&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;setTransactionManager&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;transactionManager&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        txHandler&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;setPattern&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pattern&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Proxy&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;newProxyInstance&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getClass&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getClassLoader&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; serviceInterface &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; txHandler&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Class&lt;/span&gt;&lt;span class=&quot;token generics&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;getObjectType&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; serviceInterface&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 팩토리 빈이 생성하는 오브젝트의 타입은 DI 받은 인터페이스 타입에 따라 달라진다. 따라서 다양한 타입의 프록시 오브젝트 생성에 재사용할 수 있다.&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;isSingleTon&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 싱글톤 빈이 아니라는 뜻이 아니라 getObject()가 매번 같은 오브젝트를 리턴하지 않는다는 뜻이다.&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// setter ..&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;위의 코드를 보면 알 수 있듯이 팩토리 빈이 만드는 다이내믹 프록시는 구현 인터페이스나, 타깃의 종류에 제한이 없습니다. 따라서 &lt;strong&gt;DI를 통해 TxHandler를 이용하는 다이내믹 프록시를 재사용해서 사용&lt;/strong&gt;할 수 있습니다.&lt;/p&gt;
&lt;h3&gt;팩토리 빈의 한계&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;TransactionHandler&lt;/code&gt;를 이용하는 다이내믹 프록시를 생성해주는 &lt;code class=&quot;language-text&quot;&gt;TxProxyFactoryBean&lt;/code&gt;은 코드의 수정 없이도 다양한 클래스에 적용이 가능합니다. 타깃 오브젝트에 맞는 프로퍼티 정보만 설정해서 빈으로 등록해주면 되기 때문입니다.&lt;/p&gt;
&lt;p&gt;하지만 이러한 방법 역시 명확한 한계점을 가지고 있습니다. 바로 한 번에 여러 클래스에 공통적인 부가기능을 제공하는 것 입니다. 지금과 같은 방법은 &lt;strong&gt;적용 대상인 클래스가 N개라면 그만큼의 프록시 패턴의 빈의 설정이 중복&lt;/strong&gt;되는 구조를 가지게 됩니다.&lt;/p&gt;
&lt;p&gt;또한 &lt;strong&gt;&lt;code class=&quot;language-text&quot;&gt;Handler&lt;/code&gt; 오브젝트가 프록시 팩토리 빈 갯수만큼 만들어진다는 점입니다.&lt;/strong&gt; 이는 타깃 오브젝트르 프로퍼티로 가지고 있음으로 생기는 문제입니다.&lt;/p&gt;
&lt;p&gt;이러한 문제들을 해결할 수 있는 방법은 없을까요?? 이를 다음글에서 한번 살펴보도록 합시다.&lt;/p&gt;
&lt;h2&gt;글을 마무리하며..&lt;/h2&gt;
&lt;p&gt;이번 글을 정리하면서 Proxy에 대해서 다시 한번 정리할 수 있는 시간이였습니다. 매번 해당 내용이 추상적으로 다가왔는데 이번에는 조금 이해가 잘되었던 것 같습니다. 아마 진행하고 있는 테크코스 과제와 스터디가 큰 영향을 미친거 같기도 합니다. 이번 6장을 끝으로 토비의 스프링 스터디를 마무리 할 것 같은데 유의미하게 마무리할 수 있었으면 좋겠습니다.&lt;/p&gt;
&lt;br&gt;
&lt;blockquote&gt;
&lt;p&gt;참고한 글&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;토비의 스프링 3.1&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/woowacourse/jwp-dashboard-jdbc&quot;&gt;https://github.com/woowacourse/jwp-dashboard-jdbc&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://docs.oracle.com/javase/8/docs/api/java/lang/reflect/InvocationHandler.html&quot;&gt;https://docs.oracle.com/javase/8/docs/api/java/lang/reflect/InvocationHandler.html&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item></channel></rss>